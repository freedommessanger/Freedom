<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Freedom</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ─── DARK THEME ─── */
[data-theme="dark"] {
  --bg: #0d0f14;
  --sidebar: #13151c;
  --surface: #1a1d27;
  --surface2: #20232f;
  --border: #2a2d3a;
  --border2: #333648;
  --accent: #4f8ef7;
  --accent-dim: rgba(79,142,247,0.15);
  --accent-hover: #6aa0ff;
  --green: #34d058;
  --green-dim: rgba(52,208,88,0.12);
  --red: #ff5252;
  --red-dim: rgba(255,82,82,0.12);
  --yellow: #ffd166;
  --text: #e8eaf0;
  --text2: #7c8094;
  --text3: #4a4d60;
  --bubble-out: #1c3a6e;
  --bubble-in: #1a1d27;
  --shadow: 0 8px 32px rgba(0,0,0,0.4);
}

/* ─── LIGHT THEME ─── */
[data-theme="light"] {
  --bg: #f0f2f8;
  --sidebar: #ffffff;
  --surface: #f4f6fb;
  --surface2: #e8ecf5;
  --border: #dde1ed;
  --border2: #c8cee0;
  --accent: #4f8ef7;
  --accent-dim: rgba(79,142,247,0.12);
  --accent-hover: #3a7be8;
  --green: #1faa47;
  --green-dim: rgba(31,170,71,0.10);
  --red: #e53935;
  --red-dim: rgba(229,57,53,0.10);
  --yellow: #f59e0b;
  --text: #1a1d2e;
  --text2: #5c637a;
  --text3: #9ba3b8;
  --bubble-out: #dbeafe;
  --bubble-in: #ffffff;
  --shadow: 0 8px 32px rgba(0,0,0,0.12);
}

* { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); font-size:14px; -webkit-font-smoothing:antialiased; }
::-webkit-scrollbar { width:3px; height:3px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border2); border-radius:2px; }

/* ─── AUTH ─── */
#auth-screen {
  display:flex; align-items:center; justify-content:center; height:100vh;
  background: radial-gradient(ellipse 70% 50% at 50% 0%, rgba(79,142,247,0.1) 0%, transparent 65%);
}
.auth-card {
  width:400px; background:var(--sidebar); border:1px solid var(--border);
  border-radius:24px; padding:40px 36px; box-shadow:0 32px 80px rgba(0,0,0,0.2);
}
.auth-brand { display:flex; align-items:center; gap:14px; margin-bottom:32px; }
.auth-brand-icon { width:52px; height:52px; background:var(--accent); border-radius:16px; display:flex; align-items:center; justify-content:center; }
.auth-brand-text h1 { font-size:24px; font-weight:700; letter-spacing:-0.5px; }
.auth-brand-text p { color:var(--text2); font-size:13px; margin-top:2px; }
.auth-seg { display:flex; background:var(--bg); border-radius:12px; padding:3px; margin-bottom:28px; border:1px solid var(--border); }
.auth-seg-btn { flex:1; padding:9px; border:none; background:none; color:var(--text2); border-radius:9px; cursor:pointer; font-size:13px; font-weight:500; transition:all .2s; font-family:inherit; }
.auth-seg-btn.active { background:var(--sidebar); color:var(--text); box-shadow:0 2px 8px rgba(0,0,0,0.12); }
.field { margin-bottom:16px; position:relative; }
.field-label { display:flex; align-items:center; gap:6px; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:1px; color:var(--text2); margin-bottom:8px; }
.field-icon { position:absolute; left:13px; bottom:11px; color:var(--text3); pointer-events:none; }
.field input { width:100%; padding:11px 14px 11px 40px; background:var(--surface); border:1px solid var(--border); border-radius:12px; color:var(--text); font-family:inherit; font-size:14px; outline:none; transition:all .2s; }
.field input:focus { border-color:var(--accent); background:var(--surface2); }
.field input::placeholder { color:var(--text3); }
.auth-btn { width:100%; padding:12px; background:var(--accent); border:none; border-radius:12px; color:#fff; font-size:14px; font-weight:600; cursor:pointer; transition:all .2s; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:8px; margin-top:4px; }
.auth-btn:hover { background:var(--accent-hover); transform:translateY(-1px); box-shadow:0 4px 16px rgba(79,142,247,0.3); }
.auth-err { color:var(--red); font-size:12px; text-align:center; margin-top:10px; min-height:16px; }

/* ─── APP ─── */
#app { display:none; height:100vh; }
#app.on { display:flex; }

/* ─── SIDEBAR ─── */
.sidebar { width:300px; background:var(--sidebar); border-right:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; }
.sb-head { display:flex; align-items:center; gap:10px; padding:14px 14px 12px; border-bottom:1px solid var(--border); }
.me-av { width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; cursor:pointer; flex-shrink:0; overflow:hidden; transition:opacity .2s; }
.me-av:hover { opacity:.8; }
.me-av img { width:100%; height:100%; object-fit:cover; }
.me-nm { flex:1; font-weight:600; font-size:14px; cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.me-nm:hover { color:var(--accent); }
.sb-acts { display:flex; gap:2px; }
.ib { width:32px; height:32px; border:none; background:none; color:var(--text2); border-radius:9px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .18s; }
.ib:hover { background:var(--surface); color:var(--text); }
.sb-search { padding:10px 12px; border-bottom:1px solid var(--border); }
.srch-wrap { position:relative; }
.srch-wrap svg { position:absolute; left:11px; top:50%; transform:translateY(-50%); color:var(--text3); pointer-events:none; }
.srch-inp { width:100%; padding:8px 12px 8px 36px; background:var(--surface); border:1px solid var(--border); border-radius:22px; color:var(--text); font-family:inherit; font-size:13px; outline:none; transition:all .2s; }
.srch-inp:focus { border-color:var(--accent); background:var(--surface2); }
.srch-inp::placeholder { color:var(--text3); }
.sb-tabs { display:flex; padding:0 12px; border-bottom:1px solid var(--border); gap:2px; }
.sb-tab { flex:1; padding:10px 4px 9px; border:none; background:none; color:var(--text2); cursor:pointer; font-size:12px; font-weight:500; border-bottom:2px solid transparent; transition:all .2s; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:5px; }
.sb-tab:hover { color:var(--text); }
.sb-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.chat-list { flex:1; overflow-y:auto; padding:6px; }
.chat-item { display:flex; align-items:center; gap:11px; padding:9px 10px; border-radius:12px; cursor:pointer; transition:background .15s; position:relative; }
.chat-item:hover { background:var(--surface); }
.chat-item.active { background:var(--surface2); }
.chat-item.active::before { content:''; position:absolute; left:0; top:50%; transform:translateY(-50%); width:3px; height:55%; background:var(--accent); border-radius:0 3px 3px 0; }
.ci-av { width:46px; height:46px; border-radius:14px; flex-shrink:0; position:relative; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:17px; overflow:hidden; }
.ci-av img { width:100%; height:100%; object-fit:cover; border-radius:14px; }
.odot { position:absolute; bottom:-1px; right:-1px; width:13px; height:13px; background:var(--green); border-radius:50%; border:2px solid var(--sidebar); }
.ci-info { flex:1; min-width:0; }
.ci-top { display:flex; align-items:center; justify-content:space-between; gap:4px; }
.ci-name { font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ci-time { font-size:11px; color:var(--text3); flex-shrink:0; }
.ci-bot { display:flex; align-items:center; justify-content:space-between; gap:4px; margin-top:2px; }
.ci-prev { color:var(--text2); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:flex; align-items:center; gap:4px; }
.ubadge { background:var(--accent); color:#fff; font-size:10px; font-weight:700; border-radius:10px; padding:2px 6px; min-width:18px; text-align:center; flex-shrink:0; }
.empty-list { padding:48px 20px; text-align:center; color:var(--text2); font-size:13px; }
.empty-list-icon { color:var(--text3); margin-bottom:12px; display:flex; justify-content:center; }
.sec-hd { padding:14px 12px 4px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; color:var(--text3); }

/* ─── CHAT AREA ─── */
.chat-area { flex:1; display:flex; flex-direction:column; background:var(--bg); min-width:0; }
.no-chat { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; color:var(--text2); }
.no-chat-icon { color:var(--text3); opacity:.5; }
.no-chat h3 { font-size:18px; font-weight:600; color:var(--text); }
.no-chat p { font-size:13px; }
.chat-hd { display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid var(--border); background:var(--sidebar); flex-shrink:0; }
.ch-av { width:38px; height:38px; border-radius:12px; cursor:pointer; flex-shrink:0; overflow:hidden; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; }
.ch-av img { width:100%; height:100%; object-fit:cover; }
.ch-info { flex:1; cursor:pointer; min-width:0; }
.ch-name { font-weight:600; font-size:15px; }
.ch-status { font-size:12px; color:var(--text2); margin-top:1px; display:flex; align-items:center; gap:4px; }
.ch-status.on { color:var(--green); }
.ch-status.on::before { content:''; width:6px; height:6px; background:var(--green); border-radius:50%; display:inline-block; }
.ch-acts { display:flex; gap:2px; }

/* Messages */
.msgs { flex:1; overflow-y:auto; padding:16px 16px 8px; display:flex; flex-direction:column; gap:2px; }
.date-div { display:flex; align-items:center; gap:10px; margin:12px 0; color:var(--text3); font-size:11px; }
.date-div::before,.date-div::after { content:''; flex:1; height:1px; background:var(--border); }
.mrow { display:flex; align-items:flex-end; gap:8px; animation:msgIn .18s ease; }
.mrow.out { flex-direction:row-reverse; align-self:flex-end; max-width:75%; }
.mrow.in { align-self:flex-start; max-width:75%; }
@keyframes msgIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.msg-av { width:28px; height:28px; border-radius:9px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:11px; overflow:hidden; }
.msg-av img { width:100%; height:100%; object-fit:cover; }
.bubble { padding:8px 12px; border-radius:16px; max-width:100%; word-break:break-word; cursor:default; position:relative; }
[data-theme="dark"] .out .bubble { background:var(--bubble-out); border-bottom-right-radius:4px; }
[data-theme="light"] .out .bubble { background:var(--bubble-out); border-bottom-right-radius:4px; border:1px solid rgba(79,142,247,0.2); }
.in .bubble { background:var(--bubble-in); border-bottom-left-radius:4px; border:1px solid var(--border); }
.bbl-reply { background:rgba(255,255,255,0.06); border-left:2px solid var(--accent); border-radius:8px; padding:5px 8px; margin-bottom:6px; }
[data-theme="light"] .bbl-reply { background:rgba(79,142,247,0.07); }
.bbl-rname { font-size:11px; font-weight:600; color:var(--accent); margin-bottom:2px; }
.bbl-rtext { font-size:12px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.bbl-text { font-size:14px; line-height:1.55; }
.bbl-img { max-width:280px; max-height:260px; border-radius:10px; display:block; cursor:zoom-in; object-fit:contain; width:auto; height:auto; }
.bbl-meta { display:flex; align-items:center; justify-content:flex-end; gap:4px; margin-top:4px; font-size:10px; color:var(--text3); }
.bbl-meta .chk { color:var(--accent); display:flex; }
.voice-msg { display:flex; align-items:center; gap:10px; min-width:190px; }
.voice-play { width:36px; height:36px; border-radius:50%; background:var(--accent); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; color:#fff; transition:background .2s; }
.voice-play:hover { background:var(--accent-hover); }
.voice-waves { flex:1; display:flex; align-items:center; gap:2px; height:24px; }
.voice-waves span { display:inline-block; width:3px; border-radius:2px; background:var(--text3); }
.voice-dur { font-size:11px; color:var(--text2); }
.typing-row { display:flex; align-items:center; gap:8px; color:var(--text2); font-size:12px; padding:4px 0; }
.tdots { display:flex; gap:3px; }
.tdots span { width:6px; height:6px; background:var(--text2); border-radius:50%; animation:tdot 1.2s infinite; }
.tdots span:nth-child(2){animation-delay:.2s}.tdots span:nth-child(3){animation-delay:.4s}
@keyframes tdot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

/* ─── INPUT BAR ─── */
.ibar { padding:10px 14px 12px; background:var(--sidebar); border-top:1px solid var(--border); flex-shrink:0; }
.reply-strip { display:none; align-items:center; gap:10px; background:var(--surface); border-left:3px solid var(--accent); border-radius:0 10px 10px 0; padding:6px 10px; margin-bottom:8px; }
.reply-strip.on { display:flex; }
.rs-info { flex:1; min-width:0; }
.rs-nm { font-size:11px; font-weight:600; color:var(--accent); margin-bottom:2px; }
.rs-tx { font-size:12px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.rs-x { border:none; background:none; color:var(--text2); cursor:pointer; padding:2px; border-radius:4px; display:flex; }
.rs-x:hover { color:var(--text); }
.img-strip { display:none; position:relative; margin-bottom:8px; width:fit-content; }
.img-strip.on { display:block; }
.img-strip img { height:80px; border-radius:10px; display:block; }
.img-strip-rm { position:absolute; top:-6px; right:-6px; width:20px; height:20px; background:var(--red); border:none; border-radius:50%; cursor:pointer; color:#fff; display:flex; align-items:center; justify-content:center; }
.irow { display:flex; align-items:flex-end; gap:8px; }
.iab { width:38px; height:38px; border:none; background:none; color:var(--text2); border-radius:11px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .18s; flex-shrink:0; }
.iab:hover { background:var(--surface); color:var(--text); }
.iwrap { flex:1; position:relative; }
.msg-inp { width:100%; padding:9px 40px 9px 16px; background:var(--surface); border:1px solid var(--border); border-radius:14px; color:var(--text); font-family:inherit; font-size:14px; outline:none; resize:none; max-height:120px; transition:border-color .2s; line-height:1.5; }
.msg-inp:focus { border-color:var(--border2); background:var(--surface2); }
.msg-inp::placeholder { color:var(--text3); }
.emoji-trigger { position:absolute; right:10px; bottom:8px; border:none; background:none; color:var(--text3); cursor:pointer; padding:2px; border-radius:6px; display:flex; transition:color .18s; }
.emoji-trigger:hover { color:var(--text2); }
.emoji-picker { display:none; position:absolute; bottom:50px; right:0; background:var(--surface2); border:1px solid var(--border); border-radius:16px; padding:10px; z-index:200; width:288px; box-shadow:var(--shadow); }
.emoji-picker.on { display:block; }
.emoji-grid { display:grid; grid-template-columns:repeat(8,1fr); gap:3px; }
.emoji-it { font-size:22px; cursor:pointer; text-align:center; border-radius:8px; padding:4px; transition:background .12s; }
.emoji-it:hover { background:var(--surface); }
.send-btn { width:38px; height:38px; border:none; background:var(--accent); color:#fff; border-radius:11px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.send-btn:hover { background:var(--accent-hover); transform:scale(1.04); }
.mic-btn { width:38px; height:38px; border:none; background:var(--surface); color:var(--text2); border-radius:11px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.mic-btn:hover { background:var(--surface2); color:var(--text); }
.mic-btn.rec { background:var(--red-dim); color:var(--red); animation:rp 1s infinite; border:1px solid var(--red); }
@keyframes rp{0%,100%{opacity:1}50%{opacity:.7}}

/* ─── CONTEXT MENU ─── */
.ctx { position:fixed; background:var(--surface2); border:1px solid var(--border); border-radius:14px; padding:4px; box-shadow:var(--shadow); z-index:1000; min-width:170px; display:none; overflow:hidden; }
.ctx.on { display:block; }
.ctx-it { display:flex; align-items:center; gap:10px; padding:9px 13px; border-radius:10px; cursor:pointer; font-size:13px; transition:background .12s; }
.ctx-it:hover { background:var(--surface); }
.ctx-it.danger { color:var(--red); }

/* ─── SETTINGS PANEL ─── */
.sett-panel { position:fixed; top:0; right:-420px; width:380px; height:100vh; background:var(--sidebar); border-left:1px solid var(--border); z-index:300; transition:right .3s cubic-bezier(.4,0,.2,1); display:flex; flex-direction:column; box-shadow:-8px 0 32px rgba(0,0,0,0.15); }
.sett-panel.on { right:0; }
.sett-hd { display:flex; align-items:center; gap:12px; padding:16px 20px; border-bottom:1px solid var(--border); flex-shrink:0; }
.sett-hd h2 { font-size:17px; font-weight:700; flex:1; }
.sett-body { flex:1; overflow-y:auto; padding-bottom:80px; }
.sett-profile { padding:24px 20px; text-align:center; border-bottom:1px solid var(--border); }
.sett-av-wrap { position:relative; width:80px; margin:0 auto 14px; cursor:pointer; }
.sett-av { width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:30px; font-weight:700; overflow:hidden; border:2px solid var(--border); }
.sett-av img { width:100%; height:100%; object-fit:cover; }
.sett-av-badge { position:absolute; bottom:-4px; right:-4px; width:26px; height:26px; background:var(--accent); border-radius:8px; display:flex; align-items:center; justify-content:center; border:2px solid var(--sidebar); }
.sett-uname { font-size:18px; font-weight:700; margin-bottom:4px; }
.sett-handle { font-size:13px; color:var(--text2); }
.sett-grp { padding:12px 16px; border-bottom:1px solid var(--border); }
.sett-grp-title { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; color:var(--text3); margin-bottom:8px; padding:0 4px; }
.sett-row { display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:12px; cursor:pointer; transition:background .15s; }
.sett-row:hover { background:var(--surface); }
.sett-ico { width:34px; height:34px; border-radius:10px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.sett-ico.blue { background:rgba(79,142,247,0.15); color:var(--accent); }
.sett-ico.green { background:var(--green-dim); color:var(--green); }
.sett-ico.red { background:var(--red-dim); color:var(--red); }
.sett-ico.yellow { background:rgba(255,209,102,0.12); color:var(--yellow); }
.sett-ico.purple { background:rgba(160,110,247,0.12); color:#a06ef7; }
.sett-row-body { flex:1; min-width:0; }
.sett-row-label { font-size:14px; font-weight:500; }
.sett-row-sub { font-size:12px; color:var(--text2); margin-top:2px; }
.sett-row-arrow { color:var(--text3); display:flex; align-items:center; }
.sett-edit-form { padding:16px; border-bottom:1px solid var(--border); display:none; }
.sett-edit-form.on { display:block; }
.sett-inp { width:100%; padding:10px 14px; background:var(--surface); border:1px solid var(--border); border-radius:11px; color:var(--text); font-family:inherit; font-size:14px; outline:none; margin-bottom:10px; transition:border-color .2s; }
.sett-inp:focus { border-color:var(--accent); }
.sett-ta { width:100%; padding:10px 14px; background:var(--surface); border:1px solid var(--border); border-radius:11px; color:var(--text); font-family:inherit; font-size:14px; outline:none; resize:none; height:80px; margin-bottom:10px; transition:border-color .2s; }
.sett-ta:focus { border-color:var(--accent); }
.btn-row { display:flex; gap:8px; }
.btn-prim { flex:1; padding:10px; background:var(--accent); border:none; border-radius:10px; color:#fff; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; transition:all .2s; }
.btn-prim:hover { background:var(--accent-hover); }
.btn-sec { flex:1; padding:10px; background:var(--surface); border:1px solid var(--border); border-radius:10px; color:var(--text2); font-size:13px; font-weight:500; cursor:pointer; font-family:inherit; transition:all .2s; }
.btn-sec:hover { background:var(--surface2); color:var(--text); }
.btn-danger { width:100%; padding:11px; background:var(--red-dim); border:1px solid rgba(255,82,82,0.2); border-radius:10px; color:var(--red); font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; transition:all .2s; display:flex; align-items:center; justify-content:center; gap:8px; }
.btn-danger:hover { background:rgba(255,82,82,0.2); }
/* Toggle switch */
.sett-toggle { position:relative; display:inline-block; width:42px; height:24px; flex-shrink:0; }
.sett-toggle input { opacity:0; width:0; height:0; }
.sett-toggle-slider { position:absolute; inset:0; background:var(--border2); border-radius:12px; cursor:pointer; transition:background .2s; }
.sett-toggle-slider:before { content:''; position:absolute; width:18px; height:18px; left:3px; top:3px; background:#fff; border-radius:50%; transition:transform .2s; }
.sett-toggle input:checked + .sett-toggle-slider { background:var(--accent); }
.sett-toggle input:checked + .sett-toggle-slider:before { transform:translateX(18px); }
/* Privacy select */
.priv-sel { background:var(--surface); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:inherit; font-size:12px; padding:4px 8px; outline:none; cursor:pointer; }

/* ─── PROFILE MODAL ─── */
.pm-over { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:400; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.pm-over.on { display:flex; }
.pm-card { background:var(--sidebar); border:1px solid var(--border); border-radius:22px; width:340px; overflow:hidden; box-shadow:0 24px 60px rgba(0,0,0,0.3); }
.pm-banner { height:90px; position:relative; overflow:visible; }
.pm-banner-grad { position:absolute; inset:0; background:linear-gradient(135deg,var(--accent) 0%,#7c4dff 100%); border-radius:22px 22px 0 0; }
.pm-body { padding:0 20px 20px; position:relative; z-index:2; }
.pm-av-row { display:flex; align-items:flex-end; justify-content:space-between; margin-top:-36px; margin-bottom:12px; position:relative; z-index:3; }
.pm-av { width:72px; height:72px; border-radius:50%; border:3px solid var(--sidebar); display:flex; align-items:center; justify-content:center; font-size:26px; font-weight:700; overflow:hidden; position:relative; z-index:4; flex-shrink:0; }
.pm-av img { width:100%; height:100%; object-fit:cover; display:block; border-radius:50%; }
.pm-status { font-size:12px; font-weight:500; }
.pm-status.on { color:var(--green); }
.pm-status.off { color:var(--text2); }
.pm-name { font-size:20px; font-weight:700; }
.pm-handle { font-size:13px; color:var(--text2); margin:3px 0 10px; }
.pm-bio { font-size:13px; color:var(--text2); line-height:1.55; margin-bottom:16px; }
.pm-btns { display:flex; gap:8px; }
.pm-joined { font-size:11px; color:var(--text3); margin-bottom:14px; display:flex; align-items:center; gap:5px; }
.pm-joined svg { flex-shrink:0; }
.pm-btn { flex:1; padding:9px 8px; border-radius:12px; border:none; cursor:pointer; font-size:13px; font-weight:600; font-family:inherit; transition:all .2s; display:flex; align-items:center; justify-content:center; gap:6px; }
.pm-btn.prim { background:var(--accent); color:#fff; }
.pm-btn.prim:hover { background:var(--accent-hover); }
.pm-btn.sec { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
.pm-btn.sec:hover { background:var(--surface); }

/* ─── MODAL OVERLAY (generic) ─── */
.modal-over { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:450; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.modal-over.on { display:flex; }
.modal-card { background:var(--sidebar); border:1px solid var(--border); border-radius:20px; width:360px; overflow:hidden; box-shadow:0 24px 60px rgba(0,0,0,0.3); }
.modal-hd { display:flex; align-items:center; gap:10px; padding:16px 20px; border-bottom:1px solid var(--border); }
.modal-hd h3 { font-size:16px; font-weight:700; flex:1; }
.modal-body { padding:16px 20px 20px; }
.modal-msg { font-size:13px; color:var(--text2); margin-bottom:14px; line-height:1.6; }
.sett-err { color:var(--red); font-size:12px; min-height:16px; margin-bottom:10px; }
.sett-ok { color:var(--green); font-size:12px; min-height:16px; margin-bottom:10px; }

/* ─── CALL MODAL ─── */
.call-over { display:none; position:fixed; inset:0; background:rgba(10,12,18,0.92); z-index:500; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(12px); }
.call-over.on { display:flex; }
.call-card { background:var(--sidebar); border:1px solid var(--border); border-radius:28px; padding:36px 44px; text-align:center; min-width:300px; box-shadow:0 32px 80px rgba(0,0,0,0.4); }
.call-av { width:88px; height:88px; border-radius:26px; display:flex; align-items:center; justify-content:center; font-size:34px; font-weight:700; margin:0 auto 16px; overflow:hidden; border:2px solid var(--border); }
.call-av img { width:100%; height:100%; object-fit:cover; }
.call-name { font-size:22px; font-weight:700; margin-bottom:6px; }
.call-st { color:var(--text2); font-size:13px; margin-bottom:28px; display:flex; align-items:center; justify-content:center; gap:6px; }
.call-timer { font-size:36px; font-weight:700; letter-spacing:2px; margin-bottom:6px; font-variant-numeric:tabular-nums; }
.call-btns { display:flex; gap:14px; justify-content:center; flex-wrap:wrap; }
.call-btn-wrap { display:flex; flex-direction:column; align-items:center; gap:6px; }
.call-btn-wrap span { font-size:11px; color:var(--text2); }
.cbtn { width:58px; height:58px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s; }
.cbtn:hover { transform:scale(1.06); }
.cbtn.accept { background:#1db954; color:#fff; }
.cbtn.decline { background:var(--red); color:#fff; }
.cbtn.end-call { background:var(--red); color:#fff; }
.cbtn.neutral { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
.cbtn.neutral.muted { background:var(--accent-dim); color:var(--accent); border-color:var(--accent); }
.vid-area { display:none; width:100%; max-width:560px; margin-bottom:20px; border-radius:16px; overflow:hidden; background:#000; position:relative; }
.vid-area.on { display:block; }
#remoteVideo { width:100%; max-height:280px; object-fit:cover; background:#111; display:block; }
#localVideo { position:absolute; bottom:8px; right:8px; width:96px; height:72px; border-radius:10px; object-fit:cover; border:2px solid var(--accent); background:#222; }

/* ─── LIGHTBOX ─── */
.lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:600; align-items:center; justify-content:center; cursor:zoom-out; }
.lightbox.on { display:flex; }
.lightbox img { max-width:92vw; max-height:92vh; border-radius:10px; }

/* ─── TOAST ─── */
.toast { position:fixed; bottom:20px; right:20px; background:var(--surface2); border:1px solid var(--border); border-radius:16px; padding:12px 14px; z-index:700; transform:translateX(120%); opacity:0; transition:all .3s cubic-bezier(.4,0,.2,1); display:flex; align-items:center; gap:10px; max-width:320px; cursor:pointer; box-shadow:var(--shadow); }
.toast.on { transform:translateX(0); opacity:1; }
.toast-av { width:38px; height:38px; border-radius:11px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:13px; overflow:hidden; }
.toast-av img { width:100%; height:100%; object-fit:cover; }
.t-name { font-weight:600; font-size:13px; }
.t-text { color:var(--text2); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* ─── RING ANIMATION ─── */
@keyframes ring {0%{transform:scale(1)}25%{transform:scale(1.08)}50%{transform:scale(1)}75%{transform:scale(1.04)}100%{transform:scale(1)}}
.call-av.ringing { animation:ring 1s infinite; }

/* Mobile */

@media(max-width:640px){
  .sidebar{width:100%!important;max-width:100%!important;}
  .chat-area{display:none;}
  .chat-area.mob{display:flex!important;position:fixed;inset:0;z-index:50;width:100%;height:100%;}
  .back-btn{display:flex!important;}
  .sett-panel{width:100%;right:-100%;}
  .sett-body{padding-bottom:160px !important; overflow-y:auto !important; -webkit-overflow-scrolling:touch !important;}
  .sett-panel{overflow:hidden !important;}
  #app.on{width:100%;overflow-x:hidden;}
  /* ── Mobile image fix ── */
  .mrow.out,.mrow.in{max-width:88%;}
  .bbl-img{max-width:calc(100vw - 110px)!important;max-height:320px!important;width:100%!important;object-fit:cover!important;}
  .bubble{max-width:100%;overflow:hidden;}
  /* Image bubbles: no side padding so image fills edge-to-edge */
  .bubble:has(.bbl-img){padding:4px 4px 0 4px;}
  .bubble:has(.bbl-img) .bbl-meta{padding:2px 6px 4px;margin-top:0;}
}
.back-btn{display:none;}

/* ─── VIDEO NOTE MODAL ─── */
.vnote-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:900;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);}
.vnote-card{background:var(--sidebar);border:1px solid var(--border);border-radius:28px;padding:22px 24px 28px;text-align:center;width:270px;box-shadow:0 32px 80px rgba(0,0,0,.5);animation:vnSlide .25s cubic-bezier(.4,0,.2,1);}
@keyframes vnSlide{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.vnote-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.vnote-hd-title{font-size:15px;font-weight:700;}
.vnote-hd-close{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:none;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.vnote-hd-close:hover{background:var(--surface);color:var(--text);}
.vnote-circ-wrap{display:flex;justify-content:center;margin-bottom:12px;}
.vnote-circ{width:180px;height:180px;border-radius:50%;overflow:hidden;position:relative;background:#000;border:3px solid var(--border);}
.vnote-circ video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
.vnote-dot{position:absolute;top:10px;right:10px;width:10px;height:10px;border-radius:50%;background:#f33;animation:vndot 1s infinite;z-index:2;display:none;}
@keyframes vndot{0%,100%{opacity:1}50%{opacity:0}}
.vnote-ring-wrap{position:absolute;inset:0;z-index:1;pointer-events:none;}
.vnote-ring-svg{width:100%;height:100%;transform:rotate(-90deg);}
.vnote-ring-bg{fill:none;stroke:rgba(255,255,255,.1);stroke-width:5;}
.vnote-ring-prog{fill:none;stroke:var(--accent);stroke-width:5;stroke-linecap:round;stroke-dasharray:339.3;stroke-dashoffset:339.3;transition:stroke-dashoffset .4s linear;}
.vnote-time{font-size:24px;font-weight:700;letter-spacing:2px;font-variant-numeric:tabular-nums;margin-bottom:18px;}
.vnote-btns{display:flex;gap:14px;justify-content:center;align-items:center;margin-bottom:10px;}
.vnote-rec-btn{width:62px;height:62px;border-radius:50%;background:#e53;border:3px solid rgba(255,255,255,.25);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;animation:vnPulse 2s infinite;}
@keyframes vnPulse{0%,100%{box-shadow:0 0 0 0 rgba(238,85,51,.5)}50%{box-shadow:0 0 0 10px rgba(238,85,51,0)}}
.vnote-rec-btn:hover{transform:scale(1.06);}
.vnote-stop-btn{width:50px;height:50px;border-radius:50%;background:var(--red);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.vnote-send-btn{width:50px;height:50px;border-radius:50%;background:var(--accent);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.vnote-stop-btn:hover,.vnote-send-btn:hover{transform:scale(1.06);}
.vnote-hint{font-size:11px;color:var(--text3);}
/* ─── VIDEO NOTE BUBBLE ─── */
.vnbbl{position:relative;display:inline-block;cursor:pointer;width:180px;height:180px;}
.vnbbl video{width:180px;height:180px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);display:block;}
.vnbbl-play{position:absolute;inset:0;border-radius:50%;background:rgba(0,0,0,.32);display:flex;align-items:center;justify-content:center;transition:background .15s;}
.vnbbl:hover .vnbbl-play{background:rgba(0,0,0,.12);}
.vnbbl-dur{position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.6);color:#fff;font-size:10px;font-weight:600;padding:2px 6px;border-radius:8px;}
/* ─── CALL EVENT BUBBLE ─── */
.call-ev-bbl{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface);border-radius:16px;border:1px solid var(--border);min-width:170px;max-width:260px;}
.call-ev-ico{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.call-ev-ico.ended{background:var(--accent-dim);color:var(--accent);}
.call-ev-ico.missed{background:var(--red-dim);color:var(--red);}
.call-ev-label{font-size:13px;font-weight:600;}
.call-ev-sub{font-size:11px;color:var(--text2);margin-top:2px;}

/* ─── MIDNIGHT THEME ─── */
[data-theme="midnight"] {
  --bg:#090b12;--sidebar:#0e1020;--surface:#131628;--surface2:#181b30;
  --border:#232640;--border2:#2e3254;--accent:#7c4dff;--accent-dim:rgba(124,77,255,0.18);
  --accent-hover:#9c6dff;--green:#00e5a0;--green-dim:rgba(0,229,160,0.12);
  --red:#ff4f7a;--red-dim:rgba(255,79,122,0.12);--yellow:#ffd166;
  --text:#dde0f5;--text2:#6e729a;--text3:#3e4268;
  --bubble-out:#231458;--bubble-in:#131628;--shadow:0 8px 32px rgba(0,0,0,0.6);
}
/* ─── FOREST THEME ─── */
[data-theme="forest"] {
  --bg:#0c120e;--sidebar:#121a14;--surface:#172019;--surface2:#1c2a1e;
  --border:#243028;--border2:#2e3e32;--accent:#34d058;--accent-dim:rgba(52,208,88,0.15);
  --accent-hover:#50e070;--green:#34d058;--green-dim:rgba(52,208,88,0.12);
  --red:#ff6b6b;--red-dim:rgba(255,107,107,0.12);--yellow:#f9c74f;
  --text:#d8eed9;--text2:#6a8c6e;--text3:#3a5040;
  --bubble-out:#1a3d22;--bubble-in:#172019;--shadow:0 8px 32px rgba(0,0,0,0.5);
}
/* ─── FLOATING MINI CALL BAR ─── */
.mini-call-bar {
  position:fixed;top:16px;left:50%;transform:translateX(-50%);
  background:var(--sidebar);border:1px solid var(--border);
  border-radius:50px;padding:8px 12px 8px 10px;
  display:flex;align-items:center;gap:8px;
  box-shadow:0 8px 32px rgba(0,0,0,0.4);
  z-index:999;cursor:pointer;min-width:220px;
  animation:mcbSlide .3s cubic-bezier(.4,0,.2,1);
}
@keyframes mcbSlide{from{opacity:0;transform:translateX(-50%) translateY(-16px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.mini-call-pulse{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;animation:pulseGrn 1.4s infinite;}
@keyframes pulseGrn{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.4)}}
.mini-call-av{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;overflow:hidden;flex-shrink:0;}
.mini-call-av img{width:100%;height:100%;object-fit:cover;}
.mini-call-info{flex:1;min-width:0;}
.mini-call-name{font-weight:600;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mini-call-timer{font-size:11px;color:var(--green);font-weight:500;}
.mini-call-end{width:30px;height:30px;border-radius:50%;background:var(--red);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.mini-call-end:hover{background:#ff2222;transform:scale(1.1);}
.mini-call-restore{width:26px;height:26px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;}
.mini-call-restore:hover{color:var(--text);background:var(--surface);}
/* ─── IN-CALL SIDEBAR STATUS ─── */
.sb-call-status{margin:0 6px 6px;padding:9px 12px;background:rgba(52,208,88,0.1);border:1px solid rgba(52,208,88,0.25);border-radius:12px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:background .2s;}
.sb-call-status:hover{background:rgba(52,208,88,0.18);}
.sb-call-status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulseGrn 1.4s infinite;flex-shrink:0;}
.sb-call-status-info{flex:1;min-width:0;}
.sb-call-status-label{font-size:10px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.8px;}
.sb-call-status-name{font-size:12px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sb-call-status-end{border:none;background:none;color:var(--red);cursor:pointer;padding:3px;border-radius:6px;display:flex;align-items:center;}
/* ─── CALL OVERLAY MINIMIZE BTN ─── */
.call-minimize-btn{position:absolute;top:10px;right:10px;width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,0.12);border:none;color:rgba(255,255,255,0.7);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;z-index:2;}
.call-minimize-btn:hover{background:rgba(255,255,255,0.25);color:#fff;}
.call-card{position:relative;}
/* ─── THEME CHOOSER PANEL ─── */
.theme-panel{display:none;padding:12px 16px 16px;background:var(--surface);border-radius:12px;margin:0 16px 8px;border:1px solid var(--border);}
.theme-panel.on{display:block;}
.theme-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.theme-chip{padding:8px 4px;border-radius:10px;border:2px solid var(--border);cursor:pointer;text-align:center;transition:all .2s;background:var(--surface2);font-size:11px;font-weight:600;color:var(--text2);}
.theme-chip:hover{border-color:var(--accent);color:var(--text);}
.theme-chip.active{border-color:var(--accent);background:var(--accent-dim);color:var(--accent);}
.theme-chip-prev{height:24px;border-radius:6px;margin-bottom:5px;display:flex;overflow:hidden;}
.theme-chip-prev span{flex:1;}
/* ─── WALLPAPER ─── */
.wall-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.wall-item{aspect-ratio:16/10;border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s;overflow:hidden;}
.wall-item:hover{transform:scale(1.04);border-color:var(--accent);}
.wall-item.active{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim);}
.wall-item-none{background:var(--surface2);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:4px;color:var(--text3);font-size:10px;font-weight:600;}
.wall-item img{width:100%;height:100%;object-fit:cover;}
.msgs.has-wall{background-size:cover;background-position:center;background-attachment:local;}
.msgs.has-wall .bubble{box-shadow:0 1px 4px rgba(0,0,0,0.2);}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-brand">
      <div class="auth-brand-icon">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </div>
      <div class="auth-brand-text"><h1>Freedom</h1><p>Мессенджер без границ</p></div>
    </div>
    <div class="auth-seg">
      <button class="auth-seg-btn active" onclick="authTab('login')">Войти</button>
      <button class="auth-seg-btn" onclick="authTab('reg')">Регистрация</button>
    </div>
    <div id="lf">
      <div class="field">
        <div class="field-label"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Имя пользователя</div>
        <div class="field-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <input type="text" id="lu" placeholder="username" autocomplete="username">
      </div>
      <div class="field">
        <div class="field-label"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Пароль</div>
        <div class="field-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
        <input type="password" id="lp" placeholder="••••••••" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="auth-btn" onclick="doLogin()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
        Войти
      </button>
      <div class="auth-err" id="le"></div>
    </div>
    <div id="rf" style="display:none">
      <div class="field">
        <div class="field-label">Отображаемое имя</div>
        <div class="field-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <input type="text" id="rn" placeholder="Ваше имя">
      </div>
      <div class="field">
        <div class="field-label">Логин</div>
        <div class="field-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8.56 2.75c4.37 6.03 6.02 9.42 8.03 17.72m2.54-15.38c-3.72 4.35-8.94 5.66-16.88 5.85m19.5 1.9c-3.5-.93-6.63-.82-8.94 0-2.58.92-5.01 2.86-7.44 6.32"/></svg></div>
        <input type="text" id="ru" placeholder="username (мин. 3 символа, a-z 0-9 _)">
      </div>
      <div class="field">
        <div class="field-label">Пароль</div>
        <div class="field-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
        <input type="password" id="rp" placeholder="••••••••" onkeydown="if(event.key==='Enter')doReg()">
      </div>
      <button class="auth-btn" onclick="doReg()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
        Создать аккаунт
      </button>
      <div class="auth-err" id="re"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sb-head">
      <div class="me-av" id="me-av" onclick="showMyProfile()" title="Мой профиль"></div>
      <div class="me-nm" id="me-nm" onclick="showMyProfile()" title="Мой профиль"></div>
      <div class="sb-acts">
        <button class="ib" title="Новый чат" onclick="goPeople()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
        <button class="ib" title="Настройки" onclick="openSett()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
      </div>
    </div>
    <div class="sb-search">
      <div class="srch-wrap">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="srch-inp" id="srch-inp" placeholder="Поиск по имени или @username..." oninput="filterList(this.value)">
      </div>
    </div>
    <div class="sb-tabs">
      <button class="sb-tab active" id="tab-c" onclick="switchTab('chats',this)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Чаты
      </button>
      <button class="sb-tab" id="tab-p" onclick="switchTab('people',this)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Люди
      </button>
    </div>
    <div class="chat-list" id="clist"></div>
    <div class="sb-call-status" id="sb-call-status" style="display:none" onclick="restoreCallOverlay()">
      <div class="sb-call-status-dot"></div>
      <div class="sb-call-status-info">
        <div class="sb-call-status-label">В звонке</div>
        <div class="sb-call-status-name" id="sb-call-status-name"></div>
      </div>
      <button class="sb-call-status-end" onclick="event.stopPropagation();endCall()" title="Завершить">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1-9.4 0-17-7.6-17-17 0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z" transform="rotate(135,12,12)"/></svg>
      </button>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area" id="chat-area">
    <div id="no-chat" class="no-chat">
      <div class="no-chat-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
      <h3>Freedom Messenger</h3>
      <p>Выберите чат или найдите собеседника</p>
    </div>
    <div id="chat-view" style="display:none;flex-direction:column;height:100%">
      <div class="chat-hd">
        <button class="ib back-btn" onclick="closeMob()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
        </button>
        <div class="ch-av" id="ch-av" onclick="showPM(currentChat)"></div>
        <div class="ch-info" onclick="showPM(currentChat)">
          <div class="ch-name" id="ch-name"></div>
          <div class="ch-status" id="ch-status"></div>
        </div>
        <div class="ch-acts">
          <button class="ib" title="Аудиозвонок" onclick="startCall('audio')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.61 3.4 2 2 0 0 1 3.6 1.22h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L7.91 8.8a16 16 0 0 0 6 6l.94-.94a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 21.5 16c.02.32.02.64 0 .96"/></svg>
          </button>
          <button class="ib" title="Видеозвонок" onclick="startCall('video')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </button>
          <button class="ib" title="Профиль" onclick="showPM(currentChat)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
          </button>
        </div>
      </div>
      <div class="msgs" id="msgs" oncontextmenu="return false"></div>
      <div class="ibar">
        <div class="reply-strip" id="rs">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5" style="flex-shrink:0"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg>
          <div class="rs-info"><div class="rs-nm" id="rs-nm"></div><div class="rs-tx" id="rs-tx"></div></div>
          <button class="rs-x" onclick="cancelReply()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="img-strip" id="is"><img id="ithumb"><button class="img-strip-rm" onclick="rmImg()"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
        <div class="irow">
          <button class="iab" title="Прикрепить фото" onclick="document.getElementById('fi').click()">
            <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
          </button>
          <input type="file" id="fi" accept="image/*" style="display:none" onchange="handleImg(event)">
          <div class="iwrap">
            <textarea class="msg-inp" id="mi" placeholder="Написать сообщение..." rows="1" oninput="resize(this);onType()" onkeydown="mkey(event)"></textarea>
            <button class="emoji-trigger" onclick="toggleEmoji()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
            </button>
            <div class="emoji-picker" id="ep"></div>
          </div>
          <button class="mic-btn" id="mic-btn" onclick="toggleRec()" title="Голосовое сообщение">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
          </button>
          <button class="mic-btn" id="vnote-btn" onclick="openVideoNote()" title="Видео-кружок" style="color:var(--accent)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8" fill="currentColor" stroke="none"/></svg>
          </button>
          <button class="send-btn" onclick="sendMsg()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div class="sett-panel" id="sp">
  <div class="sett-hd">
    <button class="ib" onclick="closeSett()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5"/><path d="M12 5l-7 7 7 7"/></svg></button>
    <h2>Настройки</h2>
  </div>
  <div class="sett-body">
    <div class="sett-profile">
      <div class="sett-av-wrap" onclick="document.getElementById('avi').click()">
        <div class="sett-av" id="sett-av"></div>
        <div class="sett-av-badge"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
      </div>
      <input type="file" id="avi" accept="image/*" style="display:none" onchange="chgAv(event)">
      <div class="sett-uname" id="sett-un"></div>
      <div class="sett-handle" id="sett-hn"></div>
    </div>

    <div class="sett-grp">
      <div class="sett-grp-title">Аккаунт</div>
      <div class="sett-row" onclick="showMyProfile();closeSett()">
        <div class="sett-ico" style="background:var(--accent-dim);color:var(--accent)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Мой профиль</div><div class="sett-row-sub">Посмотреть свой профиль</div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
      <div class="sett-row" onclick="toggleEdit()">
        <div class="sett-ico blue"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Редактировать профиль</div><div class="sett-row-sub" id="sett-nm-sub"></div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
      <div class="sett-row" onclick="openChangePwd()">
        <div class="sett-ico red"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Сменить пароль</div><div class="sett-row-sub">Рекомендуется регулярно</div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
    </div>

    <div class="sett-edit-form" id="sef">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:12px">Редактирование профиля</div>
      <input class="sett-inp" id="en" placeholder="Отображаемое имя">
      <textarea class="sett-ta" id="eb" placeholder="Расскажите о себе..."></textarea>
      <div class="btn-row">
        <button class="btn-prim" onclick="saveProf()">Сохранить</button>
        <button class="btn-sec" onclick="toggleEdit()">Отмена</button>
      </div>
    </div>

    <div class="sett-grp">
      <div class="sett-grp-title">Приватность</div>
      <div class="sett-row">
        <div class="sett-ico green"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Последний визит</div><div class="sett-row-sub">Кто видит время посещения</div></div>
        <select class="priv-sel" id="priv-ls" onchange="savePriv('lastSeen',this.value)">
          <option value="everyone">Все</option>
          <option value="nobody">Никто</option>
        </select>
      </div>
      <div class="sett-row">
        <div class="sett-ico blue"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Фото профиля</div><div class="sett-row-sub">Кто видит ваш аватар</div></div>
        <select class="priv-sel" id="priv-pp" onchange="savePriv('profilePhoto',this.value)">
          <option value="everyone">Все</option>
          <option value="nobody">Никто</option>
        </select>
      </div>
      <div class="sett-row">
        <div class="sett-ico green"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Статус онлайн</div><div class="sett-row-sub">Кто видит что вы онлайн</div></div>
        <select class="priv-sel" id="priv-on" onchange="savePriv('online',this.value)">
          <option value="everyone">Все</option>
          <option value="nobody">Никто</option>
        </select>
      </div>
    </div>

    <div class="sett-grp">
      <div class="sett-grp-title">Внешний вид</div>
      <div class="sett-row" onclick="toggleThemePanel()">
        <div class="sett-ico yellow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="theme-ico"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Тема оформления</div><div class="sett-row-sub" id="theme-sub">Тёмная</div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
    </div>
    <div class="theme-panel" id="theme-panel">
      <div class="theme-grid">
        <div class="theme-chip" id="tc-dark" onclick="applyTheme('dark')"><div class="theme-chip-prev"><span style="background:#0d0f14"></span><span style="background:#13151c"></span><span style="background:#4f8ef7"></span></div>Тёмная</div>
        <div class="theme-chip" id="tc-light" onclick="applyTheme('light')"><div class="theme-chip-prev"><span style="background:#f0f2f8"></span><span style="background:#ffffff"></span><span style="background:#4f8ef7"></span></div>Светлая</div>
        <div class="theme-chip" id="tc-midnight" onclick="applyTheme('midnight')"><div class="theme-chip-prev"><span style="background:#090b12"></span><span style="background:#0e1020"></span><span style="background:#7c4dff"></span></div>Полночь</div>
        <div class="theme-chip" id="tc-forest" onclick="applyTheme('forest')"><div class="theme-chip-prev"><span style="background:#0c120e"></span><span style="background:#121a14"></span><span style="background:#34d058"></span></div>Лес</div>
      </div>
    </div>
    <div class="sett-grp">
      <div class="sett-row" onclick="openWallModal()">
        <div class="sett-ico purple"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Фон чата</div><div class="sett-row-sub" id="wall-sub">Без фона</div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
      <div class="sett-row" style="cursor:default">
        <div class="sett-ico purple"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Уведомления</div><div class="sett-row-sub" id="notif-sub">Выключены</div></div>
        <label class="sett-toggle" onclick="event.stopPropagation()">
          <input type="checkbox" id="notif-chk" onchange="toggleNotif(this.checked)">
          <span class="sett-toggle-slider"></span>
        </label>
      </div>
    </div>

    <div class="sett-grp">
      <button class="btn-danger" onclick="doLogout()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Выйти из аккаунта
      </button>
    </div>
  </div>
</div>

<!-- CHANGE PASSWORD MODAL -->
<div class="modal-over" id="pwd-modal" onclick="if(event.target===this)closePwdModal()">
  <div class="modal-card">
    <div class="modal-hd">
      <div style="width:32px;height:32px;border-radius:10px;background:var(--red-dim);color:var(--red);display:flex;align-items:center;justify-content:center;">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      </div>
      <h3>Сменить пароль</h3>
      <button class="ib" onclick="closePwdModal()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body">
      <div class="sett-err" id="pwd-err"></div>
      <div class="sett-ok" id="pwd-ok"></div>
      <input class="sett-inp" type="password" id="pwd-old" placeholder="Текущий пароль">
      <input class="sett-inp" type="password" id="pwd-new" placeholder="Новый пароль (мин. 6 символов)">
      <input class="sett-inp" type="password" id="pwd-new2" placeholder="Повторите новый пароль" style="margin-bottom:16px" onkeydown="if(event.key==='Enter')submitPwd()">
      <div class="btn-row">
        <button class="btn-prim" onclick="submitPwd()">Сохранить</button>
        <button class="btn-sec" onclick="closePwdModal()">Отмена</button>
      </div>
    </div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="pm-over" id="pmo" onclick="if(event.target===this)closePM()">
  <div class="pm-card">
    <div class="pm-banner">
      <div class="pm-banner-grad"></div>
      <button class="ib" onclick="closePM()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.4)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="pm-body">
      <div class="pm-av-row">
        <div class="pm-av" id="pmav"></div>
        <div class="pm-status" id="pmst"></div>
      </div>
      <div class="pm-name" id="pmnm"></div>
      <div class="pm-handle" id="pmhn"></div>
      <div class="pm-bio" id="pmbio"></div>
      <div class="pm-joined" id="pm-joined"></div>
      <div class="pm-btns" id="pm-btns">
        <button class="pm-btn prim" onclick="chatFromPM()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Написать</button>
        <button class="pm-btn sec" onclick="callFromPM('audio')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.61 3.4 2 2 0 0 1 3.6 1.22h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L7.91 8.8a16 16 0 0 0 6 6l.94-.94a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 21.5 16c.02.32.02.64 0 .96"/></svg>Звонок</button>
        <button class="pm-btn sec" onclick="callFromPM('video')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>Видео</button>
      </div>
    </div>
  </div>
</div>

<!-- CALL MODAL -->
<div class="call-over" id="co">
  <div class="vid-area" id="va">
    <video id="remoteVideo" autoplay playsinline style="display:none"></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>
  <div class="call-card">
    <button class="call-minimize-btn" onclick="minimizeCallOverlay()" title="Свернуть">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 9l-7 7-7-7"/></svg>
    </button>
    <div class="call-av" id="cav"></div>
    <div class="call-name" id="cnm"></div>
    <div class="call-st" id="cst"></div>
    <div class="call-timer" id="ctmr" style="display:none"></div>
    <div class="call-btns" id="cbtns"></div>
  </div>
</div>

<!-- MINI CALL BAR -->
<div class="mini-call-bar" id="mini-call-bar" style="display:none" onclick="restoreCallOverlay()">
  <div class="mini-call-pulse"></div>
  <div class="mini-call-av" id="mini-call-av"></div>
  <div class="mini-call-info">
    <div class="mini-call-name" id="mini-call-name">В звонке</div>
    <div class="mini-call-timer" id="mini-call-timer">0:00</div>
  </div>
  <button class="mini-call-end" onclick="event.stopPropagation();endCall()" title="Завершить">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1-9.4 0-17-7.6-17-17 0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z" transform="rotate(135,12,12)"/></svg>
  </button>
  <button class="mini-call-restore" onclick="event.stopPropagation();restoreCallOverlay()" title="Развернуть">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 15l7-7 7 7"/></svg>
  </button>
</div>

<!-- WALLPAPER MODAL -->
<div class="modal-over" id="wall-modal" onclick="if(event.target===this)closeWallModal()" style="display:none">
  <div class="modal-card" style="width:500px;max-width:95vw">
    <div class="modal-hd">
      <div style="width:32px;height:32px;border-radius:10px;background:rgba(160,110,247,0.15);color:#a06ef7;display:flex;align-items:center;justify-content:center;flex-shrink:0">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      </div>
      <h3>Фон чата</h3>
      <button class="ib" onclick="closeWallModal()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);margin-bottom:12px">Готовые фоны</div>
      <div class="wall-grid" id="wall-grid"></div>
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
        <div style="display:flex;gap:10px">
          <button class="btn-prim" style="flex:1" onclick="document.getElementById('wall-file-inp').click()">Загрузить фото</button>
          <button class="btn-sec" onclick="setWallpaper(null)">Убрать фон</button>
        </div>
        <input type="file" id="wall-file-inp" accept="image/*" style="display:none" onchange="handleWallFile(event)">
      </div>
    </div>
  </div>
</div>

<!-- VIDEO NOTE MODAL -->
<div id="vnote-overlay" class="vnote-overlay" style="display:none">
  <div class="vnote-card">
    <div class="vnote-hd">
      <span class="vnote-hd-title">Видео-кружок</span>
      <button class="vnote-hd-close" onclick="vnClose()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="vnote-circ-wrap">
      <div class="vnote-circ">
        <video id="vn-preview" autoplay muted playsinline></video>
        <div class="vnote-dot" id="vn-dot"></div>
        <div class="vnote-ring-wrap">
          <svg class="vnote-ring-svg" viewBox="0 0 120 120">
            <circle class="vnote-ring-bg" cx="60" cy="60" r="54"/>
            <circle class="vnote-ring-prog" id="vn-ring" cx="60" cy="60" r="54"/>
          </svg>
        </div>
      </div>
    </div>
    <div class="vnote-time" id="vn-time">0:00</div>
    <div class="vnote-btns">
      <button class="vnote-stop-btn" id="vn-cancel-btn" style="display:none;background:var(--surface2);color:var(--text2)" onclick="vnCancel()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      <button class="vnote-rec-btn" id="vn-rec-btn" onclick="vnStart()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="8"/></svg>
      </button>
      <button class="vnote-stop-btn" id="vn-stop-btn" style="display:none" onclick="vnStop()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="3"/></svg>
      </button>
      <button class="vnote-send-btn" id="vn-send-btn" style="display:none" onclick="vnSend()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
    <div class="vnote-hint" id="vn-hint">Нажмите ● чтобы начать запись</div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lb" onclick="this.classList.remove('on')"><img id="lbi"></div>

<!-- CONTEXT MENU -->
<div class="ctx" id="ctx">
  <div class="ctx-it" onclick="ctxReply()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg>Ответить</div>
  <div class="ctx-it" onclick="ctxCopy()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Копировать</div>
  <div class="ctx-it danger" id="ctx-del" onclick="ctxDel()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>Удалить</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast" onclick="openToast()">
  <div class="toast-av" id="tav"></div>
  <div><div class="t-name" id="tnm"></div><div class="t-text" id="ttx"></div></div>
</div>

<script>
// SVG snippets
var CHK = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;
var DBLCHK = `<svg width="16" height="12" viewBox="0 0 28 14" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="2 7 7 12 14 4"/><polyline points="14 7 19 12 26 4"/></svg>`;
var PLAY_ICO = `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>`;
var PAUSE_ICO = `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`;
var PHONE_ICO = `<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1-9.4 0-17-7.6-17-17 0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z"/></svg>`;
var EMOJIS = ['😀','😂','🥰','😍','🤔','😎','😭','😤','🥺','🤣','❤️','🔥','👍','👎','🎉','✨','💯','🙏','😊','🤗','😏','😅','🤦','🤷','💪','👀','🫡','🫂','💀','🤙','💬','✈️','🌟','🚀','🎮','🍕','🎵','🌈','🌙','⚡'];

// ─── Socket ───────────────────────────────────────────────────────────────────
function connectSocket() {
  socket = io();
  socket.on('new_message', onNewMessage);
  socket.on('user_online', u => updateUserStatus(u.username, true));
  socket.on('user_offline', u => updateUserStatus(u.username, false, u.lastSeen));
  socket.on('user_updated', onUserUpdated);
  socket.on('user_typing', onTyping);
  socket.on('messages_read', ({by}) => markMessagesRead(by));
  socket.on('message_deleted', ({msgId}) => removeMessageEl(msgId));
  socket.on('incoming_call', onIncomingCall);
  socket.on('call_answered', onCallAnswered);
  socket.on('ice_candidate', onIceCandidate);
  socket.on('call_ended', onCallEnded);
  socket.on('call_rejected', () => { showCallStatus('Отклонено', true); try{_injectCallMsg(currentCallUser,'missed');}catch(e){} });
  socket.on('call_busy', () => showCallStatus('Занято', true));
  // ФИКС #2: Восстановление сессии при переподключении
  socket.on('connect', () => {
    const savedSession = localStorage.getItem('userSession');
    if (savedSession && !me) {
      const session = JSON.parse(savedSession);
      socket.emit('restore_session', session, (res) => {
        if (res && res.user) {
          onLoggedIn(res.user);
        }
      });
    }
  });
}

// ─── Auth ─────────────────────────────────────────────────────────────────────
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (tab==='login'&&i===0)||(tab==='register'&&i===1)));
  document.getElementById('login-form').style.display = tab==='login'?'':'none';
  document.getElementById('register-form').style.display = tab==='register'?'':'none';
}

function doLogin() {
  const username = (document.getElementById('lu') || document.getElementById('login-username'))?.value.trim();
  const password = (document.getElementById('lp') || document.getElementById('login-password'))?.value;

  if (!username || !password) return setErr('le','Заполните все поля');

  socket.emit('login', {username, password}, res => {
    if (res.error) return setErr('le', res.error);
    localStorage.setItem('userSession', JSON.stringify({username, password}));
    onLoggedIn(res.user);
  });
}

function doRegister() {
  const displayName = (document.getElementById('rn') || document.getElementById('reg-displayname'))?.value.trim();
  const username = (document.getElementById('ru') || document.getElementById('reg-username'))?.value.trim();
  const password = (document.getElementById('rp') || document.getElementById('reg-password'))?.value;

  if (!displayName || !username || !password) return setErr('re','Заполните все поля');

  socket.emit('register', {username, password, displayName}, res => {
    if (res.error) return setErr('re', res.error);
    localStorage.setItem('userSession', JSON.stringify({username, password}));
    onLoggedIn(res.user);
  });
}

function onLoggedIn(user) {
  me = user;
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('on');
  updateMyUI();
  loadUsers();
  // ФИКС #11: Применение сохраненного фона
  applyChatBackground();
}

function doLogout() {
  socket.emit('logout');
  me = null; currentChat = null; allUsers = [];
  chatHistory = {}; unread = {}; chatPreviews = {};
  // ФИКС #2: Очистка сохраненной сессии
  localStorage.removeItem('userSession');
  document.getElementById('app').classList.remove('on');
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('chat-view').style.display = 'none';
  document.getElementById('no-chat').style.display = 'flex';
  closeSettings();
}

function setErr(id, msg) { 
  const el = document.getElementById(id);
  if (el) {
    el.textContent = msg; 
    setTimeout(()=>el.textContent='', 4000); 
  }
}

// ─── UI Updates ───────────────────────────────────────────────────────────────
function updateMyUI() {
  const name = me.displayName || me.username;
  document.getElementById('my-display-name').textContent = name;
  document.getElementById('my-avatar-text').textContent = initials(name);
  document.getElementById('settings-username').textContent = name;
  document.getElementById('settings-handle').textContent = '@' + me.username;
  document.getElementById('sett-display-name').textContent = name;
  document.getElementById('sett-bio').textContent = me.bio || 'Нет';
  document.getElementById('settings-avatar-text').textContent = initials(name);
  if (me.avatar) {
    setAvatarImg('my-avatar', me.avatar);
    setAvatarImg('settings-avatar', me.avatar);
  } else {
    const myAv = document.getElementById('my-avatar');
    const settAv = document.getElementById('settings-avatar');
    if (myAv) myAv.style.background = strColor(me.username);
    if (settAv) settAv.style.background = strColor(me.username);
  }
}

function initials(name) {
  return name.split(' ').slice(0,2).map(w=>w[0]?.toUpperCase()).join('') || '?';
}

function setAvatarEl(el, user) {
  if (!el) return;
  if (user.avatar) {
    el.innerHTML = `<img src="${user.avatar}" alt="">`;
  } else {
    el.innerHTML = `<span>${initials(user.displayName||user.username)}</span>`;
    el.style.background = strColor(user.username);
  }
}

function setAvatarImg(elId, src) {
  const el = document.getElementById(elId);
  if (!el) return;
  el.innerHTML = `<img src="${src}" alt="">`;
}

function strColor(str) {
  const colors = ['#2d7dd2','#7c4dff','#e91e8c','#00bcd4','#ff6b35','#4caf50','#ff9800','#9c27b0'];
  let h = 0; for (let c of str) h = (h*31 + c.charCodeAt(0)) % colors.length;
  return colors[h];
}

// ─── Users / Contacts ─────────────────────────────────────────────────────────
function loadUsers() {
  fetch('/api/users').then(r=>r.json()).then(users => {
    allUsers = users.filter(u => u.username !== me.username);
    renderChatList();
  });
}

function switchSidebarTab(tab, btn) {
  document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  if (tab === 'chats') renderChatList('chats');
  else renderChatList('people');
}

function renderChatList(mode = 'chats', filter = '') {
  const list = document.getElementById('chat-list');
  let html = '';

  if (mode === 'people') {
    const users = allUsers.filter(u => !filter || u.displayName.toLowerCase().includes(filter) || u.username.includes(filter));
    if (!users.length) { 
      list.innerHTML = `<div class="empty-state"><div class="empty-icon">👥</div><div>Пользователи не найдены</div></div>`; 
      return; 
    }
    html += `<div class="section-label">Все пользователи</div>`;
    users.forEach(u => {
      html += renderUserItem(u);
    });
  } else {
    // Show chats with recent messages first, then all contacts
    const chatsWithMsgs = allUsers.filter(u => chatPreviews[u.username]);
    const others = allUsers.filter(u => !chatPreviews[u.username]);
    const combined = [...chatsWithMsgs, ...others].filter(u => !filter || u.displayName.toLowerCase().includes(filter) || u.username.includes(filter));
    if (!combined.length) { 
      list.innerHTML = `<div class="empty-state"><div class="empty-icon">💬</div><div>Нет чатов<br><small style="color:var(--text3)">Перейди во вкладку «Люди»</small></div></div>`; 
      return; 
    }
    if (chatsWithMsgs.length) html += `<div class="section-label">Недавние</div>`;
    combined.forEach(u => html += renderUserItem(u, true));
  }
  list.innerHTML = html;
}

function renderUserItem(u, showPreview = false) {
  const preview = chatPreviews[u.username];
  const unreadCount = unread[u.username] || 0;
  const badge = unreadCount ? `<div class="unread-badge">${unreadCount}</div>` : '';
  const onlineDot = u.online ? `<div class="online-dot"></div>` : '';
  const avatarBg = strColor(u.username);
  const avatarContent = u.avatar ? `<img src="${u.avatar}" alt="">` : `<span>${initials(u.displayName||u.username)}</span>`;
  const time = preview ? formatTime(preview.timestamp) : '';
  const previewText = preview ? (preview.type === 'image' ? '📷 Фото' : preview.type === 'voice' ? '🎤 Голосовое' : escHtml(preview.content||'').slice(0,40)) : (u.online ? 'В сети' : '');
  const activeClass = currentChat === u.username ? 'active' : '';

  return `<div class="chat-item ${activeClass}" onclick="openChat('${u.username}')">
    <div class="chat-avatar" style="background:${avatarBg}">${avatarContent}${onlineDot}</div>
    <div class="chat-info">
      <div class="chat-name">${escHtml(u.displayName||u.username)}</div>
      <div class="chat-preview">${previewText}</div>
    </div>
    <div class="chat-meta">
      <div class="chat-time">${time}</div>
      ${badge}
    </div>
  </div>`;
}

function filterChats(val) {
  const tab = document.querySelector('.sidebar-tab.active').textContent;
  renderChatList(tab.includes('Люди') ? 'people' : 'chats', val.toLowerCase());
}

// ─── Chat ─────────────────────────────────────────────────────────────────────
function openChat(username) {
  currentChat = username;
  unread[username] = 0;
  const user = allUsers.find(u => u.username === username) || {username, displayName: username};

  // Update header
  const hdrAvatar = document.getElementById('chat-hdr-avatar');
  hdrAvatar.style.background = strColor(username);
  setAvatarEl(hdrAvatar, user);

  document.getElementById('chat-hdr-name').textContent = user.displayName || username;
  const statusEl = document.getElementById('chat-hdr-status');
  statusEl.textContent = user.online ? 'В сети' : 'Не в сети';
  statusEl.className = 'ch-status' + (user.online ? ' online' : '');

  document.getElementById('no-chat').style.display = 'none';
  document.getElementById('chat-view').style.display = 'flex';

  // Load messages
  socket.emit('get_messages', {with: username}, (msgs) => {
    chatHistory[username] = msgs || [];
    renderMessages();
    scrollToBottom();
    // Mark as read
    socket.emit('mark_read', {chatWith: username});
  });

  renderChatList();
  
  // Mobile: show chat area
  if (window.innerWidth <= 768) {
    document.querySelector('.chat-area').classList.add('active');
  }
}

function renderMessages() {
  if (!currentChat) return;
  const msgs = chatHistory[currentChat] || [];
  const container = document.getElementById('msgs');
  container.innerHTML = '';
  
  let lastDate = null;
  msgs.forEach(msg => {
    const msgDate = new Date(msg.timestamp).toLocaleDateString();
    if (msgDate !== lastDate) {
      const dateDiv = document.createElement('div');
      dateDiv.className = 'date-div';
      dateDiv.textContent = formatDate(msg.timestamp);
      container.appendChild(dateDiv);
      lastDate = msgDate;
    }
    container.appendChild(createMessageElement(msg));
  });
  
  // ФИКС #8: Добавляем индикатор печати
  const typingDiv = document.createElement('div');
  typingDiv.className = 'typing-row';
  typingDiv.id = 'typing-indicator';
  typingDiv.innerHTML = `<span class="typing-text">печатает</span><div class="tdots"><span></span><span></span><span></span></div>`;
  container.appendChild(typingDiv);
}

function createMessageElement(msg) {
  const isOut = msg.from === me.username;
  const user = isOut ? me : allUsers.find(u => u.username === msg.from) || {username: msg.from, displayName: msg.from};
  
  const row = document.createElement('div');
  row.className = `mrow ${isOut ? 'out' : 'in'}`;
  row.dataset.msgId = msg.id;
  
  // Avatar (only for incoming)
  if (!isOut) {
    const av = document.createElement('div');
    av.className = 'msg-av';
    av.style.background = strColor(user.username);
    if (user.avatar) {
      av.innerHTML = `<img src="${user.avatar}">`;
    } else {
      av.innerHTML = `<span>${initials(user.displayName||user.username)}</span>`;
    }
    row.appendChild(av);
  }
  
  // Bubble
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.oncontextmenu = (e) => {
    e.preventDefault();
    showContextMenu(e, msg);
  };
  
  // Reply
  if (msg.replyTo) {
    const replyMsg = (chatHistory[currentChat] || []).find(m => m.id === msg.replyTo);
    if (replyMsg) {
      const replyDiv = document.createElement('div');
      replyDiv.className = 'bbl-reply';
      replyDiv.innerHTML = `<div class="bbl-rname">${replyMsg.from === me.username ? 'Вы' : (allUsers.find(u=>u.username===replyMsg.from)?.displayName || replyMsg.from)}</div><div class="bbl-rtext">${escHtml(replyMsg.content || '').slice(0,50)}</div>`;
      bubble.appendChild(replyDiv);
    }
  }
  
  // Content
  if (msg.type === 'image') {
    const img = document.createElement('img');
    img.className = 'bbl-img';
    img.src = msg.content;
    img.onclick = () => showLightbox(msg.content);
    bubble.appendChild(img);
  } else if (msg.type === 'voice') {
    const voiceDiv = document.createElement('div');
    voiceDiv.className = 'voice-msg';
    voiceDiv.innerHTML = `
      <button class="voice-play" onclick="playVoiceMessage(this, '${msg.content}')">▶</button>
      <div class="voice-waves">${'<span style="height:8px"></span>'.repeat(20)}</div>
      <div class="voice-dur">${msg.duration || '0:00'}</div>
    `;
    bubble.appendChild(voiceDiv);
  } else {
    const text = document.createElement('div');
    text.className = 'bbl-text';
    text.textContent = msg.content;
    bubble.appendChild(text);
  }
  
  // Meta (time + read indicator)
  const meta = document.createElement('div');
  meta.className = 'bbl-meta';
  meta.innerHTML = formatTime(msg.timestamp);
  
  // ФИКС #4: Добавляем индикатор прочтения для исходящих сообщений
  if (isOut) {
    const readIcon = msg.read 
      ? '<svg class="msg-check read" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/><path d="M12 16.2L7.8 12l-1.4 1.4L12 19 24 7l-1.4-1.4L12 16.2z"/></svg>'
      : '<svg class="msg-check sent" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>';
    meta.innerHTML += readIcon;
  }
  
  bubble.appendChild(meta);
  row.appendChild(bubble);
  
  return row;
}

// ФИКС #5: Функция воспроизведения голосовых сообщений
function playVoiceMessage(btn, audioData) {
  // Останавливаем предыдущее аудио
  if (currentPlayingAudio) {
    currentPlayingAudio.pause();
    currentPlayingAudio.currentTime = 0;
    // Сбрасываем кнопку предыдущего аудио
    const prevBtn = document.querySelector('.voice-play.playing');
    if (prevBtn) {
      prevBtn.innerHTML = '▶';
      prevBtn.classList.remove('playing');
    }
  }
  
  const audio = new Audio(audioData);
  currentPlayingAudio = audio;
  
  btn.innerHTML = '⏸';
  btn.classList.add('playing');
  
  audio.play();
  
  audio.onended = () => {
    btn.innerHTML = '▶';
    btn.classList.remove('playing');
    currentPlayingAudio = null;
  };
  
  btn.onclick = () => {
    if (audio.paused) {
      audio.play();
      btn.innerHTML = '⏸';
    } else {
      audio.pause();
      btn.innerHTML = '▶';
    }
  };
}

// ─── Message Actions ──────────────────────────────────────────────────────────
function handleInputChange() {
  const input = document.getElementById('msg-input');
  const sendBtn = document.getElementById('send-btn');
  const micBtn = document.getElementById('mic-btn');
  
  const hasText = input.value.trim().length > 0;
  sendBtn.style.display = hasText ? 'flex' : 'none';
  micBtn.style.display = hasText ? 'none' : 'flex';
  
  // Auto-resize textarea
  input.style.height = 'auto';
  input.style.height = Math.min(input.scrollHeight, 120) + 'px';
  
  // ФИКС #8: Отправка индикатора печати
  if (currentChat) {
    if (hasText && !typingState) {
      typingState = true;
      socket.emit('typing', {to: currentChat, isTyping: true});
    } else if (!hasText && typingState) {
      typingState = false;
      socket.emit('typing', {to: currentChat, isTyping: false});
    }
  }
}

function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text && !attachedImage) return;
  
  const data = {
    to: currentChat,
    content: attachedImage || text,
    type: attachedImage ? 'image' : 'text',
    replyTo: replyTo
  };
  
  socket.emit('send_message', data, (res) => {
    if (res && res.message) {
      // ФИКС #1: Добавляем сообщение в локальную историю сразу
      if (!chatHistory[currentChat]) chatHistory[currentChat] = [];
      chatHistory[currentChat].push(res.message);
      renderMessages();
      scrollToBottom();
      
      // Обновляем превью чата
      chatPreviews[currentChat] = {
        content: text || '📷 Фото',
        timestamp: res.message.timestamp,
        type: res.message.type
      };
      renderChatList();
    }
  });
  
  input.value = '';
  input.style.height = 'auto';
  cancelReply();
  removeImage();
  handleInputChange();
  
  // Сбрасываем состояние печати
  typingState = false;
  socket.emit('typing', {to: currentChat, isTyping: false});
}

// ФИКС #7: Улучшенное качество голосовых сообщений
async function toggleVoiceRecording() {
  const micBtn = document.getElementById('mic-btn');
  
  if (!mediaRecorder) {
    try {
      // Улучшенные настройки аудио для лучшего качества
      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true,
          sampleRate: 48000,
          channelCount: 1
        } 
      });
      
      // Используем webm с opus кодеком для лучшего качества
      const options = { 
        mimeType: 'audio/webm;codecs=opus',
        audioBitsPerSecond: 128000
      };
      
      mediaRecorder = new MediaRecorder(stream, options);
      audioChunks = [];
      
      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };
      
      const startTime = Date.now();
      mediaRecorder.onstop = () => {
        const duration = Math.floor((Date.now() - startTime) / 1000);
        const blob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => {
          const base64 = reader.result;
          socket.emit('send_message', {
            to: currentChat,
            content: base64,
            type: 'voice',
            duration: formatDuration(duration)
          }, (res) => {
            if (res && res.message) {
              // ФИКС #1: Добавляем сообщение в локальную историю
              if (!chatHistory[currentChat]) chatHistory[currentChat] = [];
              chatHistory[currentChat].push(res.message);
              renderMessages();
              scrollToBottom();
              
              chatPreviews[currentChat] = {
                content: '🎤 Голосовое',
                timestamp: res.message.timestamp,
                type: 'voice'
              };
              renderChatList();
            }
          });
          
          stream.getTracks().forEach(track => track.stop());
        };
        mediaRecorder = null;
      };
      
      mediaRecorder.start();
      micBtn.classList.add('rec');
    } catch(err) {
      console.error('Ошибка доступа к микрофону:', err);
      alert('Не удалось получить доступ к микрофону');
    }
  } else {
    mediaRecorder.stop();
    micBtn.classList.remove('rec');
  }
}

function formatDuration(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function showContextMenu(e, msg) {
  const menu = document.getElementById('ctx-menu');
  menu.classList.add('on');
  menu.style.left = e.pageX + 'px';
  menu.style.top = e.pageY + 'px';
  ctxMsg = msg;
}

function ctxReply() {
  if (!ctxMsg) return;
  replyTo = ctxMsg.id;
  const replyStrip = document.getElementById('reply-strip');
  replyStrip.classList.add('on');
  document.getElementById('reply-name').textContent = ctxMsg.from === me.username ? 'Вы' : (allUsers.find(u=>u.username===ctxMsg.from)?.displayName || ctxMsg.from);
  document.getElementById('reply-text').textContent = ctxMsg.content || '';
  document.getElementById('ctx-menu').classList.remove('on');
  document.getElementById('msg-input').focus();
}

function ctxCopy() {
  if (!ctxMsg || !ctxMsg.content) return;
  navigator.clipboard.writeText(ctxMsg.content);
  document.getElementById('ctx-menu').classList.remove('on');
}

function ctxDelete() {
  if (!ctxMsg || ctxMsg.from !== me.username) return;
  socket.emit('delete_message', {msgId: ctxMsg.id, chatWith: currentChat}, () => {
    if (chatHistory[currentChat]) {
      chatHistory[currentChat] = chatHistory[currentChat].filter(m => m.id !== ctxMsg.id);
      renderMessages();
    }
  });
  document.getElementById('ctx-menu').classList.remove('on');
}

function cancelReply() {
  replyTo = null;
  document.getElementById('reply-strip').classList.remove('on');
}

// ─── File Handling ────────────────────────────────────────────────────────────
function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file || !file.type.startsWith('image/')) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    attachedImage = e.target.result;
    document.getElementById('img-preview').src = attachedImage;
    document.getElementById('img-strip').classList.add('on');
  };
  reader.readAsDataURL(file);
}

function removeImage() {
  attachedImage = null;
  document.getElementById('img-strip').classList.remove('on');
  document.getElementById('file-input').value = '';
}

// ─── Emoji ────────────────────────────────────────────────────────────────────
function toggleEmoji() {
  const picker = document.getElementById('ep') || document.getElementById('emoji-picker');
  if (!picker) return;
  const isOpen = picker.classList.toggle('on');
  if (isOpen && !picker.innerHTML) {
    picker.innerHTML = EMOJIS.map(e => `<div class="emoji-it" onclick="insertEmoji('${e}')">${e}</div>`).join('');
  }
}

function insertEmoji(emoji) {
  const input = document.getElementById('mi') || document.getElementById('msg-input');
  if (!input) return;
  const pos = input.selectionStart || input.value.length;
  input.value = input.value.slice(0, pos) + emoji + input.value.slice(pos);
  if (typeof handleInputChange === 'function') handleInputChange();
  if (typeof resize === 'function') resize(input);
  input.focus();
  const picker = document.getElementById('ep') || document.getElementById('emoji-picker');
  if (picker) picker.classList.remove('on');
}

// ─── Socket Events ────────────────────────────────────────────────────────────
// ФИКС #1: Обработка входящих сообщений в реальном времени
function onNewMessage(msg) {
  const key = msg.from === me?.username ? msg.to : msg.from;
  if (!chatHistory[key]) chatHistory[key] = [];
  chatHistory[key].push(msg);
  
  // Обновляем превью
  chatPreviews[key] = {
    content: msg.type === 'image' ? '📷 Фото' : msg.type === 'voice' ? '🎤 Голосовое' : msg.content,
    timestamp: msg.timestamp,
    type: msg.type
  };
  
  if (currentChat === key) {
    renderMessages();
    scrollToBottom();
    socket.emit('mark_read', {chatWith: key});
  } else {
    unread[key] = (unread[key] || 0) + 1;
    // Show toast notification
    showToast(msg);
  }
  
  renderChatList();
}

// ФИКС #8: Обработка индикатора печати
function onTyping({from, isTyping}) {
  if (from !== currentChat) return;
  const indicator = document.getElementById('typing-indicator');
  if (indicator) {
    if (isTyping) {
      indicator.classList.add('show');
      scrollToBottom();
    } else {
      indicator.classList.remove('show');
    }
  }
}

function updateUserStatus(username, isOnline, lastSeen) {
  const user = allUsers.find(u => u.username === username);
  if (user) {
    user.online = isOnline;
    user.lastSeen = lastSeen;
  }
  
  if (currentChat === username) {
    const statusEl = document.getElementById('chat-hdr-status');
    statusEl.textContent = isOnline ? 'В сети' : 'Не в сети';
    statusEl.className = 'ch-status' + (isOnline ? ' online' : '');
  }
  
  renderChatList();
}

function onUserUpdated({username, avatar, displayName, bio, privacy}) {
  const user = allUsers.find(u => u.username === username);
  if (user) {
    if (avatar !== undefined) user.avatar = avatar;
    if (displayName) user.displayName = displayName;
    if (bio !== undefined) user.bio = bio;
    if (privacy) user.privacy = privacy;
  }
  
  if (currentChat === username) {
    const hdrAvatar = document.getElementById('chat-hdr-avatar');
    setAvatarEl(hdrAvatar, user);
    document.getElementById('chat-hdr-name').textContent = displayName || username;
  }
  
  renderChatList();
}

// ФИКС #4: Отметка сообщений как прочитанных
function markMessagesRead(by) {
  if (!chatHistory[by]) return;
  chatHistory[by].forEach(m => {
    if (m.to === me.username) m.read = true;
  });
  if (currentChat === by) {
    renderMessages();
  }
}

function removeMessageEl(msgId) {
  if (!currentChat) return;
  const msgs = chatHistory[currentChat];
  if (msgs) {
    chatHistory[currentChat] = msgs.filter(m => m.id !== msgId);
    renderMessages();
  }
}

// ─── Toast Notification ───────────────────────────────────────────────────────
function showToast(msg) {
  if (currentChat === (msg.from === me.username ? msg.to : msg.from)) return;
  
  const user = allUsers.find(u => u.username === msg.from) || {username: msg.from, displayName: msg.from};
  const toast = document.getElementById('toast');
  const avatar = document.getElementById('toast-avatar');
  
  avatar.style.background = strColor(user.username);
  if (user.avatar) {
    avatar.innerHTML = `<img src="${user.avatar}">`;
  } else {
    avatar.innerHTML = `<span>${initials(user.displayName||user.username)}</span>`;
  }
  
  document.getElementById('toast-name').textContent = user.displayName || user.username;
  const msgText = msg.type === 'image' ? '📷 Фото' : msg.type === 'voice' ? '🎤 Голосовое' : msg.content;
  document.getElementById('toast-msg').textContent = msgText;
  
  toastChatUser = msg.from;
  toast.classList.add('on');
  
  if (toastTimeout) clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => {
    toast.classList.remove('on');
  }, 4000);
}

function openChatFromToast() {
  if (toastChatUser) {
    openChat(toastChatUser);
    document.getElementById('toast').classList.remove('on');
  }
}
// ─── Глобальные переменные звонка ─────────────────────────────────────────────
var localStream = null;
var peerConnection = null;
var currentCallUser = null;
var callType = null; // 'voice' или 'video'
var callTimer = null;
var callSeconds = 0;
let callMinimized = false;
let iceCandidatesQueue = []; // ФИКС: Очередь для кандидатов до установки RemoteDescription

// ─── Основные функции WebRTC ──────────────────────────────────────────────────

async function startCall(type) {
    if (!currentChat) return;
    callType = type;
    currentCallUser = currentChat;

    const user = allUsers.find(u => u.username === currentChat);
    if (!user || !user.online) {
        alert('Пользователь не в сети');
        return;
    }

    try {
        const constraints = type === 'video' 
            ? { video: true, audio: true } 
            : { video: false, audio: true };

        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        createPeerConnection();

        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        socket.emit('call_user', { to: currentChat, offer, callType: type });

        showCallOverlay(user, 'Звоним...', false);
    } catch (err) {
        console.error('Ошибка при запуске звонка:', err);
        alert('Не удалось получить доступ к камере/микрофону. Проверьте разрешения.');
        cleanupCall();
    }
}

function createPeerConnection() {
    peerConnection = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    peerConnection.ontrack = (event) => {
        const remoteVideo = document.getElementById('remoteVideo');
        if (remoteVideo) remoteVideo.srcObject = event.streams[0];
    };

    peerConnection.onicecandidate = (event) => {
        if (event.candidate && currentCallUser) {
            socket.emit('ice_candidate', { to: currentCallUser, candidate: event.candidate });
        }
    };
}

// ─── Обработка входящих событий ───────────────────────────────────────────────

function onIncomingCall({ from, offer, callType: type }) {
    currentCallUser = from;
    callType = type;
    window.incomingOffer = offer;

    const user = allUsers.find(u => u.username === from);
    if (!user) return;

    showCallOverlay(user, type === 'video' ? 'Видеозвонок...' : 'Голосовой звонок...', true);
}

async function acceptCall() {
    if (!window.incomingOffer || !currentCallUser) return;

    try {
        const constraints = callType === 'video' 
            ? { video: true, audio: true } 
            : { video: false, audio: true };

        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        createPeerConnection();

        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });

        await peerConnection.setRemoteDescription(new RTCSessionDescription(window.incomingOffer));
        
        // ФИКС: Обработка накопившихся ICE-кандидатов
        processIceQueue();

        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        socket.emit('call_answer', { to: currentCallUser, answer });

        const user = allUsers.find(u => u.username === currentCallUser);
        showCallOverlay(user, 'Соединено', false);
        startCallTimer();

        if (callType === 'video') {
            document.getElementById('localVideo').srcObject = localStream;
        }
    } catch (err) {
        console.error('Ошибка при принятии звонка:', err);
        rejectCall();
    }
}

async function onCallAnswered({ answer }) {
    // Use any available peer connection reference
    if (!peerConnection && window._pc) peerConnection = window._pc;
    if (!peerConnection) { console.warn('onCallAnswered: no peerConnection'); return; }
    try {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        // Show remote video if it was hidden
        var rv = document.getElementById('remoteVideo');
        if (rv) rv.style.display = '';
        var el = document.getElementById('call-status') || document.getElementById('cst');
        if (el) el.textContent = 'Соединено';
        processIceQueue();
        if (typeof startCallTimer === 'function') startCallTimer();
    } catch (e) {
        console.error("Ошибка при установке ответа:", e);
    }
}

async function onIceCandidate({ candidate }) {
    if (!peerConnection && window._pc) peerConnection = window._pc;
    if (!peerConnection || !peerConnection.remoteDescription) {
        iceCandidatesQueue.push(candidate);
        return;
    }
    try {
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    } catch (e) {
        console.error('Ошибка добавления ICE candidate:', e);
    }
}

async function processIceQueue() {
    while (iceCandidatesQueue.length > 0) {
        const cand = iceCandidatesQueue.shift();
        try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(cand));
        } catch (e) { console.warn("Ошибка очереди ICE:", e); }
    }
}

// ─── Управление интерфейсом ───────────────────────────────────────────────────

function showCallOverlay(user, status, showActions) {
    const modal = document.getElementById('call-modal');
    const avatar = document.getElementById('call-avatar');
    
    avatar.style.background = typeof strColor === 'function' ? strColor(user.username) : '#ccc';
    avatar.innerHTML = user.avatar 
        ? `<img src="${user.avatar}">` 
        : `<span>${typeof initials === 'function' ? initials(user.displayName || user.username) : '?'}</span>`;

    document.getElementById('call-name').textContent = user.displayName || user.username;
    document.getElementById('call-status').textContent = status;

    const videoArea = document.getElementById('video-area');
    if (callType === 'video' && localStream) {
        videoArea.classList.add('on');
        document.getElementById('localVideo').srcObject = localStream;
    } else {
        videoArea.classList.remove('on');
    }

    const actionsDiv = document.getElementById('call-actions');
    if (showActions) {
        actionsDiv.innerHTML = `
            <button class="call-btn call-btn-reject" onclick="rejectCall()">✕</button>
            <button class="call-btn call-btn-accept" onclick="acceptCall()">✓</button>
        `;
    } else {
        actionsDiv.innerHTML = `
            <button class="call-btn call-btn-mute" onclick="toggleMute(event)" title="Микрофон">🎤</button>
            ${callType === 'video' ? '<button class="call-btn call-btn-video" onclick="toggleVideo(event)" title="Камера">📹</button>' : ''}
            <button class="call-btn call-btn-minimize" onclick="minimizeCall()" title="Свернуть">─</button>
            <button class="call-btn call-btn-end" onclick="endCall()">✕</button>
        `;
    }

    modal.classList.add('on');
    callMinimized = false;
}

function minimizeCall() {
    document.getElementById('call-box-main').style.display = 'none';
    const miniBox = document.getElementById('call-minimized');
    miniBox.style.display = 'flex';

    const user = allUsers.find(u => u.username === currentCallUser);
    if (user) {
        const miniAvatar = document.getElementById('call-mini-avatar');
        miniAvatar.style.background = typeof strColor === 'function' ? strColor(user.username) : '#ccc';
        document.getElementById('call-mini-name').textContent = user.displayName || user.username;
    }
    callMinimized = true;
}

function maximizeCall() {
    document.getElementById('call-box-main').style.display = 'block';
    document.getElementById('call-minimized').style.display = 'none';
    callMinimized = false;
}

// ─── Кнопки управления потоком ───────────────────────────────────────────────

function toggleMute(event) {
    if (!localStream) return;
    const audioTrack = localStream.getAudioTracks()[0];
    if (audioTrack) {
        audioTrack.enabled = !audioTrack.enabled;
        event.currentTarget.classList.toggle('active');
    }
}

function toggleVideo(event) {
    if (!localStream) return;
    const videoTrack = localStream.getVideoTracks()[0];
    if (videoTrack) {
        videoTrack.enabled = !videoTrack.enabled;
        event.currentTarget.classList.toggle('active');
    }
}

// ─── Завершение звонка ────────────────────────────────────────────────────────

function endCall() {
    if (currentCallUser) {
        socket.emit('call_end', { to: currentCallUser });
    }
    
    // ФИКС: Сначала сохраняем время, потом чистим
    const finalDuration = formatCallDuration(callSeconds);
    const hasTalked = callSeconds > 0;

    cleanupCall();

    if (hasTalked) {
        alert(`Звонок завершен. Длительность: ${finalDuration}`);
    }
}

function rejectCall() {
    if (currentCallUser) {
        socket.emit('call_reject', { to: currentCallUser });
    }
    cleanupCall();
}

function onCallEnded() {
    const finalDuration = formatCallDuration(callSeconds);
    const hasTalked = callSeconds > 0;
    
    cleanupCall();
    
    if (hasTalked) {
        alert(`Собеседник завершил звонок. Длительность: ${finalDuration}`);
    } else {
        alert('Звонок завершен');
    }
}

function cleanupCall() {
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    if (callTimer) {
        clearInterval(callTimer);
        callTimer = null;
    }

    // Сброс UI
    document.getElementById('call-modal').classList.remove('on');
    document.getElementById('call-timer').style.display = 'none';
    document.getElementById('call-timer').textContent = '00:00';
    document.getElementById('call-minimized').style.display = 'none';
    document.getElementById('call-box-main').style.display = 'block';
    
    const remoteVideo = document.getElementById('remoteVideo');
    const localVideo = document.getElementById('localVideo');
    if (remoteVideo) remoteVideo.srcObject = null;
    if (localVideo) localVideo.srcObject = null;

    // Сброс данных
    callSeconds = 0;
    currentCallUser = null;
    callMinimized = false;
    window.incomingOffer = null;
    iceCandidatesQueue = [];
}

// ─── Вспомогательные функции ──────────────────────────────────────────────────

function startCallTimer() {
    callSeconds = 0;
    const timerEl = document.getElementById('call-timer');
    const miniTimerEl = document.getElementById('call-mini-time');
    timerEl.style.display = 'block';

    callTimer = setInterval(() => {
        callSeconds++;
        const timeStr = formatCallDuration(callSeconds);
        timerEl.textContent = timeStr;
        if (miniTimerEl) miniTimerEl.textContent = timeStr;
    }, 1000);
}

function formatCallDuration(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}


// ─── ADDED: Helper functions ──────────────────────────────────────────────────
if(typeof G === 'undefined') { var G = function(id){ return document.getElementById(id); }; }
if(typeof E === 'undefined') { var E = function(id, msg){ var el=document.getElementById(id); if(el){el.textContent=msg; setTimeout(function(){el.textContent='';},4000);} }; }

function authTab(t) {
  document.querySelectorAll('.auth-seg-btn').forEach(function(b,i){
    b.classList.toggle('active', t==='login' ? i===0 : i===1);
  });
  var lf=document.getElementById('lf'), rf=document.getElementById('rf');
  if(lf) lf.style.display = t==='login' ? 'block' : 'none';
  if(rf) rf.style.display = t==='reg'   ? 'block' : 'none';
  var le=document.getElementById('le'), re_=document.getElementById('re');
  if(le) le.textContent=''; if(re_) re_.textContent='';
}

function doReg() {
  var n=document.getElementById('rn')||document.getElementById('rn')||document.getElementById('reg-displayname');
  var u=document.getElementById('ru')||document.getElementById('ru')||document.getElementById('reg-username');
  var p=document.getElementById('rp')||document.getElementById('rp')||document.getElementById('reg-password');
  if(!n||!u||!p||!n.value.trim()||!u.value.trim()||!p.value) {
    var re_=document.getElementById('re'); if(re_) re_.textContent='Заполните все поля'; return;
  }
  socket.emit('register',{username:u.value.trim(),password:p.value,displayName:n.value.trim()},function(r){
    if(r.error){var re_=document.getElementById('re'); if(re_) re_.textContent=r.error; return;}
    localStorage.setItem('userSession',JSON.stringify({username:u.value.trim(),password:p.value}));
    onLoggedIn(r.user);
  });
}
// ──────────────────────────────────────────────────────────────────────────────
// ── Periodic refresh ──
setInterval(()=>{ if(me) loadUsers(); }, 30000);
// connectSocket() отключён — сокет запускается через init() во втором блоке скрипта
// connectSocket();
</script>

<style>
/* ─── AUTH ─── */
#auth-screen {
  display:flex; align-items:center; justify-content:center; height:100vh;
  background: radial-gradient(ellipse 70% 50% at 50% 0%, rgba(79,142,247,0.1) 0%, transparent 65%);
}
.auth-card {
  width:400px; background:var(--sidebar); border:1px solid var(--border);
  border-radius:24px; padding:40px 36px; box-shadow:0 32px 80px rgba(0,0,0,0.6);
}
.auth-brand { display:flex; align-items:center; gap:14px; margin-bottom:32px; }
.auth-brand-icon { width:52px; height:52px; background:var(--accent); border-radius:16px; display:flex; align-items:center; justify-content:center; }
.auth-brand-text h1 { font-size:24px; font-weight:700; letter-spacing:-0.5px; }
.auth-brand-text p { color:var(--text2); font-size:13px; margin-top:2px; }
.auth-seg { display:flex; background:var(--bg); border-radius:12px; padding:3px; margin-bottom:28px; border:1px solid var(--border); }
.auth-seg-btn { flex:1; padding:9px; border:none; background:none; color:var(--text2); border-radius:9px; cursor:pointer; font-size:13px; font-weight:500; transition:all .2s; font-family:inherit; }
.auth-seg-btn.active { background:var(--surface); color:var(--text); box-shadow:0 2px 8px rgba(0,0,0,0.3); }
.field { margin-bottom:16px; position:relative; }
.field-label { display:flex; align-items:center; gap:6px; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:1px; color:var(--text2); margin-bottom:8px; }
.field-icon { position:absolute; left:13px; bottom:11px; color:var(--text3); pointer-events:none; }
.field input { width:100%; padding:11px 14px 11px 40px; background:var(--surface); border:1px solid var(--border); border-radius:12px; color:var(--text); font-family:inherit; font-size:14px; outline:none; transition:all .2s; }
.field input:focus { border-color:var(--accent); background:var(--surface2); }
.field input::placeholder { color:var(--text3); }
.auth-btn { width:100%; padding:12px; background:var(--accent); border:none; border-radius:12px; color:#fff; font-size:14px; font-weight:600; cursor:pointer; transition:all .2s; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:8px; margin-top:4px; }
.auth-btn:hover { background:var(--accent-hover); transform:translateY(-1px); box-shadow:0 4px 16px rgba(79,142,247,0.3); }
.auth-err { color:var(--red); font-size:12px; text-align:center; margin-top:10px; min-height:16px; }

/* ─── APP ─── */
#app { display:none; height:100vh; }
#app.on { display:flex; }

/* ─── SIDEBAR ─── */
.sidebar { width:300px; background:var(--sidebar); border-right:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; }
.sb-head { display:flex; align-items:center; gap:10px; padding:14px 14px 12px; border-bottom:1px solid var(--border); }
.me-av { width:38px; height:38px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; cursor:pointer; flex-shrink:0; overflow:hidden; transition:opacity .2s; }
.me-av:hover { opacity:.8; }
.me-av img { width:100%; height:100%; object-fit:cover; }
.me-nm { flex:1; font-weight:600; font-size:14px; cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.me-nm:hover { color:var(--accent); }
.sb-acts { display:flex; gap:2px; }
.ib { width:32px; height:32px; border:none; background:none; color:var(--text2); border-radius:9px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .18s; }
.ib:hover { background:var(--surface); color:var(--text); }
.sb-search { padding:10px 12px; border-bottom:1px solid var(--border); }
.srch-wrap { position:relative; }
.srch-wrap svg { position:absolute; left:11px; top:50%; transform:translateY(-50%); color:var(--text3); pointer-events:none; }
.srch-inp { width:100%; padding:8px 12px 8px 36px; background:var(--surface); border:1px solid var(--border); border-radius:22px; color:var(--text); font-family:inherit; font-size:13px; outline:none; transition:all .2s; }
.srch-inp:focus { border-color:var(--accent); background:var(--surface2); }
.srch-inp::placeholder { color:var(--text3); }
.sb-tabs { display:flex; padding:0 12px; border-bottom:1px solid var(--border); gap:2px; }
.sb-tab { flex:1; padding:10px 4px 9px; border:none; background:none; color:var(--text2); cursor:pointer; font-size:12px; font-weight:500; border-bottom:2px solid transparent; transition:all .2s; font-family:inherit; display:flex; align-items:center; justify-content:center; gap:5px; }
.sb-tab:hover { color:var(--text); }
.sb-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
.chat-list { flex:1; overflow-y:auto; padding:6px; }
.chat-item { display:flex; align-items:center; gap:11px; padding:9px 10px; border-radius:12px; cursor:pointer; transition:background .15s; position:relative; }
.chat-item:hover { background:var(--surface); }
.chat-item.active { background:var(--surface2); }
.chat-item.active::before { content:''; position:absolute; left:0; top:50%; transform:translateY(-50%); width:3px; height:55%; background:var(--accent); border-radius:0 3px 3px 0; }
.ci-av { width:46px; height:46px; border-radius:14px; flex-shrink:0; position:relative; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:17px; overflow:hidden; }
.ci-av img { width:100%; height:100%; object-fit:cover; border-radius:14px; }
.odot { position:absolute; bottom:-1px; right:-1px; width:13px; height:13px; background:var(--green); border-radius:50%; border:2px solid var(--sidebar); }
.ci-info { flex:1; min-width:0; }
.ci-top { display:flex; align-items:center; justify-content:space-between; gap:4px; }
.ci-name { font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.ci-time { font-size:11px; color:var(--text3); flex-shrink:0; }
.ci-bot { display:flex; align-items:center; justify-content:space-between; gap:4px; margin-top:2px; }
.ci-prev { color:var(--text2); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:flex; align-items:center; gap:4px; }
.ubadge { background:var(--accent); color:#fff; font-size:10px; font-weight:700; border-radius:10px; padding:2px 6px; min-width:18px; text-align:center; flex-shrink:0; }
.empty-list { padding:48px 20px; text-align:center; color:var(--text2); font-size:13px; }
.empty-list-icon { color:var(--text3); margin-bottom:12px; display:flex; justify-content:center; }
.sec-hd { padding:14px 12px 4px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; color:var(--text3); }

/* ─── CHAT AREA ─── */
.chat-area { flex:1; display:flex; flex-direction:column; background:var(--bg); min-width:0; }
.no-chat { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; color:var(--text2); }
.no-chat-icon { color:var(--text3); opacity:.5; }
.no-chat h3 { font-size:18px; font-weight:600; color:var(--text); }
.no-chat p { font-size:13px; }
.chat-hd { display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid var(--border); background:var(--sidebar); flex-shrink:0; }
.ch-av { width:38px; height:38px; border-radius:12px; cursor:pointer; flex-shrink:0; overflow:hidden; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; }
.ch-av img { width:100%; height:100%; object-fit:cover; }
.ch-info { flex:1; cursor:pointer; min-width:0; }
.ch-name { font-weight:600; font-size:15px; }
.ch-status { font-size:12px; color:var(--text2); margin-top:1px; display:flex; align-items:center; gap:4px; }
.ch-status.on { color:var(--green); }
.ch-status.on::before { content:''; width:6px; height:6px; background:var(--green); border-radius:50%; display:inline-block; }
.ch-acts { display:flex; gap:2px; }

/* Messages */
.msgs { flex:1; overflow-y:auto; padding:16px 16px 8px; display:flex; flex-direction:column; gap:2px; }
.date-div { display:flex; align-items:center; gap:10px; margin:12px 0; color:var(--text3); font-size:11px; }
.date-div::before,.date-div::after { content:''; flex:1; height:1px; background:var(--border); }
.mrow { display:flex; align-items:flex-end; gap:8px; animation:msgIn .18s ease; }
.mrow.out { flex-direction:row-reverse; align-self:flex-end; max-width:75%; }
.mrow.in { align-self:flex-start; max-width:75%; }
@keyframes msgIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
.msg-av { width:28px; height:28px; border-radius:9px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:11px; overflow:hidden; }
.msg-av img { width:100%; height:100%; object-fit:cover; }
.bubble { padding:8px 12px; border-radius:16px; max-width:100%; word-break:break-word; cursor:default; position:relative; }
.out .bubble { background:var(--bubble-out); border-bottom-right-radius:4px; }
.in .bubble { background:var(--bubble-in); border-bottom-left-radius:4px; border:1px solid var(--border); }
.bbl-reply { background:rgba(255,255,255,0.06); border-left:2px solid var(--accent); border-radius:8px; padding:5px 8px; margin-bottom:6px; }
.bbl-rname { font-size:11px; font-weight:600; color:var(--accent); margin-bottom:2px; }
.bbl-rtext { font-size:12px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.bbl-text { font-size:14px; line-height:1.55; }
.bbl-img { max-width:280px; max-height:260px; border-radius:10px; display:block; cursor:zoom-in; object-fit:contain; width:auto; height:auto; }
.bbl-meta { display:flex; align-items:center; justify-content:flex-end; gap:4px; margin-top:4px; font-size:10px; color:rgba(255,255,255,0.35); }
.bbl-meta .chk { color:var(--accent); display:flex; }
.voice-msg { display:flex; align-items:center; gap:10px; min-width:190px; }
.voice-play { width:36px; height:36px; border-radius:50%; background:var(--accent); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; color:#fff; transition:background .2s; }
.voice-play:hover { background:var(--accent-hover); }
.voice-waves { flex:1; display:flex; align-items:center; gap:2px; height:24px; }
.voice-waves span { display:inline-block; width:3px; border-radius:2px; background:rgba(255,255,255,0.35); }
.voice-dur { font-size:11px; color:var(--text2); }
.typing-row { display:flex; align-items:center; gap:8px; color:var(--text2); font-size:12px; padding:4px 0; }
.tdots { display:flex; gap:3px; }
.tdots span { width:6px; height:6px; background:var(--text2); border-radius:50%; animation:tdot 1.2s infinite; }
.tdots span:nth-child(2){animation-delay:.2s}.tdots span:nth-child(3){animation-delay:.4s}
@keyframes tdot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

/* ─── INPUT BAR ─── */
.ibar { padding:10px 14px 12px; background:var(--sidebar); border-top:1px solid var(--border); flex-shrink:0; }
.reply-strip { display:none; align-items:center; gap:10px; background:var(--surface); border-left:3px solid var(--accent); border-radius:0 10px 10px 0; padding:6px 10px; margin-bottom:8px; }
.reply-strip.on { display:flex; }
.rs-info { flex:1; min-width:0; }
.rs-nm { font-size:11px; font-weight:600; color:var(--accent); margin-bottom:2px; }
.rs-tx { font-size:12px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.rs-x { border:none; background:none; color:var(--text2); cursor:pointer; padding:2px; border-radius:4px; display:flex; }
.rs-x:hover { color:var(--text); }
.img-strip { display:none; position:relative; margin-bottom:8px; width:fit-content; }
.img-strip.on { display:block; }
.img-strip img { height:80px; border-radius:10px; display:block; }
.img-strip-rm { position:absolute; top:-6px; right:-6px; width:20px; height:20px; background:var(--red); border:none; border-radius:50%; cursor:pointer; color:#fff; display:flex; align-items:center; justify-content:center; }
.irow { display:flex; align-items:flex-end; gap:8px; }
.iab { width:38px; height:38px; border:none; background:none; color:var(--text2); border-radius:11px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .18s; flex-shrink:0; }
.iab:hover { background:var(--surface); color:var(--text); }
.iwrap { flex:1; position:relative; }
.msg-inp { width:100%; padding:9px 40px 9px 16px; background:var(--surface); border:1px solid var(--border); border-radius:14px; color:var(--text); font-family:inherit; font-size:14px; outline:none; resize:none; max-height:120px; transition:border-color .2s; line-height:1.5; }
.msg-inp:focus { border-color:var(--border2); background:var(--surface2); }
.msg-inp::placeholder { color:var(--text3); }
.emoji-trigger { position:absolute; right:10px; bottom:8px; border:none; background:none; color:var(--text3); cursor:pointer; padding:2px; border-radius:6px; display:flex; transition:color .18s; }
.emoji-trigger:hover { color:var(--text2); }
.emoji-picker { display:none; position:absolute; bottom:50px; right:0; background:var(--surface2); border:1px solid var(--border); border-radius:16px; padding:10px; z-index:200; width:288px; box-shadow:var(--shadow); }
.emoji-picker.on { display:block; }
.emoji-grid { display:grid; grid-template-columns:repeat(8,1fr); gap:3px; }
.emoji-it { font-size:22px; cursor:pointer; text-align:center; border-radius:8px; padding:4px; transition:background .12s; }
.emoji-it:hover { background:var(--surface); }
.send-btn { width:38px; height:38px; border:none; background:var(--accent); color:#fff; border-radius:11px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.send-btn:hover { background:var(--accent-hover); transform:scale(1.04); }
.mic-btn { width:38px; height:38px; border:none; background:var(--surface); color:var(--text2); border-radius:11px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s; flex-shrink:0; }
.mic-btn:hover { background:var(--surface2); color:var(--text); }
.mic-btn.rec { background:var(--red-dim); color:var(--red); animation:rp 1s infinite; border:1px solid var(--red); }
@keyframes rp{0%,100%{opacity:1}50%{opacity:.7}}

/* ─── CONTEXT MENU ─── */
.ctx { position:fixed; background:var(--surface2); border:1px solid var(--border); border-radius:14px; padding:4px; box-shadow:var(--shadow); z-index:1000; min-width:170px; display:none; overflow:hidden; }
.ctx.on { display:block; }
.ctx-it { display:flex; align-items:center; gap:10px; padding:9px 13px; border-radius:10px; cursor:pointer; font-size:13px; transition:background .12s; }
.ctx-it:hover { background:var(--surface); }
.ctx-it.danger { color:var(--red); }

/* ─── SETTINGS PANEL ─── */
.sett-panel { position:fixed; top:0; right:-420px; width:380px; height:100vh; background:var(--sidebar); border-left:1px solid var(--border); z-index:300; transition:right .3s cubic-bezier(.4,0,.2,1); display:flex; flex-direction:column; box-shadow:-8px 0 32px rgba(0,0,0,0.3); }
.sett-panel.on { right:0; }
.sett-hd { display:flex; align-items:center; gap:12px; padding:16px 20px; border-bottom:1px solid var(--border); flex-shrink:0; }
.sett-hd h2 { font-size:17px; font-weight:700; flex:1; }
.sett-body { flex:1; overflow-y:auto; }
.sett-profile { padding:24px 20px; text-align:center; border-bottom:1px solid var(--border); }
.sett-av-wrap { position:relative; width:80px; margin:0 auto 14px; cursor:pointer; }
.sett-av { width:80px; height:80px; border-radius:22px; display:flex; align-items:center; justify-content:center; font-size:30px; font-weight:700; overflow:hidden; border:2px solid var(--border); }
.sett-av img { width:100%; height:100%; object-fit:cover; }
.sett-av-badge { position:absolute; bottom:-4px; right:-4px; width:26px; height:26px; background:var(--accent); border-radius:8px; display:flex; align-items:center; justify-content:center; border:2px solid var(--sidebar); }
.sett-uname { font-size:18px; font-weight:700; margin-bottom:4px; }
.sett-handle { font-size:13px; color:var(--text2); }
.sett-grp { padding:12px 16px; border-bottom:1px solid var(--border); }
.sett-grp-title { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; color:var(--text3); margin-bottom:8px; padding:0 4px; }
.sett-row { display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:12px; cursor:pointer; transition:background .15s; }
.sett-row:hover { background:var(--surface); }
.sett-ico { width:34px; height:34px; border-radius:10px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.sett-ico.blue { background:rgba(79,142,247,0.15); color:var(--accent); }
.sett-ico.green { background:var(--green-dim); color:var(--green); }
.sett-ico.red { background:var(--red-dim); color:var(--red); }
.sett-ico.yellow { background:rgba(255,209,102,0.12); color:var(--yellow); }
.sett-ico.purple { background:rgba(160,110,247,0.12); color:#a06ef7; }
.sett-row-body { flex:1; min-width:0; }
.sett-row-label { font-size:14px; font-weight:500; }
.sett-row-sub { font-size:12px; color:var(--text2); margin-top:2px; }
.sett-row-arrow { color:var(--text3); display:flex; align-items:center; }
.sett-edit-form { padding:16px; border-bottom:1px solid var(--border); display:none; }
.sett-edit-form.on { display:block; }
.sett-inp { width:100%; padding:10px 14px; background:var(--surface); border:1px solid var(--border); border-radius:11px; color:var(--text); font-family:inherit; font-size:14px; outline:none; margin-bottom:10px; transition:border-color .2s; }
.sett-inp:focus { border-color:var(--accent); }
.sett-ta { width:100%; padding:10px 14px; background:var(--surface); border:1px solid var(--border); border-radius:11px; color:var(--text); font-family:inherit; font-size:14px; outline:none; resize:none; height:80px; margin-bottom:10px; transition:border-color .2s; }
.sett-ta:focus { border-color:var(--accent); }
.btn-row { display:flex; gap:8px; }
.btn-prim { flex:1; padding:10px; background:var(--accent); border:none; border-radius:10px; color:#fff; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; transition:all .2s; }
.btn-prim:hover { background:var(--accent-hover); }
.btn-sec { flex:1; padding:10px; background:var(--surface); border:1px solid var(--border); border-radius:10px; color:var(--text2); font-size:13px; font-weight:500; cursor:pointer; font-family:inherit; transition:all .2s; }
.btn-sec:hover { background:var(--surface2); color:var(--text); }
.btn-danger { width:100%; padding:11px; background:var(--red-dim); border:1px solid rgba(255,82,82,0.2); border-radius:10px; color:var(--red); font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; transition:all .2s; display:flex; align-items:center; justify-content:center; gap:8px; }
.btn-danger:hover { background:rgba(255,82,82,0.2); }

/* ─── PROFILE MODAL ─── */
.pm-over { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:400; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
.pm-over.on { display:flex; }
.pm-card { background:var(--sidebar); border:1px solid var(--border); border-radius:22px; width:340px; overflow:hidden; box-shadow:0 24px 60px rgba(0,0,0,0.6); }
.pm-banner { height:90px; position:relative; }
.pm-banner-grad { position:absolute; inset:0; background:linear-gradient(135deg,var(--accent) 0%,#7c4dff 100%); }
.pm-body { padding:0 20px 20px; }
.pm-av-row { display:flex; align-items:flex-end; justify-content:space-between; margin-top:-32px; margin-bottom:12px; }
.pm-av { width:68px; height:68px; border-radius:18px; border:3px solid var(--sidebar); display:flex; align-items:center; justify-content:center; font-size:26px; font-weight:700; overflow:hidden; }
.pm-av img { width:100%; height:100%; object-fit:cover; }
.pm-status { font-size:12px; font-weight:500; }
.pm-status.on { color:var(--green); }
.pm-status.off { color:var(--text2); }
.pm-name { font-size:20px; font-weight:700; }
.pm-handle { font-size:13px; color:var(--text2); margin:3px 0 10px; }
.pm-bio { font-size:13px; color:var(--text2); line-height:1.55; margin-bottom:16px; }
.pm-btns { display:flex; gap:8px; }
.pm-btn { flex:1; padding:9px 8px; border-radius:12px; border:none; cursor:pointer; font-size:13px; font-weight:600; font-family:inherit; transition:all .2s; display:flex; align-items:center; justify-content:center; gap:6px; }
.pm-btn.prim { background:var(--accent); color:#fff; }
.pm-btn.prim:hover { background:var(--accent-hover); }
.pm-btn.sec { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
.pm-btn.sec:hover { background:var(--surface); }

/* ─── CALL MODAL ─── */
.call-over { display:none; position:fixed; inset:0; background:rgba(10,12,18,0.92); z-index:500; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(12px); }
.call-over.on { display:flex; }
.call-card { background:var(--sidebar); border:1px solid var(--border); border-radius:28px; padding:36px 44px; text-align:center; min-width:300px; box-shadow:0 32px 80px rgba(0,0,0,0.6); }
.call-av { width:88px; height:88px; border-radius:26px; display:flex; align-items:center; justify-content:center; font-size:34px; font-weight:700; margin:0 auto 16px; overflow:hidden; border:2px solid var(--border); }
.call-av img { width:100%; height:100%; object-fit:cover; }
.call-name { font-size:22px; font-weight:700; margin-bottom:6px; }
.call-st { color:var(--text2); font-size:13px; margin-bottom:28px; display:flex; align-items:center; justify-content:center; gap:6px; }
.call-timer { font-size:36px; font-weight:700; letter-spacing:2px; margin-bottom:6px; font-variant-numeric:tabular-nums; }
.call-btns { display:flex; gap:14px; justify-content:center; flex-wrap:wrap; }
.call-btn-wrap { display:flex; flex-direction:column; align-items:center; gap:6px; }
.call-btn-wrap span { font-size:11px; color:var(--text2); }
.cbtn { width:58px; height:58px; border-radius:50%; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s; }
.cbtn:hover { transform:scale(1.06); }
.cbtn.accept { background:#1db954; color:#fff; }
.cbtn.decline { background:var(--red); color:#fff; }
.cbtn.end-call { background:var(--red); color:#fff; }
.cbtn.neutral { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
.cbtn.neutral.muted { background:var(--accent-dim); color:var(--accent); border-color:var(--accent); }
.vid-area { display:none; width:100%; max-width:560px; margin-bottom:20px; border-radius:16px; overflow:hidden; background:#000; position:relative; }
.vid-area.on { display:block; }
#remoteVideo { width:100%; max-height:280px; object-fit:cover; background:#111; display:block; }
#localVideo { position:absolute; bottom:8px; right:8px; width:96px; height:72px; border-radius:10px; object-fit:cover; border:2px solid var(--accent); background:#222; }

/* ─── LIGHTBOX ─── */
.lightbox { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.92); z-index:600; align-items:center; justify-content:center; cursor:zoom-out; }
.lightbox.on { display:flex; }
.lightbox img { max-width:92vw; max-height:92vh; border-radius:10px; }

/* ─── TOAST ─── */
.toast { position:fixed; bottom:20px; right:20px; background:var(--surface2); border:1px solid var(--border); border-radius:16px; padding:12px 14px; z-index:700; transform:translateX(120%); opacity:0; transition:all .3s cubic-bezier(.4,0,.2,1); display:flex; align-items:center; gap:10px; max-width:320px; cursor:pointer; box-shadow:var(--shadow); }
.toast.on { transform:translateX(0); opacity:1; }
.toast-av { width:38px; height:38px; border-radius:11px; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:13px; overflow:hidden; }
.toast-av img { width:100%; height:100%; object-fit:cover; }
.t-name { font-weight:600; font-size:13px; }
.t-text { color:var(--text2); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* Mobile */
@media(max-width:640px){
  .sidebar{width:100%;}
  .chat-area{display:none;}
  .chat-area.mob{display:flex;position:fixed;inset:0;z-index:50;}
  .back-btn{display:flex!important;}
  .sett-panel{width:100%;right:-100%;}
}
.back-btn{display:none;}

</style>
<div style="display:none" data-dup="2">

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-brand">
      <div class="auth-brand-icon">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </div>
      <div class="auth-brand-text"><h1>Freedom</h1><p>Мессенджер без границ</p></div>
    </div>
    <div class="auth-seg">
      <button class="auth-seg-btn active" onclick="authTab('login')">Войти</button>
      <button class="auth-seg-btn" onclick="authTab('reg')">Регистрация</button>
    </div>
    <div id="lf">
      <div class="field">
        <div class="field-label"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Имя пользователя</div>
        <div class="field-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <input type="text" id="lu" placeholder="username" autocomplete="username">
      </div>
      <div class="field">
        <div class="field-label"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Пароль</div>
        <div class="field-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
        <input type="password" id="lp" placeholder="••••••••" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="auth-btn" onclick="doLogin()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
        Войти
      </button>
      <div class="auth-err" id="le"></div>
    </div>
    <div id="rf" style="display:none">
      <div class="field">
        <div class="field-label">Отображаемое имя</div>
        <div class="field-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <input type="text" id="rn" placeholder="Ваше имя">
      </div>
      <div class="field">
        <div class="field-label">Логин</div>
        <div class="field-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8.56 2.75c4.37 6.03 6.02 9.42 8.03 17.72m2.54-15.38c-3.72 4.35-8.94 5.66-16.88 5.85m19.5 1.9c-3.5-.93-6.63-.82-8.94 0-2.58.92-5.01 2.86-7.44 6.32"/></svg></div>
        <input type="text" id="ru" placeholder="username (мин. 3 символа)">
      </div>
      <div class="field">
        <div class="field-label">Пароль</div>
        <div class="field-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
        <input type="password" id="rp" placeholder="••••••••" onkeydown="if(event.key==='Enter')doReg()">
      </div>
      <button class="auth-btn" onclick="doReg()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
        Создать аккаунт
      </button>
      <div class="auth-err" id="re"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sb-head">
      <div class="me-av" id="me-av" onclick="showMyProfile()" title="Мой профиль"></div>
      <div class="me-nm" id="me-nm" onclick="showMyProfile()" title="Мой профиль"></div>
      <div class="sb-acts">
        <button class="ib" title="Новый чат" onclick="goPeople()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
        <button class="ib" title="Настройки" onclick="openSett()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
      </div>
    </div>
    <div class="sb-search">
      <div class="srch-wrap">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="srch-inp" placeholder="Поиск..." oninput="filterList(this.value)">
      </div>
    </div>
    <div class="sb-tabs">
      <button class="sb-tab active" id="tab-c" onclick="switchTab('chats',this)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Чаты
      </button>
      <button class="sb-tab" id="tab-p" onclick="switchTab('people',this)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Люди
      </button>
    </div>
    <div class="chat-list" id="clist"></div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area" id="chat-area">
    <div id="no-chat" class="no-chat">
      <div class="no-chat-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
      <h3>Freedom Messenger</h3>
      <p>Выберите чат или найдите собеседника</p>
    </div>
    <div id="chat-view" style="display:none;flex-direction:column;height:100%">
      <div class="chat-hd">
        <button class="ib back-btn" onclick="closeMob()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
        </button>
        <div class="ch-av" id="ch-av" onclick="showPM(currentChat)"></div>
        <div class="ch-info" onclick="showPM(currentChat)">
          <div class="ch-name" id="ch-name"></div>
          <div class="ch-status" id="ch-status"></div>
        </div>
        <div class="ch-acts">
          <button class="ib" title="Аудиозвонок" onclick="startCall('audio')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.61 3.4 2 2 0 0 1 3.6 1.22h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L7.91 8.8a16 16 0 0 0 6 6l.94-.94a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 21.5 16c.02.32.02.64 0 .96"/></svg>
          </button>
          <button class="ib" title="Видеозвонок" onclick="startCall('video')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </button>
          <button class="ib" title="Профиль" onclick="showPM(currentChat)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
          </button>
        </div>
      </div>
      <div class="msgs" id="msgs" oncontextmenu="return false"></div>
      <div class="ibar">
        <div class="reply-strip" id="rs">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5" style="flex-shrink:0"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg>
          <div class="rs-info"><div class="rs-nm" id="rs-nm"></div><div class="rs-tx" id="rs-tx"></div></div>
          <button class="rs-x" onclick="cancelReply()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="img-strip" id="is"><img id="ithumb"><button class="img-strip-rm" onclick="rmImg()"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
        <div class="irow">
          <button class="iab" title="Прикрепить файл" onclick="document.getElementById('fi').click()">
            <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
          </button>
          <input type="file" id="fi" accept="image/*" style="display:none" onchange="handleImg(event)">
          <div class="iwrap">
            <textarea class="msg-inp" id="mi" placeholder="Написать сообщение..." rows="1" oninput="resize(this);onType()" onkeydown="mkey(event)"></textarea>
            <button class="emoji-trigger" onclick="toggleEmoji()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
            </button>
            <div class="emoji-picker" id="ep"></div>
          </div>
          <button class="mic-btn" id="mic-btn" onclick="toggleRec()" title="Голосовое сообщение">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
          </button>
          <button class="send-btn" onclick="sendMsg()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div class="sett-panel" id="sp">
  <div class="sett-hd">
    <button class="ib" onclick="closeSett()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5"/><path d="M12 5l-7 7 7 7"/></svg></button>
    <h2>Настройки</h2>
  </div>
  <div class="sett-body">
    <div class="sett-profile">
      <div class="sett-av-wrap" onclick="document.getElementById('avi').click()">
        <div class="sett-av" id="sett-av"></div>
        <div class="sett-av-badge"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
      </div>
      <input type="file" id="avi" accept="image/*" style="display:none" onchange="chgAv(event)">
      <div class="sett-uname" id="sett-un"></div>
      <div class="sett-handle" id="sett-hn"></div>
    </div>

    <div class="sett-grp">
      <div class="sett-grp-title">Аккаунт</div>
      <div class="sett-row" onclick="showMyProfile();closeSett()">
        <div class="sett-ico" style="background:var(--accent-dim);color:var(--accent)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Мой профиль</div><div class="sett-row-sub">Посмотреть свой профиль</div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
      <div class="sett-row" onclick="toggleEdit()">
        <div class="sett-ico blue"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Редактировать профиль</div><div class="sett-row-sub" id="sett-nm-sub"></div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
      <div class="sett-row">
        <div class="sett-ico purple"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">О себе</div><div class="sett-row-sub" id="sett-bio-sub">Не указано</div></div>
      </div>
    </div>

    <div class="sett-edit-form" id="sef">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:12px">Редактирование</div>
      <input class="sett-inp" id="en" placeholder="Отображаемое имя">
      <textarea class="sett-ta" id="eb" placeholder="Расскажите о себе..."></textarea>
      <div class="btn-row">
        <button class="btn-prim" onclick="saveProf()">Сохранить</button>
        <button class="btn-sec" onclick="toggleEdit()">Отмена</button>
      </div>
    </div>

    <div class="sett-grp">
      <div class="sett-grp-title">Приватность</div>
      <div class="sett-row" onclick="alert('Скоро!')">
        <div class="sett-ico green"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Последний визит</div><div class="sett-row-sub">Все пользователи</div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
      <div class="sett-row" onclick="alert('Скоро!')">
        <div class="sett-ico blue"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Фото профиля</div><div class="sett-row-sub">Все пользователи</div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
    </div>

    <div class="sett-grp">
      <div class="sett-grp-title">Внешний вид</div>
      <div class="sett-row" onclick="alert('Скоро!')">
        <div class="sett-ico yellow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Тема оформления</div><div class="sett-row-sub">Тёмная</div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
      <div class="sett-row" onclick="alert('Скоро!')">
        <div class="sett-ico green"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Уведомления</div><div class="sett-row-sub">Включены</div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
    </div>

    <div class="sett-grp">
      <div class="sett-grp-title">Безопасность</div>
      <div class="sett-row" onclick="alert('Скоро!')">
        <div class="sett-ico red"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
        <div class="sett-row-body"><div class="sett-row-label">Сменить пароль</div><div class="sett-row-sub">Рекомендуется регулярно</div></div>
        <div class="sett-row-arrow"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></div>
      </div>
    </div>

    <div class="sett-grp">
      <button class="btn-danger" onclick="doLogout()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Выйти из аккаунта
      </button>
    </div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div class="pm-over" id="pmo" onclick="if(event.target===this)closePM()">
  <div class="pm-card">
    <div class="pm-banner">
      <div class="pm-banner-grad"></div>
      <button class="ib" onclick="closePM()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.4)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="pm-body">
      <div class="pm-av-row">
        <div class="pm-av" id="pmav"></div>
        <div class="pm-status" id="pmst"></div>
      </div>
      <div class="pm-name" id="pmnm"></div>
      <div class="pm-handle" id="pmhn"></div>
      <div class="pm-bio" id="pmbio"></div>
      <div class="pm-joined" id="pm-joined"></div>
      <div class="pm-btns" id="pm-btns">
        <button class="pm-btn prim" onclick="chatFromPM()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Написать</button>
        <button class="pm-btn sec" onclick="callFromPM('audio')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.61 3.4 2 2 0 0 1 3.6 1.22h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L7.91 8.8a16 16 0 0 0 6 6l.94-.94a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 21.5 16c.02.32.02.64 0 .96"/></svg>Звонок</button>
        <button class="pm-btn sec" onclick="callFromPM('video')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>Видео</button>
      </div>
    </div>
  </div>
</div>

<!-- CALL MODAL -->
<div class="call-over" id="co">
  <div class="vid-area" id="va"><video id="remoteVideo" autoplay playsinline style="display:none"></video><video id="localVideo" autoplay muted playsinline></video></div>
  <div class="call-card">
    <div class="call-av" id="cav"></div>
    <div class="call-name" id="cnm"></div>
    <div class="call-st" id="cst"></div>
    <div class="call-timer" id="ctmr" style="display:none"></div>
    <div class="call-btns" id="cbtns"></div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lb" onclick="this.classList.remove('on')"><img id="lbi"></div>

<!-- CONTEXT MENU -->
<div class="ctx" id="ctx">
  <div class="ctx-it" onclick="ctxReply()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg>Ответить</div>
  <div class="ctx-it" onclick="ctxCopy()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Копировать</div>
  <div class="ctx-it danger" id="ctx-del" onclick="ctxDel()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>Удалить</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast" onclick="openToast()">
  <div class="toast-av" id="tav"></div>
  <div><div class="t-name" id="tnm"></div><div class="t-text" id="ttx"></div></div>
</div>

<script>
// SVG snippets
var CHK = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;
var DBLCHK = `<svg width="16" height="12" viewBox="0 0 28 14" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="2 7 7 12 14 4"/><polyline points="14 7 19 12 26 4"/></svg>`;
var PLAY_ICO = `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>`;
var PAUSE_ICO = `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`;
var EMOJIS = ['😀','😂','🥰','😍','🤔','😎','😭','😤','🥺','🤣','❤️','🔥','👍','👎','🎉','✨','💯','🙏','😊','🤗','😏','😅','🤦','🤷','💪','👀','🫡','🫂','💀','🤙','💬','🚀','🌟','🎮','🍕','🎵','🌈','🌙','⚡','🎯'];

var socket, me=null, cur=null;
var users=[], hist={}, unread={}, prev={};
var replyMsg=null, ctxMsg=null;
let tyTimer=null, typing=false;
let recorder=null, chunks=[], recInt=null;
var pc=null, stream=null;
let callInt=null, callSecs=0, callUser=null, callKind='audio';
let attachImg=null, toastTimer=null, toastUser=null, pmUser=null;

function init(){
  socket = io();
  socket.on('new_message',onMsg);
  socket.on('user_online',({username})=>setStatus(username,true));
  socket.on('user_offline',({username,lastSeen})=>setStatus(username,false,lastSeen));
  socket.on('user_updated',onUserUpd);
  socket.on('user_typing',onTypingEvt);
  socket.on('messages_read',({by})=>markRead(by));
  socket.on('message_deleted',({msgId})=>rmEl(msgId));
  socket.on('incoming_call',onInCall);
  socket.on('call_answered',onCallAns);
  socket.on('ice_candidate',({candidate})=>{try{if(pc)pc.addIceCandidate(candidate);}catch(e){}});
  socket.on('call_ended',()=>callSt('Звонок завершён',true));
  socket.on('call_rejected',()=>{callSt('Отклонено',true);try{_injectCallMsg(callUser,'missed');}catch(e){}});
  socket.on('call_busy',()=>callSt('Занято',true));
  // ── Восстановление сессии после переподключения ──
  socket.on('connect',()=>{
    if(!me){
      const saved=localStorage.getItem('userSession');
      if(saved){
        try{
          const {username,password}=JSON.parse(saved);
          socket.emit('login',{username,password},r=>{
            if(r&&!r.error)onAuth(r.user);
            else localStorage.removeItem('userSession');
          });
        }catch(e){localStorage.removeItem('userSession');}
      }
    }
  });
  // ── Применяем сохранённую тему ──
  const savedTheme=localStorage.getItem('theme')||'dark';
  document.documentElement.setAttribute('data-theme',savedTheme);
  _updateThemeUI(savedTheme);
}

// ─── ХЕЛПЕРЫ (обязательно в самом верху!) ──────────────────────────────────
var G = id => document.getElementById(id);
var E = (id, msg) => { const el = G(id); if(el){ el.textContent = msg; setTimeout(()=>el.textContent='', 4000); }};

// ─── ПЕРЕКЛЮЧЕНИЕ ВКЛАДОК АВТОРИЗАЦИИ ─────────────────────────────────────
function authTab(t){
  document.querySelectorAll('.auth-seg-btn').forEach((b,i)=>{
    b.classList.toggle('active', t==='login' ? i===0 : i===1);
  });
  G('lf').style.display = t==='login' ? 'block' : 'none';
  G('rf').style.display = t==='reg' ? 'block' : 'none';
  // Очищаем ошибки при переключении
  if(G('le')) G('le').textContent = '';
  if(G('re')) G('re').textContent = '';
}
// СТАЛО (унифицированные ID)
function doLogin(){
  const u=(document.getElementById('lu')||document.getElementById('l-user')||document.getElementById('login-username'));
  const p=(document.getElementById('lp')||document.getElementById('l-pass')||document.getElementById('login-password'));
  if(!u||!p||!u.value.trim()||!p.value)return E('le','Заполните все поля');
  socket.emit('login',{username:u.value.trim(),password:p.value},r=>{
    if(r.error)return E('le',r.error);
    localStorage.setItem('userSession',JSON.stringify({username:u.value.trim(),password:p.value}));
    onAuth(r.user);
  });
}
function doReg(){
  const n=(document.getElementById('rn')||document.getElementById('r-name')||document.getElementById('reg-displayname'));
  const u=(document.getElementById('ru')||document.getElementById('r-user')||document.getElementById('reg-username'));
  const p=(document.getElementById('rp')||document.getElementById('r-pass')||document.getElementById('reg-password'));
  if(!n||!u||!p||!n.value.trim()||!u.value.trim()||!p.value)return E('re','Заполните все поля');
  socket.emit('register',{username:u.value.trim(),password:p.value,displayName:n.value.trim()},r=>{
    if(r.error)return E('re',r.error);
    localStorage.setItem('userSession',JSON.stringify({username:u.value.trim(),password:p.value}));
    onAuth(r.user);
  });
}
function onAuth(user){
  me=user;
  G('auth-screen').style.display='none';
  G('app').classList.add('on');
  updMe(); loadUsers();
}
function doLogout(){
  socket.emit('logout');
  me=null;cur=null;users=[];hist={};unread={};prev={};
  localStorage.removeItem('userSession');
  G('app').classList.remove('on');
  G('auth-screen').style.display='flex';
  G('chat-view').style.display='none';
  G('no-chat').style.display='flex';
  closeSett();
}
// G already declared above
function V(id){return G(id).value.trim();}
// E already declared above

// Me UI
function updMe(){
  const n=me.displayName||me.username;
  G('me-nm').textContent=n;
  setAv(G('me-av'),me,'10px');
  G('sett-un').textContent=n;
  G('sett-hn').textContent='@'+me.username;
  G('sett-nm-sub').textContent=n;
  G('sett-bio-sub').textContent=me.bio||'Не указано';
  setAv(G('sett-av'),me,'20px');
}
function setAv(el,user,r='50%'){
  if(!el)return;
  el.style.borderRadius=r;
  if(user.avatar){
    el.style.background='transparent';
    el.innerHTML=`<img src="${user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:${r};display:block;">`;
  }else{
    el.style.background=col(user.username);
    el.innerHTML=`<span>${ini(user.displayName||user.username)}</span>`;
  }
}
function ini(n){return n.split(' ').slice(0,2).map(w=>w[0]?.toUpperCase()).join('')||'?';}
function col(s){const c=['#4f8ef7','#7c4dff','#e91e8c','#00bcd4','#ff6b35','#2eb872','#ff9800','#9c27b0'];let h=0;for(let ch of s)h=(h*31+ch.charCodeAt(0))%c.length;return c[h];}
function ft(ts){const d=new Date(ts),n=new Date();if(d.toDateString()===n.toDateString())return d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});if(n-d<7*864e5)return d.toLocaleDateString('ru-RU',{weekday:'short'});return d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'});}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fs(s){return`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;}

// Users
function loadUsers(){
  fetch('/api/users').then(r=>r.json()).then(u=>{users=u.filter(x=>x.username!==me.username);renderList();});
}
function switchTab(tab,btn){
  document.querySelectorAll('.sb-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  renderList(tab);
}
function goPeople(){G('tab-p').click();}
function filterList(q){
  const active=document.querySelector('.sb-tab.active').textContent.includes('Люди')?'people':'chats';
  renderList(active,q.toLowerCase());
}
function renderList(mode='chats',q=''){
  const el=G('clist');
  const f=users.filter(u=>!q||(u.displayName||u.username).toLowerCase().includes(q)||u.username.includes(q));
  if(!f.length){el.innerHTML=`<div class="empty-list"><div class="empty-list-icon"><svg width="38" height="38" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg></div><div>Никого нет</div></div>`;return;}
  let html='';
  if(mode==='chats'){
    const wm=f.filter(u=>prev[u.username]),wo=f.filter(u=>!prev[u.username]);
    if(wm.length)html+=`<div class="sec-hd">Активные</div>`;
    wm.forEach(u=>html+=ci(u));
    if(wo.length&&wm.length)html+=`<div class="sec-hd">Контакты</div>`;
    wo.forEach(u=>html+=ci(u));
  }else{
    html+=`<div class="sec-hd">Все пользователи · ${f.length}</div>`;
    f.forEach(u=>html+=ci(u));
  }
  el.innerHTML=html;
}
function ci(u){
  const p=prev[u.username],badge=(unread[u.username]||0)>0?`<div class="ubadge">${unread[u.username]}</div>`:'';
  const online=u.online?`<div class="odot"></div>`:'';
  const avC=u.avatar?`<img src="${u.avatar}">`:`<span>${ini(u.displayName||u.username)}</span>`;
  const time=p?`<span class="ci-time">${ft(p.timestamp)}</span>`:'';
  let ptx='';
  if(p)ptx=p.type==='image'?`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Фото`:p.type==='voice'?`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>Голосовое`:esc(p.content||'').slice(0,45);
  else ptx=u.online?`<span style="color:var(--green);font-size:11px">В сети</span>`:'';
  return`<div class="chat-item${cur===u.username?' active':''}" onclick="openChat('${u.username}')"><div class="ci-av" style="background:${col(u.username)}">${avC}${online}</div><div class="ci-info"><div class="ci-top"><span class="ci-name">${esc(u.displayName||u.username)}</span>${time}</div><div class="ci-bot"><span class="ci-prev">${ptx}</span>${badge}</div></div></div>`;
}

// Open Chat
function openChat(username){
  cur=username; unread[username]=0;
  const u=users.find(x=>x.username===username)||{username,displayName:username};
  const hav=G('ch-av'); hav.style.background=col(username); setAv(hav,u,'12px');
  G('ch-name').textContent=u.displayName||username;
  const st=G('ch-status'); st.textContent=u.online?'В сети':'Не в сети'; st.className='ch-status'+(u.online?' on':'');
  G('no-chat').style.display='none';
  G('chat-view').style.display='flex';
  G('chat-area').classList.add('mob');
  socket.emit('get_messages',{with:username},msgs=>{hist[username]=msgs||[];renderMsgs();scrollBot();});
  socket.emit('mark_read',{chatWith:username});
  renderList();
}
function closeMob(){G('chat-area').classList.remove('mob');}

// Render Messages
function renderMsgs(){
  const area=G('msgs'),msgs=hist[cur]||[];
  if(!msgs.length){area.innerHTML=`<div style="text-align:center;color:var(--text3);padding:48px 20px;font-size:13px">Начните переписку 👋</div>`;return;}
  let html='',lastD=null;
  msgs.forEach(m=>{
    const d=new Date(m.timestamp).toLocaleDateString('ru-RU',{day:'numeric',month:'long'});
    if(d!==lastD){html+=`<div class="date-div">${d}</div>`;lastD=d;}
    html+=bbl(m);
  });
  area.innerHTML=html;
  bindEvts(area);
}
function bbl(m){
  const out=m.from===me.username,u=users.find(x=>x.username===m.from)||{username:m.from,displayName:m.from};
  const avC=u.avatar?`<img src="${u.avatar}">`:`<span>${ini(u.displayName||u.username)}</span>`;
  const time=ft(m.timestamp),checks=out?`<span class="chk">${m.read?DBLCHK:CHK}</span>`:'';
  let reply='';
  if(m.replyTo){
    const orig=(hist[cur]||[]).find(x=>x.id===m.replyTo);
    if(orig){const rn=orig.from===me.username?'Вы':(users.find(x=>x.username===orig.from)?.displayName||orig.from);reply=`<div class="bbl-reply"><div class="bbl-rname">${rn}</div><div class="bbl-rtext">${orig.type==='image'?'Фото':orig.type==='voice'?'Голосовое':esc(orig.content||'').slice(0,60)}</div></div>`;}
  }
  let body='';
  if(m.type==='image')body=`<img class="bbl-img" src="${m.content}" alt="фото">`;
  else if(m.type==='voice'){const bars=Array.from({length:22},()=>`<span style="height:${5+Math.floor(Math.random()*16)}px"></span>`).join('');body=`<div class="voice-msg"><button class="voice-play" onclick="playV(this,'${m.content}')">${PLAY_ICO}</button><div class="voice-waves">${bars}</div><span class="voice-dur">${m.duration||'0:00'}</span></div>`;}
  else body=`<div class="bbl-text">${esc(m.content||'').replace(/\n/g,'<br>')}</div>`;
  const avEl=!out?`<div class="msg-av" style="background:${col(m.from)}">${avC}</div>`:'';
  return`<div class="mrow ${out?'out':'in'}" id="mw-${m.id}">${avEl}<div class="bubble" data-id="${m.id}" data-from="${m.from}" data-content="${esc(m.content||'')}">${reply}${body}<div class="bbl-meta">${time}${checks}</div></div></div>`;
}
function bindEvts(el){
  el.querySelectorAll('.bubble').forEach(b=>b.addEventListener('contextmenu',e=>{e.preventDefault();showCtx(e,b.dataset.id);}));
  el.querySelectorAll('.bbl-img').forEach(img=>img.addEventListener('click',()=>{G('lbi').src=img.src;G('lb').classList.add('on');}));
}
function scrollBot(){const a=G('msgs');setTimeout(()=>a.scrollTop=a.scrollHeight,40);}

// Send
function sendMsg(){
  if(!cur)return;
  if(attachImg){sendImg();return;}
  const inp=G('mi'),text=inp.value.trim();
  if(!text)return;
  const d={to:cur,content:text,type:'text'};
  if(replyMsg)d.replyTo=replyMsg.id;
  socket.emit('send_message',d,r=>{if(r?.message)pushMsg(r.message);});
  inp.value='';resize(inp);cancelReply();clearTyp();
}
function sendImg(){
  socket.emit('send_message',{to:cur,content:attachImg,type:'image',replyTo:replyMsg?.id||null},r=>{if(r?.message)pushMsg(r.message);});
  rmImg();cancelReply();
}
function pushMsg(msg){
  var activeCur=null;try{activeCur=cur||currentChat||activeChat;}catch(e){}
  if(!activeCur)return;
  // Сначала проверяем DOM — это главный источник истины, не hist
  // Раньше было наоборот: hist проверялся первым, и onMsg успевал добавить в hist
  // до вызова pushMsg, из-за чего pushMsg делал return и ничего не рисовал в DOM
  if(document.getElementById('mw-'+msg.id)){
    if(msg.read){var chkEl=document.getElementById('mw-'+msg.id);if(chkEl){var chk=chkEl.querySelector('.chk');if(chk)chk.innerHTML=DBLCHK;}}
    return;
  }
  // Синхронизируем hist
  if(!hist[activeCur])hist[activeCur]=[];
  if(!hist[activeCur].find(function(m){return m.id===msg.id;})){hist[activeCur].push(msg);}
  prev[activeCur]=msg;
  // Рисуем в DOM
  var area=G('msgs');
  if(!area)return;
  var ph=area.querySelector('[style*="Начните"]');if(ph)ph.remove();
  var d=document.createElement('div');d.innerHTML=bbl(msg);
  var el=d.firstElementChild;
  if(!el)return;
  area.appendChild(el);
  bindEvts(el.parentElement||area);scrollBot();renderList();
}
function onMsg(msg){
  const cu=msg.from===me.username?msg.to:msg.from;
  if(cu===cur){
    // pushMsg сам добавит в hist и отрисует в DOM (dedup по DOM, не hist)
    pushMsg(msg);
    socket.emit('mark_read',{chatWith:cu});
  } else {
    // Чат не открыт — просто сохраняем в hist
    if(!hist[cu])hist[cu]=[];
    if(!hist[cu].find(m=>m.id===msg.id)){hist[cu].push(msg);prev[cu]=msg;}
    if(msg.from!==me.username){unread[msg.from]=(unread[msg.from]||0)+1;showToast(msg);}
  }
  renderList();
}
function mkey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}}
function handleImg(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{attachImg=ev.target.result;G('ithumb').src=attachImg;G('is').classList.add('on');};r.readAsDataURL(f);e.target.value='';}
function rmImg(){attachImg=null;G('is').classList.remove('on');}
function resize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}

// Typing
function onType(){if(!cur)return;if(!typing){typing=true;socket.emit('typing',{to:cur,isTyping:true});}clearTimeout(tyTimer);tyTimer=setTimeout(clearTyp,2500);}
function clearTyp(){if(typing){typing=false;socket.emit('typing',{to:cur,isTyping:false});}}
function onTypingEvt({from,isTyping:t}){if(from!==cur)return;const area=G('msgs'),ex=document.getElementById('tind');if(t&&!ex){const d=document.createElement('div');d.id='tind';d.className='typing-row';d.innerHTML=`<div class="tdots"><span></span><span></span><span></span></div><span>печатает...</span>`;area.appendChild(d);scrollBot();}else if(!t&&ex)ex.remove();}

// Reply/Delete
function cancelReply(){replyMsg=null;G('rs').classList.remove('on');}
function rmEl(id){G('mw-'+id)?.remove();}
function markRead(by){if(by!==cur)return;(hist[cur]||[]).forEach(m=>{if(m.from===me.username)m.read=true;});renderMsgs();}

// Context
function showCtx(e,id){ctxMsg=(hist[cur]||[]).find(m=>m.id===id);const c=G('ctx');c.style.left=Math.min(e.clientX,window.innerWidth-200)+'px';c.style.top=Math.min(e.clientY,window.innerHeight-130)+'px';c.classList.add('on');G('ctx-del').style.display=ctxMsg?.from===me.username?'':'none';}
document.addEventListener('click',()=>G('ctx').classList.remove('on'));
function ctxReply(){if(!ctxMsg)return;replyMsg=ctxMsg;const n=ctxMsg.from===me.username?'Вы':(users.find(u=>u.username===ctxMsg.from)?.displayName||ctxMsg.from);G('rs-nm').textContent=n;G('rs-tx').textContent=ctxMsg.type==='image'?'Фото':ctxMsg.type==='voice'?'Голосовое':ctxMsg.content?.slice(0,80);G('rs').classList.add('on');G('mi').focus();}
function ctxCopy(){if(ctxMsg?.content)navigator.clipboard.writeText(ctxMsg.content).catch(()=>{});}
function ctxDel(){if(!ctxMsg)return;socket.emit('delete_message',{msgId:ctxMsg.id,chatWith:cur},r=>{if(r?.ok){hist[cur]=(hist[cur]||[]).filter(m=>m.id!==ctxMsg.id);rmEl(ctxMsg.id);}});}

// Emoji
function toggleEmoji(){const p=G('ep');if(!p.innerHTML)p.innerHTML=`<div class="emoji-grid">${EMOJIS.map(e=>`<div class="emoji-it" onclick="insEmoji('${e}')">${e}</div>`).join('')}</div>`;p.classList.toggle('on');}
function insEmoji(e){const inp=G('mi'),pos=inp.selectionStart;inp.value=inp.value.slice(0,pos)+e+inp.value.slice(pos);inp.selectionStart=inp.selectionEnd=pos+e.length;inp.focus();G('ep').classList.remove('on');}
document.addEventListener('click',e=>{if(!e.target.closest('.iwrap'))G('ep')?.classList.remove('on');});

// Voice
async function toggleRec(){
  if(recorder&&recorder.state==='recording'){recorder.stop();return;}
  try{
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    recorder=new MediaRecorder(s);chunks=[];let sec=0;
    const btn=G('mic-btn');btn.classList.add('rec');
    recInt=setInterval(()=>{sec++;btn.title=`Запись: ${fs(sec)}`;},1000);
    recorder.ondataavailable=e=>chunks.push(e.data);
    recorder.onstop=()=>{
      clearInterval(recInt);btn.classList.remove('rec');btn.title='Голосовое сообщение';
      const blob=new Blob(chunks,{type:'audio/webm'});const r=new FileReader();
      r.onload=ev=>{socket.emit('send_message',{to:cur,content:ev.target.result,type:'voice',duration:fs(sec),replyTo:replyMsg?.id||null},res=>{if(res?.message)pushMsg(res.message);});};
      r.readAsDataURL(blob);s.getTracks().forEach(t=>t.stop());cancelReply();
    };
    recorder.start();
  }catch(e){alert('Нет доступа к микрофону');}
}
function playV(btn,src){const a=new Audio(src);btn.innerHTML=PAUSE_ICO;a.play();a.onended=()=>{btn.innerHTML=PLAY_ICO;};}

// Status
function setStatus(username,online){const u=users.find(x=>x.username===username);if(u)u.online=online;if(cur===username){const s=G('ch-status');s.textContent=online?'В сети':'Не в сети';s.className='ch-status'+(online?' on':'');}renderList();}
function onUserUpd({username,displayName,avatar}){const u=users.find(x=>x.username===username);if(u){u.displayName=displayName;u.avatar=avatar;}if(username===me.username){me.displayName=displayName;me.avatar=avatar;updMe();}renderList();}

// Settings
function openSett(){G('sp').classList.add('on');G('sef').classList.remove('on');}
function closeSett(){G('sp').classList.remove('on');}
function toggleEdit(){
  const f=G('sef');
  if(!f.classList.contains('on')){G('en').value=me.displayName||'';G('eb').value=me.bio||'';f.classList.add('on');}
  else f.classList.remove('on');
}
function saveProf(){
  const n=G('en').value.trim(),b=G('eb').value.trim();
  socket.emit('update_profile',{displayName:n,bio:b},r=>{if(r?.ok){me=r.user;updMe();G('sef').classList.remove('on');}});
}
function chgAv(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{fetch('/api/avatar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:me.username,avatar:ev.target.result})}).then(()=>{me.avatar=ev.target.result;updMe();});};r.readAsDataURL(f);e.target.value='';}

// Profile Modal
function showPM(username){
  if(!username)return;
  var isSelf = me && username === me.username;
  var u = isSelf ? me : (users.find(x=>x.username===username)||{username,displayName:username});
  pmUser=username;
  const av=G('pmav');av.style.background=col(username);setAv(av,u,'16px');
  G('pmnm').textContent=u.displayName||username;
  G('pmhn').textContent='@'+username;
  const st=G('pmst');
  if(isSelf){
    st.textContent='Это вы';st.className='pm-status on';
  } else {
    st.textContent=u.online?'В сети':'Не в сети';st.className='pm-status '+(u.online?'on':'off');
  }
  G('pmbio').textContent=u.bio||'Нет описания';
  // Joined date
  const jEl=G('pm-joined');
  if(jEl){
    var dateStr='';
    var rawDate=u.createdAt||u.joinedAt||u.registeredAt||null;
    if(rawDate){var d=new Date(rawDate);dateStr=d.toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});}
    jEl.innerHTML=dateStr?'<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Зарегистрирован: '+dateStr:'';
    jEl.style.display=dateStr?'flex':'none';
  }
  // Hide/show action buttons for own profile
  const btns=G('pm-btns');
  if(btns){
    if(isSelf){
      btns.innerHTML='<button class="pm-btn prim" onclick="closePM();openSett()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Редактировать</button>';
    } else {
      btns.innerHTML='<button class="pm-btn prim" onclick="chatFromPM()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Написать</button><button class="pm-btn sec" onclick="callFromPM(\'audio\')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.61 3.4 2 2 0 0 1 3.6 1.22h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L7.91 8.8a16 16 0 0 0 6 6l.94-.94a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 21.5 16c.02.32.02.64 0 .96"/></svg>Звонок</button><button class="pm-btn sec" onclick="callFromPM(\'video\')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>Видео</button>';
    }
  }
  G('pmo').classList.add('on');
}
function showMyProfile(){if(me)showPM(me.username);}
function closePM(){G('pmo').classList.remove('on');}
function chatFromPM(){closePM();openChat(pmUser);}
function callFromPM(t){closePM();openChat(pmUser);setTimeout(()=>startCall(t),300);}

// Toast
function showToast(msg){const u=users.find(x=>x.username===msg.from)||{username:msg.from,displayName:msg.from};toastUser=msg.from;const av=G('tav');av.style.background=col(msg.from);av.style.borderRadius='11px';setAv(av,u,'11px');G('tnm').textContent=u.displayName||u.username;G('ttx').textContent=msg.type==='image'?'Фото':msg.type==='voice'?'Голосовое':(msg.content||'').slice(0,60);const t=G('toast');t.classList.add('on');clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('on'),4500);}
function openToast(){G('toast').classList.remove('on');if(toastUser)openChat(toastUser);}

// Calls
const ICE={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
async function startCall(type){
  if(!cur)return;callKind=type;callUser=cur;
  const u=users.find(x=>x.username===cur)||{username:cur};
  showCallUI(u,type,'out');
  try{
    stream=await navigator.mediaDevices.getUserMedia(type==='video'?{video:true,audio:true}:{audio:true});
    if(type==='video'){G('localVideo').srcObject=stream;G('va').classList.add('on');}
    pc=new RTCPeerConnection(ICE);stream.getTracks().forEach(t=>pc.addTrack(t,stream));
    pc.ontrack=function(e){
      // Show remote video (caller side)
      var rv=G('remoteVideo');
      if(rv){rv.style.display='block';rv.srcObject=e.streams[0];if(type==='video')G('va').classList.add('on');}
      // Dedicated audio element guarantees sound for both audio and video calls
      var ra=document.getElementById('remoteAudio');
      if(!ra){ra=document.createElement('audio');ra.id='remoteAudio';ra.autoplay=true;ra.style.display='none';document.body.appendChild(ra);}
      ra.srcObject=e.streams[0];
    };
    pc.onicecandidate=e=>{if(e.candidate)socket.emit('ice_candidate',{to:callUser,candidate:e.candidate});};
    const offer=await pc.createOffer();await pc.setLocalDescription(offer);
    socket.emit('call_user',{to:callUser,offer,callType:type});
  }catch(e){endCall();alert('Нет доступа к камере/микрофону');}
}
function onInCall({from,offer,callType:ct}){callUser=from;callKind=ct;showCallUI(users.find(x=>x.username===from)||{username:from},ct,'in',offer);}
async function acceptCall(offer){
  try{
    stream=await navigator.mediaDevices.getUserMedia(callKind==='video'?{video:true,audio:true}:{audio:true});
    if(callKind==='video'){G('localVideo').srcObject=stream;G('va').classList.add('on');}
    pc=new RTCPeerConnection(ICE);stream.getTracks().forEach(t=>pc.addTrack(t,stream));
    pc.ontrack=function(e){
      var rv=G('remoteVideo');
      if(rv){rv.style.display='block';rv.srcObject=e.streams[0];}
      var ra=document.getElementById('remoteAudio');
      if(!ra){ra=document.createElement('audio');ra.id='remoteAudio';ra.autoplay=true;ra.style.display='none';document.body.appendChild(ra);}
      ra.srcObject=e.streams[0];
    };
    pc.onicecandidate=e=>{if(e.candidate)socket.emit('ice_candidate',{to:callUser,candidate:e.candidate});};
    await pc.setRemoteDescription(offer);const answer=await pc.createAnswer();await pc.setLocalDescription(answer);
    socket.emit('call_answer',{to:callUser,answer});startCallTimer();
  }catch(e){endCall();}
}
async function onCallAns({answer}){try{await pc.setRemoteDescription(answer);startCallTimer();showCallUI(users.find(x=>x.username===callUser)||{username:callUser},callKind,'active');}catch(e){}}
function endCall(){socket.emit('call_end',{to:callUser});cleanCall();}
function rejectCall(){socket.emit('call_reject',{to:callUser});cleanCall();}
function cleanCall(){pc?.close();pc=null;stream?.getTracks().forEach(t=>t.stop());stream=null;clearInterval(callInt);callSecs=0;G('ctmr').style.display='none';G('va').classList.remove('on');G('co').classList.remove('on');
  var rv=G('remoteVideo');if(rv){rv.srcObject=null;rv.style.display='none';}
  var ra=document.getElementById('remoteAudio');if(ra){ra.srcObject=null;}
  window._inCall=false;}
function callSt(msg,close){G('cst').textContent=msg;if(close)setTimeout(cleanCall,2000);}
function startCallTimer(){callSecs=0;const el=G('ctmr');el.style.display='block';callInt=setInterval(()=>{callSecs++;el.textContent=fs(callSecs);},1000);}
var PHONE_ICO=`<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1-9.4 0-17-7.6-17-17 0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z"/></svg>`;
function showCallUI(u,type,mode,offer){
  const av=G('cav');av.style.background=col(u.username);setAv(av,u,'22px');
  G('cnm').textContent=u.displayName||u.username;
  const tl=type==='video'?'Видеозвонок':'Аудиозвонок';
  let st='',btns='';
  if(mode==='out'){
    st=tl+' · Исходящий...';
    btns=`<div class="call-btn-wrap"><button class="cbtn end-call" onclick="endCall()">${PHONE_ICO}</button><span>Завершить</span></div>`;
  }else if(mode==='in'){
    st='Входящий '+tl.toLowerCase();
    G('cst').textContent=st;
    G('cbtns').innerHTML=`<div class="call-btn-wrap"><button class="cbtn decline" onclick="rejectCall()">${PHONE_ICO}</button><span>Отклонить</span></div><div class="call-btn-wrap"><button id="acc-btn" class="cbtn accept">${PHONE_ICO}</button><span>Принять</span></div>`;
    G('co').classList.add('on');
    G('acc-btn').onclick=()=>acceptCall(offer);return;
  }else{
    st=tl;G('ctmr').style.display='block';
    btns=`<div class="call-btn-wrap"><button class="cbtn neutral" id="cbmute" onclick="tMute(this)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></button><span>Микрофон</span></div><div class="call-btn-wrap"><button class="cbtn end-call" onclick="endCall()">${PHONE_ICO}</button><span>Завершить</span></div>${type==='video'?`<div class="call-btn-wrap"><button class="cbtn neutral" id="cbcam" onclick="tCam(this)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg></button><span>Камера</span></div>`:''}`;
  }
  G('cst').textContent=st;G('cbtns').innerHTML=btns;G('co').classList.add('on');
}
function tMute(btn){if(!stream)return;const t=stream.getAudioTracks()[0];t.enabled=!t.enabled;btn.classList.toggle('muted',!t.enabled);}
function tCam(btn){if(!stream)return;const t=stream.getVideoTracks()[0];t.enabled=!t.enabled;btn.classList.toggle('muted',!t.enabled);}

// ── Вспомогательная для UI темы ──
function _updateThemeUI(t){
  const sub=G('theme-sub');
  if(sub)sub.textContent=t==='dark'?'Тёмная':'Светлая';
  const ico=G('theme-ico');
  if(ico){
    if(t==='light'){
      ico.innerHTML=`<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>`;
    }else{
      ico.innerHTML=`<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>`;
    }
  }
}

// ── Переключение темы ──
function toggleTheme(){
  const current=document.documentElement.getAttribute('data-theme')||'dark';
  const next=current==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',next);
  localStorage.setItem('theme',next);
  _updateThemeUI(next);
}

// ── Смена пароля ──
function openChangePwd(){
  G('pwd-modal').classList.add('on');
  G('pwd-old').value='';G('pwd-new').value='';G('pwd-new2').value='';
  G('pwd-err').textContent='';G('pwd-ok').textContent='';
}
function closePwdModal(){G('pwd-modal').classList.remove('on');}
function submitPwd(){
  const oldP=G('pwd-old').value,newP=G('pwd-new').value,newP2=G('pwd-new2').value;
  if(!oldP||!newP||!newP2)return G('pwd-err').textContent='Заполните все поля';
  if(newP!==newP2)return G('pwd-err').textContent='Новые пароли не совпадают';
  if(newP.length<6)return G('pwd-err').textContent='Минимум 6 символов';
  G('pwd-err').textContent='';
  socket.emit('change_password',{oldPassword:oldP,newPassword:newP},r=>{
    if(r?.error)return G('pwd-err').textContent=r.error;
    G('pwd-ok').textContent='Пароль успешно изменён!';
    // Обновляем сохранённую сессию с новым паролем
    try{const s=JSON.parse(localStorage.getItem('userSession')||'{}');s.password=newP;localStorage.setItem('userSession',JSON.stringify(s));}catch(e){}
    setTimeout(closePwdModal,1500);
  });
}

// ── Настройки приватности ──
function savePriv(key,val){
  const priv={...me.privacy,[key]:val};
  socket.emit('update_profile',{privacy:priv},r=>{if(r?.ok){me.privacy=r.user.privacy;}});
}

// ── Уведомления ──
function toggleNotif(checked){
  const sub=G('notif-sub');
  if(checked){
    // Request browser permission when enabling
    if('Notification' in window && Notification.permission !== 'granted'){
      Notification.requestPermission().then(perm=>{
        const granted = perm === 'granted';
        if(!granted){
          // Reverted - permission denied
          const chk=G('notif-chk');if(chk)chk.checked=false;
          if(sub)sub.textContent='Выключены';
          localStorage.setItem('notif','0');
          alert('Разрешение на уведомления отклонено. Разрешите их в настройках браузера.');
          return;
        }
        if(sub)sub.textContent='Включены';
        localStorage.setItem('notif','1');
      });
      return;
    }
  }
  if(sub)sub.textContent=checked?'Включены':'Выключены';
  localStorage.setItem('notif',checked?'1':'0');
}
if(typeof init==="function") init(); else if(typeof connectSocket==="function") connectSocket();
</script>
<!-- STYLE-DISABLED 
.auth-box {
  width:380px; background:var(--sidebar); border:1px solid var(--border);
  border-radius:20px; padding:36px 32px; box-shadow:0 24px 60px rgba(0,0,0,0.5);
}
.auth-logo { text-align:center; margin-bottom:28px; }
.auth-logo .logo-icon { font-size:48px; margin-bottom:8px; }
.auth-logo h1 { font-size:28px; font-weight:700; letter-spacing:-0.5px; }
.auth-logo p { color:var(--text2); font-size:13px; margin-top:4px; }
.auth-tabs { display:flex; gap:4px; background:var(--bg); border-radius:10px; padding:4px; margin-bottom:24px; }
.auth-tab {
  flex:1; padding:8px; border:none; background:none; color:var(--text2);
  border-radius:8px; cursor:pointer; font-size:13px; font-weight:500; transition:all .2s;
}
.auth-tab.active { background:var(--accent); color:#fff; }
.form-group { margin-bottom:14px; }
.form-group label { display:block; font-size:12px; color:var(--text2); margin-bottom:6px; font-weight:500; }
.form-group input {
  width:100%; padding:10px 14px; background:var(--surface);
  border:1px solid var(--border); border-radius:10px; color:var(--text);
  font-family:'Inter',sans-serif; font-size:14px; outline:none; transition:border-color .2s;
}
.form-group input:focus { border-color:var(--accent); }
.btn {
  width:100%; padding:11px; background:var(--accent); border:none; border-radius:10px;
  color:#fff; font-size:14px; font-weight:600; cursor:pointer; transition:background .2s;
  font-family:'Inter',sans-serif; margin-top:4px;
}
.btn:hover { background:var(--accent-hover); }
.btn-danger { background:var(--danger); }
.btn-danger:hover { background:#ff6b6b; }
.btn-ghost {
  background:none; border:1px solid var(--border); color:var(--text2);
  margin-top:8px;
}
.btn-ghost:hover { background:var(--surface); color:var(--text); }
.auth-error { color:var(--danger); font-size:12px; text-align:center; margin-top:10px; min-height:18px; }

/* ── MAIN LAYOUT ── */
#app { display:none; height:100vh; flex-direction:column; }
#app.visible { display:flex; }
.app-body { display:flex; flex:1; overflow:hidden; }

/* ── SIDEBAR ── */
.sidebar {
  width:300px; background:var(--sidebar); border-right:1px solid var(--border);
  display:flex; flex-direction:column; flex-shrink:0;
}
.sidebar-header {
  padding:12px 14px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:10px;
}
.sidebar-header .my-avatar {
  width:36px; height:36px; border-radius:50%; background:var(--accent);
  display:flex; align-items:center; justify-content:center; font-weight:700;
  font-size:14px; cursor:pointer; flex-shrink:0; overflow:hidden;
}
.sidebar-header .my-avatar img { width:100%; height:100%; object-fit:cover; }
.sidebar-header .my-name { font-weight:600; font-size:14px; flex:1; cursor:pointer; }
.sidebar-header .my-name:hover { color:var(--accent); }
.icon-btn {
  width:32px; height:32px; border:none; background:none; color:var(--text2);
  border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:16px; transition:all .2s;
}
.icon-btn:hover { background:var(--surface); color:var(--text); }

.sidebar-search { padding:10px 14px; border-bottom:1px solid var(--border); }
.search-input {
  width:100%; padding:8px 12px; background:var(--surface);
  border:1px solid var(--border); border-radius:20px; color:var(--text);
  font-family:'Inter',sans-serif; font-size:13px; outline:none;
}
.search-input:focus { border-color:var(--accent); }

.sidebar-tabs { display:flex; border-bottom:1px solid var(--border); }
.sidebar-tab {
  flex:1; padding:10px; border:none; background:none; color:var(--text2);
  cursor:pointer; font-size:12px; font-weight:500; border-bottom:2px solid transparent;
  transition:all .2s;
}
.sidebar-tab.active { color:var(--accent); border-bottom-color:var(--accent); }

.chat-list { flex:1; overflow-y:auto; }
.chat-list::-webkit-scrollbar { width:4px; }
.chat-list::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

.chat-item {
  display:flex; align-items:center; gap:12px; padding:10px 14px;
  cursor:pointer; transition:background .15s; position:relative;
}
.chat-item:hover { background:var(--surface); }
.chat-item.active { background:var(--surface2); }

.chat-avatar {
  width:44px; height:44px; border-radius:50%; background:var(--accent);
  display:flex; align-items:center; justify-content:center; font-weight:700;
  font-size:16px; flex-shrink:0; position:relative; overflow:hidden;
}
.chat-avatar img { width:100%; height:100%; object-fit:cover; }
.online-dot {
  position:absolute; bottom:1px; right:1px; width:12px; height:12px;
  background:var(--accent2); border-radius:50%; border:2px solid var(--sidebar);
}
.chat-info { flex:1; min-width:0; }
.chat-name { font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.chat-preview { color:var(--text2); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px; }
.chat-meta { display:flex; flex-direction:column; align-items:flex-end; gap:4px; flex-shrink:0; }
.chat-time { color:var(--text3); font-size:11px; }
.unread-badge {
  background:var(--accent); color:#fff; font-size:11px; font-weight:600;
  border-radius:10px; padding:1px 6px; min-width:18px; text-align:center;
}

.empty-state { padding:40px 20px; text-align:center; color:var(--text2); font-size:13px; }
.empty-state .empty-icon { font-size:40px; margin-bottom:12px; opacity:0.5; }

/* ── MAIN CHAT AREA ── */
.chat-area {
  flex:1; display:flex; flex-direction:column; background:var(--bg);
}

.no-chat {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  color:var(--text2);
}
.no-chat .big-icon { font-size:80px; margin-bottom:16px; opacity:0.3; }
.no-chat h2 { font-size:20px; font-weight:600; margin-bottom:8px; }
.no-chat p { font-size:13px; opacity:0.7; }

.chat-header {
  display:flex; align-items:center; gap:12px; padding:12px 16px;
  border-bottom:1px solid var(--border); background:var(--sidebar);
}
.chat-header .back-btn { display:none; }
.chat-header-avatar {
  width:38px; height:38px; border-radius:50%; background:var(--accent);
  display:flex; align-items:center; justify-content:center; font-weight:700;
  font-size:14px; cursor:pointer; overflow:hidden; position:relative;
}
.chat-header-avatar img { width:100%; height:100%; object-fit:cover; }
.chat-header-info { flex:1; cursor:pointer; }
.chat-header-name { font-weight:600; font-size:15px; }
.chat-header-status { font-size:12px; color:var(--text2); margin-top:1px; }
.chat-header-status.online { color:var(--accent2); }
.chat-header-actions { display:flex; gap:4px; }

.messages-area {
  flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:4px;
}
.messages-area::-webkit-scrollbar { width:4px; }
.messages-area::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

.date-divider {
  text-align:center; margin:12px 0; color:var(--text3); font-size:12px;
  display:flex; align-items:center; gap:8px;
}
.date-divider::before, .date-divider::after {
  content:''; flex:1; height:1px; background:var(--border);
}

.msg-wrap { display:flex; align-items:flex-end; gap:8px; max-width:72%; }
.msg-wrap.out { align-self:flex-end; flex-direction:row-reverse; }
.msg-wrap.in { align-self:flex-start; }

.msg-avatar-small {
  width:28px; height:28px; border-radius:50%; background:var(--accent);
  display:flex; align-items:center; justify-content:center; font-weight:700;
  font-size:11px; flex-shrink:0; overflow:hidden;
}
.msg-avatar-small img { width:100%; height:100%; object-fit:cover; }

.bubble {
  padding:8px 12px; border-radius:16px; max-width:100%; word-break:break-word;
  position:relative; line-height:1.5;
}
.out .bubble { background:var(--bubble-out); border-bottom-right-radius:4px; }
.in .bubble { background:var(--bubble-in); border-bottom-left-radius:4px; }

.bubble-reply {
  background:rgba(255,255,255,0.07); border-left:3px solid var(--accent);
  border-radius:8px; padding:4px 8px; margin-bottom:6px; font-size:12px; color:var(--text2);
}
.bubble-reply .reply-name { font-weight:600; color:var(--accent); font-size:11px; margin-bottom:2px; }

.bubble-text { font-size:14px; }
.bubble-time {
  font-size:11px; color:rgba(255,255,255,0.4); margin-top:4px;
  display:flex; align-items:center; gap:4px; justify-content:flex-end;
}
.bubble-time .read-icon { color:var(--accent2); }

.bubble img.msg-image {
  max-width:280px; max-height:280px; border-radius:10px; display:block; cursor:pointer;
}

.voice-bubble {
  display:flex; align-items:center; gap:10px; min-width:180px; padding:8px 12px;
}
.voice-play-btn {
  width:34px; height:34px; border-radius:50%; background:var(--accent);
  border:none; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center;
  font-size:14px; flex-shrink:0;
}
.voice-wave { flex:1; height:28px; display:flex; align-items:center; gap:2px; }
.voice-wave span {
  display:inline-block; width:3px; background:rgba(255,255,255,0.4);
  border-radius:2px; animation: none;
}
.voice-duration { font-size:11px; color:var(--text2); }

.typing-indicator { display:flex; align-items:center; gap:8px; padding:4px 0; color:var(--text2); font-size:13px; }
.typing-dots { display:flex; gap:3px; }
.typing-dots span {
  width:6px; height:6px; background:var(--text2); border-radius:50%;
  animation: bounce 1.2s infinite;
}
.typing-dots span:nth-child(2) { animation-delay:.2s; }
.typing-dots span:nth-child(3) { animation-delay:.4s; }
@keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }

/* Context menu */
.ctx-menu {
  position:fixed; background:var(--surface2); border:1px solid var(--border);
  border-radius:12px; padding:4px; box-shadow:0 8px 24px rgba(0,0,0,0.4);
  z-index:1000; min-width:160px; display:none;
}
.ctx-menu.show { display:block; }
.ctx-item {
  display:flex; align-items:center; gap:8px; padding:8px 12px;
  border-radius:8px; cursor:pointer; font-size:13px; transition:background .15s;
}
.ctx-item:hover { background:var(--surface); }
.ctx-item.danger { color:var(--danger); }

/* ── INPUT AREA ── */
.input-area {
  padding:12px 16px; border-top:1px solid var(--border); background:var(--sidebar);
}
.reply-preview {
  display:none; background:var(--surface); border-left:3px solid var(--accent);
  border-radius:8px; padding:6px 10px; margin-bottom:8px;
  flex-direction:row; align-items:center; gap:8px;
}
.reply-preview.show { display:flex; }
.reply-preview .rp-text { flex:1; font-size:12px; color:var(--text2); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.reply-preview .rp-name { font-weight:600; color:var(--accent); font-size:11px; }
.reply-close { border:none; background:none; color:var(--text2); cursor:pointer; font-size:16px; }

.input-row { display:flex; align-items:flex-end; gap:8px; }
.attach-btn, .emoji-btn {
  width:38px; height:38px; border:none; background:none; color:var(--text2);
  border-radius:50%; cursor:pointer; font-size:18px; display:flex; align-items:center;
  justify-content:center; transition:all .2s; flex-shrink:0;
}
.attach-btn:hover, .emoji-btn:hover { background:var(--surface); color:var(--text); }
.msg-input {
  flex:1; background:var(--surface); border:1px solid var(--border); border-radius:20px;
  padding:9px 16px; color:var(--text); font-family:'Inter',sans-serif; font-size:14px;
  outline:none; resize:none; max-height:120px; transition:border-color .2s; line-height:1.4;
}
.msg-input:focus { border-color:var(--accent); }
.msg-input::placeholder { color:var(--text3); }
.send-btn {
  width:38px; height:38px; border:none; background:var(--accent); color:#fff;
  border-radius:50%; cursor:pointer; font-size:18px; display:flex; align-items:center;
  justify-content:center; transition:all .2s; flex-shrink:0;
}
.send-btn:hover { background:var(--accent-hover); transform:scale(1.05); }
.mic-btn {
  width:38px; height:38px; border:none; background:var(--surface); color:var(--text2);
  border-radius:50%; cursor:pointer; font-size:16px; display:flex; align-items:center;
  justify-content:center; transition:all .2s; flex-shrink:0;
}
.mic-btn:hover { background:var(--accent); color:#fff; }
.mic-btn.recording { background:var(--danger); color:#fff; animation:pulse 1s infinite; }
@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

/* ── CALL MODAL ── */
.call-modal {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85);
  z-index:500; flex-direction:column; align-items:center; justify-content:center;
}
.call-modal.show { display:flex; }
.call-box {
  background:var(--sidebar); border:1px solid var(--border); border-radius:24px;
  padding:40px 48px; text-align:center; min-width:300px;
}
.call-avatar-big {
  width:90px; height:90px; border-radius:50%; background:var(--accent);
  display:flex; align-items:center; justify-content:center; font-size:36px;
  font-weight:700; margin:0 auto 16px; overflow:hidden; position:relative;
}
.call-avatar-big img { width:100%; height:100%; object-fit:cover; }
.call-name { font-size:22px; font-weight:700; margin-bottom:8px; }
.call-status { color:var(--text2); font-size:14px; margin-bottom:32px; }
.call-actions { display:flex; gap:16px; justify-content:center; }
.call-btn {
  width:60px; height:60px; border-radius:50%; border:none; cursor:pointer;
  font-size:24px; display:flex; align-items:center; justify-content:center; transition:all .2s;
}
.call-btn:hover { transform:scale(1.08); }
.call-btn.accept { background:#1db954; color:#fff; }
.call-btn.reject { background:var(--danger); color:#fff; }
.call-btn.end { background:var(--danger); color:#fff; }
.call-btn.mute { background:var(--surface2); color:var(--text); }
.call-btn.speaker { background:var(--surface2); color:var(--text); }
.call-btn.cam { background:var(--surface2); color:var(--text); }
.call-timer { font-size:32px; font-weight:700; letter-spacing:2px; margin-bottom:8px; }

/* Video */
.video-area {
  display:none; width:100%; max-width:600px; border-radius:16px; overflow:hidden;
  background:#000; margin-bottom:20px; position:relative;
}
.video-area.show { display:block; }
#remoteVideo { width:100%; max-height:300px; object-fit:cover; background:#111; }
#localVideo {
  position:absolute; bottom:8px; right:8px; width:100px; height:75px;
  border-radius:8px; object-fit:cover; border:2px solid var(--accent); background:#222;
}

/* ── SETTINGS PANEL ── */
.settings-panel {
  position:fixed; top:0; right:-400px; width:400px; height:100vh;
  background:var(--sidebar); border-left:1px solid var(--border);
  z-index:200; transition:right .3s ease; overflow-y:auto; display:flex; flex-direction:column;
}
.settings-panel.open { right:0; }
.settings-panel::-webkit-scrollbar { width:4px; }
.settings-panel::-webkit-scrollbar-thumb { background:var(--border); }
.settings-header {
  padding:16px 20px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
}
.settings-header h2 { font-size:18px; font-weight:700; flex:1; }
.settings-body { padding:20px; flex:1; }
.settings-avatar-section { text-align:center; margin-bottom:24px; }
.settings-avatar {
  width:80px; height:80px; border-radius:50%; background:var(--accent);
  display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:700;
  margin:0 auto 12px; cursor:pointer; overflow:hidden; position:relative; border:3px solid var(--border);
}
.settings-avatar:hover::after {
  content:'📷'; position:absolute; inset:0; background:rgba(0,0,0,0.6);
  display:flex; align-items:center; justify-content:center; font-size:24px;
  border-radius:50%;
}
.settings-avatar img { width:100%; height:100%; object-fit:cover; }
.settings-username { font-size:18px; font-weight:700; }
.settings-handle { font-size:13px; color:var(--text2); margin-top:2px; }

.settings-section { margin-bottom:24px; }
.settings-section-title {
  font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:1.5px;
  color:var(--text3); margin-bottom:12px;
}
.settings-row {
  background:var(--surface); border-radius:12px; margin-bottom:2px; overflow:hidden;
}
.settings-item {
  display:flex; align-items:center; gap:12px; padding:12px 16px;
  cursor:pointer; transition:background .15s; border-bottom:1px solid var(--border);
}
.settings-item:last-child { border-bottom:none; }
.settings-item:hover { background:var(--surface2); }
.settings-item-icon { font-size:18px; width:24px; text-align:center; }
.settings-item-text { flex:1; }
.settings-item-label { font-size:14px; font-weight:500; }
.settings-item-sub { font-size:12px; color:var(--text2); margin-top:2px; }
.settings-item-arrow { color:var(--text3); font-size:12px; }

.settings-input {
  width:100%; background:var(--surface); border:1px solid var(--border); border-radius:10px;
  padding:10px 14px; color:var(--text); font-family:'Inter',sans-serif; font-size:14px;
  outline:none; margin-bottom:10px;
}
.settings-input:focus { border-color:var(--accent); }
.settings-textarea {
  width:100%; background:var(--surface); border:1px solid var(--border); border-radius:10px;
  padding:10px 14px; color:var(--text); font-family:'Inter',sans-serif; font-size:14px;
  outline:none; resize:none; height:80px; margin-bottom:10px;
}
.settings-textarea:focus { border-color:var(--accent); }

/* ── USER PROFILE MODAL ── */
.profile-modal {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);
  z-index:300; align-items:center; justify-content:center;
}
.profile-modal.show { display:flex; }
.profile-box {
  background:var(--sidebar); border:1px solid var(--border); border-radius:20px;
  width:340px; overflow:hidden;
}
.profile-cover { height:100px; background:linear-gradient(135deg, var(--accent), #7c4dff); }
.profile-content { padding:0 20px 20px; }
.profile-avatar-wrap { margin-top:-40px; margin-bottom:12px; }
.profile-avatar-wrap .pa {
  width:80px; height:80px; border-radius:50%; background:var(--accent);
  display:flex; align-items:center; justify-content:center; font-size:30px; font-weight:700;
  border:3px solid var(--sidebar); overflow:hidden;
}
.profile-avatar-wrap .pa img { width:100%; height:100%; object-fit:cover; }
.profile-name { font-size:20px; font-weight:700; }
.profile-handle { color:var(--text2); font-size:13px; margin:3px 0 12px; }
.profile-bio { color:var(--text2); font-size:13px; line-height:1.5; margin-bottom:16px; }
.profile-actions { display:flex; gap:8px; }
.profile-actions button {
  flex:1; padding:9px; border-radius:10px; border:none; cursor:pointer;
  font-size:13px; font-weight:600; font-family:'Inter',sans-serif; transition:all .2s;
}
.btn-msg { background:var(--accent); color:#fff; }
.btn-msg:hover { background:var(--accent-hover); }
.btn-audio { background:var(--surface2); color:var(--text); }
.btn-audio:hover { background:var(--surface); }
.btn-video { background:var(--surface2); color:var(--text); }
.btn-video:hover { background:var(--surface); }
.profile-close { position:absolute; top:12px; right:12px; }

/* Image lightbox */
.lightbox {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9);
  z-index:600; align-items:center; justify-content:center;
}
.lightbox.show { display:flex; }
.lightbox img { max-width:90vw; max-height:90vh; border-radius:8px; }

/* Notification toast */
.toast {
  position:fixed; bottom:20px; right:20px; background:var(--surface2);
  border:1px solid var(--border); border-radius:12px; padding:12px 16px;
  z-index:700; transform:translateY(80px); opacity:0; transition:all .3s;
  display:flex; align-items:center; gap:10px; max-width:320px; cursor:pointer;
}
.toast.show { transform:translateY(0); opacity:1; }
.toast-avatar {
  width:36px; height:36px; border-radius:50%; background:var(--accent);
  display:flex; align-items:center; justify-content:center; font-weight:700; font-size:13px;
  flex-shrink:0;
}
.toast-text { flex:1; }
.toast-name { font-weight:600; font-size:13px; }
.toast-msg { color:var(--text2); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* Emoji picker */
.emoji-picker {
  display:none; position:absolute; bottom:60px; left:16px;
  background:var(--surface2); border:1px solid var(--border); border-radius:14px;
  padding:10px; z-index:100; width:280px;
}
.emoji-picker.show { display:block; }
.emoji-grid { display:grid; grid-template-columns:repeat(8,1fr); gap:4px; }
.emoji-item { font-size:22px; cursor:pointer; text-align:center; border-radius:6px; padding:3px; transition:background .15s; }
.emoji-item:hover { background:var(--surface); }
.input-wrapper { flex:1; position:relative; }

/* ── IMAGE UPLOAD OVERLAY ── */
.img-attach-preview {
  display:none; background:var(--surface); border:1px solid var(--border);
  border-radius:12px; padding:10px; margin-bottom:8px; position:relative;
}
.img-attach-preview.show { display:block; }
.img-attach-preview img { max-height:120px; border-radius:8px; }
.img-attach-preview .remove-img {
  position:absolute; top:8px; right:8px; background:var(--danger); color:#fff;
  border:none; border-radius:50%; width:22px; height:22px; cursor:pointer; font-size:12px;
  display:flex; align-items:center; justify-content:center;
}

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

/* ── ANIMATIONS ── */
.msg-wrap { animation: msgIn .2s ease; }
@keyframes msgIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

/* ── MOBILE ── */
@media (max-width: 640px) {
  .sidebar { width:100%; }
  .chat-area { display:none; }
  .chat-area.mobile-open { display:flex; position:fixed; inset:0; z-index:100; }
  .chat-header .back-btn { display:flex; }
  .settings-panel { width:100%; right:-100%; }
}
</div>
<div style="display:none" data-dup="3">

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="logo-icon">✈️</div>
      <h1>Freedom</h1>
      <p>Мессенджер без границ</p>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Войти</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Регистрация</button>
    </div>

    <!-- LOGIN -->
    <div id="login-form">
      <div class="form-group">
        <label>Имя пользователя</label>
        <input type="text" id="login-username" placeholder="username">
      </div>
      <div class="form-group">
        <label>Пароль</label>
        <input type="password" id="login-password" placeholder="••••••••" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="btn" onclick="doLogin()">Войти</button>
      <div class="auth-error" id="login-error"></div>
    </div>

    <!-- REGISTER -->
    <div id="register-form" style="display:none">
      <div class="form-group">
        <label>Отображаемое имя</label>
        <input type="text" id="reg-displayname" placeholder="Ваше имя">
      </div>
      <div class="form-group">
        <label>Имя пользователя (login)</label>
        <input type="text" id="reg-username" placeholder="username (мин. 3 символа)">
      </div>
      <div class="form-group">
        <label>Пароль</label>
        <input type="password" id="reg-password" placeholder="••••••••" onkeydown="if(event.key==='Enter')doRegister()">
      </div>
      <button class="btn" onclick="doRegister()">Создать аккаунт</button>
      <div class="auth-error" id="reg-error"></div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <div class="app-body">

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="my-avatar" id="my-avatar" onclick="openSettings()">
          <span id="my-avatar-text"></span>
        </div>
        <div class="my-name" onclick="openSettings()" id="my-display-name"></div>
        <button class="icon-btn" title="Новый чат" onclick="showNewChatHint()">✏️</button>
        <button class="icon-btn" title="Настройки" onclick="openSettings()">⚙️</button>
      </div>
      <div class="sidebar-search">
        <input class="search-input" placeholder="🔍 Поиск..." oninput="filterChats(this.value)">
      </div>
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" onclick="switchSidebarTab('chats',this)">Чаты</button>
        <button class="sidebar-tab" onclick="switchSidebarTab('people',this)">Люди</button>
      </div>
      <div class="chat-list" id="chat-list">
        <div class="empty-state">
          <div class="empty-icon">💬</div>
          <div>Пока нет чатов<br><small style="color:var(--text3)">Перейди во вкладку «Люди»</small></div>
        </div>
      </div>
    </div>

    <!-- CHAT AREA -->
    <div class="chat-area" id="chat-area">
      <div id="no-chat" class="no-chat" style="flex:1;display:flex">
        <div class="big-icon">✈️</div>
        <h2>Freedom Messenger</h2>
        <p>Выбери чат слева или найди нового собеседника</p>
      </div>
      <div id="chat-view" style="display:none;flex-direction:column;height:100%">
        <div class="chat-header">
          <button class="icon-btn back-btn" onclick="closeMobileChat()">←</button>
          <div class="chat-header-avatar" id="chat-hdr-avatar" onclick="showUserProfile(currentChat)"></div>
          <div class="chat-header-info" onclick="showUserProfile(currentChat)">
            <div class="chat-header-name" id="chat-hdr-name"></div>
            <div class="chat-header-status" id="chat-hdr-status"></div>
          </div>
          <div class="chat-header-actions">
            <button class="icon-btn" title="Аудиозвонок" onclick="startCall('audio')">📞</button>
            <button class="icon-btn" title="Видеозвонок" onclick="startCall('video')">📹</button>
            <button class="icon-btn" title="Поиск" onclick="alert('Поиск в чате — скоро!')">🔍</button>
            <button class="icon-btn" title="Ещё">⋮</button>
          </div>
        </div>
        <div class="messages-area" id="messages-area" oncontextmenu="return false"></div>
        <div class="input-area">
          <div class="reply-preview" id="reply-preview">
            <div class="rp-text">
              <div class="rp-name" id="reply-name"></div>
              <div id="reply-text"></div>
            </div>
            <button class="reply-close" onclick="cancelReply()">✕</button>
          </div>
          <div class="img-attach-preview" id="img-attach-preview">
            <img id="img-attach-thumb">
            <button class="remove-img" onclick="removeAttachedImage()">✕</button>
          </div>
          <div class="input-row">
            <button class="attach-btn" onclick="document.getElementById('file-input').click()">📎</button>
            <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleImageAttach(event)">
            <div class="input-wrapper">
              <button class="emoji-btn" onclick="toggleEmojiPicker()">😊</button>
              <div class="emoji-picker" id="emoji-picker"></div>
              <textarea class="msg-input" id="msg-input" placeholder="Написать сообщение..." rows="1"
                oninput="autoResize(this);handleTyping()" onkeydown="handleMsgKey(event)"></textarea>
            </div>
            <button class="mic-btn" id="mic-btn" onclick="toggleRecording()" title="Голосовое сообщение">🎤</button>
            <button class="send-btn" onclick="sendMessage()">➤</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div class="settings-panel" id="settings-panel">
  <div class="settings-header">
    <button class="icon-btn" onclick="closeSettings()">←</button>
    <h2>Настройки</h2>
  </div>
  <div class="settings-body">
    <div class="settings-avatar-section">
      <div class="settings-avatar" id="settings-avatar" onclick="document.getElementById('avatar-input').click()">
        <span id="settings-avatar-text"></span>
      </div>
      <input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="handleAvatarChange(event)">
      <div class="settings-username" id="settings-username"></div>
      <div class="settings-handle" id="settings-handle"></div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Профиль</div>
      <div class="settings-row">
        <div class="settings-item" onclick="editProfile()">
          <span class="settings-item-icon">✏️</span>
          <div class="settings-item-text">
            <div class="settings-item-label">Редактировать профиль</div>
            <div class="settings-item-sub">Имя, фото, о себе</div>
          </div>
          <span class="settings-item-arrow">›</span>
        </div>
        <div class="settings-item" onclick="toggleEditProfile()">
          <span class="settings-item-icon">👤</span>
          <div class="settings-item-text">
            <div class="settings-item-label">Имя</div>
            <div class="settings-item-sub" id="sett-display-name"></div>
          </div>
        </div>
        <div class="settings-item">
          <span class="settings-item-icon">📝</span>
          <div class="settings-item-text">
            <div class="settings-item-label">О себе</div>
            <div class="settings-item-sub" id="sett-bio">Нет</div>
          </div>
        </div>
      </div>
    </div>

    <div id="edit-profile-form" style="display:none" class="settings-section">
      <div class="settings-section-title">Редактирование</div>
      <input class="settings-input" id="edit-displayname" placeholder="Отображаемое имя">
      <textarea class="settings-textarea" id="edit-bio" placeholder="О себе..."></textarea>
      <button class="btn" onclick="saveProfile()" style="width:100%;margin-bottom:8px">Сохранить</button>
      <button class="btn btn-ghost" onclick="toggleEditProfile()">Отмена</button>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Приватность</div>
      <div class="settings-row">
        <div class="settings-item">
          <span class="settings-item-icon">👁️</span>
          <div class="settings-item-text">
            <div class="settings-item-label">Последний визит</div>
            <div class="settings-item-sub">Все</div>
          </div>
          <span class="settings-item-arrow">›</span>
        </div>
        <div class="settings-item">
          <span class="settings-item-icon">📸</span>
          <div class="settings-item-text">
            <div class="settings-item-label">Фото профиля</div>
            <div class="settings-item-sub">Все</div>
          </div>
          <span class="settings-item-arrow">›</span>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">Внешний вид</div>
      <div class="settings-row">
        <div class="settings-item" onclick="alert('Тема скоро!')">
          <span class="settings-item-icon">🎨</span>
          <div class="settings-item-text">
            <div class="settings-item-label">Тема</div>
            <div class="settings-item-sub">Тёмная</div>
          </div>
          <span class="settings-item-arrow">›</span>
        </div>
        <div class="settings-item" onclick="alert('Скоро!')">
          <span class="settings-item-icon">🔔</span>
          <div class="settings-item-text">
            <div class="settings-item-label">Уведомления</div>
            <div class="settings-item-sub">Включены</div>
          </div>
          <span class="settings-item-arrow">›</span>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <button class="btn btn-danger" onclick="doLogout()">Выйти из аккаунта</button>
    </div>
  </div>
</div>

<!-- USER PROFILE MODAL -->
<div class="profile-modal" id="profile-modal" onclick="if(event.target===this)closeProfileModal()">
  <div class="profile-box">
    <div class="profile-cover"></div>
    <div class="profile-content">
      <div class="profile-avatar-wrap">
        <div class="pa" id="pm-avatar"></div>
      </div>
      <div class="profile-name" id="pm-name"></div>
      <div class="profile-handle" id="pm-handle"></div>
      <div class="profile-bio" id="pm-bio"></div>
      <div class="profile-actions">
        <button class="btn-msg" onclick="openChatFromProfile()">💬 Написать</button>
        <button class="btn-audio" onclick="startCallFromProfile('audio')">📞</button>
        <button class="btn-video" onclick="startCallFromProfile('video')">📹</button>
      </div>
    </div>
  </div>
</div>

<!-- CALL MODAL -->
<div class="call-modal" id="call-modal">
  <div class="call-box">
    <div class="video-area" id="video-area">
      <video id="remoteVideo" autoplay playsinline style="display:none"></video>
      <video id="localVideo" autoplay muted playsinline style="display:none"></video>
    </div>
    <div class="call-avatar-big" id="call-avatar"></div>
    <div class="call-name" id="call-name"></div>
    <div class="call-status" id="call-status"></div>
    <div class="call-timer" id="call-timer" style="display:none">00:00</div>
    <div class="call-actions" id="call-actions"></div>
  </div>
</div>

<!-- IMAGE LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="this.classList.remove('show')">
  <img id="lightbox-img">
</div>

<!-- CONTEXT MENU -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="ctxReply()">↩️ Ответить</div>
  <div class="ctx-item" onclick="ctxCopy()">📋 Копировать</div>
  <div class="ctx-item danger" onclick="ctxDelete()">🗑️ Удалить</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast" onclick="openChatFromToast()">
  <div class="toast-avatar" id="toast-avatar"></div>
  <div class="toast-text">
    <div class="toast-name" id="toast-name"></div>
    <div class="toast-msg" id="toast-msg"></div>
  </div>
</div>

<script>
// ─── State ───────────────────────────────────────────────────────────────────
// socket and me already declared
var allUsers = [], chatHistory = {}, unread = {}, chatPreviews = {};
var replyTo = null;
var ctxMsg = null;
let typingTimers = {}, typingState = false;
var mediaRecorder = null, audioChunks = [], recordingInterval = null;
var peerConnection = null, localStream = null;
var callTimer = null; if(typeof callSeconds === "undefined") var callSeconds = 0;
var currentCallUser = null, callType = 'audio';
let attachedImage = null;
let toastTimeout = null, toastChatUser = null;
let profileModalUser = null;

var EMOJIS = ['😀','😂','🥰','😍','🤔','😎','😭','😤','🥺','🤣','❤️','🔥','👍','👎','🎉','✨','💯','🙏','😊','🤗','😏','😅','🤦','🤷','💪','👀','🫡','🫂','💀','🤙','💬','✈️','🌟','🚀','🎮','🍕','🎵','🌈','🌙','⚡'];

// ─── Socket ───────────────────────────────────────────────────────────────────
function connectSocket() {
  socket = io();
  socket.on('new_message', onNewMessage);
  socket.on('user_online', u => updateUserStatus(u.username, true));
  socket.on('user_offline', u => updateUserStatus(u.username, false, u.lastSeen));
  socket.on('user_updated', onUserUpdated);
  socket.on('user_typing', onTyping);
  socket.on('messages_read', ({by}) => markMessagesRead(by));
  socket.on('message_deleted', ({msgId}) => removeMessageEl(msgId));
  socket.on('incoming_call', onIncomingCall);
  socket.on('call_answered', onCallAnswered);
  socket.on('ice_candidate', onIceCandidate);
  socket.on('call_ended', onCallEnded);
  socket.on('call_rejected', () => { showCallStatus('Отклонено', true); try{_injectCallMsg(currentCallUser,'missed');}catch(e){} });
  socket.on('call_busy', () => showCallStatus('Занято', true));
}

// ─── Auth ─────────────────────────────────────────────────────────────────────
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (tab==='login'&&i===0)||(tab==='register'&&i===1)));
  document.getElementById('login-form').style.display = tab==='login'?'':'none';
  document.getElementById('register-form').style.display = tab==='register'?'':'none';
}

function doLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username || !password) return setErr('login-error','Заполните все поля');
  socket.emit('login', {username, password}, res => {
    if (res.error) return setErr('login-error', res.error);
    onLoggedIn(res.user);
  });
}

function doRegister() {
  const displayName = document.getElementById('reg-displayname').value.trim();
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  if (!displayName || !username || !password) return setErr('reg-error','Заполните все поля');
  socket.emit('register', {username, password, displayName}, res => {
    if (res.error) return setErr('reg-error', res.error);
    onLoggedIn(res.user);
  });
}

function onLoggedIn(user) {
  me = user;
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  updateMyUI();
  loadUsers();
}

function doLogout() {
  socket.emit('logout');
  me = null; currentChat = null; allUsers = [];
  chatHistory = {}; unread = {}; chatPreviews = {};
  document.getElementById('app').classList.remove('visible');
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('chat-view').style.display = 'none';
  document.getElementById('no-chat').style.display = 'flex';
  closeSettings();
}

function setErr(id, msg) { document.getElementById(id).textContent = msg; setTimeout(()=>document.getElementById(id).textContent='', 4000); }

// ─── UI Updates ───────────────────────────────────────────────────────────────
function updateMyUI() {
  const name = me.displayName || me.username;
  document.getElementById('my-display-name').textContent = name;
  document.getElementById('my-avatar-text').textContent = initials(name);
  document.getElementById('settings-username').textContent = name;
  document.getElementById('settings-handle').textContent = '@' + me.username;
  document.getElementById('sett-display-name').textContent = name;
  document.getElementById('sett-bio').textContent = me.bio || 'Нет';
  document.getElementById('settings-avatar-text').textContent = initials(name);
  if (me.avatar) {
    setAvatarImg('my-avatar', me.avatar);
    setAvatarImg('settings-avatar', me.avatar);
  }
}

function initials(name) {
  return name.split(' ').slice(0,2).map(w=>w[0]?.toUpperCase()).join('') || '?';
}

function setAvatarEl(el, user) {
  if (!el) return;
  if (user.avatar) {
    el.innerHTML = `<img src="${user.avatar}" alt="">`;
  } else {
    el.innerHTML = `<span>${initials(user.displayName||user.username)}</span>`;
    el.style.background = strColor(user.username);
  }
}

function setAvatarImg(elId, src) {
  const el = document.getElementById(elId);
  if (!el) return;
  el.innerHTML = `<img src="${src}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
}

function strColor(str) {
  const colors = ['#2d7dd2','#7c4dff','#e91e8c','#00bcd4','#ff6b35','#4caf50','#ff9800','#9c27b0'];
  let h = 0; for (let c of str) h = (h*31 + c.charCodeAt(0)) % colors.length;
  return colors[h];
}

// ─── Users / Contacts ─────────────────────────────────────────────────────────
function loadUsers() {
  fetch('/api/users').then(r=>r.json()).then(users => {
    allUsers = users.filter(u => u.username !== me.username);
    renderChatList();
  });
}

function switchSidebarTab(tab, btn) {
  document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  if (tab === 'chats') renderChatList('chats');
  else renderChatList('people');
}

function renderChatList(mode = 'chats', filter = '') {
  const list = document.getElementById('chat-list');
  let html = '';

  if (mode === 'people') {
    const users = allUsers.filter(u => !filter || u.displayName.toLowerCase().includes(filter) || u.username.includes(filter));
    if (!users.length) { list.innerHTML = `<div class="empty-state"><div class="empty-icon">👥</div><div>Пользователи не найдены</div></div>`; return; }
    html += `<div class="section-label" style="padding:12px 14px 4px;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px">Все пользователи</div>`;
    users.forEach(u => {
      html += renderUserItem(u);
    });
  } else {
    // Show chats with recent messages first, then all contacts
    const chatsWithMsgs = allUsers.filter(u => chatPreviews[u.username]);
    const others = allUsers.filter(u => !chatPreviews[u.username]);
    const combined = [...chatsWithMsgs, ...others].filter(u => !filter || u.displayName.toLowerCase().includes(filter) || u.username.includes(filter));
    if (!combined.length) { list.innerHTML = `<div class="empty-state"><div class="empty-icon">💬</div><div>Нет чатов<br><small style="color:var(--text3)">Перейди во вкладку «Люди»</small></div></div>`; return; }
    if (chatsWithMsgs.length) html += `<div class="section-label" style="padding:12px 14px 4px;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px">Недавние</div>`;
    combined.forEach(u => html += renderUserItem(u, true));
  }
  list.innerHTML = html;
}

function renderUserItem(u, showPreview = false) {
  const preview = chatPreviews[u.username];
  const unreadCount = unread[u.username] || 0;
  const badge = unreadCount ? `<div class="unread-badge">${unreadCount}</div>` : '';
  const onlineDot = u.online ? `<div class="online-dot"></div>` : '';
  const avatarBg = strColor(u.username);
  const avatarContent = u.avatar ? `<img src="${u.avatar}" alt="">` : `<span>${initials(u.displayName||u.username)}</span>`;
  const time = preview ? formatTime(preview.timestamp) : '';
  const previewText = preview ? (preview.type === 'image' ? '📷 Фото' : preview.type === 'voice' ? '🎤 Голосовое' : escHtml(preview.content||'').slice(0,40)) : (u.online ? 'В сети' : '');
  const activeClass = currentChat === u.username ? 'active' : '';

  return `<div class="chat-item ${activeClass}" onclick="openChat('${u.username}')">
    <div class="chat-avatar" style="background:${avatarBg}">${avatarContent}${onlineDot}</div>
    <div class="chat-info">
      <div class="chat-name">${escHtml(u.displayName||u.username)}</div>
      <div class="chat-preview">${previewText}</div>
    </div>
    <div class="chat-meta">
      <div class="chat-time">${time}</div>
      ${badge}
    </div>
  </div>`;
}

function filterChats(val) {
  const tab = document.querySelector('.sidebar-tab.active').textContent;
  renderChatList(tab === 'Люди' ? 'people' : 'chats', val.toLowerCase());
}

// ─── Chat ─────────────────────────────────────────────────────────────────────
function openChat(username) {
  currentChat = username;
  unread[username] = 0;
  const user = allUsers.find(u => u.username === username) || {username, displayName: username};

  // Update header
  const hdrAvatar = document.getElementById('chat-hdr-avatar');
  hdrAvatar.style.background = strColor(username);
  setAvatarEl(hdrAvatar, user);

  document.getElementById('chat-hdr-name').textContent = user.displayName || username;
  const statusEl = document.getElementById('chat-hdr-status');
  statusEl.textContent = user.online ? 'В сети' : 'Не в сети';
  statusEl.className = 'chat-header-status' + (user.online ? ' online' : '');

  document.getElementById('no-chat').style.display = 'none';
  const cv = document.getElementById('chat-view');
  cv.style.display = 'flex';

  // Mobile
  document.getElementById('chat-area').classList.add('mobile-open');

  // Load messages
  socket.emit('get_messages', {with: username}, msgs => {
    chatHistory[username] = msgs || [];
    renderMessages();
    scrollBottom();
  });

  // Mark read
  socket.emit('mark_read', {chatWith: username});
  renderChatList();
}

function closeMobileChat() {
  document.getElementById('chat-area').classList.remove('mobile-open');
}

function renderMessages() {
  const area = document.getElementById('messages-area');
  const msgs = chatHistory[currentChat] || [];
  if (!msgs.length) {
    area.innerHTML = `<div style="text-align:center;color:var(--text3);padding:40px;font-size:13px">Начните переписку! 👋</div>`;
    return;
  }
  let html = '', lastDate = null;
  msgs.forEach(m => {
    const d = new Date(m.timestamp).toLocaleDateString('ru-RU', {day:'numeric',month:'long'});
    if (d !== lastDate) { html += `<div class="date-divider">${d}</div>`; lastDate = d; }
    html += renderBubble(m);
  });
  area.innerHTML = html;
  area.querySelectorAll('.bubble').forEach(b => {
    b.addEventListener('contextmenu', e => { e.preventDefault(); showCtxMenu(e, b.dataset.id); });
  });
  area.querySelectorAll('img.msg-image').forEach(img => {
    img.addEventListener('click', () => openLightbox(img.src));
  });
}

function renderBubble(m) {
  const isOut = m.from === me.username;
  const user = allUsers.find(u => u.username === m.from) || {username: m.from, displayName: m.from};
  const avatarBg = strColor(m.from);
  const avatarContent = user.avatar ? `<img src="${user.avatar}" alt="">` : `<span>${initials(user.displayName||user.username)}</span>`;
  const time = formatTime(m.timestamp);
  const readIcon = isOut ? `<span class="read-icon">${m.read ? '✓✓' : m.delivered ? '✓✓' : '✓'}</span>` : '';

  let replyHtml = '';
  if (m.replyTo) {
    const orig = (chatHistory[currentChat]||[]).find(x=>x.id===m.replyTo);
    if (orig) {
      const rFrom = orig.from === me.username ? 'Вы' : (allUsers.find(u=>u.username===orig.from)?.displayName || orig.from);
      const rText = orig.type==='image' ? '📷 Фото' : orig.type==='voice' ? '🎤 Голосовое' : escHtml(orig.content||'').slice(0,60);
      replyHtml = `<div class="bubble-reply"><div class="reply-name">${rFrom}</div>${rText}</div>`;
    }
  }

  let content = '';
  if (m.type === 'image') {
    content = `<img class="msg-image" src="${m.content}" alt="фото">`;
  } else if (m.type === 'voice') {
    const bars = Array.from({length:20},(_,i)=>`<span style="height:${8+Math.random()*16}px"></span>`).join('');
    content = `<div class="voice-bubble">
      <button class="voice-play-btn" onclick="playVoice(this,'${m.id}','${m.content}')">▶</button>
      <div class="voice-wave">${bars}</div>
      <span class="voice-duration">${m.duration||'0:00'}</span>
    </div>`;
  } else {
    content = `<div class="bubble-text">${escHtml(m.content||'').replace(/\n/g,'<br>')}</div>`;
  }

  return `<div class="msg-wrap ${isOut?'out':'in'}" id="msg-${m.id}">
    ${!isOut ? `<div class="msg-avatar-small" style="background:${avatarBg}">${avatarContent}</div>` : ''}
    <div class="bubble" data-id="${m.id}" data-from="${m.from}" data-content="${escHtml(m.content||'')}">
      ${replyHtml}
      ${content}
      <div class="bubble-time">${time} ${readIcon}</div>
    </div>
  </div>`;
}

function onNewMessage(msg) {
  if (!allUsers.find(u=>u.username===msg.from) && msg.from !== me.username) {
    loadUsers();
  }
  const chatUser = msg.from === me.username ? msg.to : msg.from;
  if (!chatHistory[chatUser]) chatHistory[chatUser] = [];
  chatHistory[chatUser].push(msg);
  chatPreviews[chatUser] = msg;

  if (chatUser === currentChat) {
    appendMessage(msg);
    scrollBottom();
    socket.emit('mark_read', {chatWith: chatUser});
  } else if (msg.from !== me.username) {
    unread[msg.from] = (unread[msg.from]||0) + 1;
    showToast(msg);
  }
  renderChatList();
}

function appendMessage(msg) {
  const area = document.getElementById('messages-area');
  const placeholder = area.querySelector('[style*="Начните"]');
  if (placeholder) placeholder.remove();
  const div = document.createElement('div');
  div.innerHTML = renderBubble(msg);
  const wrap = div.firstElementChild;
  area.appendChild(wrap);
  wrap.querySelectorAll('.bubble').forEach(b => {
    b.addEventListener('contextmenu', e => { e.preventDefault(); showCtxMenu(e, b.dataset.id); });
  });
  wrap.querySelectorAll('img.msg-image').forEach(img => {
    img.addEventListener('click', () => openLightbox(img.src));
  });
}

function scrollBottom() {
  const a = document.getElementById('messages-area');
  setTimeout(() => a.scrollTop = a.scrollHeight, 50);
}

// ─── Send Message ──────────────────────────────────────────────────────────────
function sendMessage() {
  if (!currentChat) return;
  if (attachedImage) { sendImageMessage(); return; }
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text) return;
  const data = {to: currentChat, content: text, type: 'text'};
  if (replyTo) { data.replyTo = replyTo.id; }
  socket.emit('send_message', data, res => {
    if (res?.message) {
      if (!chatHistory[currentChat]) chatHistory[currentChat] = [];
      chatHistory[currentChat].push(res.message);
      chatPreviews[currentChat] = res.message;
      appendMessage(res.message);
      scrollBottom();
      renderChatList();
    }
  });
  input.value = ''; autoResize(input);
  cancelReply();
  clearTyping();
}

function sendImageMessage() {
  if (!attachedImage || !currentChat) return;
  const data = {to: currentChat, content: attachedImage, type: 'image', replyTo: replyTo?.id||null};
  socket.emit('send_message', data, res => {
    if (res?.message) {
      if (!chatHistory[currentChat]) chatHistory[currentChat] = [];
      chatHistory[currentChat].push(res.message);
      chatPreviews[currentChat] = res.message;
      appendMessage(res.message);
      scrollBottom();
      renderChatList();
    }
  });
  removeAttachedImage();
  cancelReply();
}

function handleMsgKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function handleImageAttach(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    attachedImage = ev.target.result;
    document.getElementById('img-attach-thumb').src = attachedImage;
    document.getElementById('img-attach-preview').classList.add('show');
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

function removeAttachedImage() {
  attachedImage = null;
  document.getElementById('img-attach-preview').classList.remove('show');
}

// ─── Typing ───────────────────────────────────────────────────────────────────
function handleTyping() {
  if (!currentChat) return;
  if (!typingState) { typingState = true; socket.emit('typing', {to: currentChat, isTyping: true}); }
  clearTimeout(typingTimers['me']);
  typingTimers['me'] = setTimeout(clearTyping, 2500);
}

function clearTyping() {
  if (typingState) { typingState = false; socket.emit('typing', {to: currentChat, isTyping: false}); }
}

function onTyping({from, isTyping}) {
  if (from !== currentChat) return;
  const area = document.getElementById('messages-area');
  const existing = document.getElementById('typing-indicator');
  if (isTyping && !existing) {
    const div = document.createElement('div');
    div.id = 'typing-indicator';
    div.className = 'typing-indicator';
    div.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div><span>печатает...</span>`;
    area.appendChild(div);
    scrollBottom();
  } else if (!isTyping && existing) {
    existing.remove();
  }
}

// ─── Voice Recording ──────────────────────────────────────────────────────────
async function toggleRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({audio: true});
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    let seconds = 0;
    const btn = document.getElementById('mic-btn');
    btn.classList.add('recording');
    btn.textContent = '⏹';
    recordingInterval = setInterval(() => { seconds++; btn.title = formatSecs(seconds); }, 1000);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      clearInterval(recordingInterval);
      btn.classList.remove('recording');
      btn.textContent = '🎤';
      btn.title = 'Голосовое сообщение';
      const blob = new Blob(audioChunks, {type:'audio/webm'});
      const reader = new FileReader();
      reader.onload = ev => {
        const dur = formatSecs(seconds);
        socket.emit('send_message', {to: currentChat, content: ev.target.result, type: 'voice', duration: dur}, res => {
          if (res?.message) {
            if (!chatHistory[currentChat]) chatHistory[currentChat] = [];
            chatHistory[currentChat].push(res.message);
            chatPreviews[currentChat] = res.message;
            appendMessage(res.message);
            scrollBottom();
            renderChatList();
          }
        });
      };
      reader.readAsDataURL(blob);
      stream.getTracks().forEach(t=>t.stop());
    };
    mediaRecorder.start();
  } catch(e) { alert('Нет доступа к микрофону'); }
}

function playVoice(btn, id, src) {
  const audio = new Audio(src);
  btn.textContent = '⏸';
  audio.play();
  audio.onended = () => { btn.textContent = '▶'; };
}

function formatSecs(s) { return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }

// ─── Context Menu ──────────────────────────────────────────────────────────────
function showCtxMenu(e, msgId) {
  const msgs = chatHistory[currentChat] || [];
  ctxMsg = msgs.find(m => m.id === msgId);
  const menu = document.getElementById('ctx-menu');
  menu.style.left = Math.min(e.clientX, window.innerWidth-180) + 'px';
  menu.style.top = Math.min(e.clientY, window.innerHeight-120) + 'px';
  menu.classList.add('show');
  const deleteItem = menu.children[2];
  deleteItem.style.display = ctxMsg?.from === me.username ? '' : 'none';
  e.stopPropagation();
}

document.addEventListener('click', () => document.getElementById('ctx-menu').classList.remove('show'));

function ctxReply() {
  if (!ctxMsg) return;
  replyTo = ctxMsg;
  const name = ctxMsg.from === me.username ? 'Вы' : (allUsers.find(u=>u.username===ctxMsg.from)?.displayName || ctxMsg.from);
  document.getElementById('reply-name').textContent = name;
  document.getElementById('reply-text').textContent = ctxMsg.type==='image' ? '📷 Фото' : ctxMsg.type==='voice' ? '🎤 Голосовое' : ctxMsg.content?.slice(0,80);
  document.getElementById('reply-preview').classList.add('show');
  document.getElementById('msg-input').focus();
}

function ctxCopy() {
  if (ctxMsg?.content) navigator.clipboard.writeText(ctxMsg.content).catch(()=>{});
}

function ctxDelete() {
  if (!ctxMsg) return;
  socket.emit('delete_message', {msgId: ctxMsg.id, chatWith: currentChat}, res => {
    if (res?.ok) {
      chatHistory[currentChat] = (chatHistory[currentChat]||[]).filter(m=>m.id!==ctxMsg.id);
      removeMessageEl(ctxMsg.id);
    }
  });
}

function cancelReply() { replyTo = null; document.getElementById('reply-preview').classList.remove('show'); }

function removeMessageEl(msgId) {
  const el = document.getElementById('msg-' + msgId);
  if (el) el.remove();
}

// ─── Emoji picker ──────────────────────────────────────────────────────────────
function toggleEmojiPicker() {
  const picker = document.getElementById('emoji-picker');
  if (!picker.innerHTML) {
    picker.innerHTML = `<div class="emoji-grid">${EMOJIS.map(e=>`<span class="emoji-item" onclick="insertEmoji('${e}')">${e}</span>`).join('')}</div>`;
  }
  picker.classList.toggle('show');
}

function insertEmoji(e) {
  const input = document.getElementById('msg-input');
  const pos = input.selectionStart;
  input.value = input.value.slice(0, pos) + e + input.value.slice(pos);
  input.selectionStart = input.selectionEnd = pos + e.length;
  input.focus();
  document.getElementById('emoji-picker').classList.remove('show');
}

document.addEventListener('click', e => {
  if (!e.target.closest('.input-wrapper')) document.getElementById('emoji-picker')?.classList.remove('show');
});

// ─── Read Receipts ────────────────────────────────────────────────────────────
function markMessagesRead(by) {
  if (by !== currentChat) return;
  const msgs = chatHistory[currentChat] || [];
  msgs.forEach(m => { if (m.from === me.username) m.read = true; });
  renderMessages();
}

// ─── Status Updates ───────────────────────────────────────────────────────────
function updateUserStatus(username, online, lastSeen) {
  const u = allUsers.find(u=>u.username===username);
  if (u) u.online = online;
  if (!online && lastSeen) { if(u) u.lastSeen = lastSeen; }
  if (currentChat === username) {
    const s = document.getElementById('chat-hdr-status');
    s.textContent = online ? 'В сети' : 'Не в сети';
    s.className = 'chat-header-status' + (online ? ' online' : '');
  }
  renderChatList();
}

function onUserUpdated({username, displayName, avatar}) {
  const u = allUsers.find(u=>u.username===username);
  if (u) { u.displayName = displayName; u.avatar = avatar; }
  if (username === me.username) { me.displayName = displayName; me.avatar = avatar; updateMyUI(); }
  renderChatList();
}

// ─── Calls ────────────────────────────────────────────────────────────────────
const ICE_SERVERS = {iceServers: [{urls:'stun:stun.l.google.com:19302'}]};

async function startCall(type) {
  if (!currentChat) return;
  callType = type; currentCallUser = currentChat;
  const user = allUsers.find(u=>u.username===currentChat)||{username:currentChat,displayName:currentChat};
  showCallModal(user, type, 'outgoing');
  try {
    localStream = await navigator.mediaDevices.getUserMedia(type==='video' ? {video:true,audio:true} : {audio:true});
    if (type === 'video') {
      document.getElementById('localVideo').srcObject = localStream;
      document.getElementById('video-area').classList.add('show');
    }
    peerConnection = new RTCPeerConnection(ICE_SERVERS);
    localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
    peerConnection.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
    peerConnection.onicecandidate = e => { if (e.candidate) socket.emit('ice_candidate', {to: currentCallUser, candidate: e.candidate}); };
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.emit('call_user', {to: currentCallUser, offer, callType: type});
  } catch(e) { endCall(); alert('Нет доступа к камере/микрофону'); }
}

async function onIncomingCall({from, offer, callType: ct}) {
  currentCallUser = from; callType = ct;
  const user = allUsers.find(u=>u.username===from)||{username:from,displayName:from};
  showCallModal(user, ct, 'incoming', offer);
}

async function acceptCall(offer) {
  try {
    localStream = await navigator.mediaDevices.getUserMedia(callType==='video' ? {video:true,audio:true} : {audio:true});
    if (callType === 'video') {
      document.getElementById('localVideo').srcObject = localStream;
      document.getElementById('video-area').classList.add('show');
    }
    peerConnection = new RTCPeerConnection(ICE_SERVERS);
    localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
    peerConnection.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
    peerConnection.onicecandidate = e => { if(e.candidate) socket.emit('ice_candidate', {to: currentCallUser, candidate: e.candidate}); };
    await peerConnection.setRemoteDescription(offer);
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket.emit('call_answer', {to: currentCallUser, answer});
    startCallTimer();
  } catch(e) { endCall(); }
}

async function onCallAnswered({answer}) {
  try {
    await peerConnection.setRemoteDescription(answer);
    startCallTimer();
    showCallModal(allUsers.find(u=>u.username===currentCallUser)||{username:currentCallUser}, callType, 'active');
  } catch(e) {}
}

async function onIceCandidate({candidate}) {
  try { if(peerConnection) await peerConnection.addIceCandidate(candidate); } catch(e) {}
}

function onCallEnded() { showCallStatus('Звонок завершён', true); }

function endCall() {
  socket.emit('call_end', {to: currentCallUser});
  cleanupCall();
}

function rejectCall() {
  socket.emit('call_reject', {to: currentCallUser});
  cleanupCall();
}

function cleanupCall() {
  if (peerConnection) { peerConnection.close(); peerConnection = null; }
  if (localStream) { localStream.getTracks().forEach(t=>t.stop()); localStream = null; }
  clearInterval(callTimer); callSeconds = 0;
  document.getElementById('call-timer').style.display = 'none';
  document.getElementById('video-area').classList.remove('show');
  document.getElementById('call-modal').classList.remove('show');
}

function showCallModal(user, type, mode, offer) {
  const modal = document.getElementById('call-modal');
  const avatar = document.getElementById('call-avatar');
  avatar.style.background = strColor(user.username);
  setAvatarEl(avatar, user);
  document.getElementById('call-name').textContent = user.displayName || user.username;
  const icon = type==='video' ? '📹' : '📞';
  const typeLabel = type==='video' ? 'Видеозвонок' : 'Аудиозвонок';

 let status, actions;
  if (mode === 'outgoing') {
    status = `${icon} ${typeLabel} • Исходящий...`;
    actions = `<button class="call-btn end" onclick="endCall()">📵</button>`;
  } else if (mode === 'incoming') {
    status = `${icon} Входящий ${typeLabel.toLowerCase()}`;
    modal.classList.add('show');
    document.getElementById('call-status').textContent = status;
    document.getElementById('call-actions').innerHTML = `
      <button class="call-btn reject" onclick="rejectCall()">📵</button>
      <button class="call-btn accept" id="accept-btn">📞</button>`;
    document.getElementById('accept-btn').onclick = () => acceptCall(offer);
    return;
  } else {
    status = `${icon} ${typeLabel}`;
    document.getElementById('call-timer').style.display = 'block';
    actions = `<button class="call-btn mute" onclick="toggleMute(this)">🎙️</button>
               <button class="call-btn end" onclick="endCall()">📵</button>
               ${type==='video' ? '<button class="call-btn cam" onclick="toggleCam(this)">📷</button>' : '<button class="call-btn speaker" onclick="toggleSpeaker(this)">🔊</button>'}`;
  }
  document.getElementById('call-status').textContent = status;
  document.getElementById('call-actions').innerHTML = actions;
  modal.classList.add('show');
}

function showCallStatus(msg, autoClose) {
  document.getElementById('call-status').textContent = msg;
  if (autoClose) setTimeout(() => cleanupCall(), 2000);
}

function startCallTimer() {
  callSeconds = 0;
  const el = document.getElementById('call-timer');
  el.style.display = 'block';
  callTimer = setInterval(() => { callSeconds++; el.textContent = formatSecs(callSeconds); }, 1000);
}

function toggleMute(btn) {
  if (!localStream) return;
  const track = localStream.getAudioTracks()[0];
  if (!track) return;
  track.enabled = !track.enabled;
  btn.textContent = track.enabled ? '🎙️' : '🔇';
}

function toggleCam(btn) {
  if (!localStream) return;
  const track = localStream.getVideoTracks()[0];
  if (!track) return;
  track.enabled = !track.enabled;
  btn.textContent = track.enabled ? '📷' : '🚫';
}

function toggleSpeaker(btn) {
  btn.textContent = btn.textContent === '🔊' ? '🔈' : '🔊';
}

// ─── Settings ─────────────────────────────────────────────────────────────────
function openSettings() {
  const panel = document.getElementById('settings-panel');
  const form = document.getElementById('edit-profile-form');
  if (!panel) return;
  panel.classList.add('open');
  if (form) form.style.display = 'none';
}

function closeSettings() {
  const panel = document.getElementById('settings-panel');
  if (panel) panel.classList.remove('open');
}

function editProfile() { toggleEditProfile(); }

function toggleEditProfile() {
  const form = document.getElementById('edit-profile-form');
  if (!form) return;
  if (form.style.display === 'none') {
    document.getElementById('edit-displayname').value = me?.displayName || '';
    document.getElementById('edit-bio').value = me?.bio || '';
    form.style.display = '';
  } else {
    form.style.display = 'none';
  }
}

function saveProfile() {
  const displayNameEl = document.getElementById('edit-displayname');
  const bioEl = document.getElementById('edit-bio');
  if (!displayNameEl || !bioEl) return;
  const displayName = displayNameEl.value.trim();
  const bio = bioEl.value.trim();
  if (!displayName) return;
  socket.emit('update_profile', {displayName, bio}, res => {
    if (res?.ok) {
      me = res.user;
      updateMyUI();
      const form = document.getElementById('edit-profile-form');
      if (form) form.style.display = 'none';
    }
  });
}

function handleAvatarChange(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    fetch('/api/avatar', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username: me.username, avatar: ev.target.result})
    }).then(r => r.json()).then(() => {
      me.avatar = ev.target.result;
      updateMyUI();
    }).catch(err => console.error('Ошибка загрузки аватара:', err));
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

// ─── Profile Modal ────────────────────────────────────────────────────────────
function showUserProfile(username) {
  if (!username) return;
  const user = allUsers.find(u => u.username === username) || {username, displayName: username};
  profileModalUser = username;
  const pa = document.getElementById('pm-avatar');
  if (!pa) return;
  pa.style.background = strColor(username);
  setAvatarEl(pa, user);
  document.getElementById('pm-name').textContent = user.displayName || username;
  document.getElementById('pm-handle').textContent = '@' + username + (user.online ? ' • В сети' : '');
  document.getElementById('pm-bio').textContent = user.bio || 'Нет описания';
  document.getElementById('profile-modal').classList.add('show');
}

function closeProfileModal() {
  const modal = document.getElementById('profile-modal');
  if (modal) modal.classList.remove('show');
}

function openChatFromProfile() {
  closeProfileModal();
  if (profileModalUser) openChat(profileModalUser);
}

function startCallFromProfile(type) {
  if (!profileModalUser) return;
  closeProfileModal();
  openChat(profileModalUser);
  setTimeout(() => startCall(type), 300);
}

// ─── Toast Notifications ──────────────────────────────────────────────────────
function showToast(msg) {
  if (!msg?.from) return;
  const user = allUsers.find(u => u.username === msg.from) || {username: msg.from, displayName: msg.from};
  toastChatUser = msg.from;
  const ta = document.getElementById('toast-avatar');
  if (!ta) return;
  ta.style.background = strColor(msg.from);
  if (user.avatar) {
    ta.innerHTML = `<img src="${user.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:11px">`;
  } else {
    ta.textContent = initials(user.displayName || user.username);
  }
  const nameEl = document.getElementById('toast-name');
  const msgEl = document.getElementById('toast-msg');
  if (nameEl) nameEl.textContent = user.displayName || user.username;
  const text = msg.type === 'image' ? '📷 Фото' : msg.type === 'voice' ? '🎤 Голосовое' : (msg.content || '').slice(0, 50);
  if (msgEl) msgEl.textContent = text;
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.classList.add('show');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => toast.classList.remove('show'), 4000);
}

function openChatFromToast() {
  const toast = document.getElementById('toast');
  if (toast) toast.classList.remove('show');
  if (toastChatUser) openChat(toastChatUser);
}

// ─── Image Lightbox ───────────────────────────────────────────────────────────
function openLightbox(src) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.add('show');
}

// ─── Misc ──────────────────────────────────────────────────────────────────────
function showNewChatHint() {
  document.querySelectorAll('.sidebar-tab')[1].click();
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function formatTime(ts) {
  const d = new Date(ts);
  const now = new Date();
  if (d.toDateString() === now.toDateString()) return d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
  const days = Math.floor((now-d)/86400000);
  if (days < 7) return d.toLocaleDateString('ru-RU',{weekday:'short'});
  return d.toLocaleDateString('ru-RU',{day:'numeric',month:'short'});
}

// ─── Init ──────────────────────────────────────────────────────────────────────
// connectSocket() отключён — сокет запускается через init() в основном блоке
// connectSocket();

// Refresh users every 30s for online status
setInterval(() => { if (me) loadUsers(); }, 30000);
</script>
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:4px;}

/* ── AUTH ── */
#auth-screen{
  display:flex;align-items:center;justify-content:center;
  height:100vh;background:var(--bg);
  animation:fadeIn .4s ease;
}
.auth-box{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:20px;padding:48px 44px;width:420px;
  box-shadow:0 32px 80px rgba(0,0,0,.5);
}
.auth-logo{
  text-align:center;margin-bottom:32px;
}
.auth-logo .logo-mark{
  width:64px;height:64px;border-radius:18px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:inline-flex;align-items:center;justify-content:center;
  font-size:28px;font-weight:800;letter-spacing:-1px;
  box-shadow:0 8px 32px rgba(108,99,255,.4);
  margin-bottom:16px;
}
.auth-logo h1{font-size:28px;font-weight:800;letter-spacing:-.5px;}
.auth-logo p{color:var(--text2);font-size:14px;margin-top:4px;}
.auth-tabs{display:flex;background:var(--bg3);border-radius:10px;padding:4px;margin-bottom:28px;}
.auth-tab{flex:1;padding:9px;text-align:center;border-radius:8px;font-size:14px;font-weight:600;color:var(--text2);transition:var(--trans);cursor:pointer;}
.auth-tab.active{background:var(--bg4);color:var(--text);}
.field{margin-bottom:16px;}
.field label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px;letter-spacing:.3px;text-transform:uppercase;}
.field input{
  width:100%;padding:13px 16px;
  background:var(--bg3);border:1px solid var(--border);
  border-radius:10px;font-size:15px;font-weight:500;
  transition:var(--trans);
}
.field input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(108,99,255,.15);}
.field input::placeholder{color:var(--text3);}
.btn-primary{
  width:100%;padding:14px;border-radius:10px;font-size:15px;font-weight:700;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#fff;transition:var(--trans);letter-spacing:.2px;
  box-shadow:0 4px 20px rgba(108,99,255,.35);
}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 8px 28px rgba(108,99,255,.45);}
.btn-primary:active{transform:translateY(0);}
.auth-err{color:var(--red);font-size:13px;text-align:center;margin-top:12px;min-height:20px;}

/* ── APP SHELL ── */
#app{display:none;height:100vh;flex-direction:row;}
#app.visible{display:flex;}

/* ── SIDEBAR ── */
.sidebar{
  width:var(--sidebar-w);min-width:var(--sidebar-w);
  background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;
}
.sidebar-header{
  padding:16px;display:flex;align-items:center;gap:10px;
  border-bottom:1px solid var(--border);
}
.sidebar-logo{
  font-size:20px;font-weight:800;letter-spacing:-.5px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  flex:1;
}
.icon-btn{
  width:36px;height:36px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  color:var(--text2);transition:var(--trans);
}
.icon-btn:hover{background:var(--bg3);color:var(--text);}
.icon-btn svg{width:20px;height:20px;}

.search-wrap{padding:10px 12px;border-bottom:1px solid var(--border);}
.search-box{
  display:flex;align-items:center;gap:8px;
  background:var(--bg3);border-radius:10px;padding:9px 12px;
}
.search-box svg{width:16px;height:16px;color:var(--text3);flex-shrink:0;}
.search-box input{flex:1;font-size:14px;font-weight:500;}
.search-box input::placeholder{color:var(--text3);}

.chat-list{flex:1;overflow-y:auto;}
.chat-item{
  display:flex;align-items:center;gap:12px;
  padding:12px 16px;cursor:pointer;transition:var(--trans);
  border-bottom:1px solid var(--border);
}
.chat-item:hover{background:var(--bg3);}
.chat-item.active{background:var(--bg3);}
.avatar{
  width:48px;height:48px;border-radius:50%;flex-shrink:0;
  background:var(--accent);
  display:flex;align-items:center;justify-content:center;
  font-size:18px;font-weight:700;color:#fff;position:relative;
  overflow:hidden;cursor:pointer;
}
.avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:50%;}
.chat-header-info{flex:1;cursor:pointer;}
.online-dot{
  position:absolute;bottom:2px;right:2px;
  width:10px;height:10px;border-radius:50%;
  background:var(--green);border:2px solid var(--bg2);
}
.chat-info{flex:1;min-width:0;}
.chat-name{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chat-preview{font-size:13px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px;}
.chat-meta{display:flex;flex-direction:column;align-items:flex-end;gap:4px;}
.chat-time{font-size:12px;color:var(--text3);}
.unread-badge{
  background:var(--accent);color:#fff;border-radius:20px;
  font-size:11px;font-weight:700;padding:2px 7px;min-width:20px;text-align:center;
}

.sidebar-nav{
  display:flex;border-top:1px solid var(--border);padding:6px;gap:2px;
}
.nav-btn{
  flex:1;padding:10px 6px;border-radius:10px;
  display:flex;flex-direction:column;align-items:center;gap:4px;
  font-size:11px;font-weight:600;color:var(--text3);transition:var(--trans);
}
.nav-btn:hover{background:var(--bg3);color:var(--text2);}
.nav-btn.active{color:var(--accent);}
.nav-btn svg{width:22px;height:22px;}

/* ── MAIN AREA ── */
.main-area{flex:1;display:flex;flex-direction:column;background:var(--bg);position:relative;}

/* Empty state */
.empty-state{
  flex:1;display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:12px;color:var(--text3);
}
.empty-state .mark{
  width:80px;height:80px;border-radius:24px;
  background:var(--bg2);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:36px;font-weight:800;
  background:linear-gradient(135deg,var(--accent3),var(--accent));
  color:#fff;
}
.empty-state p{font-size:16px;font-weight:500;}
.empty-state span{font-size:13px;}

/* ── CHAT WINDOW ── */
.chat-window{flex:1;display:flex;flex-direction:column;display:none;}
.chat-window.open{display:flex;}

.chat-header{
  padding:12px 20px;display:flex;align-items:center;gap:12px;
  border-bottom:1px solid var(--border);background:var(--bg2);
}
.chat-header .avatar{width:40px;height:40px;font-size:15px;}
.chat-header-info{flex:1;}
.chat-header-info .name{font-size:16px;font-weight:700;}
.chat-header-info .status{font-size:13px;color:var(--text2);}
.chat-header-info .status.online{color:var(--green);}
.header-actions{display:flex;gap:4px;}

.messages-area{
  flex:1;overflow-y:auto;padding:20px;
  display:flex;flex-direction:column;gap:4px;
}

/* Messages */
.msg-wrap{display:flex;flex-direction:column;max-width:68%;gap:2px;}
.msg-wrap.out{align-self:flex-end;align-items:flex-end;}
.msg-wrap.in{align-self:flex-start;align-items:flex-start;}

.msg-bubble{
  padding:10px 14px;border-radius:18px;
  font-size:15px;line-height:1.5;word-break:break-word;
  position:relative;max-width:100%;
}
.out .msg-bubble{background:var(--msg-out);border-bottom-right-radius:4px;}
.in  .msg-bubble{background:var(--msg-in);border-bottom-left-radius:4px;}

.msg-time-status{
  font-size:11px;color:var(--text3);margin-top:3px;
  display:flex;align-items:center;gap:4px;
}
.out .msg-time-status{justify-content:flex-end;}

/* Read ticks */
.ticks{display:inline-flex;color:var(--text3);}
.ticks.read{color:var(--accent2);}
.ticks svg{width:14px;height:14px;}

/* Voice message */
.voice-msg{
  display:flex;align-items:center;gap:10px;
  padding:4px 0;min-width:220px;
}
.play-btn{
  width:36px;height:36px;border-radius:50%;
  background:var(--accent);color:#fff;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  transition:var(--trans);
}
.play-btn:hover{background:var(--accent2);}
.play-btn svg{width:16px;height:16px;}
.waveform{flex:1;height:28px;display:flex;align-items:center;gap:2px;cursor:pointer;}
.wave-bar{width:3px;border-radius:2px;background:rgba(255,255,255,.25);transition:height .1s;}
.wave-bar.active{background:var(--accent2);}
.voice-dur{font-size:12px;color:var(--text2);font-weight:600;}

/* Video circle */
.video-circle{
  width:180px;height:180px;border-radius:50%;
  overflow:hidden;border:3px solid var(--accent);
  cursor:pointer;position:relative;
}
.video-circle video,.video-circle img{width:100%;height:100%;object-fit:cover;}
.vc-play-overlay{
  position:absolute;inset:0;background:rgba(0,0,0,.3);
  display:flex;align-items:center;justify-content:center;border-radius:50%;
}

/* Image message */
.img-msg{
  max-width:320px;max-height:280px;border-radius:14px;
  overflow:hidden;cursor:pointer;
}
.img-msg img{width:100%;height:100%;object-fit:cover;display:block;}

/* Reply preview in message */
.reply-preview{
  border-left:3px solid var(--accent2);padding:6px 10px;
  margin-bottom:8px;border-radius:0 8px 8px 0;
  background:rgba(255,255,255,.05);font-size:13px;
}
.reply-preview .reply-name{color:var(--accent2);font-weight:600;margin-bottom:2px;}
.reply-preview .reply-text{color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

/* Date divider */
.date-divider{
  display:flex;align-items:center;gap:12px;margin:12px 0;
}
.date-divider span{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:20px;padding:4px 14px;font-size:12px;
  color:var(--text2);font-weight:600;white-space:nowrap;
}
.date-divider::before,.date-divider::after{content:'';flex:1;height:1px;background:var(--border);}

/* Typing indicator */
.typing-bubble{
  align-self:flex-start;background:var(--msg-in);
  border-radius:18px;border-bottom-left-radius:4px;
  padding:12px 16px;display:none;
}
.typing-bubble.show{display:block;}
.typing-dots{display:flex;gap:4px;}
.typing-dots span{
  width:7px;height:7px;border-radius:50%;background:var(--text3);
  animation:bounce .8s infinite;
}
.typing-dots span:nth-child(2){animation-delay:.15s;}
.typing-dots span:nth-child(3){animation-delay:.3s;}
@keyframes bounce{0%,80%,100%{transform:scale(.6)}40%{transform:scale(1)}}

/* ── INPUT BAR ── */
.input-bar{
  padding:12px 16px;background:var(--bg2);border-top:1px solid var(--border);
}
.reply-bar{
  display:none;align-items:center;gap:10px;
  padding:8px 12px;background:var(--bg3);border-radius:10px;margin-bottom:8px;
}
.reply-bar.show{display:flex;}
.reply-bar-content{flex:1;min-width:0;}
.reply-bar .name{font-size:12px;font-weight:700;color:var(--accent2);}
.reply-bar .text{font-size:13px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.reply-close{color:var(--text3);padding:4px;}

.input-row{display:flex;align-items:flex-end;gap:8px;}
.input-wrap{
  flex:1;background:var(--bg3);border-radius:14px;
  border:1px solid var(--border);display:flex;align-items:flex-end;
  padding:4px 8px;transition:var(--trans);
}
.input-wrap:focus-within{border-color:var(--accent);}
.msg-input{
  flex:1;padding:9px 8px;font-size:15px;resize:none;
  max-height:120px;overflow-y:auto;line-height:1.5;
}
.msg-input::placeholder{color:var(--text3);}
.attach-btn,.emoji-btn{padding:8px;color:var(--text3);border-radius:8px;transition:var(--trans);}
.attach-btn:hover,.emoji-btn:hover{color:var(--accent);}
.attach-btn svg,.emoji-btn svg{width:20px;height:20px;}
#file-input{display:none;}

.send-btn{
  width:44px;height:44px;border-radius:14px;flex-shrink:0;
  background:var(--accent);color:#fff;
  display:flex;align-items:center;justify-content:center;
  transition:var(--trans);box-shadow:0 4px 16px rgba(108,99,255,.35);
}
.send-btn:hover{background:var(--accent2);transform:scale(1.05);}
.send-btn svg{width:20px;height:20px;}
.send-btn.mic-mode{background:var(--bg3);color:var(--text2);box-shadow:none;}
.send-btn.mic-mode:hover{background:var(--bg4);color:var(--text);}

/* Recording state */
.recording-bar{
  display:none;align-items:center;gap:12px;
  padding:10px 16px;background:var(--bg3);border-radius:12px;margin-bottom:8px;
}
.recording-bar.show{display:flex;}
.rec-dot{width:10px;height:10px;border-radius:50%;background:var(--red);animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.rec-time{font-size:14px;font-weight:700;flex:1;}
.rec-cancel{color:var(--text3);font-size:14px;font-weight:600;}

/* ── SETTINGS PANEL ── */
.settings-panel{
  display:none;flex:1;flex-direction:column;background:var(--bg);
}
.settings-panel.open{display:flex;}
.settings-header{
  padding:16px 20px;display:flex;align-items:center;gap:12px;
  border-bottom:1px solid var(--border);background:var(--bg2);
}
.settings-header h2{font-size:18px;font-weight:700;flex:1;}
.settings-body{flex:1;overflow-y:auto;padding:20px;}

.profile-card{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:16px;padding:24px;margin-bottom:20px;
  display:flex;flex-direction:column;align-items:center;gap:16px;
}
.profile-avatar-wrap{position:relative;cursor:pointer;}
.profile-avatar-wrap .avatar{width:90px;height:90px;font-size:32px;}
.avatar-edit-btn{
  position:absolute;bottom:0;right:0;
  width:28px;height:28px;border-radius:50%;
  background:var(--accent);color:#fff;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 2px 8px rgba(0,0,0,.4);
}
.avatar-edit-btn svg{width:14px;height:14px;}
.profile-name{font-size:22px;font-weight:800;}
.profile-username{font-size:14px;color:var(--text2);}

.settings-section{margin-bottom:20px;}
.settings-section h3{
  font-size:12px;font-weight:700;color:var(--accent2);
  text-transform:uppercase;letter-spacing:.5px;
  margin-bottom:10px;padding:0 4px;
}
.settings-item{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:12px;overflow:hidden;margin-bottom:4px;
}
.settings-row{
  display:flex;align-items:center;gap:12px;
  padding:14px 16px;cursor:pointer;transition:var(--trans);
  border-bottom:1px solid var(--border);
}
.settings-row:last-child{border-bottom:none;}
.settings-row:hover{background:var(--bg3);}
.settings-row-icon{
  width:36px;height:36px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;font-size:16px;
}
.settings-row-icon svg{width:18px;height:18px;}
.settings-row-info{flex:1;}
.settings-row-info .label{font-size:15px;font-weight:600;}
.settings-row-info .sub{font-size:13px;color:var(--text2);margin-top:2px;}
.settings-row-arrow{color:var(--text3);}
.settings-row-arrow svg{width:16px;height:16px;}

/* Toggle switch */
.toggle{
  width:44px;height:24px;border-radius:12px;background:var(--bg4);
  position:relative;cursor:pointer;transition:var(--trans);flex-shrink:0;
}
.toggle.on{background:var(--accent);}
.toggle::after{
  content:'';position:absolute;top:3px;left:3px;
  width:18px;height:18px;border-radius:50%;background:#fff;
  transition:var(--trans);
}
.toggle.on::after{left:23px;}

/* Edit field */
.edit-field{
  width:100%;padding:12px 14px;
  background:var(--bg3);border:1px solid var(--border);
  border-radius:10px;font-size:15px;font-weight:500;
  margin-bottom:12px;transition:var(--trans);
}
.edit-field:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(108,99,255,.12);}
.edit-field::placeholder{color:var(--text3);}
textarea.edit-field{resize:none;min-height:80px;line-height:1.5;}
.save-btn{
  width:100%;padding:12px;border-radius:10px;
  background:var(--accent);color:#fff;font-size:15px;font-weight:700;
  transition:var(--trans);
}
.save-btn:hover{background:var(--accent2);}

/* Privacy select */
.privacy-select{
  background:var(--bg3);border:1px solid var(--border);
  border-radius:8px;padding:8px 12px;font-size:14px;color:var(--text);
  font-family:inherit;cursor:pointer;
}
.privacy-select option{background:var(--bg3);}

/* ── CONTACTS PANEL ── */
.contacts-panel{
  display:none;flex:1;flex-direction:column;background:var(--bg);
}
.contacts-panel.open{display:flex;}
.contacts-header{
  padding:16px 20px;display:flex;align-items:center;gap:12px;
  border-bottom:1px solid var(--border);background:var(--bg2);
}
.contacts-header h2{font-size:18px;font-weight:700;flex:1;}
.contacts-list{flex:1;overflow-y:auto;}
.contact-item{
  display:flex;align-items:center;gap:12px;
  padding:12px 20px;cursor:pointer;transition:var(--trans);
  border-bottom:1px solid var(--border);
}
.contact-item:hover{background:var(--bg2);}
.contact-item .avatar{width:44px;height:44px;font-size:16px;}
.contact-item .info{flex:1;}
.contact-item .name{font-size:15px;font-weight:600;}
.contact-item .status{font-size:13px;color:var(--text3);}
.contact-item .status.online-s{color:var(--green);}

/* ── CALL OVERLAY ── */
#call-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.7);backdrop-filter:blur(20px);
  z-index:100;align-items:center;justify-content:center;
  flex-direction:column;
}
#call-overlay.show{display:flex;}
.call-box{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:24px;padding:40px;text-align:center;
  min-width:320px;
}
.call-avatar{
  width:90px;height:90px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent3),var(--accent));
  display:flex;align-items:center;justify-content:center;
  font-size:34px;font-weight:700;color:#fff;
  margin:0 auto 20px;
  box-shadow:0 0 0 0 rgba(108,99,255,.4);
  overflow:hidden;position:relative;
}
.call-avatar img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;}
.call-avatar.ringing{animation:callPulse 1.5s infinite;}
@keyframes callPulse{
  0%{box-shadow:0 0 0 0 rgba(108,99,255,.4)}
  70%{box-shadow:0 0 0 24px rgba(108,99,255,0)}
  100%{box-shadow:0 0 0 0 rgba(108,99,255,0)}
}
.call-name{font-size:24px;font-weight:800;margin-bottom:8px;}
.call-status{font-size:15px;color:var(--text2);margin-bottom:32px;}
.call-actions{display:flex;gap:16px;justify-content:center;}
.call-btn{
  width:60px;height:60px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  transition:var(--trans);
}
.call-btn svg{width:26px;height:26px;}
.call-btn.end{background:var(--red);}
.call-btn.end:hover{background:#ef4444;}
.call-btn.answer{background:var(--green);}
.call-btn.answer:hover{background:#22c55e;}
.call-btn.mute,.call-btn.cam,.call-btn.speaker{background:var(--bg4);color:var(--text2);}
.call-btn.mute:hover,.call-btn.cam:hover,.call-btn.speaker:hover{background:var(--bg3);}
.call-btn.active-btn{background:var(--accent);color:#fff;}

.call-timer{font-size:18px;font-weight:700;margin-bottom:20px;color:var(--green);}

/* Video call */
.video-wrap{
  display:none;width:100%;max-width:600px;border-radius:16px;
  overflow:hidden;position:relative;margin-bottom:20px;background:#000;
  aspect-ratio:4/3;
}
.video-wrap.show{display:block;}
#remote-video,#local-video{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;}
#local-video{
  width:140px;height:105px;position:absolute;bottom:12px;right:12px;
  border-radius:10px;border:2px solid var(--accent);z-index:2;
}

/* ── INCOMING CALL ── */
#incoming-call{
  display:none;position:fixed;bottom:24px;right:24px;
  background:var(--bg2);border:1px solid var(--border);
  border-radius:20px;padding:20px 24px;z-index:200;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
  animation:slideUp .3s ease;min-width:280px;
}
#incoming-call.show{display:block;}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.inc-top{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.inc-top .avatar{width:44px;height:44px;font-size:16px;}
.inc-info{flex:1;}
.inc-name{font-size:16px;font-weight:700;}
.inc-type{font-size:13px;color:var(--text2);}
.inc-actions{display:flex;gap:12px;}
.inc-btn{
  flex:1;padding:11px;border-radius:12px;font-size:14px;font-weight:700;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:var(--trans);
}
.inc-btn svg{width:18px;height:18px;}
.inc-btn.reject{background:rgba(248,113,113,.15);color:var(--red);}
.inc-btn.reject:hover{background:var(--red);color:#fff;}
.inc-btn.accept{background:rgba(74,222,128,.15);color:var(--green);}
.inc-btn.accept:hover{background:var(--green);color:#fff;}

/* ── CONTEXT MENU ── */
#ctx-menu{
  display:none;position:fixed;z-index:300;
  background:var(--bg2);border:1px solid var(--border);
  border-radius:12px;padding:6px;min-width:160px;
  box-shadow:0 12px 40px rgba(0,0,0,.4);
}
#ctx-menu.show{display:block;}
.ctx-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;border-radius:8px;cursor:pointer;
  font-size:14px;font-weight:500;transition:var(--trans);
}
.ctx-item:hover{background:var(--bg3);}
.ctx-item svg{width:16px;height:16px;color:var(--text3);}
.ctx-item.danger{color:var(--red);}
.ctx-item.danger svg{color:var(--red);}

/* ── LIGHTBOX ── */
#lightbox{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);
  z-index:400;align-items:center;justify-content:center;cursor:pointer;
}
#lightbox.show{display:flex;}
#lightbox img{max-width:90vw;max-height:90vh;border-radius:12px;object-fit:contain;}

/* Toasts */
#toast-container{position:fixed;top:20px;right:20px;z-index:500;display:flex;flex-direction:column;gap:8px;}
.toast{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:10px;padding:12px 16px;font-size:14px;font-weight:500;
  box-shadow:0 8px 32px rgba(0,0,0,.3);animation:toastIn .3s ease;
  display:flex;align-items:center;gap:8px;
}
@keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.toast.success{border-color:rgba(74,222,128,.3);}
.toast.error{border-color:rgba(248,113,113,.3);}
.toast-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.toast.success .toast-dot{background:var(--green);}
.toast.error .toast-dot{background:var(--red);}

/* ── VIDEO RECORD UI ── */
#vc-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
  z-index:250;align-items:center;justify-content:center;flex-direction:column;gap:20px;
}
#vc-overlay.show{display:flex;}
.vc-preview{
  width:260px;height:260px;border-radius:50%;overflow:hidden;
  border:4px solid var(--accent);background:#000;
}
.vc-preview video{width:100%;height:100%;object-fit:cover;}
.vc-controls{display:flex;gap:20px;align-items:center;}
.vc-btn{
  width:56px;height:56px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:24px;transition:var(--trans);
}
.vc-btn.start{background:var(--red);}
.vc-btn.stop{background:var(--accent);}
.vc-btn.cancel{background:var(--bg4);color:var(--text2);}
.vc-btn svg{width:24px;height:24px;}
.vc-timer{font-size:20px;font-weight:700;color:#fff;}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* Select options */
.select-opt-group{
  background:var(--bg2);border:1px solid var(--border);
  border-radius:12px;overflow:hidden;margin-bottom:16px;
}
.select-opt{
  display:flex;align-items:center;gap:12px;
  padding:13px 16px;cursor:pointer;transition:var(--trans);
  border-bottom:1px solid var(--border);font-size:14px;font-weight:500;
}
.select-opt:last-child{border-bottom:none;}
.select-opt:hover{background:var(--bg3);}
.select-opt.selected::after{content:'';width:8px;height:8px;border-radius:50%;background:var(--accent);margin-left:auto;}

/* sub-panel */
.sub-panel{display:none;}
.sub-panel.open{display:block;}

/* Responsive */
@media(max-width:768px){
  :root{--sidebar-w:100%;}
  .sidebar{position:absolute;z-index:10;height:100%;transition:var(--trans);}
  .sidebar.hidden{transform:translateX(-100%);}
  .main-area{width:100%;}
}
</div>
<div style="display:none" data-dup="4">

<!-- ── AUTH SCREEN ─────────────────────────────────────────────── -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="logo-mark">F</div>
      <h1>Freedom</h1>
      <p>Secure. Fast. Free.</p>
    </div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')">Sign In</div>
      <div class="auth-tab" onclick="switchTab('register')">Create Account</div>
    </div>
    <!-- Login -->
    <div id="tab-login">
      <div class="field"><label>Username</label><input id="l-user" type="text" placeholder="your_username" autocomplete="username"/></div>
      <div class="field"><label>Password</label><input id="l-pass" type="password" placeholder="••••••••" autocomplete="current-password"/></div>
      <button class="btn-primary" onclick="doLogin()">Sign In</button>
    </div>
    <!-- Register -->
    <div id="tab-register" style="display:none">
      <div class="field"><label>Display Name</label><input id="r-name" type="text" placeholder="Your Name"/></div>
      <div class="field"><label>Username</label><input id="r-user" type="text" placeholder="username (min 3 chars)" autocomplete="username"/></div>
      <div class="field"><label>Password</label><input id="r-pass" type="password" placeholder="••••••••" autocomplete="new-password"/></div>
      <button class="btn-primary" onclick="doRegister()">Create Account</button>
    </div>
    <div class="auth-err" id="auth-err"></div>
  </div>
</div>

<!-- ── APP SHELL ────────────────────────────────────────────────── -->
<div id="app">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">Freedom</div>
      <button class="icon-btn" onclick="openCompose()" title="New Message">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      </button>
    </div>
    <div class="search-wrap">
      <div class="search-box">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
        <input type="text" placeholder="Search" id="search-input" oninput="filterChats(this.value)"/>
      </div>
    </div>
    <div class="chat-list" id="chat-list"></div>
    <div class="sidebar-nav">
      <button class="nav-btn active" id="nav-chats" onclick="showPanel('chats')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        Chats
      </button>
      <button class="nav-btn" id="nav-contacts" onclick="showPanel('contacts')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
        Contacts
      </button>
      <button class="nav-btn" id="nav-settings" onclick="showPanel('settings')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        Settings
      </button>
    </div>
  </div>

  <!-- MAIN AREA -->
  <div class="main-area" id="main-area">

    <!-- EMPTY STATE -->
    <div class="empty-state" id="empty-state">
      <div class="mark">F</div>
      <p>Freedom Messenger</p>
      <span>Select a conversation to start</span>
    </div>

    <!-- CHAT WINDOW -->
    <div class="chat-window" id="chat-window">
      <div class="chat-header" id="chat-header">
        <div class="avatar" id="ch-avatar"></div>
        <div class="chat-header-info">
          <div class="name" id="ch-name"></div>
          <div class="status" id="ch-status"></div>
        </div>
        <div class="header-actions">
          <button class="icon-btn" id="call-btn" onclick="startCall('audio')" title="Voice Call">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.79 19.79 19.79 0 01.22 1.18 2 2 0 012.18 0h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.39 7.09a16 16 0 006.52 6.52l1.45-1.45a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 14z"/></svg>
          </button>
          <button class="icon-btn" onclick="startCall('video')" title="Video Call">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
          </button>
          <button class="icon-btn" onclick="openProfile()" title="Profile">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.58-7 8-7s8 3 8 7"/></svg>
          </button>
        </div>
      </div>

      <div class="messages-area" id="messages-area">
        <div class="typing-bubble" id="typing-bubble">
          <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
      </div>

      <div class="input-bar">
        <div class="reply-bar" id="reply-bar">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--accent2);flex-shrink:0"><path d="M3 10h13a5 5 0 010 10H8"/><path d="M7 6L3 10l4 4"/></svg>
          <div class="reply-bar-content">
            <div class="name" id="reply-name"></div>
            <div class="text" id="reply-text"></div>
          </div>
          <button class="reply-close" onclick="cancelReply()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="recording-bar" id="recording-bar">
          <div class="rec-dot"></div>
          <span class="rec-time" id="rec-time">0:00</span>
          <button class="rec-cancel" onclick="cancelRecord()">Cancel</button>
        </div>
        <div class="input-row">
          <button class="icon-btn attach-btn" onclick="document.getElementById('file-input').click()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
          </button>
          <input type="file" id="file-input" accept="image/*,video/*" onchange="handleFileUpload(this)"/>
          <button class="icon-btn" onclick="startVideoCircle()" title="Video circle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>
          </button>
          <div class="input-wrap">
            <textarea class="msg-input" id="msg-input" rows="1" placeholder="Message..." onkeydown="handleKey(event)" oninput="handleInput(this)"></textarea>
          </div>
          <button class="send-btn mic-mode" id="send-btn" onclick="handleSendBtn()">
            <svg id="send-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>
            <svg id="mic-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M12 2a3 3 0 013 3v7a3 3 0 01-6 0V5a3 3 0 013-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- SETTINGS PANEL -->
    <div class="settings-panel" id="settings-panel">
      <div class="settings-header">
        <h2>Settings</h2>
        <button class="icon-btn" onclick="logout()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--red)"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
      </div>
      <div class="settings-body" id="settings-body">
        <!-- Profile card -->
        <div class="profile-card">
          <div class="profile-avatar-wrap" onclick="document.getElementById('avatar-input').click()">
            <div class="avatar" id="my-avatar" style="width:90px;height:90px;font-size:32px;"></div>
            <div class="avatar-edit-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </div>
          </div>
          <input type="file" id="avatar-input" accept="image/*" style="display:none" onchange="uploadAvatar(this)"/>
          <div class="profile-name" id="my-display-name"></div>
          <div class="profile-username" id="my-username-display"></div>
        </div>

        <!-- Edit profile sub-panel -->
        <div class="settings-section">
          <h3>Profile</h3>
          <div class="settings-item">
            <div class="settings-row" onclick="toggleSub('edit-profile-sub')">
              <div class="settings-row-icon" style="background:rgba(108,99,255,.15);color:var(--accent)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              </div>
              <div class="settings-row-info"><div class="label">Edit Profile</div><div class="sub">Name, bio, username</div></div>
              <div class="settings-row-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
            </div>
            <div class="sub-panel" id="edit-profile-sub" style="padding:16px">
              <input class="edit-field" id="edit-name" type="text" placeholder="Display Name"/>
              <textarea class="edit-field" id="edit-bio" placeholder="Bio (about yourself)"></textarea>
              <button class="save-btn" onclick="saveProfile()">Save Changes</button>
            </div>
          </div>
        </div>

        <!-- Privacy settings -->
        <div class="settings-section">
          <h3>Privacy</h3>
          <div class="settings-item">
            <div class="settings-row">
              <div class="settings-row-icon" style="background:rgba(74,222,128,.15);color:var(--green)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
              </div>
              <div class="settings-row-info"><div class="label">Last Seen</div></div>
              <select class="privacy-select" id="priv-lastseen" onchange="savePrivacy()">
                <option value="everyone">Everyone</option>
                <option value="contacts">My Contacts</option>
                <option value="nobody">Nobody</option>
              </select>
            </div>
            <div class="settings-row">
              <div class="settings-row-icon" style="background:rgba(251,191,36,.15);color:var(--yellow)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              </div>
              <div class="settings-row-info"><div class="label">Profile Photo</div></div>
              <select class="privacy-select" id="priv-photo" onchange="savePrivacy()">
                <option value="everyone">Everyone</option>
                <option value="contacts">My Contacts</option>
                <option value="nobody">Nobody</option>
              </select>
            </div>
            <div class="settings-row" style="cursor:default">
              <div class="settings-row-icon" style="background:rgba(108,99,255,.15);color:var(--accent)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 1l22 22"/><path d="M16.72 11.06A10.94 10.94 0 0119 12.55"/><path d="M5 12.55a10.94 10.94 0 015.17-2.39"/><path d="M10.71 5.05A16 16 0 0122.56 9"/><path d="M1.42 9a15.91 15.91 0 014.7-2.88"/><path d="M8.53 16.11a6 6 0 006.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>
              </div>
              <div class="settings-row-info"><div class="label">Online Status</div></div>
              <select class="privacy-select" id="priv-online" onchange="savePrivacy()">
                <option value="everyone">Everyone</option>
                <option value="contacts">My Contacts</option>
                <option value="nobody">Nobody</option>
              </select>
            </div>
          </div>
        </div>

        <!-- App settings -->
        <div class="settings-section">
          <h3>Appearance</h3>
          <div class="settings-item">
            <div class="settings-row" style="cursor:default">
              <div class="settings-row-icon" style="background:rgba(108,99,255,.15);color:var(--accent)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
              </div>
              <div class="settings-row-info"><div class="label">Theme</div><div class="sub">Dark</div></div>
              <div class="toggle on" id="theme-toggle" onclick="this.classList.toggle('on')"></div>
            </div>
            <div class="settings-row" style="cursor:default">
              <div class="settings-row-icon" style="background:rgba(74,222,128,.15);color:var(--green)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
              </div>
              <div class="settings-row-info"><div class="label">Notifications</div></div>
              <div class="toggle on" id="notif-toggle" onclick="toggleNotifications(this)"></div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3>Account</h3>
          <div class="settings-item">
            <div class="settings-row" onclick="logout()" style="color:var(--red)">
              <div class="settings-row-icon" style="background:rgba(248,113,113,.15);color:var(--red)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
              </div>
              <div class="settings-row-info"><div class="label">Sign Out</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTACTS PANEL -->
    <div class="contacts-panel" id="contacts-panel">
      <div class="contacts-header">
        <h2>People</h2>
      </div>
      <div class="contacts-list" id="contacts-list"></div>
    </div>

  </div><!-- /main-area -->
</div><!-- /app -->

<!-- ── CALL OVERLAY ── -->
<div id="call-overlay">
  <div class="video-wrap" id="video-wrap">
    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay muted playsinline></video>
  </div>
  <div class="call-box">
    <div class="call-avatar ringing" id="call-avatar"></div>
    <div class="call-name" id="call-name"></div>
    <div class="call-status" id="call-status">Calling...</div>
    <div class="call-timer" id="call-timer" style="display:none"></div>
    <div class="call-actions" id="call-actions">
      <button class="call-btn mute" id="mute-btn" onclick="toggleMute()" title="Mute">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 013 3v7a3 3 0 01-6 0V5a3 3 0 013-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      </button>
      <button class="call-btn end" onclick="endCall()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 011.72 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.42 19.42 0 013.07 9.12 19.79 19.79 0 01.22 .5 2 2 0 012.18 0h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.39 7.09a16 16 0 006.29 6.22z"/></svg>
      </button>
      <button class="call-btn cam" id="cam-btn" onclick="toggleCam()" title="Camera">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- ── INCOMING CALL ── -->
<div id="incoming-call">
  <div class="inc-top">
    <div class="avatar" id="inc-avatar"></div>
    <div class="inc-info">
      <div class="inc-name" id="inc-name"></div>
      <div class="inc-type" id="inc-type"></div>
    </div>
  </div>
  <div class="inc-actions">
    <button class="inc-btn reject" onclick="rejectCall()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      Decline
    </button>
    <button class="inc-btn accept" onclick="acceptCall()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.79 19.79 19.79 0 01.22 1.18 2 2 0 012.18 0h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.39 7.09a16 16 0 006.52 6.52l1.45-1.45a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 14z"/></svg>
      Answer
    </button>
  </div>
</div>

<!-- ── VIDEO CIRCLE OVERLAY ── -->
<div id="vc-overlay">
  <div class="vc-preview">
    <video id="vc-preview-video" autoplay muted playsinline></video>
  </div>
  <div class="vc-timer" id="vc-timer">0:00</div>
  <div class="vc-controls">
    <button class="vc-btn cancel" onclick="cancelVideoCircle()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <button class="vc-btn start" id="vc-record-btn" onclick="toggleVideoRecord()">
      <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
    </button>
  </div>
</div>

<!-- ── CONTEXT MENU ── -->
<div id="ctx-menu">
  <div class="ctx-item" id="ctx-reply" onclick="ctxReply()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10h13a5 5 0 010 10H8"/><path d="M7 6L3 10l4 4"/></svg>
    Reply
  </div>
  <div class="ctx-item" id="ctx-copy" onclick="ctxCopy()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
    Copy Text
  </div>
  <div class="ctx-item danger" id="ctx-delete" onclick="ctxDelete()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>
    Delete
  </div>
</div>

<!-- ── LIGHTBOX ── -->
<div id="lightbox" onclick="document.getElementById('lightbox').classList.remove('show')">
  <img id="lightbox-img" src="" alt=""/>
</div>

<!-- ── TOAST CONTAINER ── -->
<div id="toast-container"></div>

<!-- ── USER PROFILE MODAL ── -->
<div id="user-profile-modal" onclick="if(event.target===this)closeUserProfile()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;align-items:center;justify-content:center;">
  <div style="background:var(--bg2);border:1px solid var(--border);border-radius:20px;width:320px;overflow:hidden;position:relative;">
    <div id="upm-banner" style="height:90px;background:linear-gradient(135deg,var(--accent),var(--accent2));position:relative;">
      <button onclick="closeUserProfile()" style="position:absolute;top:10px;right:10px;width:30px;height:30px;border-radius:50%;background:rgba(0,0,0,0.4);border:none;color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;">✕</button>
    </div>
    <div style="padding:0 20px 20px;">
      <div style="margin-top:-36px;margin-bottom:12px;display:flex;align-items:flex-end;justify-content:space-between;">
        <div id="upm-avatar" style="width:72px;height:72px;border-radius:50%;border:3px solid var(--bg2);overflow:hidden;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:26px;flex-shrink:0;"></div>
        <div id="upm-status" style="font-size:13px;padding:3px 10px;border-radius:20px;font-weight:600;"></div>
      </div>
      <div id="upm-name" style="font-size:20px;font-weight:700;"></div>
      <div id="upm-handle" style="font-size:13px;color:var(--text2);margin:2px 0 10px;"></div>
      <div id="upm-bio" style="font-size:13px;color:var(--text2);line-height:1.5;margin-bottom:16px;"></div>
      <div style="display:flex;gap:8px;">
        <button onclick="upmChat()" style="flex:1;padding:9px;border-radius:10px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:13px;font-weight:600;font-family:inherit;">💬 Написать</button>
        <button onclick="upmCall('audio')" style="flex:1;padding:9px;border-radius:10px;background:var(--bg3);color:var(--text);border:none;cursor:pointer;font-size:13px;font-weight:600;font-family:inherit;">📞 Звонок</button>
        <button onclick="upmCall('video')" style="flex:1;padding:9px;border-radius:10px;background:var(--bg3);color:var(--text);border:none;cursor:pointer;font-size:13px;font-weight:600;font-family:inherit;">📹 Видео</button>
      </div>
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════════
//  FREEDOM MESSENGER — CLIENT (state vars only, socket from init())
// ═══════════════════════════════════════════════════════════════════════

// socket is created in init() from the dup2 script block

// ── State ──────────────────────────────────────────────────────────────
// me already declared
let activeChat = null;      // username we're chatting with
var allUsers = [];          // all known users
// chatHistory already declared above
let unreadCounts = {};      // username -> count
let lastSeen = {};          // username -> timestamp
let replyingTo = null;      // message being replied to
var ctxMsg = null;          // message for context menu

// Voice recording
let mediaRec = null;
let recChunks = [];
let recTimer = null;
let recSecs = 0;
let isRecording = false;

// Video circle
let vcStream = null;
let vcRec = null;
let vcChunks = [];
let vcTimer = null;
let vcSecs = 0;
let vcRecording = false;

// WebRTC
var pc = null;
var localStream = null;
var callTimer = null;
// callSecs already declared
let incomingOffer = null;
let incomingCaller = null;
let incomingCallType = null;
let isMuted = false;
let isCamOff = false;
let currentCallType = null;

const iceServers = { iceServers: [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' }
]};

// ── Helpers ────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const fmt = (str,...a) => str;

function toast(msg, type='success') {
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<div class="toast-dot"></div>${msg}`;
  $('toast-container').appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

function fmtTime(ts) {
  const d = new Date(ts);
  return d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
}

function fmtDate(ts) {
  const d = new Date(ts);
  const now = new Date();
  const diff = now - d;
  if (diff < 86400000 && d.getDate() === now.getDate()) return 'Today';
  if (diff < 172800000) return 'Yesterday';
  return d.toLocaleDateString([], { month:'short', day:'numeric' });
}

function secs2str(s) {
  return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
}

function getUserInitials(name) {
  return name ? name.charAt(0).toUpperCase() : '?';
}

function getUser(username) {
  return allUsers.find(u => u.username === username) || { username, displayName: username };
}

function renderAvatar(el, user, size=48) {
  if (!user) return;
  el.innerHTML = '';
  el.style.width = size + 'px';
  el.style.height = size + 'px';
  el.style.fontSize = Math.floor(size*0.36) + 'px';
  if (user.avatar) {
    el.style.background = 'transparent';
    const img = document.createElement('img');
    img.src = user.avatar;
    img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:inherit;display:block;';
    el.appendChild(img);
  } else {
    const colors = ['#2d7dd2','#7c4dff','#e91e8c','#00bcd4','#ff6b35','#4caf50','#ff9800','#9c27b0'];
    let h = 0; const str = user.username || '';
    for (let c of str) h = (h*31 + c.charCodeAt(0)) % colors.length;
    el.style.background = colors[h];
    el.textContent = getUserInitials(user.displayName || user.username);
  }
  // Online dot
  const existing = el.querySelector('.online-dot');
  if (existing) existing.remove();
  if (user.online) {
    const dot = document.createElement('div');
    dot.className = 'online-dot';
    el.appendChild(dot);
  }
}

// ── Auth ───────────────────────────────────────────────────────────────
function switchTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => {
    t.classList.toggle('active', (i===0) === (tab==='login'));
  });
  $('tab-login').style.display = tab==='login'?'':'none';
  $('tab-register').style.display = tab==='register'?'':'none';
  $('auth-err').textContent = '';
}

function doLogin() {
  const username = $('l-user').value.trim();
  const password = $('l-pass').value;
  if (!username || !password) { $('auth-err').textContent='Please fill all fields'; return; }
  socket.emit('login', { username, password }, res => {
    if (res.error) { $('auth-err').textContent = res.error; return; }
    onAuth(res.user);
  });
}

function doRegister() {
  const displayName = $('r-name').value.trim();
  const username = $('r-user').value.trim();
  const password = $('r-pass').value;
  if (!displayName || !username || !password) { $('auth-err').textContent='Please fill all fields'; return; }
  socket.emit('register', { username, password, displayName }, res => {
    if (res.error) { $('auth-err').textContent = res.error; return; }
    onAuth(res.user);
  });
}

// Enter key on auth fields
document.querySelectorAll('#tab-login input').forEach(inp =>
  inp.addEventListener('keydown', e => { if (e.key==='Enter') doLogin(); })
);
document.querySelectorAll('#tab-register input').forEach(inp =>
  inp.addEventListener('keydown', e => { if (e.key==='Enter') doRegister(); })
);

function onAuth(user) {
  me = user;
  $('auth-screen').style.display = 'none';
  $('app').classList.add('visible');
  updateMyProfile();
  loadUsers();
  loadPrivacySettings();
  showPanel('chats');
}

function logout() {
  socket.emit('logout');
  me = null;
  activeChat = null;
  chatHistory = {};
  unreadCounts = {};
  $('app').classList.remove('visible');
  $('auth-screen').style.display = 'flex';
  $('chat-list').innerHTML = '';
  $('l-user').value = '';
  $('l-pass').value = '';
  $('auth-err').textContent = '';
}

function updateMyProfile() {
  if (!me) return;
  $('my-display-name').textContent = me.displayName;
  $('my-username-display').textContent = '@' + me.username;
  renderAvatar($('my-avatar'), { ...me, online: true }, 90);
  $('edit-name').value = me.displayName || '';
  $('edit-bio').value = me.bio || '';
}

// ── Users / Contacts ───────────────────────────────────────────────────
function loadUsers() {
  fetch('/api/users').then(r=>r.json()).then(users => {
    allUsers = users.filter(u => u.username !== me.username);
    renderChatList();
    renderContacts();
  });
}

function renderChatList() {
  const list = $('chat-list');
  const query = $('search-input').value.toLowerCase();
  list.innerHTML = '';

  // Build items: users we've chatted with first, then rest
  const chatted = allUsers.filter(u => chatHistory[u.username]?.length > 0);
  const rest    = allUsers.filter(u => !chatHistory[u.username]?.length);
  const ordered = [...chatted, ...rest].filter(u =>
    !query || u.displayName.toLowerCase().includes(query) || u.username.toLowerCase().includes(query)
  );

  ordered.forEach(user => {
    const msgs = chatHistory[user.username] || [];
    const last = msgs[msgs.length-1];
    const uc = unreadCounts[user.username] || 0;
    const div = document.createElement('div');
    div.className = 'chat-item' + (activeChat===user.username?' active':'');
    div.onclick = () => openChat(user.username);

    let preview = '';
    if (last) {
      if (last.type==='voice') preview = 'Voice message';
      else if (last.type==='video_circle') preview = 'Video circle';
      else if (last.type==='image') preview = 'Photo';
      else preview = last.content;
    }

    const av = document.createElement('div');
    av.className = 'avatar';
    renderAvatar(av, user, 48);

    div.innerHTML = `
      <div class="chat-info">
        <div class="chat-name">${user.displayName}</div>
        <div class="chat-preview">${preview || '<span style="color:var(--text3)">Start a conversation</span>'}</div>
      </div>
      <div class="chat-meta">
        <div class="chat-time">${last ? fmtTime(last.timestamp) : ''}</div>
        ${uc > 0 ? `<div class="unread-badge">${uc}</div>` : ''}
      </div>
    `;
    div.insertBefore(av, div.firstChild);
    list.appendChild(div);
  });
}

function filterChats(q) { renderChatList(); }

function renderContacts() {
  const list = $('contacts-list');
  list.innerHTML = '';
  allUsers.forEach(user => {
    const div = document.createElement('div');
    div.className = 'contact-item';
    div.onclick = () => { openChat(user.username); showPanel('chats'); };
    const av = document.createElement('div');
    av.className = 'avatar';
    renderAvatar(av, user, 44);
    div.innerHTML = `
      <div class="info">
        <div class="name">${user.displayName}</div>
        <div class="status ${user.online?'online-s':''}">${user.online ? 'Online' : (lastSeen[user.username] ? 'last seen '+fmtTime(lastSeen[user.username]) : 'Offline')}</div>
      </div>
    `;
    div.insertBefore(av, div.firstChild);
    list.appendChild(div);
  });
}

// ── Chat ───────────────────────────────────────────────────────────────
function openChat(username) {
  activeChat = username;
  unreadCounts[username] = 0;

  const user = getUser(username);
  // Update header
  const av = $('ch-avatar');
  renderAvatar(av, user, 40);
  $('ch-name').textContent = user.displayName || username;
  updateStatus(username);

  document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
  // Mark active
  renderChatList();

  // Show chat window
  $('empty-state').style.display = 'none';
  $('chat-window').classList.add('open');
  $('settings-panel').classList.remove('open');
  $('contacts-panel').classList.remove('open');

  // Load messages
  socket.emit('get_messages', { with: username }, msgs => {
    chatHistory[username] = msgs || [];
    renderMessages();
    socket.emit('mark_read', { chatWith: username });
  });

  $('msg-input').focus();
}

function updateStatus(username) {
  const user = getUser(username);
  const statusEl = $('ch-status');
  if (user.online) {
    statusEl.textContent = 'Online';
    statusEl.className = 'status online';
  } else {
    const ls = lastSeen[username];
    statusEl.textContent = ls ? 'last seen ' + fmtDate(ls) + ' at ' + fmtTime(ls) : 'Offline';
    statusEl.className = 'status';
  }
}

function renderMessages() {
  const area = $('messages-area');
  const msgs = chatHistory[activeChat] || [];
  area.innerHTML = '';

  let lastDate = null;
  msgs.forEach(msg => {
    const d = new Date(msg.timestamp);
    const dateStr = fmtDate(msg.timestamp);
    if (dateStr !== lastDate) {
      const div = document.createElement('div');
      div.className = 'date-divider';
      div.innerHTML = `<span>${dateStr}</span>`;
      area.appendChild(div);
      lastDate = dateStr;
    }
    area.appendChild(createMsgEl(msg));
  });

  // Add typing bubble at end
  const tb = document.createElement('div');
  tb.className = 'typing-bubble';
  tb.id = 'typing-bubble';
  tb.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
  area.appendChild(tb);

  area.scrollTop = area.scrollHeight;
}

function createMsgEl(msg) {
  const isOut = msg.from === me.username;
  const wrap = document.createElement('div');
  wrap.className = `msg-wrap ${isOut ? 'out' : 'in'}`;
  wrap.dataset.id = msg.id;

  let content = '';

  // Reply preview
  if (msg.replyTo) {
    const orig = findMsg(msg.replyTo);
    if (orig) {
      const rName = orig.from === me.username ? 'You' : (getUser(orig.from).displayName || orig.from);
      const rText = orig.type === 'voice' ? 'Voice message' : orig.type === 'video_circle' ? 'Video circle' : (orig.content || '');
      content += `<div class="reply-preview"><div class="reply-name">${rName}</div><div class="reply-text">${rText}</div></div>`;
    }
  }

  // Content by type
  if (msg.type === 'voice') {
    content += buildVoiceMsg(msg);
  } else if (msg.type === 'video_circle') {
    content += buildVideoCircle(msg);
  } else if (msg.type === 'image') {
    content += buildImageMsg(msg);
  } else {
    content += `<span>${escHtml(msg.content)}</span>`;
  }

  const ticks = isOut ? `
    <span class="ticks ${msg.read?'read':''}">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
      ${msg.delivered||msg.read ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-left:-8px"><polyline points="20 6 9 17 4 12"/></svg>` : ''}
    </span>` : '';

  wrap.innerHTML = `
    <div class="msg-bubble">${content}</div>
    <div class="msg-time-status">${fmtTime(msg.timestamp)}${ticks}</div>
  `;

  // Context menu
  wrap.addEventListener('contextmenu', e => {
    e.preventDefault();
    showCtxMenu(e, msg);
  });
  wrap.addEventListener('touchstart', (e) => {
    const t = setTimeout(() => showCtxMenu({ clientX:e.touches[0].clientX, clientY:e.touches[0].clientY }, msg), 600);
    wrap.addEventListener('touchend', () => clearTimeout(t), { once:true });
  });

  // Voice play
  if (msg.type === 'voice') {
    setTimeout(() => setupVoicePlayer(wrap, msg), 0);
  }
  // Video circle play
  if (msg.type === 'video_circle') {
    setTimeout(() => setupVideoCirclePlayer(wrap, msg), 0);
  }
  // Image lightbox
  if (msg.type === 'image') {
    setTimeout(() => {
      const img = wrap.querySelector('.img-msg img');
      if (img) img.addEventListener('click', () => openLightbox(msg.content));
    }, 0);
  }

  return wrap;
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/\n/g,'<br>');
}

function findMsg(id) {
  const msgs = chatHistory[activeChat] || [];
  return msgs.find(m => m.id === id);
}

function buildVoiceMsg(msg) {
  const bars = Array(28).fill(0).map((_,i) => {
    const h = 6 + Math.random()*22;
    return `<div class="wave-bar" style="height:${h}px" data-i="${i}"></div>`;
  }).join('');
  return `
    <div class="voice-msg">
      <button class="play-btn" data-mid="${msg.id}">
        <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      </button>
      <div class="waveform">${bars}</div>
      <span class="voice-dur">${msg.duration ? secs2str(msg.duration) : '0:00'}</span>
    </div>`;
}

function setupVoicePlayer(wrap, msg) {
  const btn = wrap.querySelector('.play-btn');
  const bars = wrap.querySelectorAll('.wave-bar');
  const durEl = wrap.querySelector('.voice-dur');
  if (!btn) return;
  let audio = null;
  let playing = false;
  let progTimer = null;

  btn.addEventListener('click', () => {
    if (!audio) {
      audio = new Audio(msg.content);
      audio.addEventListener('timeupdate', () => {
        const pct = audio.currentTime / (audio.duration || 1);
        const active = Math.floor(pct * bars.length);
        bars.forEach((b,i) => b.classList.toggle('active', i <= active));
        durEl.textContent = secs2str(Math.floor(audio.currentTime));
      });
      audio.addEventListener('ended', () => {
        playing = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
        bars.forEach(b => b.classList.remove('active'));
        durEl.textContent = secs2str(msg.duration || 0);
      });
    }
    if (playing) {
      audio.pause(); playing = false;
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
    } else {
      audio.play(); playing = true;
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
    }
  });
}

function buildVideoCircle(msg) {
  return `
    <div class="video-circle" data-mid="${msg.id}">
      <video src="${msg.content}" loop preload="metadata" playsinline></video>
      <div class="vc-play-overlay">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      </div>
    </div>`;
}

function setupVideoCirclePlayer(wrap, msg) {
  const vc = wrap.querySelector('.video-circle');
  if (!vc) return;
  const video = vc.querySelector('video');
  const overlay = vc.querySelector('.vc-play-overlay');
  vc.addEventListener('click', () => {
    if (video.paused) {
      video.play();
      overlay.style.display = 'none';
    } else {
      video.pause();
      overlay.style.display = 'flex';
    }
  });
}

function buildImageMsg(msg) {
  return `<div class="img-msg"><img src="${msg.content}" alt="Photo" loading="lazy"/></div>`;
}

function appendMsg(msg) {
  if (!chatHistory[msg.from] && msg.from !== me.username) chatHistory[msg.from] = [];
  if (!chatHistory[msg.to] && msg.to !== me.username) chatHistory[msg.to] = [];
  const key = msg.from === me.username ? msg.to : msg.from;
  if (!chatHistory[key]) chatHistory[key] = [];
  chatHistory[key].push(msg);

  if (activeChat === key) {
    const area = $('messages-area');
    const tb = $('typing-bubble');
    area.insertBefore(createMsgEl(msg), tb);
    area.scrollTop = area.scrollHeight;
  }
  renderChatList();
}

// ── Sending ────────────────────────────────────────────────────────────
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendText();
  }
}

function handleInput(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  const hasText = el.value.trim().length > 0;
  $('send-icon').style.display = hasText ? '' : 'none';
  $('mic-icon').style.display = hasText ? 'none' : '';
  $('send-btn').classList.toggle('mic-mode', !hasText);
  if (!activeChat) return;
  socket.emit('typing', { to: activeChat, isTyping: hasText });
}

function handleSendBtn() {
  const hasText = $('msg-input').value.trim().length > 0;
  if (hasText) sendText();
  else startVoiceRecord();
}

function sendText() {
  const input = $('msg-input');
  const text = input.value.trim();
  if (!text || !activeChat) return;
  const data = { to: activeChat, content: text, type: 'text' };
  if (replyingTo) { data.replyTo = replyingTo.id; cancelReply(); }
  socket.emit('send_message', data, res => {
    if (res?.ok) appendMsg(res.message);
  });
  input.value = '';
  input.style.height = 'auto';
  handleInput(input);
  socket.emit('typing', { to: activeChat, isTyping: false });
}

function handleFileUpload(inp) {
  if (!inp.files[0] || !activeChat) return;
  const file = inp.files[0];
  const reader = new FileReader();
  reader.onload = e => {
    const type = file.type.startsWith('video') ? 'video_circle' : 'image';
    const data = { to: activeChat, content: e.target.result, type };
    if (replyingTo) { data.replyTo = replyingTo.id; cancelReply(); }
    socket.emit('send_message', data, res => {
      if (res?.ok) appendMsg(res.message);
    });
  };
  reader.readAsDataURL(file);
  inp.value = '';
}

// ── Voice recording ────────────────────────────────────────────────────
async function startVoiceRecord() {
  if (!activeChat) return;
  if (isRecording) { stopVoiceRecord(); return; }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRec = new MediaRecorder(stream);
    recChunks = [];
    mediaRec.ondataavailable = e => recChunks.push(e.data);
    mediaRec.onstop = sendVoiceMsg;
    mediaRec.start();
    isRecording = true;
    recSecs = 0;
    $('recording-bar').classList.add('show');
    $('rec-time').textContent = '0:00';
    recTimer = setInterval(() => {
      recSecs++;
      $('rec-time').textContent = secs2str(recSecs);
      if (recSecs >= 120) stopVoiceRecord();
    }, 1000);
  } catch(e) {
    toast('Microphone access denied', 'error');
  }
}

function stopVoiceRecord() {
  if (!mediaRec || !isRecording) return;
  mediaRec.stop();
  mediaRec.stream.getTracks().forEach(t=>t.stop());
  isRecording = false;
  clearInterval(recTimer);
  $('recording-bar').classList.remove('show');
}

function cancelRecord() {
  if (mediaRec && isRecording) {
    mediaRec.ondataavailable = null;
    mediaRec.onstop = null;
    mediaRec.stop();
    mediaRec.stream.getTracks().forEach(t=>t.stop());
    isRecording = false;
    clearInterval(recTimer);
    $('recording-bar').classList.remove('show');
    recChunks = [];
  }
}

function sendVoiceMsg() {
  if (recChunks.length === 0) return;
  const blob = new Blob(recChunks, { type: 'audio/webm' });
  const reader = new FileReader();
  const dur = recSecs;
  reader.onload = e => {
    const data = { to: activeChat, content: e.target.result, type: 'voice', duration: dur };
    if (replyingTo) { data.replyTo = replyingTo.id; cancelReply(); }
    socket.emit('send_message', data, res => {
      if (res?.ok) appendMsg(res.message);
    });
  };
  reader.readAsDataURL(blob);
  recChunks = [];
}

// ── Video Circle recording ─────────────────────────────────────────────
async function startVideoCircle() {
  if (!activeChat) return;
  try {
    vcStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' }, audio: true });
    $('vc-preview-video').srcObject = vcStream;
    $('vc-overlay').classList.add('show');
    vcSecs = 0;
    $('vc-timer').textContent = '0:00';
    vcRecording = false;
  } catch(e) {
    toast('Camera/mic access denied', 'error');
  }
}

function toggleVideoRecord() {
  if (!vcRecording) {
    vcRec = new MediaRecorder(vcStream);
    vcChunks = [];
    vcRec.ondataavailable = e => vcChunks.push(e.data);
    vcRec.onstop = sendVideoCircle;
    vcRec.start();
    vcRecording = true;
    vcSecs = 0;
    $('vc-record-btn').style.background = 'var(--accent)';
    $('vc-timer').style.color = 'var(--red)';
    vcTimer = setInterval(() => {
      vcSecs++;
      $('vc-timer').textContent = secs2str(vcSecs);
      if (vcSecs >= 60) { stopVideoRecord(); }
    }, 1000);
  } else {
    stopVideoRecord();
  }
}

function stopVideoRecord() {
  if (vcRec && vcRecording) {
    vcRec.stop();
    vcRecording = false;
    clearInterval(vcTimer);
  }
}

function sendVideoCircle() {
  const blob = new Blob(vcChunks, { type: 'video/webm' });
  const reader = new FileReader();
  reader.onload = e => {
    socket.emit('send_message', { to: activeChat, content: e.target.result, type: 'video_circle' }, res => {
      if (res?.ok) appendMsg(res.message);
    });
  };
  reader.readAsDataURL(blob);
  cancelVideoCircle();
}

function cancelVideoCircle() {
  if (vcStream) { vcStream.getTracks().forEach(t=>t.stop()); vcStream = null; }
  vcChunks = [];
  vcRecording = false;
  clearInterval(vcTimer);
  $('vc-overlay').classList.remove('show');
  $('vc-preview-video').srcObject = null;
  $('vc-timer').textContent = '0:00';
  $('vc-timer').style.color = '#fff';
}

// ── Reply ───────────────────────────────────────────────────────────────
function cancelReply() {
  replyingTo = null;
  $('reply-bar').classList.remove('show');
}

function startReply(msg) {
  replyingTo = msg;
  const name = msg.from === me.username ? 'You' : (getUser(msg.from).displayName || msg.from);
  $('reply-name').textContent = name;
  $('reply-text').textContent = msg.type==='voice'?'Voice message':msg.type==='video_circle'?'Video circle':(msg.content||'');
  $('reply-bar').classList.add('show');
  $('msg-input').focus();
}

// ── Context Menu ───────────────────────────────────────────────────────
function showCtxMenu(e, msg) {
  ctxMsg = msg;
  const menu = $('ctx-menu');
  $('ctx-delete').style.display = msg.from === me.username ? '' : 'none';
  $('ctx-copy').style.display = msg.type === 'text' ? '' : 'none';
  menu.classList.add('show');
  const x = Math.min(e.clientX, window.innerWidth - 180);
  const y = Math.min(e.clientY, window.innerHeight - 140);
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';
}

document.addEventListener('click', () => $('ctx-menu').classList.remove('show'));

function ctxReply() { if (ctxMsg) startReply(ctxMsg); }
function ctxCopy() {
  if (ctxMsg?.content) navigator.clipboard.writeText(ctxMsg.content).then(() => toast('Copied'));
}
function ctxDelete() {
  if (!ctxMsg) return;
  socket.emit('delete_message', { msgId: ctxMsg.id, chatWith: activeChat }, res => {
    if (res?.ok) toast('Message deleted');
  });
}

// ── Lightbox ───────────────────────────────────────────────────────────
function openLightbox(src) {
  $('lightbox-img').src = src;
  $('lightbox').classList.add('show');
}

// ── Panels ─────────────────────────────────────────────────────────────
function showPanel(name) {
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  $(`nav-${name}`)?.classList.add('active');
  if (name !== 'chats') {
    $('chat-window').classList.remove('open');
    $('empty-state').style.display = 'none';
    activeChat = null;
  }
  $('settings-panel').classList.toggle('open', name==='settings');
  $('contacts-panel').classList.toggle('open', name==='contacts');
  if (name === 'chats') {
    $('settings-panel').classList.remove('open');
    $('contacts-panel').classList.remove('open');
    if (!activeChat) $('empty-state').style.display = 'flex';
  }
  renderChatList();
  if (name === 'contacts') renderContacts();
}

function toggleSub(id) {
  const el = $(id);
  el.classList.toggle('open');
}

function openCompose() { showPanel('contacts'); }

// ── Profile modal (other users) ────────────────────────────────────────
var _upmUser = null;

function openProfile() {
  if (!activeChat) return;
  showUserProfile(activeChat);
}

function showUserProfile(username) {
  const user = getUser(username);
  _upmUser = username;

  const av = document.getElementById('upm-avatar');
  renderAvatar(av, user, 72);

  document.getElementById('upm-name').textContent = user.displayName || username;
  document.getElementById('upm-handle').textContent = '@' + username;
  document.getElementById('upm-bio').textContent = user.bio || 'Нет описания';

  const statusEl = document.getElementById('upm-status');
  if (user.online) {
    statusEl.textContent = '● В сети';
    statusEl.style.cssText = 'font-size:13px;padding:3px 10px;border-radius:20px;font-weight:600;color:#4ade80;background:rgba(74,222,128,0.15);';
  } else {
    statusEl.textContent = 'Не в сети';
    statusEl.style.cssText = 'font-size:13px;padding:3px 10px;border-radius:20px;font-weight:600;color:var(--text3);background:var(--bg3);';
  }

  const modal = document.getElementById('user-profile-modal');
  modal.style.display = 'flex';
}

function closeUserProfile() {
  document.getElementById('user-profile-modal').style.display = 'none';
}

function upmChat() { closeUserProfile(); if (_upmUser) openChat(_upmUser); }
function upmCall(type) {
  closeUserProfile();
  if (_upmUser) { if (_upmUser !== activeChat) openChat(_upmUser); setTimeout(() => startCall(type), 300); }
}

// ── Settings ───────────────────────────────────────────────────────────
function loadPrivacySettings() {
  if (!me?.privacy) return;
  const p = me.privacy;
  if ($('priv-lastseen')) $('priv-lastseen').value = p.lastSeen || 'everyone';
  if ($('priv-photo')) $('priv-photo').value = p.profilePhoto || 'everyone';
  if ($('priv-online')) $('priv-online').value = p.online || 'everyone';
}

function savePrivacy() {
  const privacy = {
    lastSeen: $('priv-lastseen').value,
    profilePhoto: $('priv-photo').value,
    online: $('priv-online').value
  };
  socket.emit('update_profile', { privacy }, res => {
    if (res?.ok) { me = { ...me, ...res.user }; toast('Privacy updated'); }
  });
}

function saveProfile() {
  const displayName = $('edit-name').value.trim();
  const bio = $('edit-bio').value;
  if (!displayName) { toast('Name cannot be empty', 'error'); return; }
  socket.emit('update_profile', { displayName, bio }, res => {
    if (res?.ok) {
      me = { ...me, ...res.user };
      updateMyProfile();
      toast('Profile saved');
    }
  });
}

function uploadAvatar(inp) {
  if (!inp.files[0]) return;
  const reader = new FileReader();
  reader.onload = e => {
    const avatar = e.target.result;
    fetch('/api/avatar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: me.username, avatar })
    }).then(r => r.json()).then(() => {
      me.avatar = avatar;
      updateMyProfile();
      // Update in allUsers
      const u = allUsers.find(u => u.username === me.username);
      if (u) u.avatar = avatar;
      toast('Photo updated');
    });
  };
  reader.readAsDataURL(inp.files[0]);
  inp.value = '';
}

// ── WebRTC Calls ───────────────────────────────────────────────────────
async function startCall(type) {
  if (!activeChat) return;
  currentCallType = type;
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      audio: true,
      video: type === 'video'
    });
  } catch(e) {
    toast('Could not access camera/microphone', 'error');
    return;
  }

  pc = new RTCPeerConnection(iceServers);
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.ontrack = e => {
    $('remote-video').srcObject = e.streams[0];
  };
  pc.onicecandidate = e => {
    if (e.candidate) socket.emit('ice_candidate', { to: activeChat, candidate: e.candidate });
  };

  if (type === 'video') {
    $('local-video').srcObject = localStream;
    $('video-wrap').classList.add('show');
  }

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit('call_user', { to: activeChat, offer, callType: type });

  // Show outgoing call UI
  const user = getUser(activeChat);
  showCallOverlay(user, 'Calling...', false);
}

function showCallOverlay(user, status, isIncoming) {
  const av = $('call-avatar');
  renderAvatar(av, user, 90);
  av.classList.toggle('ringing', true);
  $('call-name').textContent = user.displayName || user.username;
  $('call-status').textContent = status;
  $('call-timer').style.display = 'none';
  $('call-overlay').classList.add('show');

  if (isIncoming) {
    // Show answer button
    $('call-actions').innerHTML = `
      <button class="call-btn mute" id="mute-btn" onclick="toggleMute()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 013 3v7a3 3 0 01-6 0V5a3 3 0 013-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      </button>
      <button class="call-btn answer" onclick="acceptCallFull()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.79 19.79 19.79 0 01.22 1.18 2 2 0 012.18 0h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.39 7.09a16 16 0 006.52 6.52l1.45-1.45a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 14z"/></svg>
      </button>
      <button class="call-btn end" onclick="endCall()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 011.72 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.42 19.42 0 013.07 9.12 19.79 19.79 0 01.22.5 2 2 0 012.18 0h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.39 7.09a16 16 0 006.29 6.22z"/></svg>
      </button>
    `;
  }
}

function startCallTimer() {
  callSecs = 0;
  $('call-status').style.display = 'none';
  $('call-timer').style.display = '';
  $('call-avatar').classList.remove('ringing');
  callTimer = setInterval(() => {
    callSecs++;
    $('call-timer').textContent = secs2str(callSecs);
  }, 1000);
}

function endCall() {
  if (activeChat) socket.emit('call_end', { to: activeChat });
  if (incomingCaller) socket.emit('call_end', { to: incomingCaller });
  cleanupCall();
}

function cleanupCall() {
  if (pc) { pc.close(); pc = null; }
  if (localStream) { localStream.getTracks().forEach(t=>t.stop()); localStream = null; }
  if (callTimer) { clearInterval(callTimer); callTimer = null; }
  $('call-overlay').classList.remove('show');
  $('incoming-call').classList.remove('show');
  $('video-wrap').classList.remove('show');
  $('remote-video').srcObject = null;
  $('local-video').srcObject = null;
  $('call-status').style.display = '';
  $('call-timer').style.display = 'none';
  incomingCaller = null;
  incomingOffer = null;
  currentCallType = null;
  isMuted = false;
  isCamOff = false;
  // Reset actions
  $('call-actions').innerHTML = `
    <button class="call-btn mute" id="mute-btn" onclick="toggleMute()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 013 3v7a3 3 0 01-6 0V5a3 3 0 013-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></button>
    <button class="call-btn end" onclick="endCall()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 011.72 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.42 19.42 0 013.07 9.12 19.79 19.79 0 01.22.5 2 2 0 012.18 0h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.39 7.09a16 16 0 006.29 6.22z"/></svg></button>
    <button class="call-btn cam" id="cam-btn" onclick="toggleCam()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg></button>
  `;
}

function toggleMute() {
  if (!localStream) return;
  isMuted = !isMuted;
  localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
  const btn = $('mute-btn');
  if (btn) btn.classList.toggle('active-btn', isMuted);
}

function toggleCam() {
  if (!localStream) return;
  isCamOff = !isCamOff;
  localStream.getVideoTracks().forEach(t => t.enabled = !isCamOff);
  const btn = $('cam-btn');
  if (btn) btn.classList.toggle('active-btn', isCamOff);
}

// Incoming call (small notification)
function showIncomingCall(from, callType) {
  incomingCaller = from;
  incomingCallType = callType;
  const user = getUser(from);
  const av = $('inc-avatar');
  renderAvatar(av, user, 44);
  $('inc-name').textContent = user.displayName || from;
  $('inc-type').textContent = callType === 'video' ? 'Incoming video call' : 'Incoming voice call';
  $('incoming-call').classList.add('show');
}

function rejectCall() {
  socket.emit('call_reject', { to: incomingCaller });
  incomingCaller = null;
  incomingOffer = null;
  $('incoming-call').classList.remove('show');
}

async function acceptCall() {
  $('incoming-call').classList.remove('show');
  const caller = incomingCaller;
  const type = incomingCallType;
  const offer = incomingOffer;
  if (!offer || !caller) return;
  currentCallType = type;

  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      audio: true,
      video: type === 'video'
    });
  } catch(e) {
    toast('Could not access microphone', 'error');
    return;
  }

  pc = new RTCPeerConnection(iceServers);
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  pc.ontrack = e => { $('remote-video').srcObject = e.streams[0]; };
  pc.onicecandidate = e => {
    if (e.candidate) socket.emit('ice_candidate', { to: caller, candidate: e.candidate });
  };

  if (type === 'video') {
    $('local-video').srcObject = localStream;
    $('video-wrap').classList.add('show');
  }

  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  socket.emit('call_answer', { to: caller, answer });

  const user = getUser(caller);
  showCallOverlay(user, 'Connected', false);
  startCallTimer();
}

function acceptCallFull() {
  acceptCall();
}

// ── Socket Events are handled by dup2 init() script ────────────────────
// (socket.on handlers removed to avoid duplicates - dup2 script handles all events)

// ── Notifications toggle ───────────────────────────────────────────────
function toggleNotifications(btn) {
  const wasOn = btn.classList.contains('on');
  if (!wasOn) {
    // Turning ON — request permission first
    if (!('Notification' in window)) {
      toast('Этот браузер не поддерживает уведомления', 'error');
      return;
    }
    if (Notification.permission === 'granted') {
      btn.classList.add('on');
    } else if (Notification.permission === 'denied') {
      toast('Уведомления заблокированы. Разрешите в настройках браузера.', 'error');
    } else {
      Notification.requestPermission().then(perm => {
        if (perm === 'granted') {
          btn.classList.add('on');
          toast('Уведомления включены ✓');
        } else {
          toast('Разрешение на уведомления не получено', 'error');
        }
      });
    }
  } else {
    btn.classList.remove('on');
  }
}

// ── Chat header: click avatar/name to open profile ────────────────────
document.getElementById('ch-avatar')?.addEventListener('click', openProfile);
document.getElementById('ch-name')?.addEventListener('click', openProfile);
document.getElementById('ch-status')?.addEventListener('click', openProfile);

// ── Init ────────────────────────────────────────────────────────────────
// Initial mic icon shown
$('send-icon').style.display = 'none';
$('mic-icon').style.display = '';

// Prevent context menu on messages area
$('messages-area')?.addEventListener('contextmenu', e => e.preventDefault());
</script>
        /* Chat Area */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: #0e1621 url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: soft-light; }
        
        .chat-header { height: 56px; background: var(--tg-sidebar); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; border-bottom: 1px solid var(--tg-border); }
        .chat-info h3 { font-size: 16px; }
        .chat-info span { font-size: 13px; color: var(--tg-accent); }

        /* Messages */
        .messages-container { flex: 1; padding: 15px 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .msg-group { display: flex; flex-direction: column; max-width: 75%; position: relative; margin-bottom: 4px; }
        .msg-group.out { align-self: flex-end; }
        .msg-group.in { align-self: flex-start; }

        .bubble { padding: 8px 12px; border-radius: 12px; font-size: 15px; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .in .bubble { background: var(--tg-msg-in); border-bottom-left-radius: 4px; }
        .out .bubble { background: var(--tg-msg-out); border-bottom-right-radius: 4px; }
        
        .msg-name { font-size: 13px; font-weight: 600; color: var(--tg-accent); margin-bottom: 2px; }
        .msg-time { font-size: 11px; color: var(--tg-muted); float: right; margin-top: 5px; margin-left: 8px; }

        /* Input Bar */
        .input-bar { background: var(--tg-sidebar); padding: 10px 20px; display: flex; align-items: center; gap: 15px; }
        .attach-btn { fill: var(--tg-muted); cursor: pointer; }
        .message-input { flex: 1; background: none; border: none; color: #fff; font-size: 16px; outline: none; padding: 10px 0; }
        .send-btn { color: var(--tg-accent); border: none; background: none; font-weight: bold; cursor: pointer; font-size: 15px; }

        /* Settings Panel */
        .settings-overlay { position: absolute; inset: 0; background: var(--tg-sidebar); z-index: 100; transform: translateX(-100%); transition: 0.3s ease; display: flex; flex-direction: column; }
        .settings-overlay.open { transform: translateX(0); }
        .settings-header { padding: 15px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--tg-border); }
        .settings-content { padding: 20px; flex: 1; overflow-y: auto; }
        .profile-edit { text-align: center; margin-bottom: 30px; }
        .profile-edit .avatar-large { width: 100px; height: 100px; margin: 0 auto 15px; font-size: 36px; }
        .s-input-group { margin-bottom: 20px; }
        .s-input-group label { display: block; color: var(--tg-accent); font-size: 13px; margin-bottom: 8px; font-weight: bold; }
        .s-input { width: 100%; background: var(--tg-bg); border: 1px solid var(--tg-border); padding: 12px; color: #fff; border-radius: 8px; outline: none; }

        svg { fill: var(--tg-muted); width: 24px; height: 24px; }
        .active-svg { fill: var(--tg-accent); }
    </div>
<div style="display:none" data-dup="5">

    <div class="sidebar">
        <div class="sidebar-header">
            <button class="menu-btn" onclick="toggleSettings(true)">
                <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>
            <input type="text" class="search-bar" placeholder="Поиск">
        </div>
        
        <div class="chat-item">
            <div class="avatar" id="sideAva">F</div>
            <div style="flex:1">
                <div style="font-weight: bold; font-size: 15px;">Freedom Global</div>
                <div style="color: var(--tg-muted); font-size: 13px;" id="dhStatus">DH: Ожидание...</div>
            </div>
        </div>

        <div class="settings-overlay" id="settingsPanel">
            <div class="settings-header">
                <button class="menu-btn" onclick="toggleSettings(false)">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h3>Настройки</h3>
            </div>
            <div class="settings-content">
                <div class="profile-edit">
                    <div class="avatar avatar-large" id="setAva">U</div>
                    <button style="background:none; border:none; color:var(--tg-accent); cursor:pointer">Изменить фото</button>
                </div>
                <div class="s-input-group">
                    <label>Ваш никнейм</label>
                    <input type="text" id="nickInp" class="s-input" oninput="saveProfile()">
                </div>
                <div style="background: rgba(51, 144, 236, 0.05); padding: 15px; border-radius: 10px; font-size: 13px; color: var(--tg-muted);">
                    Все сообщения защищены сквозным шифрованием Диффи-Хеллмана. Ключи никогда не покидают браузер.
                </div>
            </div>
        </div>
    </div>

    <div class="main-chat">
        <div class="chat-header">
            <div class="chat-info">
                <h3>Freedom Global Chat</h3>
                <span id="netStatus">ожидание сети...</span>
            </div>
            <div class="encryption-badge" style="font-size: 11px; color: var(--tg-muted);">E2EE SECURED</div>
        </div>

        <div class="messages-container" id="msgBox"></div>

        <div class="input-bar">
            <div class="attach-btn">
                <svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4s-4 1.79-4 4v12.5c0 3.31 2.69 6 6 6s6-2.69 6-6V6h-1.5z"/></svg>
            </div>
            <input type="text" id="mainMsgInput" class="message-input" placeholder="Написать сообщение...">
            <button class="send-btn" onclick="send()">ОТПРАВИТЬ</button>
        </div>
    </div>

    <script>
        var socket2 = io();
        var sharedSecret = null;
        // --- DH ALGORITHM ---
        var P = 0xFFFFFFFB;
        var DH_G = 2;
        var privKey = Math.floor(Math.random() * 1000000);
        var pubKey = BigInt(DH_G) ** BigInt(privKey) % BigInt(P);

        socket2.on('connect', () => {
            document.getElementById('netStatus').textContent = 'в сети';
            socket2.emit('dh-init', { key: pubKey.toString() });
        });

        socket2.on('dh-init', (data) => {
            const remotePubKey = BigInt(data.key);
            sharedSecret = remotePubKey ** BigInt(privKey) % BigInt(P);
            document.getElementById('dhStatus').textContent = 'Шифрование активно';
            document.getElementById('dhStatus').style.color = '#4caf50';
        });

        // --- CRYPTO ---
        function encrypt(t) {
            if(!sharedSecret) return t;
            return CryptoJS.AES.encrypt(t, sharedSecret.toString()).toString();
        }
        function decrypt(c) {
            if(!sharedSecret) return c;
            try {
                const b = CryptoJS.AES.decrypt(c, sharedSecret.toString());
                return b.toString(CryptoJS.enc.Utf8) || "🔒 Зашифровано";
            } catch(e) { return "🔒 Зашифровано"; }
        }

        // --- ACTIONS ---
        function send() {
            const inp = document.getElementById('mainMsgInput');
            if(!inp.value.trim()) return;
            
            const nick = localStorage.getItem('f_nick') || 'User';
            const text = inp.value.trim();
            
            socket2.emit('chat message', { text: encrypt(text), nick: nick });
            render(text, 'out', 'Вы');
            inp.value = '';
        }

        socket2.on('chat message', (data) => {
            render(decrypt(data.text), 'in', data.nick);
        });

        function render(text, type, name) {
            const box = document.getElementById('msgBox');
            const group = document.createElement('div');
            group.className = `msg-group ${type}`;
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            group.innerHTML = `
                ${type === 'in' ? `<div class="msg-name">${name}</div>` : ''}
                <div class="bubble">
                    ${text}
                    <span class="msg-time">${time}</span>
                </div>
            `;
            box.appendChild(group);
            box.scrollTop = box.scrollHeight;
        }

        // --- UI & PROFILE ---
        function toggleSettings(open) {
            document.getElementById('settingsPanel').classList.toggle('open', open);
        }

        function saveProfile() {
            const nick = document.getElementById('nickInp').value;
            localStorage.setItem('f_nick', nick);
            document.getElementById('setAva').textContent = nick.charAt(0).toUpperCase() || 'U';
            document.getElementById('sideAva').textContent = nick.charAt(0).toUpperCase() || 'U';
        }

        window.onload = () => {
            const savedNick = localStorage.getItem('f_nick') || 'Anonymous';
            document.getElementById('nickInp').value = savedNick;
            saveProfile();
        };

        document.getElementById('mainMsgInput').onkeydown = e => { if(e.key === 'Enter') send(); };
    </script>
        .message.in { background-color: var(--message-in); align-self: flex-start; border-bottom-left-radius: 2px; }
        .message.out { background-color: var(--message-out); align-self: flex-end; border-bottom-right-radius: 2px; }
        
        /* ВВОД */
        .input-area { background-color: var(--bg-panel); padding: 10px 20px; display: flex; align-items: center; gap: 12px; }
        .input-field { flex: 1; background: var(--bg-dark); border: none; padding: 12px 18px; border-radius: 22px; color: #fff; outline: none; }
        
        /* МОДАЛКА НАСТРОЕК */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-panel); width: 400px; border-radius: 15px; overflow: hidden; }
        .settings-list { padding: 20px; }
        .s-item { margin-bottom: 15px; }
        .s-item label { display: block; font-size: 12px; color: var(--success); margin-bottom: 5px; text-transform: uppercase; }
        .s-item input { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); padding: 10px; color: #fff; border-radius: 8px; outline: none; }

        .btn-icon { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; display: flex; align-items: center; }
        svg { fill: var(--text-muted); width: 24px; height: 24px; }
        .rec-active { fill: var(--danger) !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </div>
<div style="display:none" data-dup="6">

    <div class="sidebar">
        <div class="sidebar-header">
            <button class="btn-icon" onclick="toggleModal(true)">
                <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>
            <input type="text" class="search-bar" placeholder="Поиск">
        </div>
        <div style="padding: 20px; color: var(--text-muted); font-size: 13px; text-align: center;">
            Freedom Messenger<br>Сквозное шифрование включено
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div class="header-info">
                <h2>Freedom Global Chat</h2>
                <span id="netStatus">подключение...</span>
            </div>
        </div>

        <div class="messages" id="msgBox"></div>

        <div class="input-area">
            <input type="text" id="msgInput" class="input-field" placeholder="Написать сообщение...">
            <button class="btn-icon" id="sendBtn" style="display:none" onclick="sendMsg()">
                <svg style="fill:var(--success)" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
            <button class="btn-icon" id="micBtn" onclick="toggleMic()">
                <svg id="micIcon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
            </button>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                <h3>Настройки</h3>
                <button onclick="toggleModal(false)" style="background:none; border:none; color:#fff; cursor:pointer;">✕</button>
            </div>
            <div class="settings-list">
                <div class="s-item">
                    <label>Ваш ник</label>
                    <input type="text" id="nickInp" placeholder="Напр. Pavel">
                </div>
                <div class="s-item">
                    <label>Ключ шифрования (AES)</label>
                    <input type="password" id="cryptoInp" placeholder="Секретный код">
                </div>
                <button onclick="saveSettings()" style="width:100%; padding:12px; background:var(--success); border:none; color:#fff; border-radius:8px; cursor:pointer; font-weight:bold;">СОХРАНИТЬ</button>
            </div>
        </div>
    </div>

    <script>
        // ГЛОБАЛЬНЫЙ ЧАТ (legacy-блок, скрытый) — использует отдельный сокет
        // ВАЖНО: не перезаписываем глобальную переменную socket, иначе ломается основной мессенджер
        (function() {
        var _gcSocket = null; // отдельный сокет для глобального чата (не используется без CryptoJS)
        var isRecording2 = false;
        var mediaRecorder2;
        var audioChunks2 = [];

        // Функции шифрования и рендеринга (для глобального чата — скрытого блока)
        function _gcRenderMsg(text, type, author, isAudio) {
            isAudio = isAudio || false;
            var box = document.getElementById('msgBox');
            if (!box) return;
            var div = document.createElement('div');
            div.className = 'message ' + type;
            var name = document.createElement('span');
            name.className = 'msg-author';
            name.textContent = author;
            div.appendChild(name);
            if (isAudio) {
                var aud = document.createElement('audio');
                aud.src = text; aud.controls = true; aud.style.width = '200px';
                div.appendChild(aud);
            } else {
                var t = document.createElement('div');
                t.textContent = text;
                div.appendChild(t);
            }
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function toggleModal(show) {
            var m = document.getElementById('settingsModal');
            if (m) m.style.display = show ? 'flex' : 'none';
        }
        function saveSettings() {
            var nick = document.getElementById('nickInp');
            var key = document.getElementById('cryptoInp');
            if (nick) localStorage.setItem('f_nick', nick.value);
            if (key) localStorage.setItem('f_key', key.value);
            toggleModal(false);
        }

        // Загружаем сохранённые настройки при загрузке страницы
        window.addEventListener('load', function() {
            var nick = document.getElementById('nickInp');
            var key = document.getElementById('cryptoInp');
            if (nick) nick.value = localStorage.getItem('f_nick') || '';
            if (key) key.value = localStorage.getItem('f_key') || '';
        });

        var msgInp = document.getElementById('msgInput');
        if (msgInp) {
            msgInp.oninput = function() {
                var hasVal = msgInp.value.trim() !== '';
                var sendBtn = document.getElementById('sendBtn');
                var micBtn = document.getElementById('micBtn');
                if (sendBtn) sendBtn.style.display = hasVal ? 'block' : 'none';
                if (micBtn) micBtn.style.display = hasVal ? 'none' : 'block';
            };
            msgInp.onkeydown = function(e) { if (e.key === 'Enter') { /* global chat send disabled */ } };
        }
        })();
    </script>

<!-- ═══════════════════════════════════════════════════════════
     ФИНАЛЬНЫЕ ПЕРЕОПРЕДЕЛЕНИЯ — исправляют конфликты ID/классов
     между несколькими версиями кода в файле
════════════════════════════════════════════════════════════ -->
<!-- STYLE-DISABLED 
/* ── ФИНАЛЬНЫЙ ОВЕРРАЙД МОБИЛЬНОЙ РАСКЛАДКИ ── */
@media (max-width: 768px) {
  /* #app — вертикальная колонка, на весь экран */
  #app.on {
    display: flex !important;
    flex-direction: column !important;
    width: 100vw !important;
    height: 100vh !important;
    overflow: hidden !important;
    position: fixed !important;
    inset: 0 !important;
  }
  /* Сайдбар — на весь экран по умолчанию */
  #app.on .sidebar {
    width: 100% !important;
    max-width: 100% !important;
    flex-shrink: 0 !important;
    height: 100% !important;
    flex: 1 !important;
  }
  /* Чат-область — скрыта пока не открыт чат */
  #app.on .chat-area {
    display: none !important;
    position: fixed !important;
    inset: 0 !important;
    z-index: 100 !important;
    width: 100vw !important;
    height: 100vh !important;
    flex-direction: column !important;
  }
  /* Чат открыт — показываем поверх сайдбара */
  #app.on .chat-area.mob {
    display: flex !important;
  }
  /* Кнопка "назад" — видна только в открытом чате */
  .back-btn { display: flex !important; }
  /* Панель настроек */
  .sett-panel { width: 100% !important; right: -100% !important; }
}
@media (min-width: 769px) {
  .back-btn { display: none !important; }
}
 END-STYLE-DISABLED -->
<script>
(function() {
  // Правильный #app использует класс 'on', а не 'visible'
  // loadUsers должен обновлять переменную users и clist
  // switchTab с двумя аргументами — для боковой панели

  // ── Открытие чата — правильная мобильная логика ──
  window.openChat = function(username) {
    cur = username;
    if (typeof unread !== 'undefined') unread[username] = 0;
    if (typeof unreadCounts !== 'undefined') unreadCounts[username] = 0;

    var u = (typeof users !== 'undefined' ? users : []).find(function(x){ return x.username === username; })
            || { username: username, displayName: username };

    // Обновляем шапку чата
    var hav = document.getElementById('ch-av');
    if (hav) { hav.style.background = col(username); setAv(hav, u, '12px'); }
    var chName = document.getElementById('ch-name');
    if (chName) chName.textContent = u.displayName || username;
    var chStatus = document.getElementById('ch-status');
    if (chStatus) {
      chStatus.textContent = u.online ? 'В сети' : 'Не в сети';
      chStatus.className = 'ch-status' + (u.online ? ' on' : '');
    }

    // Показываем чат
    var noChat   = document.getElementById('no-chat');
    var chatView = document.getElementById('chat-view');
    var chatArea = document.getElementById('chat-area');
    if (noChat)   noChat.style.display   = 'none';
    if (chatView) chatView.style.display = 'flex';
    if (chatArea) chatArea.classList.add('mob');

    // Загружаем сообщения
    socket.emit('get_messages', { with: username }, function(msgs) {
      if (typeof hist !== 'undefined') hist[username] = msgs || [];
      if (typeof chatHistory !== 'undefined') chatHistory[username] = msgs || [];
      if (typeof renderMsgs === 'function') renderMsgs();
      if (typeof renderMessages === 'function') renderMessages();
      if (typeof scrollBot === 'function') scrollBot();
      socket.emit('mark_read', { chatWith: username });
    });

    if (typeof renderList === 'function') renderList();
  };

  window.closeMob = function() {
    var chatArea = document.getElementById('chat-area');
    if (chatArea) chatArea.classList.remove('mob');
  };

  window.onAuth = function(user) {
    me = user;
    // сохраняем сессию (на случай если вход через restore не сохранил)
    // (doLogin/doReg уже сохраняют, но на всякий случай)
    var saved = localStorage.getItem('userSession');
    if (!saved) {
      // не можем сохранить без пароля здесь — просто пропускаем
    }
    // скрываем экран входа, показываем приложение
    var authEl = document.getElementById('auth-screen');
    var appEl  = document.getElementById('app');
    if (authEl) authEl.style.display = 'none';
    if (appEl)  { appEl.classList.add('on'); appEl.classList.remove('visible'); }
    updMe();
    loadUsers();
  };

  window.loadUsers = function() {
    fetch('/api/users').then(function(r){ return r.json(); }).then(function(u) {
      // обновляем ОБЕ переменные — и users (для renderList) и allUsers
      users    = u.filter(function(x){ return x.username !== me.username; });
      allUsers = users;
      renderList();
    });
  };

  // switchTab вызывается из HTML с двумя аргументами (tab, btnElement)
  window.switchTab = function(tab, btn) {
    document.querySelectorAll('.sb-tab').forEach(function(t){ t.classList.remove('active'); });
    if (btn && btn.classList) btn.classList.add('active');
    renderList(tab);
  };

  // doLogout — используем правильный класс 'on'
  window.doLogout = function() {
    socket.emit('logout');
    me = null; cur = null; users = []; allUsers = []; hist = {}; unread = {}; prev = {};
    localStorage.removeItem('userSession');
    var appEl  = document.getElementById('app');
    var authEl = document.getElementById('auth-screen');
    var cv     = document.getElementById('chat-view');
    var nc     = document.getElementById('no-chat');
    if (appEl)  appEl.classList.remove('on');
    if (authEl) authEl.style.display = 'flex';
    if (cv)     cv.style.display = 'none';
    if (nc)     nc.style.display = 'flex';
    closeSett();
  };
})();
</script>

<!-- ═══════════════ MASTER PATCH ═══════════════ -->
<!-- STYLE-DISABLED 
/* ── 1. Недостающие CSS переменные ── */
[data-theme="dark"]  { --bg2:#13151c;--bg3:#1a1d27;--bg4:#20232f;--accent2:#7c4dff;--trans:all .2s ease;--msg-out:#1c3a6e;--msg-in:#1a1d27; }
[data-theme="light"] { --bg2:#fff;--bg3:#f4f6fb;--bg4:#e8ecf5;--accent2:#6c3fe8;--trans:all .2s ease;--msg-out:#dbeafe;--msg-in:#fff; }

/* ── 2. Placeholder — видимый текст в полях ── */
input::placeholder, textarea::placeholder,
.sett-inp::placeholder, .field input::placeholder,
.msg-inp::placeholder, .msg-input::placeholder,
#mi::placeholder, #msg-input::placeholder {
  color: rgba(180,185,200,0.75) !important;
  opacity: 1 !important;
  -webkit-text-fill-color: rgba(180,185,200,0.75) !important;
}
[data-theme="light"] input::placeholder,
[data-theme="light"] textarea::placeholder,
[data-theme="light"] .sett-inp::placeholder {
  color: rgba(80,90,120,0.6) !important;
  -webkit-text-fill-color: rgba(80,90,120,0.6) !important;
}

/* ── 3. Текст в input/textarea всегда виден ── */
input, textarea, .sett-inp, .sett-ta,
#mi, .msg-inp, #msg-input, .msg-input {
  color: var(--text) !important;
  -webkit-text-fill-color: var(--text) !important;
}

/* ── 4. Текст сообщений всегда виден ── */
.bbl-text, .bubble-text, .bubble { color: var(--text) !important; }

/* ── 5. Панель ввода — всегда видна на мобайле ── */
#chat-view {
  flex-direction: column !important;
  overflow: hidden !important;
}
#chat-view .ibar {
  flex-shrink: 0 !important;
  display: block !important;
  background: var(--sidebar) !important;
  border-top: 1px solid var(--border) !important;
  padding: 10px 14px max(12px,env(safe-area-inset-bottom)) !important;
}
#chat-view .msgs {
  flex: 1 1 0 !important;
  overflow-y: auto !important;
  min-height: 0 !important;
  -webkit-overflow-scrolling: touch !important;
}

/* ── 6. Профиль — аватар над градиентом ── */
.pm-body { position:relative !important; z-index:2 !important; background:var(--sidebar) !important; }
.pm-av   { position:relative !important; z-index:5 !important; overflow:hidden !important; }
.pm-av-row { position:relative !important; z-index:4 !important; }
.pm-banner { z-index:1 !important; }

/* ── 7. Модалки и настройки ── */
.modal-over,#pwd-modal,#pmo,.pm-over { z-index:1100 !important; }
.sett-panel { position:fixed !important; top:0 !important; right:-100% !important; width:360px !important; max-width:100vw !important; height:100vh !important; z-index:1000 !important; overflow-y:auto !important; transition:right .3s ease !important; }
.sett-panel.on { right:0 !important; }
#sett-overlay { display:none; position:fixed; inset:0; z-index:999; background:rgba(0,0,0,.45); }
#sett-overlay.on { display:block; }
#co { z-index:2000 !important; }
#eb, textarea.sett-ta { height:90px !important; max-height:200px !important; resize:vertical !important; }

/* ── 8. Мобайл ── */
@media (max-width:768px) {
  .sett-panel { width:100% !important; }
  #app.on .chat-area.mob { display:flex !important; flex-direction:column !important; height:100vh !important; overflow:hidden !important; }
}
 END-STYLE-DISABLED -->

<div id="sett-overlay" onclick="closeSett&&closeSett()"></div>

<script>
(function(){

/* ── ЛОГИН ── */
function gv(ids){for(var i=0;i<ids.length;i++){var el=document.getElementById(ids[i]);if(el)return el;}return null;}

window.doLogin=function(){
  var uEl=gv(['lu','login-username','l-user']),pEl=gv(['lp','login-password','l-pass']);
  if(!uEl||!pEl)return;
  var u=uEl.value.trim(),p=pEl.value;
  if(!u||!p){var e=gv(['le','login-error']);if(e)e.textContent='Заполните все поля';return;}
  socket.emit('login',{username:u,password:p},function(r){
    if(r&&(r.ok||r.user)){localStorage.setItem('userSession',JSON.stringify({username:u,password:p}));if(typeof window.onAuth==='function')window.onAuth(r.user||r);}
    else{var e=gv(['le','login-error']);if(e)e.textContent=(r&&r.error)||'Ошибка входа';}
  });
};

window.doReg=function(){
  var nEl=gv(['rn','reg-displayname','r-name']),uEl=gv(['ru','reg-username','r-user']),pEl=gv(['rp','reg-password','r-pass']);
  if(!nEl||!uEl||!pEl)return;
  var n=nEl.value.trim(),u=uEl.value.trim(),p=pEl.value;
  if(!n||!u||!p){var e=gv(['re','reg-error']);if(e)e.textContent='Заполните все поля';return;}
  socket.emit('register',{username:u,password:p,displayName:n},function(r){
    if(r&&(r.ok||r.user)){localStorage.setItem('userSession',JSON.stringify({username:u,password:p}));if(typeof window.onAuth==='function')window.onAuth(r.user||r);}
    else{var e=gv(['re','reg-error']);if(e)e.textContent=(r&&r.error)||'Ошибка';}
  });
};
window.doRegister=window.doReg;

/* ── ИСПРАВЛЕНИЕ: startCallTimer всегда использует правильный элемент ctmr ── */
startCallTimer = function() {
  try{ clearInterval(callInt); }catch(e){}
  callSecs = 0;
  try{ callSeconds = 0; }catch(e){}
  var el = document.getElementById('ctmr');
  if(el){ el.style.display = 'block'; el.textContent = '0:00'; }
  callInt = setInterval(function(){
    callSecs++;
    try{ callSeconds = callSecs; }catch(e){}
    var el = document.getElementById('ctmr');
    if(el) el.textContent = Math.floor(callSecs/60) + ':' + String(callSecs%60).padStart(2,'0');
  }, 1000);
};

/* ── ПЕРЕХВАТ SOCKET — реалтайм сообщения и звонки ── */
// Переменная для отслеживания звонящего (нужна для "Пропущенный звонок" у принимающего)
window._pendingCaller = null;

function interceptSocket(){
  if(!window.socket){setTimeout(interceptSocket,200);return;}
  if(socket.__patched)return;
  socket.__patched=true;

  var _orig=socket.onevent.bind(socket);
  socket.onevent=function(packet){
    _orig(packet);
    var ev=packet.data&&packet.data[0],data=packet.data&&packet.data[1];
    if(ev==='new_message') masterMsg(data);
    if(ev==='incoming_call'){
      // Запоминаем кто звонит — нужно для пропущенного звонка
      if(data && data.from) window._pendingCaller = data.from;
      masterCall(data);
    }
    // Если звонок завершён звонящим до ответа — это пропущенный звонок для нас
    if(ev==='call_ended'){
      if(!window._inCall && window._pendingCaller){
        var caller = window._pendingCaller;
        // Небольшая задержка чтобы _doCleanCall успел закрыть UI
        setTimeout(function(){
          // isIncoming=true: звонок пришёл ОТ caller, мы не ответили
          if(typeof _injectCallMsg === 'function') _injectCallMsg(caller, 'missed', true);
        }, 100);
      }
      window._pendingCaller = null;
    }
    // Когда принимающий отклоняет — сбрасываем
    if(ev==='call_rejected') window._pendingCaller = null;
  };
}

function masterMsg(msg){
  // masterMsg вызывается через interceptSocket (патч onevent).
  // onMsg уже вызван через socket.on('new_message', onMsg) ДО этого.
  // onMsg уже вызвал pushMsg и сохранил в hist.
  // Здесь нам нужно только синхронизировать chatHistory (другой скрипт) и renderChatList.
  if(!msg||!me)return;
  var key=msg.from===me.username?msg.to:msg.from;
  try{if(!chatHistory[key])chatHistory[key]=[];if(!chatHistory[key].find(function(m){return m.id===msg.id;}))chatHistory[key].push(msg);}catch(e){}
  if(typeof renderChatList==='function')renderChatList();
}

var PHONE_ICO='<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1-9.4 0-17-7.6-17-17 0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z"/></svg>';

function masterCall(data){
  if(!data)return;
  // If already in an active call, ignore new incoming (anti-double-trigger)
  if(window._inCall){return;}
  var from=data.from,offer=data.offer,ctype=data.callType||data.type||'audio';
  try{callUser=from;callKind=ctype;}catch(e){}
  try{currentCallUser=from;window.callType=ctype;window.incomingOffer=offer;}catch(e){}

  var uList=[];try{uList=users||allUsers||[];}catch(e){}
  var u=uList.find(function(x){return x.username===from;})||{username:from,displayName:from};
  var tl=ctype==='video'?'Видеозвонок':'Аудиозвонок';

  var co=document.getElementById('co'),cav=document.getElementById('cav'),cnm=document.getElementById('cnm'),cst=document.getElementById('cst'),cbtns=document.getElementById('cbtns');
  if(co&&cav&&cnm&&cst&&cbtns){
    if(typeof col==='function')cav.style.background=col(from);
    if(typeof setAv==='function')setAv(cav,u,'22px');else cav.textContent=(u.displayName||from)[0].toUpperCase();
    cnm.textContent=u.displayName||from;
    cst.textContent='Входящий '+tl.toLowerCase();
    cbtns.innerHTML='<div class="call-btn-wrap"><button class="cbtn decline" onclick="rejectCall()">'+PHONE_ICO+'</button><span>Отклонить</span></div><div class="call-btn-wrap"><button class="cbtn accept" id="acc-m">'+PHONE_ICO+'</button><span>Принять</span></div>';
    co.classList.add('on');co.style.display='';
    var accBtn=document.getElementById('acc-m');
    if(accBtn)accBtn.onclick=function(){
      // Prevent re-click
      if(accBtn)accBtn.disabled=true;
      masterAccept(offer,ctype,from,u);
    };
  }else if(confirm('Входящий звонок от '+(u.displayName||from)+'. Принять?')){
    masterAccept(offer,ctype,from,u);
  }else{socket.emit('call_reject',{to:from});}
}

window.masterAccept=async function(offer,ctype,from,u){
  window._inCall=true; // Mark as in-call immediately to block re-triggers
  try{
    var ns=await navigator.mediaDevices.getUserMedia(ctype==='video'?{audio:true,video:true}:{audio:true});
    try{stream=ns;}catch(e){}
    if(ctype==='video'){var lv=document.getElementById('localVideo');if(lv)lv.srcObject=ns;var va=document.getElementById('va');if(va)va.classList.add('on');}
    var np=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]});
    try{pc=np;}catch(e){}window._pc=np;try{peerConnection=np;}catch(e){}
    ns.getTracks().forEach(function(t){np.addTrack(t,ns);});
    np.ontrack=function(e){var rv=document.getElementById('remoteVideo');if(rv&&e.streams[0]){rv.style.display='block';rv.srcObject=e.streams[0];}
      var ra=document.getElementById('remoteAudio');if(!ra){ra=document.createElement('audio');ra.id='remoteAudio';ra.autoplay=true;ra.style.display='none';document.body.appendChild(ra);}ra.srcObject=e.streams[0];};
    np.onicecandidate=function(e){if(e.candidate)socket.emit('ice_candidate',{to:from,candidate:e.candidate});};
    await np.setRemoteDescription(new RTCSessionDescription(offer));
    var ans=await np.createAnswer();await np.setLocalDescription(ans);
    socket.emit('call_answer',{to:from,answer:ans});
    var cst=document.getElementById('cst'),cbtns=document.getElementById('cbtns'),ctmr=document.getElementById('ctmr');
    if(cst)cst.textContent=ctype==='video'?'Видеозвонок':'Аудиозвонок';
    if(ctmr)ctmr.style.display='block';
    if(cbtns)cbtns.innerHTML='<div class="call-btn-wrap"><button class="cbtn end-call" onclick="endCall()">'+PHONE_ICO+'</button><span>Завершить</span></div>';
    if(typeof startCallTimer==='function')startCallTimer();
    else if(callInt===undefined||callInt===null){callSecs=0;var el2=document.getElementById('ctmr');if(el2){el2.style.display='block';callInt=setInterval(function(){callSecs++;el2.textContent=fs(callSecs);},1000);}}
  }catch(err){
    window._inCall=false;
    var emsg=err&&err.name==='NotAllowedError'?'Нет разрешения на микрофон/камеру':(err.message||'Ошибка соединения');
    alert('Ошибка принятия звонка: '+emsg);
    window._doCleanCall&&window._doCleanCall();
  }
};

/* ── openChat ── */
window.openChat=function(username){
  try{cur=username;}catch(e){}try{currentChat=username;}catch(e){}try{activeChat=username;}catch(e){}
  var uList=[];try{uList=users||allUsers||[];}catch(e){}
  var user=uList.find(function(x){return x.username===username;})||{username:username,displayName:username};
  var hav=document.getElementById('ch-av');
  if(hav){hav.style.background=typeof col==='function'?col(username):'#4f8ef7';if(typeof setAv==='function')setAv(hav,user,'12px');}
  var cn=document.getElementById('ch-name');if(cn)cn.textContent=user.displayName||username;
  var cs=document.getElementById('ch-status');
  if(cs){cs.textContent=user.online?'В сети':'Не в сети';cs.className='ch-status'+(user.online?' on':'');}
  var nc=document.getElementById('no-chat'),cv=document.getElementById('chat-view'),ca=document.getElementById('chat-area');
  if(nc)nc.style.display='none';
  if(cv){cv.style.display='flex';cv.style.flexDirection='column';}
  if(ca)ca.classList.add('mob');
  try{unread[username]=0;}catch(e){}try{unreadCounts[username]=0;}catch(e){}
  socket.emit('get_messages',{with:username},function(msgs){
    try{hist[username]=msgs||[];}catch(e){}try{chatHistory[username]=msgs||[];}catch(e){}
    if(typeof renderMsgs==='function')renderMsgs();
    if(typeof renderMessages==='function')renderMessages();
    if(typeof scrollBot==='function')scrollBot();
    if(typeof scrollBottom==='function')scrollBottom();
    socket.emit('mark_read',{chatWith:username});
  });
  if(typeof renderList==='function')renderList();
  if(typeof renderChatList==='function')renderChatList();
  setTimeout(function(){var inp=document.getElementById('mi')||document.getElementById('msg-input');if(inp)inp.focus();},100);
};

window.closeMob=function(){var ca=document.getElementById('chat-area');if(ca)ca.classList.remove('mob');};

window.onAuth=function(user){
  me=user;
  try{cur=null;currentChat=null;activeChat=null;}catch(e){}
  var ae=document.getElementById('auth-screen'),ap=document.getElementById('app');
  if(ae)ae.style.display='none';
  if(ap){ap.classList.add('on');ap.classList.remove('visible');}
  if(typeof updMe==='function')updMe();
  if(typeof window.loadUsers==='function')window.loadUsers();
  interceptSocket();
};

window.loadUsers=function(){
  fetch('/api/users').then(function(r){return r.json();}).then(function(u){
    users=allUsers=u.filter(function(x){return x.username!==me.username;});
    if(typeof renderList==='function')renderList();
    if(typeof renderChatList==='function')renderChatList();
  });
};

window.openSett=function(){var sp=document.getElementById('sp'),ov=document.getElementById('sett-overlay'),sef=document.getElementById('sef');if(sp)sp.classList.add('on');if(ov)ov.classList.add('on');if(sef)sef.classList.remove('on');if(typeof updMe==='function')updMe();};
window.closeSett=function(){var sp=document.getElementById('sp'),ov=document.getElementById('sett-overlay');if(sp)sp.classList.remove('on');if(ov)ov.classList.remove('on');};

window.sendMsg=function(){
  var target=null;try{target=cur||currentChat||activeChat;}catch(e){}if(!target)return;
  var inp=document.getElementById('mi')||document.getElementById('msg-input');if(!inp)return;
  var text=inp.value.trim();
  var img=null;try{img=attachImg;}catch(e){}
  if(!text&&!img)return;
  var rid=null;try{rid=replyTo||replyMsg&&replyMsg.id;}catch(e){}
  // Очищаем поле сразу, не ждём ответа сервера
  inp.value='';inp.style.height='auto';
  try{attachImg=null;}catch(e){}try{replyTo=null;replyMsg=null;}catch(e){}
  var rs=document.getElementById('rs'),is=document.getElementById('is');
  if(rs)rs.classList.remove('on');if(is)is.classList.remove('on');
  socket.emit('send_message',{to:target,text:text,replyTo:rid,image:img},function(res){
    if(!res||!res.ok)return;
    if(res.message){
      var alreadyRendered=document.getElementById('mw-'+res.message.id);
      if(!alreadyRendered&&typeof pushMsg==='function'){
        try{pushMsg(res.message);}catch(e){}
      }
    }
  });
  try{socket.emit('typing',{to:target,isTyping:false});typing=false;}catch(e){}
};

window.endCall=function(){
  var t=null;try{t=callUser||currentCallUser;}catch(e){}if(!t)try{t=cur||currentChat;}catch(e){}
  if(t){
    socket.emit('call_end',{to:t});
    // Only inject ended message if call was active (had timer running)
    if(window._inCall)_injectCallMsg(t,'ended');
  }
  window._doCleanCall();
};
window.rejectCall=function(){
  var t=null;try{t=callUser||currentCallUser;}catch(e){}
  if(t){
    socket.emit('call_reject',{to:t});
    // Inject missed call notice into chat history for callee
    _injectCallMsg(t,'missed');
  }
  window._doCleanCall();
};
// Helper: inject call event as a system message in the chat
window._injectCallMsg=function(username, type, isIncoming){
  // isIncoming=true: мы принимающие (звонок пришёл к нам от username, но мы не ответили)
  // isIncoming=false/undefined: мы звонящие (звонили username, он не ответил)
  var icon=type==='missed'?'📵':'📞';
  var txt;
  if(type==='missed'){
    txt = isIncoming ? 'Пропущенный звонок от '+username : 'Пропущенный звонок';
  } else {
    txt = 'Звонок завершён';
  }
  var fromUser = isIncoming ? username : (me?me.username:'');
  var toUser   = isIncoming ? (me?me.username:'') : username;
  var fakeMsg={
    id:'call-'+Date.now(),
    from: fromUser,
    to: toUser,
    content:icon+' '+txt,
    type:'call-event',
    timestamp:new Date().toISOString(),
    read:true
  };
  try{
    if(!hist[username])hist[username]=[];
    hist[username].push(fakeMsg);
    var cu=null;try{cu=cur||currentChat;}catch(e){}
    if(cu===username&&typeof pushMsg==='function'){
      var d=document.createElement('div');d.innerHTML=bbl(fakeMsg);
      var el=d.firstElementChild;
      if(el){
        el.style.opacity='0.7';
        var area=document.getElementById('msgs');
        if(area){area.appendChild(el);area.scrollTop=area.scrollHeight;}
      }
    }
    // Update prev/chatPreviews
    try{prev[username]=fakeMsg;}catch(e){}
    if(typeof renderList==='function')renderList();
  }catch(e){}
};

// Handle call rejected/ended FROM server → add to chat for CALLER
window._doCleanCall=function(){
  window._inCall=false; // Allow new calls after cleanup
  var myPc=null;try{myPc=window._pc||pc;}catch(e){}
  if(myPc)try{myPc.close();}catch(e){}
  try{pc=null;}catch(e){}window._pc=null;
  var mySt=null;try{mySt=stream||localStream;}catch(e){}
  if(mySt)try{mySt.getTracks().forEach(function(t){t.stop();});}catch(e){}
  try{stream=null;localStream=null;}catch(e){}
  try{clearInterval(callInt);callSecs=0;callInt=null;}catch(e){}try{clearInterval(callTimer);callSeconds=0;}catch(e){}
  var co=document.getElementById('co');if(co){co.classList.remove('on');co.style.display='none';}
  var va=document.getElementById('va');if(va)va.classList.remove('on');
  var rv=document.getElementById('remoteVideo');if(rv){rv.srcObject=null;rv.style.display='none';}
  var ra=document.getElementById('remoteAudio');if(ra)ra.srcObject=null;
  var ctmr=document.getElementById('ctmr');if(ctmr)ctmr.style.display='none';
};

window.startCall=async function(type){
  var t=null;try{t=cur||currentChat;}catch(e){}if(!t)return;
  try{callUser=t;callKind=type;}catch(e){}try{currentCallUser=t;callType=type;}catch(e){}
  var uList=[];try{uList=users||allUsers||[];}catch(e){}
  var u=uList.find(function(x){return x.username===t;})||{username:t,displayName:t};
  if(typeof showCallUI==='function')showCallUI(u,type,'out');
  try{
    var ns=await navigator.mediaDevices.getUserMedia(type==='video'?{audio:true,video:true}:{audio:true});
    try{stream=ns;}catch(e){}
    if(type==='video'){var lv=document.getElementById('localVideo');if(lv)lv.srcObject=ns;var va=document.getElementById('va');if(va)va.classList.add('on');}
    var np=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
    try{pc=np;}catch(e){}window._pc=np;try{peerConnection=np;}catch(e){}
    ns.getTracks().forEach(function(tk){np.addTrack(tk,ns);});
    np.ontrack=function(e){var rv=document.getElementById('remoteVideo');if(rv){rv.style.display='block';rv.srcObject=e.streams[0];if(type==='video'){var va2=document.getElementById('va');if(va2)va2.classList.add('on');}}
      var ra=document.getElementById('remoteAudio');if(!ra){ra=document.createElement('audio');ra.id='remoteAudio';ra.autoplay=true;ra.style.display='none';document.body.appendChild(ra);}ra.srcObject=e.streams[0];};
    np.onicecandidate=function(e){if(e.candidate)socket.emit('ice_candidate',{to:t,candidate:e.candidate});};
    var offer=await np.createOffer();await np.setLocalDescription(offer);
    socket.emit('call_user',{to:t,offer:offer,callType:type});
  }catch(err){alert('Нет доступа к микрофону/камере: '+(err.message||err));window._doCleanCall();}
};

window.openProfile=function(){var t=null;try{t=cur||currentChat;}catch(e){}if(t&&typeof showPM==='function')showPM(t);};
window.showMyProfile=function(){if(typeof showPM==='function'&&typeof me!=='undefined'&&me)showPM(me.username);};

window.openChangePwd=function(){
  var m=document.getElementById('pwd-modal');if(m)m.classList.add('on');
  ['pwd-old','pwd-new','pwd-new2'].forEach(function(id){var el=document.getElementById(id);if(el)el.value='';});
  ['pwd-err','pwd-ok'].forEach(function(id){var el=document.getElementById(id);if(el)el.textContent='';});
};
window.closePwdModal=function(){var m=document.getElementById('pwd-modal');if(m)m.classList.remove('on');};
window.submitPwd=function(){
  var o=document.getElementById('pwd-old'),n=document.getElementById('pwd-new'),n2=document.getElementById('pwd-new2');
  var err=document.getElementById('pwd-err'),ok=document.getElementById('pwd-ok');
  if(!o||!n||!n2)return;
  var op=o.value,np=n.value,np2=n2.value;
  var se=function(m){if(err)err.textContent=m;},so=function(m){if(ok)ok.textContent=m;};
  if(!op||!np||!np2)return se('Заполните все поля');
  if(np!==np2)return se('Новые пароли не совпадают');
  if(np.length<6)return se('Минимум 6 символов');
  se('');
  // Проверяем что сокет подключён и авторизован
  if(!window.socket||!window.socket.connected){return se('Нет соединения с сервером. Перезайдите в аккаунт.');}
  if(!window.me){return se('Сессия истекла. Перезайдите в аккаунт.');}
  socket.emit('change_password',{oldPassword:op,newPassword:np},function(r){
    if(!r)return se('Ошибка соединения — попробуйте ещё раз');
    if(r.error)return se(r.error);
    so('Пароль успешно изменён!');
    try{var s=JSON.parse(localStorage.getItem('userSession')||'{}');s.password=np;localStorage.setItem('userSession',JSON.stringify(s));}catch(e){}
    setTimeout(window.closePwdModal,1500);
  });
};

window.saveProf=function(){
  var nEl=document.getElementById('en'),bEl=document.getElementById('eb');
  var n=nEl?nEl.value.trim():'',b=bEl?bEl.value.trim():'';
  if(!n)return alert('Имя не может быть пустым');
  socket.emit('update_profile',{displayName:n,bio:b},function(r){
    if(r&&r.ok){me=r.user||Object.assign({},me,{displayName:n,bio:b});if(typeof updMe==='function')updMe();var sef=document.getElementById('sef');if(sef)sef.classList.remove('on');}
    else alert((r&&r.error)||'Ошибка сохранения');
  });
};

window.switchTab=function(tab,btn){
  document.querySelectorAll('.sb-tab').forEach(function(t){t.classList.remove('active');});
  if(btn&&btn.classList)btn.classList.add('active');
  if(typeof renderList==='function')renderList(tab);
  if(typeof renderChatList==='function')renderChatList(tab);
};

window.doLogout=function(){
  socket.emit('logout');
  // Reset patched flag so interceptSocket re-attaches on next login
  try{if(socket)socket.__patched=false;}catch(e){}
  // Clear all call state
  try{window._doCleanCall();}catch(e){}
  try{me=null;cur=null;currentChat=null;activeChat=null;users=[];allUsers=[];hist={};chatHistory={};unread={};prev={};chatPreviews={};}catch(e){}
  localStorage.removeItem('userSession');
  var ap=document.getElementById('app'),ae=document.getElementById('auth-screen'),cv=document.getElementById('chat-view'),nc=document.getElementById('no-chat');
  if(ap)ap.classList.remove('on');if(ae)ae.style.display='flex';if(cv)cv.style.display='none';if(nc)nc.style.display='flex';
  window.closeSett();
};

// ── Лайтбокс для изображений ──
window.showLightbox=function(src){
  var lb=document.getElementById('lb'),lbi=document.getElementById('lbi');
  if(lb&&lbi){lbi.src=src;lb.classList.add('on');}
};

document.addEventListener('DOMContentLoaded',function(){
  var eb=document.getElementById('eb');if(eb){eb.removeAttribute('maxlength');eb.maxLength=9999;}
  // Запускаем перехват сразу после логина
  interceptSocket();
});

})();


/* ══════════════════════════════════════════════════════
   OVERRIDE BLOCK – Call messages, video notes, mobile fixes
══════════════════════════════════════════════════════ */
(function(){

/* 1. Persistent call event storage – survives openChat reload */
if(!window._callStore) window._callStore = {};  // {username: [callEventObj,...]}

/* 2. Override _injectCallMsg – store separately, clean preview */
window._injectCallMsg = function(username, type, isIncoming){
  var isMissed = (type === 'missed');
  var label = isMissed ? 'Пропущенный звонок' : 'Звонок завершён';
  var secs = 0;
  try{ secs = window.callSecs || window.callSeconds || 0; }catch(e){}
  var sub = isMissed
    ? (isIncoming ? 'от ' + username : 'Вы не ответили')
    : (secs ? (Math.floor(secs/60)+'м '+(secs%60)+'с') : '');
  var id = 'ce-' + Date.now() + '-' + Math.random().toString(36).slice(2);
  var fromUser = isIncoming ? username : (window.me ? window.me.username : '');
  var toUser   = isIncoming ? (window.me ? window.me.username : '') : username;

  var ev = { id, username, type, isIncoming, isMissed, label, sub,
             fromUser, toUser, timestamp: new Date().toISOString() };

  // Persist
  if(!window._callStore[username]) window._callStore[username] = [];
  window._callStore[username].push(ev);

  // Build fake msg with clean text content (no HTML) for sidebar preview
  var fakeMsg = { id, from: fromUser, to: toUser,
    content: (isMissed ? '📵 ' : '📞 ') + label,
    _ce: ev, type: 'call-event',
    timestamp: ev.timestamp, read: true };

  // Add to hist
  try{
    if(!window.hist) window.hist = {};
    if(!window.hist[username]) window.hist[username] = [];
    if(!window.hist[username].find(function(m){ return m.id === id; })){
      window.hist[username].push(fakeMsg);
    }
  }catch(e){}

  // Render in open chat
  try{
    var cu = window.cur || window.currentChat;
    if(cu === username){
      var area = document.getElementById('msgs');
      if(area){
        var row = _buildCERow(fakeMsg);
        if(row){ area.appendChild(row); area.scrollTop = area.scrollHeight; }
      }
    }
  }catch(e){}

  // Update sidebar preview
  try{ window.prev[username] = fakeMsg; }catch(e){}
  try{ if(typeof renderList==='function') renderList(); }catch(e){}
};

/* 3. Build call-event DOM row */
function _buildCERow(m){
  var ev = m._ce || {};
  var isMissed = ev.isMissed || (m.content && m.content.indexOf('📵') !== -1);
  var label = ev.label || (isMissed ? 'Пропущенный звонок' : 'Звонок завершён');
  var sub   = ev.sub || '';
  var out   = m.from === (window.me ? window.me.username : '');

  var row = document.createElement('div');
  row.className = 'mrow ' + (out ? 'out' : 'in');
  row.id = 'mw-' + m.id;
  row.style.opacity = '0.85';

  // No avatar for call events – just a centered pill
  var wrap = document.createElement('div');
  wrap.className = 'call-ev-bbl';

  var ico = document.createElement('div');
  ico.className = 'call-ev-ico ' + (isMissed ? 'missed' : 'ended');
  ico.innerHTML = isMissed
    ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 011.72 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.42 19.42 0 013.07 9.12 19.79 19.79 0 01.22.5 2 2 0 012.18 0h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.39 7.09a16 16 0 006.29 6.22z"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
    : '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1-9.4 0-17-7.6-17-17 0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z"/></svg>';

  var txt = document.createElement('div');
  var lbl = document.createElement('div');
  lbl.className = 'call-ev-label';
  lbl.textContent = label;
  var sbl = document.createElement('div');
  sbl.className = 'call-ev-sub';
  sbl.textContent = sub;
  txt.appendChild(lbl);
  if(sub) txt.appendChild(sbl);

  wrap.appendChild(ico);
  wrap.appendChild(txt);

  // Timestamp
  var meta = document.createElement('div');
  meta.className = 'bbl-meta';
  meta.style.cssText = 'margin-top:4px;padding:0';
  var ts = new Date(m.timestamp);
  meta.textContent = ts.getHours().toString().padStart(2,'0')+':'+ts.getMinutes().toString().padStart(2,'0');

  var bub = document.createElement('div');
  bub.className = 'bubble';
  bub.style.cssText = 'background:transparent;border:none;padding:0;';
  bub.appendChild(wrap);
  bub.appendChild(meta);

  row.appendChild(bub);
  return row;
}

/* 3.5. Fix ctxReply – last definition wins; it called startReply() → $('reply-bar')
        but the active UI uses #rs / #rs-nm / #rs-tx / #mi / replyMsg */
window.ctxReply = function(){
  var msg = window.ctxMsg;
  if(!msg) return;
  // Version 1 path (main active UI)
  var rs = document.getElementById('rs');
  if(rs){
    window.replyMsg = msg;
    try{window.replyTo = msg.id;}catch(e){}
    var rnEl = document.getElementById('rs-nm');
    var rtEl = document.getElementById('rs-tx');
    if(rnEl){
      var n = (window.me && msg.from === window.me.username) ? 'Вы'
            : ((window.users||[]).find(function(u){return u.username===msg.from;})||{}).displayName || msg.from;
      rnEl.textContent = n;
    }
    if(rtEl){
      rtEl.textContent = msg.type==='image' ? 'Фото'
                       : msg.type==='voice' ? 'Голосовое'
                       : msg.type==='video-note' ? 'Видео-кружок'
                       : (msg.content||'').slice(0,80);
    }
    rs.classList.add('on');
    var inp = document.getElementById('mi') || document.getElementById('msg-input');
    if(inp) inp.focus();
  }
  // Also hide any context menu that was open
  ['ctx','ctx-menu'].forEach(function(id){
    var el = document.getElementById(id);
    if(el){ el.classList.remove('on'); el.classList.remove('show'); }
  });
};

/* 4. Patch bbl() to handle call-event and video-note types, and fix reply preview for video-note */
if(typeof bbl === 'function'){
  var _bblOrig = bbl;
  window.bbl = bbl = function(m){
    if(m.type === 'call-event'){
      var row = _buildCERow(m);
      return row ? row.outerHTML : '';
    }
    if(m.type === 'video-note'){
      return _buildVNBbl(m);
    }
    // Patch: fix reply preview for video-note (shows raw data URL otherwise)
    if(m.replyTo){
      var hist2 = window.hist || {};
      var cur2 = window.cur || window.currentChat;
      var msgs2 = hist2[cur2] || [];
      var orig = msgs2.find(function(x){ return x.id === m.replyTo; });
      if(orig && orig.type === 'video-note'){
        // temporarily patch orig.type so _bblOrig renders "🎥 Видео-кружок" in reply
        var savedType = orig.type, savedContent = orig.content;
        orig.type = 'text';
        orig.content = '🎥 Видео-кружок';
        var result = _bblOrig(m);
        orig.type = savedType;
        orig.content = savedContent;
        return result;
      }
    }
    return _bblOrig(m);
  };
}

/* 5. Patch ci() to show clean preview text (no HTML tags) */
if(typeof ci === 'function'){
  var _ciOrig = ci;
  window.ci = ci = function(u){
    var p = window.prev ? window.prev[u.username] : null;
    if(p && p.type === 'call-event'){
      var ev = p._ce || {};
      var isMissed = ev.isMissed !== undefined ? ev.isMissed : (p.content && p.content.indexOf('📵') !== -1);
      // Strip any HTML tags if present
      var rawContent = (p.content || '').replace(/<[^>]*>/g, '').trim();
      var cleanTxt = isMissed ? '📵 Пропущенный звонок' : '📞 Звонок завершён';
      if(rawContent && rawContent.length < 60 && !rawContent.includes('{')) cleanTxt = rawContent;
      var saved = p.content; p.content = cleanTxt; var savedType = p.type; p.type = 'text';
      var result = _ciOrig(u);
      p.content = saved; p.type = savedType;
      return result;
    }
    if(p && p.type === 'video-note'){
      var saved2 = p.content; p.content = '🎥 Видео-кружок'; var savedType2 = p.type; p.type = 'text';
      var result2 = _ciOrig(u);
      p.content = saved2; p.type = savedType2;
      return result2;
    }
    // For any other message type, strip HTML from content before showing in preview
    if(p && p.content && p.content.includes('<div')){
      var saved3 = p.content; p.content = p.content.replace(/<[^>]*>/g,'').trim().slice(0,60);
      var result3 = _ciOrig(u);
      p.content = saved3;
      return result3;
    }
    return _ciOrig(u);
  };
}

/* 6. Patch renderMsgs to always inject call events from _callStore before rendering —
      no race condition unlike the old openChat+setTimeout(450ms) approach */
if(typeof renderMsgs === 'function'){
  var _renderMsgsOrig = renderMsgs;
  window.renderMsgs = renderMsgs = function(){
    try{
      var cu = window.cur || window.currentChat;
      if(cu && window._callStore && window._callStore[cu] && window._callStore[cu].length){
        var stored = window._callStore[cu];
        var h = (window.hist || {})[cu];
        if(h){
          stored.forEach(function(ev){
            if(!h.find(function(m){ return m.id === ev.id; })){
              h.push({
                id: ev.id, from: ev.fromUser, to: ev.toUser,
                content: (ev.isMissed ? '📵 ' : '📞 ') + ev.label,
                _ce: ev, type: 'call-event',
                timestamp: ev.timestamp, read: true
              });
            }
          });
          h.sort(function(a,b){ return new Date(a.timestamp)-new Date(b.timestamp); });
        }
      }
    }catch(e){}
    return _renderMsgsOrig();
  };
}

/* 7. Video note bubble builder */
// Cache for video-note data URLs (avoids embedding MB of base64 in HTML attributes)
window._vnCache = window._vnCache || {};
// Cache for converted Blob URLs (reused across renderMsgs calls)
window._vnBlobCache = window._vnBlobCache || {};

function _buildVNBbl(m){
  var out = m.from === (window.me ? window.me.username : '');
  var dur = m.duration || '';
  var src = m.content || '';
  var avEl = '';
  if(!out){
    var uList = window.users || window.allUsers || [];
    var u2 = uList.find(function(x){ return x.username === m.from; }) || { username: m.from, displayName: m.from };
    var ini2 = (typeof ini === 'function') ? ini(u2.displayName || u2.username) : (u2.displayName || u2.username).charAt(0);
    var avInner = u2.avatar ? '<img src="'+u2.avatar+'">' : '<span>'+ini2+'</span>';
    var bg = typeof col === 'function' ? col(m.from) : '#4f8ef7';
    avEl = '<div class="msg-av" style="background:'+bg+'">'+avInner+'</div>';
  }
  var ts = new Date(m.timestamp);
  var timeStr = ts.getHours().toString().padStart(2,'0')+':'+ts.getMinutes().toString().padStart(2,'0');
  var DCHK = typeof DBLCHK !== 'undefined' ? DBLCHK : '✓✓';
  var SCK = typeof CHK !== 'undefined' ? CHK : '✓';
  var checks = out ? '<span class="chk" style="color:rgba(255,255,255,0.9)">'+(m.read ? DCHK : SCK)+'</span>' : '';
  var timeBadge = '<div style="position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.55);border-radius:10px;padding:2px 6px;display:flex;align-items:center;gap:3px;font-size:10px;color:#fff;font-weight:500;pointer-events:none">'+timeStr+checks+'</div>';
  // Store video data in JS cache (NOT in HTML attribute) to avoid DOM size limits and innerHTML slowdowns
  if(src) window._vnCache[m.id] = src;
  return '<div class="mrow '+(out?'out':'in')+'" id="mw-'+m.id+'" style="max-width:220px">'+avEl+
    '<div class="vnbbl" onclick="_vnPlay(this,\''+m.id+'\')" style="width:180px;height:180px;flex-shrink:0">'+
    '<video id="vnv-'+m.id+'" playsinline style="width:180px;height:180px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);display:block;background:#000"></video>'+
    '<div class="vnbbl-play"><svg width="32" height="32" viewBox="0 0 24 24" fill="white"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>'+
    (dur ? '<div class="vnbbl-dur">'+dur+'</div>' : '')+
    timeBadge+
    '</div></div>';
}

window._vnPlay = function(wrap, id){
  var vid = document.getElementById('vnv-'+id);
  if(!vid) return;
  var pl = wrap.querySelector('.vnbbl-play');

  // If already playing — pause and reset
  if(!vid.paused){
    vid.pause();
    vid.currentTime = 0;
    if(pl){ pl.style.display='flex'; pl.style.opacity='1'; }
    return;
  }

  function doPlay(){
    vid.onended = function(){ if(pl){ pl.style.display='flex'; pl.style.opacity='1'; } };
    var p = vid.play();
    if(p !== undefined){
      p.then(function(){ if(pl) pl.style.display='none'; })
       .catch(function(err){
         console.warn('_vnPlay play() error:', err);
         if(pl){ pl.style.display='flex'; pl.style.opacity='1'; }
       });
    } else {
      if(pl) pl.style.display='none';
    }
  }

  function loadAndPlay(){
    if(pl){ pl.style.opacity='0.4'; }
    var fired = false;
    function onReady(){
      if(fired) return; fired = true;
      vid.removeEventListener('canplay',   onReady);
      vid.removeEventListener('canplaythrough', onReady);
      if(pl) pl.style.opacity='1';
      doPlay();
    }
    function onErr(){
      if(fired) return; fired = true;
      vid.removeEventListener('canplay',   onReady);
      vid.removeEventListener('canplaythrough', onReady);
      vid.removeEventListener('error', onErr);
      if(pl){ pl.style.display='flex'; pl.style.opacity='1'; }
      console.warn('_vnPlay: video error for id='+id);
    }
    vid.addEventListener('canplay', onReady);
    vid.addEventListener('canplaythrough', onReady);
    vid.addEventListener('error', onErr);
    vid.load();
  }

  // ── Step 1: Already has a converted Blob URL in cache ──
  if(window._vnBlobCache && window._vnBlobCache[id]){
    if(vid.src !== window._vnBlobCache[id]) vid.src = window._vnBlobCache[id];
    if(vid.readyState >= 3){ doPlay(); } else { loadAndPlay(); }
    return;
  }

  // ── Step 2: Get data URL — first try JS cache (preferred), then data-src attribute (legacy) ──
  var dataSrc = (window._vnCache && window._vnCache[id]) || vid.getAttribute('data-src') || '';

  // Handle case where src was set directly as a data: URL
  if(!dataSrc && vid.src && vid.src.startsWith('data:')){
    dataSrc = vid.src;
  }

  if(!dataSrc){
    console.warn('_vnPlay: no video data found for id=', id);
    return;
  }

  // ── Step 3: Convert data URL → Blob URL (works on all browsers including mobile) ──
  if(pl){ pl.style.opacity='0.3'; }
  try{
    var comma = dataSrc.indexOf(',');
    if(comma === -1){ throw new Error('invalid data URL'); }
    var meta  = dataSrc.substring(0, comma);
    var b64   = dataSrc.substring(comma + 1);
    var mime  = (meta.match(/:(.*?);/) || [])[1] || 'video/webm';
    var bin   = atob(b64);
    var bytes = new Uint8Array(bin.length);
    for(var i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
    var blob    = new Blob([bytes], { type: mime });
    var blobUrl = URL.createObjectURL(blob);
    // Store in blob cache so re-renders can reuse it
    if(!window._vnBlobCache) window._vnBlobCache = {};
    window._vnBlobCache[id] = blobUrl;
    vid.src = blobUrl;
  }catch(e){
    console.warn('_vnPlay: blob conversion failed, falling back to data URL', e);
    vid.src = dataSrc;
  }

  loadAndPlay();
};

/* 8. Video note recording */
var _vns = null, _vnRec = null, _vnChunks = [], _vnSecs = 0, _vnTimer = null, _vnBlob = null;
var VN_MAX = 60;

window.openVideoNote = function(){
  var ov = document.getElementById('vnote-overlay');
  if(!ov) return;
  _vnReset();
  ov.style.display = 'flex';
  navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:300, height:300 }, audio:true })
    .then(function(s){
      _vns = s;
      var pv = document.getElementById('vn-preview');
      if(pv) pv.srcObject = s;
    })
    .catch(function(e){ alert('Нет доступа к камере: '+(e.message||e)); vnClose(); });
};

window.vnClose = window.vnCancel = function(){
  _vnStopAll();
  var ov = document.getElementById('vnote-overlay');
  if(ov) ov.style.display = 'none';
  _vnReset();
};

window.vnStart = function(){
  if(!_vns) return;
  _vnChunks = []; _vnBlob = null; _vnSecs = 0;
  var mime = ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm','video/mp4']
    .find(function(t){ try{ return MediaRecorder.isTypeSupported(t); }catch(e){ return false; } }) || '';
  try{ _vnRec = new MediaRecorder(_vns, mime ? {mimeType:mime} : {}); }
  catch(e){ _vnRec = new MediaRecorder(_vns); }
  _vnRec.ondataavailable = function(e){ if(e.data&&e.data.size>0) _vnChunks.push(e.data); };
  _vnRec.onstop = function(){
    _vnBlob = new Blob(_vnChunks, { type: _vnRec.mimeType || 'video/webm' });
    document.getElementById('vn-send-btn').style.display = 'flex';
    document.getElementById('vn-hint').textContent = 'Отправить или отменить';
  };
  _vnRec.start(100);
  // UI
  var rb = document.getElementById('vn-rec-btn'); if(rb) rb.style.display='none';
  var sb = document.getElementById('vn-stop-btn'); if(sb) sb.style.display='flex';
  var cb = document.getElementById('vn-cancel-btn'); if(cb) cb.style.display='flex';
  var dot = document.getElementById('vn-dot'); if(dot) dot.style.display='block';
  var ht = document.getElementById('vn-hint'); if(ht) ht.textContent='Идёт запись...';
  var ring = document.getElementById('vn-ring');
  _vnTimer = setInterval(function(){
    _vnSecs++;
    var td = document.getElementById('vn-time');
    if(td) td.textContent = Math.floor(_vnSecs/60)+':'+String(_vnSecs%60).padStart(2,'0');
    if(ring){ var pct = _vnSecs/VN_MAX; ring.style.strokeDashoffset = (339.3*(1-pct)).toFixed(1); }
    if(_vnSecs >= VN_MAX) vnStop();
  }, 1000);
};

window.vnStop = function(){
  clearInterval(_vnTimer);
  if(_vnRec && _vnRec.state !== 'inactive'){ try{ _vnRec.stop(); }catch(e){} }
  var sb = document.getElementById('vn-stop-btn'); if(sb) sb.style.display='none';
  var dot = document.getElementById('vn-dot'); if(dot) dot.style.display='none';
};

window.vnSend = function(){
  if(!_vnBlob) return;
  var dur = Math.floor(_vnSecs/60)+':'+String(_vnSecs%60).padStart(2,'0');
  var cu = window.cur || window.currentChat;
  if(!cu){ vnClose(); return; }
  var reader = new FileReader();
  reader.onload = function(e){
    socket.emit('send_message',{ to:cu, content:e.target.result, type:'video-note', duration:dur },
      function(r){ if(r&&r.message){ try{ if(typeof pushMsg==='function') pushMsg(r.message); }catch(ex){} } });
    vnClose();
  };
  reader.readAsDataURL(_vnBlob);
};

function _vnStopAll(){
  clearInterval(_vnTimer);
  if(_vnRec && _vnRec.state !== 'inactive'){ try{ _vnRec.stop(); }catch(e){} }
  if(_vns){ _vns.getTracks().forEach(function(t){ t.stop(); }); _vns = null; }
}
function _vnReset(){
  _vnChunks=[]; _vnBlob=null; _vnSecs=0; _vnRec=null; _vnTimer=null;
  var pv=document.getElementById('vn-preview'); if(pv) pv.srcObject=null;
  var td=document.getElementById('vn-time'); if(td) td.textContent='0:00';
  var ring=document.getElementById('vn-ring'); if(ring) ring.style.strokeDashoffset='339.3';
  var dot=document.getElementById('vn-dot'); if(dot) dot.style.display='none';
  var ht=document.getElementById('vn-hint'); if(ht) ht.textContent='Нажмите ● чтобы начать запись';
  ['vn-rec-btn'].forEach(function(id){ var el=document.getElementById(id); if(el) el.style.display='flex'; });
  ['vn-stop-btn','vn-send-btn','vn-cancel-btn'].forEach(function(id){ var el=document.getElementById(id); if(el) el.style.display='none'; });
}

/* ════════════════════════════════════════
   NEW FEATURES — THEMES, WALLPAPER, MINIMIZE, VIDEO FIX
═══════════════════════════════════════════ */

// ── 4 THEMES ──
var THEMES = {
  dark:     {'--bg':'#0d0f14','--sidebar':'#13151c','--surface':'#1a1d27','--surface2':'#20232f','--border':'#2a2d3a','--accent':'#4f8ef7','--accent-dim':'rgba(79,142,247,0.15)','--bubble-out':'#1c3a6e','--bubble-in':'#1a1d27'},
  light:    {'--bg':'#f0f2f8','--sidebar':'#ffffff','--surface':'#f4f6fb','--surface2':'#e8ecf5','--border':'#dde1ed','--accent':'#4f8ef7','--accent-dim':'rgba(79,142,247,0.12)','--bubble-out':'#dbeafe','--bubble-in':'#ffffff'},
  midnight: {'--bg':'#090b12','--sidebar':'#0e1020','--surface':'#131628','--surface2':'#181b30','--border':'#232640','--accent':'#7c4dff','--accent-dim':'rgba(124,77,255,0.18)','--bubble-out':'#231458','--bubble-in':'#131628'},
  forest:   {'--bg':'#0c120e','--sidebar':'#121a14','--surface':'#172019','--surface2':'#1c2a1e','--border':'#243028','--accent':'#34d058','--accent-dim':'rgba(52,208,88,0.15)','--bubble-out':'#1a3d22','--bubble-in':'#172019'}
};
var THEME_NAMES = {dark:'Тёмная',light:'Светлая',midnight:'Полночь',forest:'Лес'};

window.applyTheme = function(name){
  var vars = THEMES[name]||THEMES.dark;
  var root = document.documentElement;
  // Set data-theme for CSS rules
  root.setAttribute('data-theme', name==='light'?'light':(name==='midnight'?'midnight':name==='forest'?'forest':'dark'));
  // Apply CSS vars inline for override
  Object.keys(vars).forEach(function(k){ root.style.setProperty(k, vars[k]); });
  // Update UI elements
  var sub=document.getElementById('theme-sub'); if(sub) sub.textContent=THEME_NAMES[name]||name;
  ['dark','light','midnight','forest'].forEach(function(t){
    var c=document.getElementById('tc-'+t); if(c) c.classList.toggle('active',t===name);
  });
  var ico=document.getElementById('theme-ico');
  if(ico) ico.innerHTML = name==='light'
    ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>'
    : '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
  localStorage.setItem('theme', name);
  // Close panel
  var p=document.getElementById('theme-panel'); if(p) p.classList.remove('on');
};

window.toggleThemePanel = function(){
  var p=document.getElementById('theme-panel'); if(p) p.classList.toggle('on');
};

// Override old toggleTheme
window.toggleTheme = function(){
  var cur2=localStorage.getItem('theme')||'dark';
  window.applyTheme(cur2==='dark'?'light':'dark');
};

// Init on load
(function(){
  var saved=localStorage.getItem('theme')||'dark';
  setTimeout(function(){ window.applyTheme(saved); }, 100);
})();

// ── WALLPAPER ──
var WALLS = [
  {id:'w1',label:'Звёзды',css:'linear-gradient(160deg,#0a0a2e,#1a1a5e)'},
  {id:'w2',label:'Волны',css:'linear-gradient(135deg,#0f0c29,#302b63,#24243e)'},
  {id:'w3',label:'Закат',css:'linear-gradient(135deg,#f093fb,#f5576c,#fda085)'},
  {id:'w4',label:'Океан',css:'linear-gradient(180deg,#0052d4,#065a82,#1cb5e0)'},
  {id:'w5',label:'Лес',css:'linear-gradient(160deg,#0a3d1f,#1a5c32,#2d7a4f)'},
  {id:'w6',label:'Пурпур',css:'linear-gradient(135deg,#2d1b69,#7c4dff,#e040fb)'},
  {id:'w7',label:'Рассвет',css:'linear-gradient(180deg,#1a1a2e,#16213e,#0f3460,#e94560)'},
  {id:'w8',label:'Золото',css:'linear-gradient(135deg,#373213,#b8860b,#ffd700)'},
  {id:'w9',label:'Бирюза',css:'linear-gradient(135deg,#004d4d,#009999,#00e5e5)'},
  {id:'w10',label:'Гранит',css:'linear-gradient(135deg,#1a1a1a,#2d2d2d,#3d3d3d)'},
  {id:'w11',label:'Пузыри',css:'radial-gradient(circle at 20% 20%,rgba(79,142,247,.2),transparent 40%),radial-gradient(circle at 80% 80%,rgba(52,208,88,.15),transparent 40%),linear-gradient(180deg,#0d0f14,#13151c)'},
  {id:'w12',label:'Клетка',css:'repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(255,255,255,.04) 39px,rgba(255,255,255,.04) 40px),repeating-linear-gradient(90deg,transparent,transparent 39px,rgba(255,255,255,.04) 39px,rgba(255,255,255,.04) 40px),linear-gradient(135deg,#0d1117,#161b22)'}
];

window.openWallModal = function(){
  _initWallGrid();
  var m=document.getElementById('wall-modal'); if(m){ m.style.display='flex'; }
};
window.closeWallModal = function(){
  var m=document.getElementById('wall-modal'); if(m) m.style.display='none';
};
window._initWallGrid = function(){
  var grid=document.getElementById('wall-grid'); if(!grid) return;
  var saved=localStorage.getItem('chatWallpaper')||'none';
  grid.innerHTML='';
  // None option
  var none=document.createElement('div');
  none.className='wall-item wall-item-none'+(saved==='none'?' active':'');
  none.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg><span>Нет</span>';
  none.onclick=function(){ window.setWallpaper(null); };
  grid.appendChild(none);
  WALLS.forEach(function(w){
    var d=document.createElement('div');
    d.className='wall-item'+(w.id===saved?' active':'');
    d.style.background=w.css; d.title=w.label;
    d.onclick=function(){ window.setWallpaper(w.id,w.css); };
    grid.appendChild(d);
  });
};
window.setWallpaper = function(id, css){
  var msgs=document.getElementById('msgs'); if(!msgs){ window.closeWallModal(); return; }
  if(!id){
    msgs.style.backgroundImage=''; msgs.classList.remove('has-wall');
    localStorage.removeItem('chatWallpaper'); localStorage.removeItem('chatWallpaperCSS');
    var sub=document.getElementById('wall-sub'); if(sub) sub.textContent='Без фона';
  } else {
    msgs.style.backgroundImage=css; msgs.classList.add('has-wall');
    localStorage.setItem('chatWallpaper',id); localStorage.setItem('chatWallpaperCSS',css);
    var w=WALLS.find(function(x){return x.id===id;}); var sub=document.getElementById('wall-sub');
    if(sub) sub.textContent=w?w.label:'Своя';
  }
  window.closeWallModal();
};
window.handleWallFile = function(e){
  var f=e.target.files[0]; if(!f) return;
  var r=new FileReader();
  r.onload=function(ev){
    var css='url("'+ev.target.result+'")';
    var msgs=document.getElementById('msgs');
    if(msgs){msgs.style.backgroundImage=css;msgs.style.backgroundSize='cover';msgs.classList.add('has-wall');}
    localStorage.setItem('chatWallpaper','custom');
    localStorage.setItem('chatWallpaperCSS',css);
    var sub=document.getElementById('wall-sub'); if(sub) sub.textContent='Своя картинка';
    window.closeWallModal();
  };
  r.readAsDataURL(f); e.target.value='';
};
// Apply saved wallpaper on load
(function(){
  function _applySavedWall(){
    var saved=localStorage.getItem('chatWallpaper');
    var css=localStorage.getItem('chatWallpaperCSS');
    if(!saved||saved==='none'||!css) return;
    var msgs=document.getElementById('msgs');
    if(msgs){msgs.style.backgroundImage=css;msgs.classList.add('has-wall');}
    var sub=document.getElementById('wall-sub');
    var w=WALLS.find(function(x){return x.id===saved;});
    if(sub) sub.textContent=w?w.label:(saved==='custom'?'Своя картинка':'Своя');
  }
  setTimeout(_applySavedWall, 300);
  // Re-apply when chat opens (msgs area may be recreated)
  var _origOpenChat2=window.openChat;
  if(typeof _origOpenChat2==='function'){
    window.openChat=function(u){ _origOpenChat2(u); setTimeout(_applySavedWall,50); };
  }
})();

// ── CALL MINIMIZE / RESTORE ──
window.minimizeCallOverlay = function(){
  var co=document.getElementById('co');
  var mini=document.getElementById('mini-call-bar');
  var sb=document.getElementById('sb-call-status');
  if(co){co.classList.remove('on');co.style.display='none';}
  // Copy avatar
  var cav=document.getElementById('cav'), miniAv=document.getElementById('mini-call-av');
  if(cav&&miniAv){miniAv.style.background=cav.style.background;miniAv.innerHTML=cav.innerHTML;}
  var cnm=document.getElementById('cnm'), miniNm=document.getElementById('mini-call-name');
  if(cnm&&miniNm) miniNm.textContent=cnm.textContent;
  // Sync timer
  var ctmr=document.getElementById('ctmr'), miniTmr=document.getElementById('mini-call-timer');
  if(ctmr&&miniTmr) miniTmr.textContent=ctmr.textContent||'0:00';
  if(mini) mini.style.display='flex';
  // Sidebar status
  var sbn=document.getElementById('sb-call-status-name');
  if(sbn&&cnm) sbn.textContent=cnm.textContent;
  if(sb) sb.style.display='flex';
  window._callMinimized=true;
  // Timer sync loop
  window._miniTimerSync=setInterval(function(){
    var ct=document.getElementById('ctmr'), mt=document.getElementById('mini-call-timer');
    if(ct&&mt) mt.textContent=ct.textContent||'0:00';
    if(!window._inCall){ clearInterval(window._miniTimerSync); }
  },1000);
};

window.restoreCallOverlay = function(){
  clearInterval(window._miniTimerSync);
  var co=document.getElementById('co');
  var mini=document.getElementById('mini-call-bar');
  var sb=document.getElementById('sb-call-status');
  if(mini) mini.style.display='none';
  if(sb) sb.style.display='none';
  if(co){co.style.display='';co.classList.add('on');}
  window._callMinimized=false;
};

// Patch _doCleanCall to hide mini bar
var _origDCC=window._doCleanCall;
window._doCleanCall=function(){
  _origDCC&&_origDCC();
  clearInterval(window._miniTimerSync);
  var mini=document.getElementById('mini-call-bar'); if(mini) mini.style.display='none';
  var sb=document.getElementById('sb-call-status'); if(sb) sb.style.display='none';
  window._callMinimized=false;
};

/* ══════════════════════════════════════════════════════════════
   IMPROVED MESSAGE UI — cleaner bubbles, better spacing, Telegram-style
═══════════════════════════════════════════════════════════════ */
(function(){
  var style = document.createElement('style');
  style.textContent = `
    /* ── Message rows ── */
    .msgs { padding: 12px 10px 10px; gap: 1px; }
    .mrow { max-width: 82%; margin-bottom: 2px; }
    .mrow.out { max-width: 78%; }
    .mrow.in  { max-width: 78%; }

    /* Group bubbles: reduce gap between messages from same sender */
    .mrow + .mrow.out,
    .mrow + .mrow.in  { margin-top: 1px; }

    /* ── Bubbles ── */
    .bubble {
      padding: 7px 10px 5px;
      border-radius: 18px;
      line-height: 1.5;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .out .bubble {
      border-bottom-right-radius: 5px;
      border-top-right-radius: 18px;
    }
    .in .bubble {
      border-bottom-left-radius: 5px;
      border-top-left-radius: 18px;
    }
    /* First message in group (preceded by different sender or date) */
    .mrow:first-child .bubble,
    .mrow.in:first-of-type .bubble { border-top-left-radius: 18px; }
    .mrow.out:first-of-type .bubble { border-top-right-radius: 18px; }

    /* ── Text ── */
    .bbl-text {
      font-size: 14.5px;
      line-height: 1.5;
      word-break: break-word;
      white-space: pre-wrap;
    }

    /* ── Timestamp + ticks ── */
    .bbl-meta {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 11px;
      color: var(--text3);
      float: right;
      margin: 2px -2px -3px 6px;
      position: relative;
    }
    .bbl-meta .chk { color: var(--accent); display:flex; margin-left:1px; }

    /* ── Reply strip ── */
    .bbl-reply {
      background: rgba(255,255,255,0.07);
      border-left: 3px solid var(--accent);
      border-radius: 6px 10px 10px 6px;
      padding: 4px 8px;
      margin-bottom: 5px;
      max-width: 100%;
      overflow: hidden;
    }
    [data-theme="light"] .bbl-reply { background: rgba(79,142,247,0.08); }
    .bbl-rname { font-size: 12px; font-weight: 600; color: var(--accent); margin-bottom: 1px; }
    .bbl-rtext { font-size: 12px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 220px; }

    /* ── Avatar (incoming only) ── */
    .msg-av {
      width: 28px; height: 28px; border-radius: 50%;
      margin-bottom: 2px; flex-shrink: 0;
    }

    /* ── Images ── */
    .bbl-img {
      display: block;
      border-radius: 12px;
      max-width: 260px;
      max-height: 300px;
      width: auto; height: auto;
      object-fit: contain;
      cursor: zoom-in;
    }
    .bubble:has(.bbl-img) {
      padding: 4px 4px 4px;
    }
    .bubble:has(.bbl-img) .bbl-meta { margin: 2px 2px -2px 4px; }

    /* ── Voice message ── */
    .voice-msg { min-width: 170px; max-width: 240px; gap: 8px; }
    .voice-waves span { background: var(--text2); opacity: 0.6; }

    /* ── Date divider ── */
    .date-div { margin: 14px 0 8px; font-size: 11.5px; font-weight: 500; }

    /* ── Video-note mrow fix: must stay small + aligned ── */
    .mrow:has(.vnbbl) {
      max-width: 200px !important;
      background: transparent !important;
    }
    .mrow.out:has(.vnbbl) { align-self: flex-end; justify-content: flex-end; }
    .mrow.in:has(.vnbbl)  { align-self: flex-start; }
    .vnbbl { border-radius: 50%; overflow: hidden; }

    /* ── Mobile tweaks ── */
    @media (max-width: 600px) {
      .msgs { padding: 10px 8px 8px; }
      .mrow, .mrow.out, .mrow.in { max-width: 86%; }
      .bbl-text { font-size: 14px; }
      .bbl-img { max-width: calc(100vw - 100px) !important; max-height: 260px !important; width: 100% !important; }
      .bubble:has(.bbl-img) { padding: 3px 3px 3px; }
      .voice-msg { min-width: 150px; }
    }
  `;
  document.head.appendChild(style);
})();
/* ══ END IMPROVED MESSAGE UI ══ */
// Helper: can viewer see a privacy-protected field of user u?
window._canSee = function(u, field){
  if(!u || !u.privacy) return true; // default: everyone sees
  var val = u.privacy[field];
  if(!val || val === 'everyone') return true;
  // 'nobody' → nobody except self sees it
  return false;
  // (could add 'contacts' logic here if needed)
};

// Patch updMe to also populate privacy select dropdowns
if(typeof updMe === 'function'){
  var _updMeOrig = updMe;
  window.updMe = updMe = function(){
    _updMeOrig();
    if(!window.me || !window.me.privacy) return;
    var p = window.me.privacy;
    var pls = document.getElementById('priv-ls'); if(pls) pls.value = p.lastSeen || 'everyone';
    var ppp = document.getElementById('priv-pp'); if(ppp) ppp.value = p.profilePhoto || 'everyone';
    var pon = document.getElementById('priv-on'); if(pon) pon.value = p.online || 'everyone';
  };
}

// Patch ci() to respect privacy when rendering sidebar list items
if(typeof ci === 'function'){
  var _ciOrig2 = ci;
  window.ci = ci = function(u){
    // Apply privacy: online dot, avatar
    var canSeeOnline = window._canSee(u, 'online');
    var canSeePhoto  = window._canSee(u, 'profilePhoto');
    // Temporarily mask u for the original ci() call
    var origOnline = u.online;
    var origAvatar = u.avatar;
    if(!canSeeOnline) u.online = false;
    if(!canSeePhoto)  u.avatar = null;
    var result = _ciOrig2(u);
    // Restore
    u.online = origOnline;
    u.avatar = origAvatar;
    return result;
  };
}

// Patch showPM to respect privacy when showing profile modal
if(typeof showPM === 'function'){
  var _showPMOrig = showPM;
  window.showPM = showPM = function(username){
    _showPMOrig(username);
    // After original rendered, apply privacy overrides
    try{
      if(!window.me || username === window.me.username) return; // own profile: always show
      var u = (window.users||[]).find(function(x){return x.username===username;});
      if(!u) return;

      // Online/status privacy
      if(!window._canSee(u, 'online')){
        var pmst = document.getElementById('pmst');
        if(pmst){ pmst.textContent = 'Не в сети'; pmst.className = 'pm-status off'; }
      }

      // Profile photo privacy
      if(!window._canSee(u, 'profilePhoto')){
        var pmav = document.getElementById('pmav');
        if(pmav){
          pmav.style.background = window.col ? window.col(username) : '#4f8ef7';
          pmav.innerHTML = '<span>' + (window.ini ? window.ini(u.displayName||username) : (u.displayName||username).charAt(0)) + '</span>';
        }
      }
    }catch(e){}
  };
}

// Patch setStatus to respect online privacy when updating chat header
if(typeof setStatus === 'function'){
  var _setStatusOrig = setStatus;
  window.setStatus = setStatus = function(username, isOnline, lastSeen){
    // Update the user object regardless (for internal state)
    var u = (window.users||[]).find(function(x){return x.username===username;});
    if(u){ u.online = isOnline; if(lastSeen) u.lastSeen = lastSeen; }

    // Only update chat header if this is the open chat
    var cu = window.cur || window.currentChat;
    if(cu === username){
      var chStatus = document.getElementById('ch-status');
      if(chStatus){
        var canSeeOnline = window._canSee(u, 'online');
        if(!canSeeOnline){
          chStatus.textContent = '';
          chStatus.className = 'ch-status';
        } else {
          chStatus.textContent = isOnline ? 'В сети' : 'Не в сети';
          chStatus.className = 'ch-status' + (isOnline ? ' on' : '');
        }
      }
    }
    if(typeof renderList === 'function') renderList();
  };
}

// Also patch openChat to apply privacy on header immediately
if(typeof openChat === 'function'){
  var _openChatPriv = openChat;
  window.openChat = openChat = function(username){
    _openChatPriv(username);
    try{
      var u = (window.users||[]).find(function(x){return x.username===username;});
      if(u){
        // Apply online privacy to header
        if(!window._canSee(u,'online')){
          var cs = document.getElementById('ch-status');
          if(cs){ cs.textContent=''; cs.className='ch-status'; }
        }
        // Apply photo privacy to header avatar
        if(!window._canSee(u,'profilePhoto')){
          var ha = document.getElementById('ch-av');
          if(ha){
            ha.style.background = window.col ? window.col(username) : '#4f8ef7';
            ha.innerHTML = '<span style="font-weight:700;font-size:14px;">' + (window.ini ? window.ini(u.displayName||username) : (u.displayName||username).charAt(0)) + '</span>';
          }
        }
      }
    }catch(e){}
  };
}
// ── END PRIVACY ENFORCEMENT ─────────────────────────────────────────
window.showCallUI=function(u,type,mode,offer){
  var co=document.getElementById('co'); if(co) co.style.display='';
  var PHICO='<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1-9.4 0-17-7.6-17-17 0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z"/></svg>';
  var MICO='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';
  var CICO='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>';
  var MINBTN='<div class="call-btn-wrap"><button class="cbtn neutral" onclick="minimizeCallOverlay()" title="Свернуть"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 9l-7 7-7-7"/></svg></button><span>Свернуть</span></div>';
  var cav=document.getElementById('cav');
  if(cav){var bg=typeof col==='function'?col(u.username):'#4f8ef7';cav.style.background=bg;if(typeof setAv==='function')setAv(cav,u,'22px');}
  var cnm=document.getElementById('cnm'); if(cnm) cnm.textContent=u.displayName||u.username;
  var tl=type==='video'?'Видеозвонок':'Аудиозвонок';
  var st='',btns='';
  if(mode==='out'){
    st=tl+' · Исходящий...';
    btns='<div class="call-btn-wrap"><button class="cbtn end-call" onclick="endCall()">'+PHICO+'</button><span>Завершить</span></div>'+MINBTN;
  }else if(mode==='in'){
    st='Входящий '+tl.toLowerCase();
    var cst=document.getElementById('cst'); if(cst) cst.textContent=st;
    var cbtns=document.getElementById('cbtns');
    if(cbtns) cbtns.innerHTML='<div class="call-btn-wrap"><button class="cbtn decline" onclick="rejectCall()">'+PHICO+'</button><span>Отклонить</span></div>'
      +'<div class="call-btn-wrap"><button id="acc-btn" class="cbtn accept">'+PHICO+'</button><span>Принять</span></div>';
    if(co) co.classList.add('on');
    var acc=document.getElementById('acc-btn');
    if(acc) acc.onclick=function(){if(typeof acceptCall==='function')acceptCall(offer);else if(typeof masterAccept==='function')masterAccept(offer,type,u.username,u);};
    return;
  }else{
    st=tl; var ctmr=document.getElementById('ctmr'); if(ctmr) ctmr.style.display='block';
    btns='<div class="call-btn-wrap"><button class="cbtn neutral" id="cbmute" onclick="tMute(this)">'+MICO+'</button><span>Микрофон</span></div>'
      +'<div class="call-btn-wrap"><button class="cbtn end-call" onclick="endCall()">'+PHICO+'</button><span>Завершить</span></div>'
      +(type==='video'?'<div class="call-btn-wrap"><button class="cbtn neutral" id="cbcam" onclick="tCam(this)">'+CICO+'</button><span>Камера</span></div>':'')
      +MINBTN;
  }
  var cst2=document.getElementById('cst'); if(cst2) cst2.textContent=st;
  var cbtns2=document.getElementById('cbtns'); if(cbtns2) cbtns2.innerHTML=btns;
  if(co) co.classList.add('on');
};

// ── IMPROVED VIDEO CALL ──
window.startCall=async function(type){
  var t=null;try{t=cur||currentChat;}catch(e){}if(!t)return;
  if(window._inCall){alert('Вы уже находитесь в звонке');return;}
  window._inCall=true;
  try{callUser=t;callKind=type;}catch(e){}try{currentCallUser=t;callType=type;}catch(e){}
  var uList=[];try{uList=users||allUsers||[];}catch(e){}
  var u=uList.find(function(x){return x.username===t;})||{username:t,displayName:t};
  var co=document.getElementById('co');if(co){co.style.display='';co.classList.add('on');}
  if(typeof window.showCallUI==='function')window.showCallUI(u,type,'out');
  try{
    var ns=await navigator.mediaDevices.getUserMedia(type==='video'?{audio:true,video:{width:{ideal:1280},height:{ideal:720},facingMode:'user'}}:{audio:true});
    try{stream=ns;}catch(e){}try{localStream=ns;}catch(e){}
    if(type==='video'){var lv=document.getElementById('localVideo');if(lv){lv.srcObject=ns;lv.style.display='block';}var va=document.getElementById('va');if(va)va.classList.add('on');}
    var np=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]});
    try{pc=np;}catch(e){}window._pc=np;try{peerConnection=np;}catch(e){}
    ns.getTracks().forEach(function(tk){np.addTrack(tk,ns);});
    np.ontrack=function(e){
      var rv=document.getElementById('remoteVideo');
      if(rv&&e.streams[0]){rv.srcObject=e.streams[0];rv.style.display='block';if(type==='video'){var va2=document.getElementById('va');if(va2)va2.classList.add('on');}}
      var ra=document.getElementById('remoteAudio');
      if(!ra){ra=document.createElement('audio');ra.id='remoteAudio';ra.autoplay=true;ra.style.display='none';document.body.appendChild(ra);}
      ra.srcObject=e.streams[0];
    };
    np.onicecandidate=function(e){if(e.candidate)socket.emit('ice_candidate',{to:t,candidate:e.candidate});};
    var offer=await np.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:type==='video'});
    await np.setLocalDescription(offer);
    socket.emit('call_user',{to:t,offer:offer,callType:type});
  }catch(err){alert('Нет доступа к микрофону/камере: '+(err.message||err));window._inCall=false;window._doCleanCall&&window._doCleanCall();}
};

// tMute with icon
window.tMute=function(btn){
  var s=null;try{s=stream||localStream;}catch(e){}if(!s)return;
  var tr=s.getAudioTracks()[0];if(!tr)return;
  tr.enabled=!tr.enabled;btn.classList.toggle('muted',!tr.enabled);
  btn.innerHTML=!tr.enabled
    ?'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>'
    :'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>';
};
window.tCam=function(btn){
  var s=null;try{s=stream||localStream;}catch(e){}if(!s)return;
  var tr=s.getVideoTracks()[0];if(!tr)return;
  tr.enabled=!tr.enabled;btn.classList.toggle('muted',!tr.enabled);
};


})();

/* ══════════════════════════════════════════════════════════════
   PREMIUM MESSENGER REDESIGN — полный редизайн
══════════════════════════════════════════════════════════════ */
(function(){

/* ─── GOOGLE FONTS ─── */
var fontLink = document.createElement('link');
fontLink.rel = 'stylesheet';
fontLink.href = 'https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap';
document.head.appendChild(fontLink);

var s = document.createElement('style');
s.textContent = `

/* ─── GLOBAL FONT OVERRIDE ─── */
*, body, html {
  font-family: 'Plus Jakarta Sans', 'Inter', sans-serif !important;
  -webkit-font-smoothing: antialiased !important;
  -moz-osx-font-smoothing: grayscale !important;
}

/* ─── ENHANCED THEME VARS ─── */
[data-theme="dark"] {
  --bg: #0b0d13 !important;
  --sidebar: #101318 !important;
  --surface: #161a22 !important;
  --surface2: #1c2130 !important;
  --border: #1f2535 !important;
  --border2: #2a3148 !important;
  --accent: #4f8ef7 !important;
  --accent-dim: rgba(79,142,247,0.14) !important;
  --accent-hover: #6aa0ff !important;
  --green: #3dd68c !important;
  --text: #e2e8f8 !important;
  --text2: #6b7498 !important;
  --text3: #3c4260 !important;
  --bubble-out: linear-gradient(135deg, #2563eb 0%, #1d4fd8 100%);
  --bubble-out-solid: #2055cc;
  --bubble-in: #1a1f2e;
  --bubble-in-border: rgba(255,255,255,0.04);
  --chat-bg: #0b0d13;
  --msg-time-out: rgba(255,255,255,0.5);
  --msg-time-in: rgba(140,150,185,0.7);
  --input-bg: #141824;
  --input-border: #222840;
  --shadow: 0 12px 40px rgba(0,0,0,0.55) !important;
}
[data-theme="light"] {
  --bg: #eef1f8 !important;
  --sidebar: #ffffff !important;
  --surface: #f3f5fb !important;
  --surface2: #e8ecf5 !important;
  --border: #e0e4f0 !important;
  --border2: #cdd3e5 !important;
  --bubble-out-solid: #2563eb;
  --bubble-in: #ffffff;
  --bubble-in-border: rgba(0,0,0,0.06);
  --chat-bg: #eef1f8;
  --msg-time-out: rgba(255,255,255,0.75);
  --msg-time-in: rgba(80,90,115,0.65);
  --input-bg: #ffffff;
  --input-border: #dde1ee;
  --shadow: 0 8px 32px rgba(0,0,0,0.10) !important;
}

/* ═══════════════════ AUTH SCREEN ═══════════════════ */
#auth-screen {
  background:
    radial-gradient(ellipse 80% 60% at 15% 80%, rgba(79,142,247,0.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 85% 20%, rgba(124,77,255,0.10) 0%, transparent 55%),
    var(--bg) !important;
}
.auth-card {
  border-radius: 28px !important;
  padding: 44px 40px !important;
  border: 1px solid var(--border) !important;
  box-shadow: 0 40px 100px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.04) !important;
  backdrop-filter: blur(20px) !important;
}
.auth-brand-icon {
  width: 54px !important;
  height: 54px !important;
  border-radius: 18px !important;
  background: linear-gradient(135deg, #4f8ef7, #7c4dff) !important;
  box-shadow: 0 6px 20px rgba(79,142,247,0.4) !important;
}
.auth-brand-text h1 {
  font-size: 26px !important;
  font-weight: 800 !important;
  letter-spacing: -0.7px !important;
  background: linear-gradient(135deg, var(--text) 0%, var(--accent) 120%);
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  background-clip: text !important;
}
.auth-seg {
  border-radius: 14px !important;
  padding: 4px !important;
  background: var(--surface) !important;
  border-color: var(--border) !important;
}
.auth-seg-btn {
  border-radius: 11px !important;
  font-weight: 600 !important;
  font-size: 13.5px !important;
  transition: all 0.2s !important;
}
.auth-seg-btn.active {
  background: var(--accent) !important;
  color: #fff !important;
  box-shadow: 0 3px 12px rgba(79,142,247,0.35) !important;
}
.field input {
  border-radius: 14px !important;
  padding: 12px 14px 12px 42px !important;
  font-size: 14px !important;
  font-weight: 500 !important;
  background: var(--surface) !important;
  border: 1.5px solid var(--border) !important;
  transition: all 0.2s !important;
}
.field input:focus {
  border-color: var(--accent) !important;
  background: var(--surface2) !important;
  box-shadow: 0 0 0 3px rgba(79,142,247,0.12) !important;
}
.auth-btn {
  border-radius: 14px !important;
  padding: 13px !important;
  font-size: 14.5px !important;
  font-weight: 700 !important;
  background: linear-gradient(135deg, #4f8ef7 0%, #7c4dff 100%) !important;
  box-shadow: 0 4px 18px rgba(79,142,247,0.4) !important;
  transition: all 0.2s !important;
  letter-spacing: 0.2px !important;
}
.auth-btn:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 28px rgba(79,142,247,0.5) !important;
}

/* ═══════════════════ SIDEBAR ═══════════════════ */
.sidebar {
  width: 310px !important;
  background: var(--sidebar) !important;
  border-right: 1px solid var(--border) !important;
}
.sb-head {
  padding: 16px 14px 14px !important;
  background: var(--sidebar) !important;
}
.me-av {
  width: 40px !important;
  height: 40px !important;
  border-radius: 50% !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
  transition: all 0.2s !important;
}
.me-av:hover { opacity: 0.85 !important; transform: scale(0.96) !important; }
.me-nm {
  font-weight: 700 !important;
  font-size: 15px !important;
}
.ib {
  width: 34px !important;
  height: 34px !important;
  border-radius: 10px !important;
  transition: all 0.18s !important;
}
.ib:hover {
  background: var(--accent-dim) !important;
  color: var(--accent) !important;
}
.sb-search { padding: 10px 14px !important; }
.srch-inp {
  border-radius: 24px !important;
  padding: 9px 14px 9px 38px !important;
  font-size: 13.5px !important;
  background: var(--surface) !important;
  border: 1.5px solid var(--border) !important;
  font-weight: 500 !important;
  transition: all 0.2s !important;
}
.srch-inp:focus {
  border-color: var(--accent) !important;
  background: var(--surface2) !important;
  box-shadow: 0 0 0 3px rgba(79,142,247,0.1) !important;
}
.sb-tabs {
  padding: 0 10px !important;
}
.sb-tab {
  font-size: 12.5px !important;
  font-weight: 600 !important;
  padding: 10px 6px 8px !important;
  border-bottom-width: 2.5px !important;
  transition: all 0.2s !important;
  gap: 6px !important;
}
.sb-tab.active { color: var(--accent) !important; }

/* ─── Chat List Items ─── */
.chat-list { padding: 8px 6px !important; }
.chat-item {
  padding: 10px 12px !important;
  border-radius: 16px !important;
  margin-bottom: 2px !important;
  transition: background 0.15s !important;
}
.chat-item:hover { background: var(--surface) !important; }
.chat-item.active {
  background: var(--accent-dim) !important;
}
.chat-item.active::before {
  display: none !important;
}
.ci-av {
  width: 48px !important;
  height: 48px !important;
  border-radius: 50% !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.18) !important;
}
.ci-av img { border-radius: 50% !important; }
.odot {
  width: 12px !important;
  height: 12px !important;
  border-width: 2px !important;
  bottom: 0 !important;
  right: 0 !important;
  background: var(--green) !important;
  box-shadow: 0 0 6px rgba(61,214,140,0.5) !important;
}
.ci-name {
  font-weight: 600 !important;
  font-size: 14.5px !important;
}
.ci-time {
  font-size: 11.5px !important;
  color: var(--text3) !important;
}
.ci-prev {
  font-size: 13px !important;
  color: var(--text2) !important;
}
.ubadge {
  border-radius: 12px !important;
  padding: 2px 7px !important;
  font-size: 10.5px !important;
  font-weight: 700 !important;
  background: var(--accent) !important;
  min-width: 20px !important;
  box-shadow: 0 2px 6px rgba(79,142,247,0.35) !important;
}
.sec-hd {
  font-size: 10.5px !important;
  letter-spacing: 1.2px !important;
  padding: 12px 14px 4px !important;
}

/* ═══════════════════ CHAT HEADER ═══════════════════ */
.chat-hd {
  padding: 12px 18px !important;
  background: var(--sidebar) !important;
  border-bottom: 1px solid var(--border) !important;
  box-shadow: 0 1px 10px rgba(0,0,0,0.08) !important;
}
.ch-av {
  width: 40px !important;
  height: 40px !important;
  border-radius: 50% !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
  transition: transform 0.2s !important;
}
.ch-av:hover { transform: scale(0.94) !important; }
.ch-av img { border-radius: 50% !important; }
.ch-name {
  font-size: 15.5px !important;
  font-weight: 700 !important;
  letter-spacing: -0.2px !important;
}
.ch-status {
  font-size: 12.5px !important;
  font-weight: 500 !important;
}
.ch-status.on {
  color: var(--green) !important;
}
.ch-status.on::before {
  background: var(--green) !important;
  box-shadow: 0 0 6px rgba(61,214,140,0.6) !important;
  width: 7px !important;
  height: 7px !important;
}

/* ═══════════════════ MESSAGE AREA ═══════════════════ */
.msgs {
  background: var(--chat-bg) !important;
  padding: 20px 20px 12px !important;
  gap: 3px !important;
  background-image:
    radial-gradient(circle at 20% 80%, rgba(79,142,247,0.025) 0%, transparent 40%),
    radial-gradient(circle at 80% 20%, rgba(124,77,255,0.02) 0%, transparent 40%) !important;
}

/* ─── Date Dividers ─── */
.date-div {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  margin: 16px 0 10px !important;
  color: var(--text2) !important;
  font-size: 12px !important;
  font-weight: 600 !important;
}
.date-div::before, .date-div::after { display: none !important; }

/* ─── Message Rows ─── */
.mrow {
  display: flex !important;
  align-items: flex-end !important;
  gap: 8px !important;
  margin-bottom: 2px !important;
  animation: msgSlideIn 0.22s cubic-bezier(0.34, 1.4, 0.64, 1) !important;
}
.mrow.out {
  flex-direction: row-reverse !important;
  align-self: flex-end !important;
  max-width: 74% !important;
}
.mrow.in {
  align-self: flex-start !important;
  max-width: 74% !important;
}
@keyframes msgSlideIn {
  from { opacity: 0; transform: translateY(10px) scale(0.97); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

/* Group spacing */
.mrow.out + .mrow.in,
.mrow.in + .mrow.out {
  margin-top: 10px !important;
}

/* ─── Message Avatars ─── */
.msg-av {
  width: 30px !important;
  height: 30px !important;
  border-radius: 50% !important;
  flex-shrink: 0 !important;
  overflow: hidden !important;
  box-shadow: 0 1px 6px rgba(0,0,0,0.25) !important;
}
.msg-av img { border-radius: 50% !important; }

/* ─── Bubbles ─── */
.bubble {
  padding: 9px 13px !important;
  border-radius: 20px !important;
  max-width: 100% !important;
  word-break: break-word !important;
  position: relative !important;
  transition: transform 0.15s !important;
}
.bubble:hover { transform: scale(1.005) !important; }

/* Outgoing bubble — gradient blue */
.out .bubble {
  background: linear-gradient(145deg, #3575f0, #1e50d4) !important;
  border-bottom-right-radius: 5px !important;
  border-top-right-radius: 20px !important;
  box-shadow: 0 2px 12px rgba(53,117,240,0.35) !important;
}
.mrow.out + .mrow.out .bubble {
  border-top-right-radius: 6px !important;
}
.mrow.out:not(:has(+ .mrow.out)) .bubble {
  border-bottom-right-radius: 5px !important;
}

/* Incoming bubble */
.in .bubble {
  background: var(--bubble-in) !important;
  border: 1px solid var(--bubble-in-border) !important;
  border-bottom-left-radius: 5px !important;
  border-top-left-radius: 20px !important;
  box-shadow: 0 1px 6px rgba(0,0,0,0.12) !important;
}
.mrow.in + .mrow.in .bubble {
  border-top-left-radius: 6px !important;
}

/* Bubble text */
.bbl-text {
  font-size: 14.5px !important;
  line-height: 1.58 !important;
  white-space: pre-wrap !important;
  word-break: break-word !important;
  font-weight: 450 !important;
}
.out .bbl-text { color: #ffffff !important; }
.in .bbl-text { color: var(--text) !important; }

/* Message meta (time + ticks) */
.bbl-meta {
  display: inline-flex !important;
  align-items: center !important;
  gap: 3px !important;
  float: right !important;
  font-size: 11px !important;
  margin: 2px -2px -3px 8px !important;
  opacity: 0.85 !important;
}
.out .bbl-meta { color: var(--msg-time-out, rgba(255,255,255,0.55)) !important; }
.in .bbl-meta  { color: var(--msg-time-in, rgba(140,150,185,0.7)) !important; }
.bbl-meta .chk { color: rgba(180,210,255,0.9) !important; }

/* Reply quote inside bubble */
.bbl-reply {
  background: rgba(255,255,255,0.10) !important;
  border-left: 2.5px solid rgba(255,255,255,0.6) !important;
  border-radius: 8px !important;
  padding: 5px 9px !important;
  margin-bottom: 7px !important;
}
.in .bbl-reply {
  background: rgba(79,142,247,0.08) !important;
  border-left-color: var(--accent) !important;
}
.bbl-rname {
  font-size: 11.5px !important;
  font-weight: 700 !important;
  color: rgba(180,210,255,0.9) !important;
}
.in .bbl-rname { color: var(--accent) !important; }
.bbl-rtext {
  font-size: 12.5px !important;
  color: rgba(255,255,255,0.65) !important;
}
.in .bbl-rtext { color: var(--text2) !important; }

/* Image in bubble */
.bbl-img {
  max-width: 300px !important;
  max-height: 280px !important;
  border-radius: 14px !important;
  cursor: zoom-in !important;
  display: block !important;
  transition: transform 0.2s !important;
}
.bbl-img:hover { transform: scale(0.98) !important; }

/* ─── Voice Messages ─── */
.voice-msg {
  min-width: 200px !important;
  gap: 10px !important;
  align-items: center !important;
}
.voice-play {
  width: 38px !important;
  height: 38px !important;
  border-radius: 50% !important;
  background: rgba(255,255,255,0.22) !important;
  flex-shrink: 0 !important;
  border: none !important;
  cursor: pointer !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  color: #fff !important;
  transition: transform 0.15s, background 0.15s !important;
}
.voice-play:hover { transform: scale(1.08) !important; background: rgba(255,255,255,0.3) !important; }
.in .voice-play { background: var(--accent) !important; }
.voice-waves {
  flex: 1 !important;
  display: flex !important;
  align-items: center !important;
  gap: 2px !important;
  height: 28px !important;
}
.voice-waves span {
  display: inline-block !important;
  width: 3px !important;
  border-radius: 3px !important;
}
.out .voice-waves span { background: rgba(255,255,255,0.5) !important; }
.in  .voice-waves span { background: var(--text3) !important; }
.voice-dur {
  font-size: 12px !important;
  font-weight: 600 !important;
  flex-shrink: 0 !important;
}
.out .voice-dur { color: rgba(255,255,255,0.7) !important; }
.in  .voice-dur { color: var(--text2) !important; }

/* ─── Typing Indicator ─── */
.typing-row {
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
  padding: 4px 0 !important;
  color: var(--text2) !important;
  font-size: 13px !important;
  font-weight: 500 !important;
}
.tdots { display: flex !important; gap: 4px !important; }
.tdots span {
  width: 7px !important; height: 7px !important;
  background: var(--text3) !important;
  border-radius: 50% !important;
  animation: tdot 1.4s infinite ease-in-out !important;
}
.tdots span:nth-child(2) { animation-delay: 0.2s !important; }
.tdots span:nth-child(3) { animation-delay: 0.4s !important; }
@keyframes tdot {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
  30% { transform: translateY(-6px); opacity: 1; }
}

/* ═══════════════════ INPUT BAR ═══════════════════ */
.ibar {
  background: var(--sidebar) !important;
  border-top: 1px solid var(--border) !important;
  padding: 10px 14px 16px !important;
  box-shadow: 0 -1px 12px rgba(0,0,0,0.06) !important;
}
.reply-strip {
  border-radius: 12px !important;
  margin-bottom: 8px !important;
  padding: 8px 12px !important;
  background: var(--surface) !important;
  border-left: 3px solid var(--accent) !important;
  border-top: none !important;
  border-right: none !important;
  border-bottom: none !important;
}
.irow { gap: 8px !important; align-items: flex-end !important; }
.iab {
  width: 40px !important;
  height: 40px !important;
  border-radius: 50% !important;
  background: var(--surface) !important;
  color: var(--text2) !important;
  transition: all 0.18s !important;
  flex-shrink: 0 !important;
}
.iab:hover {
  background: var(--accent-dim) !important;
  color: var(--accent) !important;
  transform: scale(1.06) !important;
}
.msg-inp {
  background: var(--input-bg) !important;
  border: 1.5px solid var(--input-border) !important;
  border-radius: 24px !important;
  padding: 11px 44px 11px 18px !important;
  font-size: 14.5px !important;
  font-weight: 450 !important;
  line-height: 1.5 !important;
  color: var(--text) !important;
  transition: all 0.2s !important;
}
.msg-inp:focus {
  border-color: var(--accent) !important;
  background: var(--surface2) !important;
  box-shadow: 0 0 0 3px rgba(79,142,247,0.1) !important;
}
.msg-inp::placeholder { color: var(--text3) !important; font-weight: 400 !important; }
.send-btn {
  width: 42px !important;
  height: 42px !important;
  border-radius: 50% !important;
  background: linear-gradient(135deg, #4f8ef7, #7c4dff) !important;
  box-shadow: 0 3px 12px rgba(79,142,247,0.45) !important;
  transition: all 0.18s !important;
  flex-shrink: 0 !important;
}
.send-btn:hover {
  transform: scale(1.10) !important;
  box-shadow: 0 6px 20px rgba(79,142,247,0.6) !important;
}
.mic-btn {
  width: 40px !important;
  height: 40px !important;
  border-radius: 50% !important;
  background: var(--surface) !important;
  color: var(--text2) !important;
  transition: all 0.18s !important;
  flex-shrink: 0 !important;
}
.mic-btn:hover {
  background: var(--accent-dim) !important;
  color: var(--accent) !important;
  transform: scale(1.06) !important;
}
.mic-btn.rec {
  background: rgba(255,79,100,0.15) !important;
  color: #ff4f64 !important;
  border: 1.5px solid rgba(255,79,100,0.4) !important;
  animation: recPulse 1.2s infinite !important;
}
@keyframes recPulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(255,79,100,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(255,79,100,0); }
}

/* ─── Emoji Picker ─── */
.emoji-picker {
  border-radius: 20px !important;
  background: var(--surface2) !important;
  border: 1px solid var(--border2) !important;
  box-shadow: 0 16px 50px rgba(0,0,0,0.35) !important;
  padding: 12px !important;
}
.emoji-it {
  font-size: 23px !important;
  border-radius: 10px !important;
  padding: 5px !important;
  transition: transform 0.12s, background 0.12s !important;
}
.emoji-it:hover {
  background: var(--surface) !important;
  transform: scale(1.18) !important;
}

/* ═══════════════════ CONTEXT MENU ═══════════════════ */
.ctx {
  border-radius: 18px !important;
  padding: 6px !important;
  background: var(--surface2) !important;
  border: 1px solid var(--border2) !important;
  backdrop-filter: blur(20px) !important;
  -webkit-backdrop-filter: blur(20px) !important;
  box-shadow: 0 12px 40px rgba(0,0,0,0.35) !important;
  min-width: 180px !important;
}
.ctx-it {
  padding: 10px 14px !important;
  border-radius: 12px !important;
  font-size: 13.5px !important;
  font-weight: 500 !important;
  gap: 11px !important;
  transition: background 0.12s !important;
}
.ctx-it:hover { background: var(--surface) !important; }
.ctx-it.danger { color: #ff4f64 !important; }

/* ═══════════════════ PROFILE MODAL ═══════════════════ */
.pm-over { backdrop-filter: blur(8px) !important; -webkit-backdrop-filter: blur(8px) !important; }
.pm-card {
  border-radius: 26px !important;
  border: 1px solid var(--border) !important;
  box-shadow: 0 32px 80px rgba(0,0,0,0.45) !important;
  width: 360px !important;
  overflow: hidden !important;
}
.pm-banner-grad {
  background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%) !important;
  opacity: 0.9 !important;
}
.pm-av {
  border-radius: 50% !important;
  border: 3px solid var(--sidebar) !important;
  box-shadow: 0 4px 16px rgba(0,0,0,0.3) !important;
  width: 76px !important;
  height: 76px !important;
  font-size: 28px !important;
}
.pm-name { font-size: 21px !important; font-weight: 800 !important; letter-spacing: -0.4px !important; }
.pm-btn {
  border-radius: 14px !important;
  font-weight: 700 !important;
  font-size: 13.5px !important;
  padding: 10px 10px !important;
}
.pm-btn.prim {
  background: linear-gradient(135deg, #4f8ef7, #7c4dff) !important;
  box-shadow: 0 4px 14px rgba(79,142,247,0.4) !important;
}
.pm-btn.prim:hover { box-shadow: 0 6px 20px rgba(79,142,247,0.55) !important; }

/* ═══════════════════ SETTINGS PANEL ═══════════════════ */
.sett-panel {
  border-radius: 0 !important;
  box-shadow: -12px 0 50px rgba(0,0,0,0.2) !important;
}
.sett-hd { padding: 18px 20px !important; }
.sett-hd h2 { font-size: 18px !important; font-weight: 800 !important; }
.sett-av {
  border-radius: 50% !important;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25) !important;
}
.sett-av-badge {
  border-radius: 50% !important;
  width: 28px !important;
  height: 28px !important;
  background: linear-gradient(135deg, #4f8ef7, #7c4dff) !important;
  box-shadow: 0 2px 8px rgba(79,142,247,0.4) !important;
}
.sett-uname { font-size: 20px !important; font-weight: 800 !important; }
.sett-row { border-radius: 14px !important; padding: 11px 12px !important; }
.sett-row:hover { background: var(--surface) !important; }
.sett-ico {
  border-radius: 11px !important;
  width: 36px !important;
  height: 36px !important;
}
.sett-row-label { font-size: 14.5px !important; font-weight: 600 !important; }
.sett-row-sub { font-size: 12.5px !important; }
.btn-prim {
  border-radius: 12px !important;
  font-weight: 700 !important;
  background: linear-gradient(135deg, #4f8ef7, #7c4dff) !important;
  box-shadow: 0 3px 12px rgba(79,142,247,0.35) !important;
}
.btn-sec { border-radius: 12px !important; font-weight: 600 !important; }
.btn-danger { border-radius: 12px !important; font-weight: 700 !important; }

/* ═══════════════════ CALL OVERLAY ═══════════════════ */
.call-over {
  background: rgba(8,10,16,0.92) !important;
  backdrop-filter: blur(16px) !important;
  -webkit-backdrop-filter: blur(16px) !important;
}
.call-card {
  border-radius: 30px !important;
  padding: 40px 48px !important;
  border: 1px solid var(--border) !important;
  box-shadow: 0 40px 100px rgba(0,0,0,0.5) !important;
}
.call-av {
  border-radius: 50% !important;
  width: 92px !important;
  height: 92px !important;
  font-size: 36px !important;
  box-shadow: 0 6px 24px rgba(0,0,0,0.3) !important;
  border: none !important;
}
.call-name { font-size: 24px !important; font-weight: 800 !important; letter-spacing: -0.5px !important; }
.cbtn {
  width: 62px !important;
  height: 62px !important;
  border-radius: 50% !important;
  transition: all 0.18s !important;
}
.cbtn:hover { transform: scale(1.10) !important; }
.cbtn.accept {
  background: linear-gradient(135deg, #22c55e, #16a34a) !important;
  box-shadow: 0 4px 16px rgba(34,197,94,0.45) !important;
}
.cbtn.decline, .cbtn.end-call {
  background: linear-gradient(135deg, #ef4444, #dc2626) !important;
  box-shadow: 0 4px 16px rgba(239,68,68,0.45) !important;
}
.cbtn.neutral {
  background: var(--surface2) !important;
  border: 1px solid var(--border2) !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
}

/* ═══════════════════ TOAST ═══════════════════ */
.toast {
  border-radius: 18px !important;
  padding: 13px 16px !important;
  backdrop-filter: blur(16px) !important;
  -webkit-backdrop-filter: blur(16px) !important;
  box-shadow: 0 12px 40px rgba(0,0,0,0.3) !important;
  font-weight: 500 !important;
  font-size: 13.5px !important;
}

/* ═══════════════════ MODAL ═══════════════════ */
.modal-over {
  backdrop-filter: blur(8px) !important;
  -webkit-backdrop-filter: blur(8px) !important;
}
.modal-card {
  border-radius: 24px !important;
  border: 1px solid var(--border) !important;
  box-shadow: 0 32px 80px rgba(0,0,0,0.4) !important;
}
.modal-hd { padding: 18px 22px !important; }
.modal-hd h3 { font-size: 17px !important; font-weight: 800 !important; }
.modal-body { padding: 18px 22px 22px !important; }

/* ═══════════════════ LIGHTBOX ═══════════════════ */
.lightbox img {
  border-radius: 14px !important;
  box-shadow: 0 24px 80px rgba(0,0,0,0.6) !important;
}

/* ═══════════════════ NO CHAT SCREEN ═══════════════════ */
.no-chat h3 {
  font-size: 20px !important;
  font-weight: 800 !important;
  letter-spacing: -0.4px !important;
}
.no-chat p { font-size: 14px !important; font-weight: 500 !important; }
.no-chat-icon { opacity: 0.3 !important; }

/* ─── Mini Call Bar ─── */
.mini-call-bar {
  border-radius: 50px !important;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4) !important;
  backdrop-filter: blur(16px) !important;
}
.mini-call-av { border-radius: 50% !important; }
.mini-call-end { border-radius: 50% !important; }

/* ─── Theme Chips ─── */
.theme-chip {
  border-radius: 12px !important;
  font-size: 11.5px !important;
  font-weight: 700 !important;
  transition: all 0.18s !important;
}
.theme-chip.active {
  border-color: var(--accent) !important;
  background: var(--accent-dim) !important;
  color: var(--accent) !important;
}

/* ═══════════════════ SCROLLBAR ═══════════════════ */
::-webkit-scrollbar { width: 4px !important; height: 4px !important; }
::-webkit-scrollbar-track { background: transparent !important; }
::-webkit-scrollbar-thumb { background: var(--border2) !important; border-radius: 3px !important; }
::-webkit-scrollbar-thumb:hover { background: var(--text3) !important; }

/* ═══════════════════ MOBILE ═══════════════════ */
@media (max-width: 640px) {
  .msgs { padding: 12px 12px 8px !important; }
  .mrow.out, .mrow.in { max-width: 88% !important; }
  .bbl-img { max-width: calc(100vw - 100px) !important; max-height: 240px !important; }
  .sidebar { width: 100% !important; }
}

`;
document.head.appendChild(s);

/* ─── Upgrade date dividers to pill style ─── */
function upgradeDateDivs() {
  document.querySelectorAll('.date-div').forEach(function(el) {
    if (el.dataset.upgraded) return;
    el.dataset.upgraded = '1';
    var text = el.textContent.trim();
    el.innerHTML = '<span style="display:inline-block;background:rgba(120,135,175,0.14);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:14px;padding:4px 16px;font-size:12px;font-weight:700;color:var(--text2);letter-spacing:0.2px;">'+text+'</span>';
  });
}
var obs = new MutationObserver(function() { upgradeDateDivs(); });
obs.observe(document.body, { childList: true, subtree: true });
setTimeout(upgradeDateDivs, 300);

})();
/* ══ END PREMIUM MESSENGER REDESIGN ══ */

</script>
</body>
</html>